---
phase: 09-deletion-flows-with-undo
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/routes/projects.py
  - backend/app/routes/threads.py
  - backend/app/routes/documents.py
  - backend/app/routes/conversations.py
autonomous: true

must_haves:
  truths:
    - "DELETE /projects/{id} returns 204 and cascades to threads/documents/messages"
    - "DELETE /threads/{id} returns 204 and cascades to messages/artifacts"
    - "DELETE /documents/{id} returns 204"
    - "DELETE /threads/{thread_id}/messages/{message_id} returns 204"
    - "All DELETE endpoints verify user ownership before deletion"
    - "Non-existent or unauthorized resources return 404"
  artifacts:
    - path: "backend/app/routes/projects.py"
      provides: "DELETE /projects/{id} endpoint"
      contains: "@router.delete"
    - path: "backend/app/routes/threads.py"
      provides: "DELETE /threads/{id} endpoint"
      contains: "@router.delete"
    - path: "backend/app/routes/documents.py"
      provides: "DELETE /documents/{id} endpoint"
      contains: "@router.delete"
    - path: "backend/app/routes/conversations.py"
      provides: "DELETE /threads/{thread_id}/messages/{message_id} endpoint"
      contains: "@router.delete"
  key_links:
    - from: "backend/app/routes/projects.py"
      to: "database cascade"
      via: "db.delete() triggers ON DELETE CASCADE"
      pattern: "await db.delete"
---

<objective>
Add DELETE endpoints to the backend API for projects, threads, documents, and messages.

Purpose: Enable the frontend to delete resources via API calls. Backend relies on existing SQLite CASCADE constraints (already configured in models.py) to automatically delete related records.

Output: Four DELETE endpoints returning 204 No Content on success.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-deletion-flows-with-undo/09-RESEARCH.md

# Existing endpoint patterns
@backend/app/routes/projects.py
@backend/app/routes/threads.py
@backend/app/routes/documents.py
@backend/app/routes/conversations.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DELETE endpoints for projects and threads</name>
  <files>
    - backend/app/routes/projects.py
    - backend/app/routes/threads.py
  </files>
  <action>
Add DELETE /projects/{project_id} endpoint to projects.py:
- Import Response from fastapi (for 204 response)
- Add endpoint with @router.delete decorator, status_code=204
- Query project by ID, verify user ownership (project.user_id == current_user["user_id"])
- Return 404 if not found or not owned
- Call await db.delete(project), await db.commit()
- Return Response(status_code=status.HTTP_204_NO_CONTENT)
- Database CASCADE handles threads, documents, messages automatically

Add DELETE /threads/{thread_id} endpoint to threads.py:
- Import Response from fastapi
- Add endpoint with @router.delete decorator, status_code=204
- Query thread with selectinload(Thread.project) to verify ownership
- Check thread.project.user_id == current_user["user_id"]
- Return 404 if not found or not owned
- Call await db.delete(thread), await db.commit()
- Return Response(status_code=status.HTTP_204_NO_CONTENT)
- Database CASCADE handles messages, artifacts automatically
  </action>
  <verify>
Backend server starts without errors:
```bash
cd backend && python -c "from app.routes.projects import router; from app.routes.threads import router"
```
  </verify>
  <done>DELETE endpoints added to projects.py and threads.py with ownership verification and 204 response</done>
</task>

<task type="auto">
  <name>Task 2: Add DELETE endpoints for documents and messages</name>
  <files>
    - backend/app/routes/documents.py
    - backend/app/routes/conversations.py
  </files>
  <action>
Add DELETE /documents/{document_id} endpoint to documents.py:
- Import Response from fastapi, status from fastapi
- Add endpoint with @router.delete decorator, status_code=204
- Query document with join to Project to verify user ownership
- Use: select(Document).join(Project).where(Document.id == document_id, Project.user_id == current_user["user_id"])
- Return 404 if not found or not owned
- Call await db.delete(doc), await db.commit()
- Return Response(status_code=status.HTTP_204_NO_CONTENT)

Add DELETE /threads/{thread_id}/messages/{message_id} endpoint to conversations.py:
- Import Response from fastapi
- Add endpoint with @router.delete decorator, status_code=204
- First verify thread ownership (reuse validate_thread_access or inline check)
- Then query message by ID and thread_id: select(Message).where(Message.id == message_id, Message.thread_id == thread_id)
- Return 404 if message not found
- Call await db.delete(message), await db.commit()
- Return Response(status_code=status.HTTP_204_NO_CONTENT)

Note: Import Message model at top of conversations.py if not already imported.
  </action>
  <verify>
Backend server starts and endpoints are registered:
```bash
cd backend && python -c "from app.routes.documents import router; from app.routes.conversations import router; print('OK')"
```
  </verify>
  <done>DELETE endpoints added to documents.py and conversations.py with ownership verification and 204 response</done>
</task>

<task type="auto">
  <name>Task 3: Manual API verification with curl</name>
  <files>None (verification only)</files>
  <action>
Start the backend server if not running, then verify each DELETE endpoint returns proper responses:

1. Create test data (project, thread, document, message) using existing endpoints
2. Test DELETE /documents/{id} - should return 204
3. Test DELETE /threads/{thread_id}/messages/{message_id} - should return 204
4. Test DELETE /threads/{id} - should return 204
5. Test DELETE /projects/{id} - should return 204
6. Test DELETE on non-existent ID - should return 404
7. Test DELETE on another user's resource (if possible) - should return 404

Document results in SUMMARY.md.

Note: This is manual verification. If backend is not running or auth tokens are complex to obtain, document the expected behavior and move on.
  </action>
  <verify>
Each DELETE endpoint:
- Returns 204 No Content on success
- Returns 404 for non-existent or unauthorized resources
- Does not return response body on 204
  </verify>
  <done>All four DELETE endpoints verified to return correct status codes</done>
</task>

</tasks>

<verification>
- [ ] Backend server starts without import errors
- [ ] DELETE /projects/{id} exists with 204 status code
- [ ] DELETE /threads/{id} exists with 204 status code
- [ ] DELETE /documents/{id} exists with 204 status code
- [ ] DELETE /threads/{thread_id}/messages/{message_id} exists with 204 status code
- [ ] All endpoints verify user ownership
- [ ] All endpoints return 404 for non-existent/unauthorized resources
</verification>

<success_criteria>
- Four DELETE endpoints added following existing FastAPI patterns
- Each endpoint returns 204 No Content on successful deletion
- Each endpoint returns 404 Not Found for non-existent or unauthorized resources
- Database cascade deletes work automatically (tested via parent deletion)
</success_criteria>

<output>
After completion, create `.planning/phases/09-deletion-flows-with-undo/09-01-SUMMARY.md`
</output>

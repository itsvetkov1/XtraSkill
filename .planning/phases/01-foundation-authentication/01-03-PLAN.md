---
phase: 01-foundation-authentication
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - frontend/lib/widgets/responsive_layout.dart
  - frontend/lib/screens/home_screen.dart
  - frontend/test/integration/auth_flow_test.dart
  - backend/tests/test_auth_integration.py

autonomous: false

must_haves:
  truths:
    - "App displays correctly on mobile phone screens (320px-600px width)"
    - "App displays correctly on tablet screens (600px-900px width)"
    - "App displays correctly on desktop screens (>900px width)"
    - "OAuth flow works identically on web, Android, and iOS"
    - "Authentication persists across app restarts on all platforms"
    - "User can navigate using platform-appropriate patterns (drawer on mobile, sidebar on desktop)"
  artifacts:
    - path: "frontend/lib/widgets/responsive_layout.dart"
      provides: "Responsive breakpoint utilities"
      min_lines: 30
    - path: "frontend/test/integration/auth_flow_test.dart"
      provides: "Integration tests for auth flow"
      contains: "testWidgets"
    - path: "backend/tests/test_auth_integration.py"
      provides: "Backend OAuth flow tests"
      contains: "test_google_oauth_flow"
  key_links:
    - from: "frontend/lib/screens/home_screen.dart"
      to: "frontend/lib/widgets/responsive_layout.dart"
      via: "responsive layout detection"
      pattern: "ResponsiveLayout.*builder"
---

<objective>
Verify and polish cross-platform authentication experience with responsive design.

Purpose: Ensure authentication works consistently across web, Android, and iOS platforms with platform-appropriate UI patterns. This addresses Pitfall #3 (cross-platform inconsistency) by establishing responsive design patterns that all subsequent phases will follow.

Output: Fully tested authentication flows on all platforms with responsive layouts, integration tests, and documented platform-specific behaviors.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/PITFALLS.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement responsive layout system and update home screen</name>
  <files>
    frontend/lib/widgets/responsive_layout.dart
    frontend/lib/screens/home_screen.dart
    frontend/lib/screens/auth/login_screen.dart
  </files>
  <action>
    Create responsive design infrastructure:

    1. **Responsive layout widget** (lib/widgets/responsive_layout.dart):
       - Define breakpoints:
         - mobile: width < 600
         - tablet: 600 <= width < 900
         - desktop: width >= 900

       - ResponsiveLayout widget with builder pattern:
         ```dart
         class ResponsiveLayout extends StatelessWidget {
           final Widget mobile;
           final Widget? tablet;
           final Widget desktop;

           ResponsiveLayout({
             required this.mobile,
             this.tablet,
             required this.desktop,
           });

           @override
           Widget build(BuildContext context) {
             return LayoutBuilder(
               builder: (context, constraints) {
                 if (constraints.maxWidth >= 900) return desktop;
                 if (constraints.maxWidth >= 600) return tablet ?? mobile;
                 return mobile;
               },
             );
           }
         }
         ```

       - Utility functions:
         - isMobile(BuildContext context) → bool
         - isTablet(BuildContext context) → bool
         - isDesktop(BuildContext context) → bool

    2. **Update home screen** (lib/screens/home_screen.dart):
       - Replace placeholder with responsive layout:
         - **Mobile**: AppBar + Drawer with navigation menu
         - **Tablet**: AppBar + Drawer (similar to mobile)
         - **Desktop**: Sidebar navigation + main content area

       Example structure:
       ```dart
       ResponsiveLayout(
         mobile: Scaffold(
           appBar: AppBar(title: Text('BA Assistant')),
           drawer: NavigationDrawer(...),
           body: Center(child: Text('Welcome to BA Assistant')),
         ),
         desktop: Row(
           children: [
             NavigationRail(...),  // Sidebar
             Expanded(child: Center(child: Text('Welcome to BA Assistant'))),
           ],
         ),
       )
       ```

    3. **Update login screen** for responsiveness:
       - Center OAuth buttons on mobile (full width, 80% max)
       - Center OAuth buttons on desktop (fixed width 400px)
       - Adjust spacing and padding based on screen size

    WHY: Establishes pattern for all future screens. Navigation drawer on mobile (thumb-friendly), sidebar on desktop (persistent visibility).

    AVOID: Fixed pixel dimensions, ignoring safe areas (iOS notch), testing only on one platform.
  </action>
  <verify>
    Run verification commands:
    ```bash
    cd frontend
    flutter analyze
    flutter test

    # Test on multiple platforms
    flutter run -d chrome --web-port=8080  # Web
    flutter run -d android  # Android emulator
    flutter run -d ios      # iOS simulator (macOS only)
    ```

    Manual checks using Flutter DevTools Device Frame:
    1. Resize browser from 320px to 1920px width
       - 320px: Mobile layout (drawer navigation)
       - 600px: Tablet layout
       - 900px: Desktop layout (sidebar navigation)
    2. Verify no horizontal scrolling at any width
    3. Verify text remains readable (no tiny fonts)
    4. Verify buttons remain tappable (min 44px touch targets)
  </verify>
  <done>
    - ResponsiveLayout widget created with breakpoint detection
    - Home screen uses responsive layout (drawer on mobile, sidebar on desktop)
    - Login screen adjusts button width based on screen size
    - Navigation patterns appropriate for each platform
    - No layout overflow errors at any breakpoint
    - Utility functions available for all screens to check device type
  </done>
</task>

<task type="auto">
  <name>Task 2: Create integration tests for authentication flows</name>
  <files>
    frontend/test/integration/auth_flow_test.dart
    backend/tests/test_auth_integration.py
    backend/tests/conftest.py
  </files>
  <action>
    Create automated tests for authentication:

    1. **Backend integration tests** (backend/tests/test_auth_integration.py):
       - Test JWT creation and verification:
         ```python
         def test_create_jwt_token():
             token = create_access_token(user_id=UUID(...), email="test@example.com")
             assert token is not None
             payload = verify_token(token)
             assert payload["email"] == "test@example.com"
         ```

       - Test OAuth initiate endpoints:
         ```python
         async def test_google_oauth_initiate(client):
             response = await client.get("/auth/google/initiate")
             assert response.status_code == 200
             assert "auth_url" in response.json()
             assert "accounts.google.com" in response.json()["auth_url"]
         ```

       - Test protected endpoint authorization:
         ```python
         async def test_protected_endpoint_requires_auth(client):
             response = await client.get("/auth/me")
             assert response.status_code == 401

             valid_token = create_access_token(...)
             response = await client.get(
                 "/auth/me",
                 headers={"Authorization": f"Bearer {valid_token}"}
             )
             assert response.status_code == 200
         ```

       - Test user creation on OAuth callback (mock external OAuth APIs):
         ```python
         async def test_google_callback_creates_user(client, db_session, mocker):
             # Mock Google token exchange
             mocker.patch("authlib.integrations.httpx_client.AsyncOAuth2Client.fetch_token")
             mocker.patch("app.services.auth_service.get_google_user_info", return_value={
                 "email": "user@example.com",
                 "sub": "google_12345"
             })

             response = await client.get("/auth/google/callback?code=test_code&state=test_state")
             assert response.status_code == 302  # Redirect

             user = db_session.query(User).filter_by(email="user@example.com").first()
             assert user is not None
             assert user.oauth_provider == "google"
         ```

       Setup conftest.py with fixtures for async test client and database session.

    2. **Flutter integration tests** (frontend/test/integration/auth_flow_test.dart):
       - Test login screen renders:
         ```dart
         testWidgets('Login screen shows OAuth buttons', (tester) async {
           await tester.pumpWidget(MyApp());
           await tester.pumpAndSettle();

           expect(find.text('Sign in with Google'), findsOneWidget);
           expect(find.text('Sign in with Microsoft'), findsOneWidget);
         });
         ```

       - Test auth state transitions (using mock auth service):
         ```dart
         testWidgets('Successful login navigates to home', (tester) async {
           final mockAuthService = MockAuthService();
           when(mockAuthService.loginWithGoogle()).thenAnswer((_) async => 'fake_token');

           await tester.pumpWidget(MyApp(authService: mockAuthService));
           await tester.tap(find.text('Sign in with Google'));
           await tester.pumpAndSettle();

           expect(find.text('Welcome to BA Assistant'), findsOneWidget);
         });
         ```

       - Test token persistence:
         ```dart
         testWidgets('App restores authenticated state on startup', (tester) async {
           final mockAuthService = MockAuthService();
           when(mockAuthService.getStoredToken()).thenAnswer((_) async => 'valid_token');
           when(mockAuthService.isTokenValid('valid_token')).thenReturn(true);

           await tester.pumpWidget(MyApp(authService: mockAuthService));
           await tester.pumpAndSettle();

           expect(find.text('Welcome to BA Assistant'), findsOneWidget);
           expect(find.text('Sign in with Google'), findsNothing);
         });
         ```

    3. **Test execution setup**:
       - Backend: pytest with async support (pytest-asyncio)
       - Frontend: flutter test with mockito for mocking services

    WHY: Integration tests catch OAuth flow breaks, token validation issues, and state management bugs before they reach users.

    AVOID: Testing external OAuth APIs directly (slow, flaky), skipping error cases, not mocking network calls.
  </action>
  <verify>
    Run verification commands:
    ```bash
    # Backend tests
    cd backend
    pytest tests/test_auth_integration.py -v

    # Flutter tests
    cd frontend
    flutter test test/integration/auth_flow_test.dart
    ```

    Expected output:
    - All backend tests pass (JWT creation, OAuth initiate, protected endpoints)
    - All Flutter tests pass (login screen render, auth state transitions)
    - No test failures or flaky tests
    - Test coverage > 80% for auth-related code
  </verify>
  <done>
    - Backend integration tests cover JWT creation/verification
    - Backend tests verify OAuth initiate endpoints return correct URLs
    - Backend tests verify protected endpoints require valid JWT
    - Backend tests mock OAuth callback and verify user creation
    - Flutter integration tests verify login screen rendering
    - Flutter tests verify auth state transitions (login, logout)
    - Flutter tests verify token persistence across app restarts
    - All tests pass consistently
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete cross-platform authentication system with OAuth flows and responsive design.

    Backend:
    - OAuth integration with Google and Microsoft
    - JWT-based session management
    - Protected endpoint pattern
    - User model with OAuth provider tracking

    Frontend:
    - OAuth login flows on web, Android, iOS
    - Secure token storage
    - Responsive layouts (mobile drawer, desktop sidebar)
    - Auth state management

    Testing:
    - Backend integration tests for OAuth flows
    - Flutter integration tests for auth UI
  </what-built>

  <how-to-verify>
    **Prerequisites:**
    1. Ensure OAuth credentials configured in backend/.env (see Plan 02 user_setup instructions)
    2. Backend running: `cd backend && uvicorn main:app --reload`

    **Test on Web:**
    3. Run Flutter web: `cd frontend && flutter run -d chrome --web-port=8080`
    4. Click "Sign in with Google"
       - Should open Google OAuth consent screen in browser
       - After approval, redirects back to app
       - App shows home screen with "Welcome to BA Assistant"
    5. Close browser tab, reopen http://localhost:8080
       - Should open directly to home screen (authenticated)
    6. Click logout (add logout button in home screen if needed)
       - Should return to login screen
    7. Resize browser window from mobile (320px) to desktop (1920px)
       - Mobile: Drawer navigation icon in app bar
       - Desktop: Sidebar navigation visible

    **Test on Android:**
    8. Run Flutter Android: `flutter run -d android`
    9. Repeat steps 4-6 on Android emulator
    10. Close app, reopen - should remain authenticated
    11. Verify drawer navigation works (swipe from left or tap hamburger icon)

    **Test on iOS (if macOS available):**
    12. Run Flutter iOS: `flutter run -d ios`
    13. Repeat steps 4-6 on iOS simulator
    14. Close app, reopen - should remain authenticated
    15. Verify Cupertino-style back button and navigation feel native

    **Test Microsoft OAuth:**
    16. On any platform, click "Sign in with Microsoft"
    17. Complete Microsoft OAuth flow
    18. Verify app shows home screen after authentication

    **Verify Backend:**
    19. Check database: `sqlite3 backend/ba_assistant.db "SELECT * FROM users;"`
        - Should show user records with oauth_provider (google or microsoft)
    20. Check backend logs for OAuth callback processing
    21. Run backend tests: `cd backend && pytest tests/test_auth_integration.py`
        - All tests should pass

    **Verify Frontend:**
    22. Run Flutter tests: `cd frontend && flutter test`
        - All tests should pass
    23. Run Flutter analyze: `flutter analyze`
        - No errors or warnings

    **Expected Results:**
    - OAuth flows work identically on web, Android, iOS
    - Authentication persists across app restarts on all platforms
    - Responsive design adapts to screen size appropriately
    - No console errors or crashes during any flow
    - Backend tests pass
    - Flutter tests pass
  </how-to-verify>

  <resume-signal>
    Type "approved" if all verification steps pass, or describe any issues encountered (e.g., "OAuth works on web but Android app crashes after redirect").
  </resume-signal>
</task>

</tasks>

<verification>
**Phase 1 complete when:**
1. OAuth authentication works on web, Android, and iOS
2. Users remain authenticated across app restarts (token persistence)
3. Responsive design displays correctly at mobile, tablet, and desktop breakpoints
4. Backend integration tests pass (OAuth flows, JWT validation)
5. Flutter integration tests pass (login UI, auth state)
6. Database contains User and TokenUsage tables
7. No cross-platform inconsistencies in navigation patterns

**Requirements coverage verification:**
- AUTH-01: Google OAuth works ✓
- AUTH-02: Microsoft OAuth works ✓
- AUTH-03: Google login persists across sessions ✓
- AUTH-04: Microsoft login persists across sessions ✓
- AUTH-05: Logout functionality works ✓
- PLAT-01: Works on web browsers ✓
- PLAT-02: Works on Android ✓
- PLAT-03: Works on iOS ✓
- PLAT-04: Data persists on server ✓
- PLAT-05: Data syncs across devices ✓
</verification>

<success_criteria>
**Measurable completion criteria:**
1. OAuth flow completes successfully on Chrome (web), Android emulator, iOS simulator
2. Token stored securely survives app restart on all three platforms
3. Home screen displays drawer navigation on mobile (<600px width)
4. Home screen displays sidebar navigation on desktop (>=900px width)
5. Backend integration tests achieve >80% code coverage for auth module
6. Flutter integration tests verify auth state transitions without flakiness
7. Database schema includes User (with oauth_provider, oauth_id) and TokenUsage tables
8. No platform-specific crashes or errors in auth flow
9. Logout removes token from storage and returns to login screen on all platforms

**Phase 1 deliverables:**
- Working OAuth authentication (Google + Microsoft)
- JWT-based session management
- Secure token storage with flutter_secure_storage
- Responsive layouts with platform-appropriate navigation
- Database schema with User and TokenUsage models
- FastAPI server with auth endpoints
- Integration tests for backend and frontend
- Cross-platform verification complete

**Goal-backward verification:**
- Truth: "Users can securely access from any device" → OAuth works on web/Android/iOS ✓
- Truth: "Authentication persists across sessions" → Token storage tested ✓
- Truth: "UI adapts to device" → Responsive layouts verified ✓
- Truth: "Foundation ready for features" → Database, API, auth established ✓
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-03-SUMMARY.md` documenting:
- Responsive layout system implementation
- Platform-specific testing results (web, Android, iOS)
- Integration test coverage and results
- Cross-platform behavior notes (any platform-specific quirks)
- OAuth setup instructions consolidated
- Development workflow for testing across platforms
- Issues encountered and resolutions
- Phase 1 complete: Foundation ready for Phase 2 (Project & Document Management)
</output>

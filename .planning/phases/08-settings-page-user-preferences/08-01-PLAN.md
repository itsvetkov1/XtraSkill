---
phase: 08-settings-page-user-preferences
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/models.py
  - backend/app/services/auth_service.py
  - backend/app/routes/auth.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User model includes display_name field that persists OAuth provider display name"
    - "/auth/me endpoint returns display_name in response"
    - "/auth/usage endpoint returns monthly token usage statistics"
    - "OAuth login stores display name from Google/Microsoft APIs"
  artifacts:
    - path: "backend/app/models.py"
      provides: "User model with display_name field"
      contains: "display_name"
    - path: "backend/app/services/auth_service.py"
      provides: "OAuth service storing display name"
      contains: "display_name"
    - path: "backend/app/routes/auth.py"
      provides: "/auth/usage endpoint"
      contains: "@router.get(\"/usage\")"
  key_links:
    - from: "backend/app/services/auth_service.py"
      to: "backend/app/models.py"
      via: "display_name field assignment in _upsert_user"
      pattern: "user\\.display_name\\s*="
    - from: "backend/app/routes/auth.py"
      to: "backend/app/services/token_tracking.py"
      via: "get_monthly_usage import and call"
      pattern: "get_monthly_usage"
---

<objective>
Add backend infrastructure for Settings page user profile and token usage display.

Purpose: Enable frontend to display user's display name (from OAuth provider) and monthly token usage statistics. This provides the API foundation for SET-01 (profile display) and SET-05 (token budget).

Output:
- User model with display_name field
- OAuth services storing display name from Google/Microsoft APIs
- /auth/me enhanced to return display_name
- New /auth/usage endpoint exposing monthly token statistics
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-settings-page-user-preferences/08-RESEARCH.md

# Key existing files
@backend/app/models.py — User model to extend
@backend/app/services/auth_service.py — OAuth service to update
@backend/app/routes/auth.py — Auth endpoints to extend
@backend/app/services/token_tracking.py — get_monthly_usage() exists, needs API exposure
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add display_name to User model and update OAuth services</name>
  <files>
    backend/app/models.py
    backend/app/services/auth_service.py
  </files>
  <action>
1. **Update User model in models.py:**
   - Add `display_name` field: `display_name: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)`
   - Place after `oauth_id` field, before audit timestamps
   - Nullable because existing users won't have it until next login

2. **Update auth_service.py OAuth processing:**
   - In `process_google_callback()`:
     - After line `email = user_info["email"]`, extract: `display_name = user_info.get("name")`
     - Pass to _upsert_user: `display_name=display_name`

   - In `process_microsoft_callback()`:
     - After line `email = user_info["mail"] or user_info.get("userPrincipalName")`, extract: `display_name = user_info.get("displayName")`
     - Pass to _upsert_user: `display_name=display_name`

3. **Update _upsert_user() method:**
   - Add parameter: `display_name: Optional[str] = None`
   - In existing user branch: `user.display_name = display_name`
   - In new user branch: add `display_name=display_name` to User constructor

**Why nullable:** Existing users in database won't have display_name until they log in again. Frontend must handle None gracefully (show email instead).

**Why update on every login:** User may change their name in Google/Microsoft - we stay current with provider.
  </action>
  <verify>
    - `grep -n "display_name" backend/app/models.py` shows field definition
    - `grep -n "display_name" backend/app/services/auth_service.py` shows extraction and storage
    - No syntax errors: `cd backend && python -c "from app.models import User; print('OK')"`
  </verify>
  <done>
    - User model has display_name field (Optional[str], nullable)
    - Google OAuth extracts name from user_info["name"]
    - Microsoft OAuth extracts displayName from user_info["displayName"]
    - _upsert_user stores display_name on create and update
  </done>
</task>

<task type="auto">
  <name>Task 2: Create /auth/usage endpoint and enhance /auth/me</name>
  <files>
    backend/app/routes/auth.py
  </files>
  <action>
1. **Enhance existing /auth/me endpoint:**
   - Add `"display_name": user_obj.display_name` to the return dictionary
   - Place after `"email"` field

2. **Create new /auth/usage endpoint:**
   - Add after the /auth/me endpoint (around line 253)
   - Use existing `Depends(get_current_user)` for authentication
   - Import `get_monthly_usage` from `app.services.token_tracking`
   - Call `await get_monthly_usage(db, user["user_id"])`
   - Return JSON with fields:
     - `total_cost` (float)
     - `total_requests` (int)
     - `total_input_tokens` (int)
     - `total_output_tokens` (int)
     - `month_start` (string ISO date)
     - `budget` (float)

**Endpoint pattern:**
```python
@router.get("/usage")
async def get_user_usage(
    user: dict = Depends(get_current_user),
    db: AsyncSession = Depends(get_db),
):
    """
    Get current month token usage for authenticated user.

    Requires valid JWT token in Authorization header.

    Returns:
        Usage object with total_cost, total_requests, total_input_tokens,
        total_output_tokens, month_start, budget
    """
    from app.services.token_tracking import get_monthly_usage

    usage = await get_monthly_usage(db, user["user_id"])

    return {
        "total_cost": float(usage["total_cost"]),
        "total_requests": usage["total_requests"],
        "total_input_tokens": usage["total_input_tokens"],
        "total_output_tokens": usage["total_output_tokens"],
        "month_start": usage["month_start"],
        "budget": float(usage["budget"]),
    }
```

**Why float conversion:** Decimal type from token_tracking doesn't serialize to JSON directly.
  </action>
  <verify>
    - `grep -n "display_name" backend/app/routes/auth.py` shows it in /me response
    - `grep -n "@router.get.*usage" backend/app/routes/auth.py` shows new endpoint
    - No syntax errors: `cd backend && python -c "from app.routes.auth import router; print('OK')"`
  </verify>
  <done>
    - /auth/me returns display_name field (may be null for existing users)
    - /auth/usage endpoint exists with proper authentication
    - /auth/usage returns total_cost, total_requests, total_input_tokens, total_output_tokens, month_start, budget
    - Both endpoints use consistent auth pattern (Depends(get_current_user))
  </done>
</task>

<task type="auto">
  <name>Task 3: Database migration and verification</name>
  <files>
    backend/app/database.py
  </files>
  <action>
1. **SQLite schema update:**
   - The project uses SQLAlchemy with `create_all()` for schema creation
   - For SQLite with new nullable column, need to handle migration

2. **Check current migration approach:**
   - Read `backend/app/database.py` to understand schema creation
   - If using `metadata.create_all()`, SQLite won't auto-add new columns to existing tables

3. **Add migration logic if needed:**
   - If database exists without display_name, use ALTER TABLE
   - Add to database initialization or create simple migration script

   **Pattern for SQLite migration:**
   ```python
   # After table creation, check and add column if missing
   async def migrate_add_display_name(engine):
       async with engine.begin() as conn:
           # Check if column exists
           result = await conn.execute(text("PRAGMA table_info(users)"))
           columns = [row[1] for row in result]

           if 'display_name' not in columns:
               await conn.execute(text(
                   "ALTER TABLE users ADD COLUMN display_name VARCHAR(255)"
               ))
   ```

4. **Verify with backend startup:**
   - Start backend: `cd backend && python run.py`
   - Check no errors related to display_name column
   - Test /auth/me and /auth/usage endpoints with curl

**Note:** SQLAlchemy's create_all() is idempotent for new tables but doesn't modify existing tables. For production, would use Alembic migrations, but for MVP SQLite, ALTER TABLE is acceptable.
  </action>
  <verify>
    - Backend starts without errors: `cd backend && timeout 5 python run.py || echo "Started OK"`
    - Schema includes display_name: `sqlite3 backend/ba_assistant.db "PRAGMA table_info(users);" | grep display_name` (if db exists)
    - API responds: `curl -s http://localhost:8000/docs | head -20` (after manual start)
  </verify>
  <done>
    - Backend starts successfully with new model
    - display_name column exists in users table (or will be created)
    - No schema-related errors on startup
    - API documentation shows updated /auth/me and new /auth/usage endpoints
  </done>
</task>

</tasks>

<verification>
Backend phase verification:
1. Model check: `grep -c "display_name" backend/app/models.py` returns 1+
2. Service check: `grep -c "display_name" backend/app/services/auth_service.py` returns 3+ (extract, pass, store)
3. Route check: `grep -c "usage" backend/app/routes/auth.py` returns 3+ (endpoint, import, call)
4. Syntax check: `cd backend && python -c "from app.models import User; from app.routes.auth import router; print('All imports OK')"`
</verification>

<success_criteria>
- User model includes display_name field (Optional[str], nullable)
- OAuth services extract and store display_name from both Google and Microsoft
- /auth/me endpoint returns display_name in response body
- /auth/usage endpoint returns monthly token usage with budget
- Backend starts without errors
- All changes follow existing code patterns and conventions
</success_criteria>

<output>
After completion, create `.planning/phases/08-settings-page-user-preferences/08-01-SUMMARY.md`
</output>

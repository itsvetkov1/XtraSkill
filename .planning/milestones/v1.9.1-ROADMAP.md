# Milestone v1.9.1: Unit Test Coverage

**Status:** ✅ SHIPPED 2026-02-02
**Phases:** 28-33
**Total Plans:** 24

## Overview

This milestone establishes comprehensive unit test coverage across backend services, LLM adapters, API routes, frontend providers, widgets, and models. Infrastructure comes first (fixtures, mocking utilities, coverage tooling), then systematic test expansion follows a backend-then-frontend progression, concluding with CI integration for coverage enforcement and visibility.

## Phases

### Phase 28: Test Infrastructure

**Goal:** Development environment has all testing utilities needed for subsequent phases
**Depends on:** None (foundation phase)
**Plans:** 3 plans

Plans:
- [x] 28-01-PLAN.md — Backend pytest-cov and dependencies
- [x] 28-02-PLAN.md — Flutter lcov coverage setup
- [x] 28-03-PLAN.md — Fixtures module, MockLLMAdapter, Factory-boy

**Requirements:**
- INFRA-01: pytest-cov installed and configured for coverage reporting
- INFRA-02: Shared fixtures module created (`tests/fixtures/`)
- INFRA-03: MockLLMAdapter implemented for adapter-layer testing
- INFRA-04: Factory-boy test data factories for User, Project, Document, Thread, Message
- INFRA-05: Flutter lcov configured for HTML coverage reports

---

### Phase 29: Backend Service Tests

**Goal:** All backend service modules have isolated unit test coverage
**Depends on:** Phase 28
**Plans:** 4 plans

Plans:
- [x] 29-01-PLAN.md — Pure function tests (conversation_service, token_tracking)
- [x] 29-02-PLAN.md — Database service tests (conversation, token, document_search, encryption)
- [x] 29-03-PLAN.md — Auth service tests (OAuth2Service with mocked clients)
- [x] 29-04-PLAN.md — AI service tests (AIService with MockLLMAdapter)

**Requirements:**
- BSVC-01: auth_service has unit test coverage
- BSVC-02: project_service has unit test coverage
- BSVC-03: document_service has unit test coverage
- BSVC-04: thread_service has unit test coverage
- BSVC-05: message_service has unit test coverage
- BSVC-06: ai_service has unit test coverage

---

### Phase 30: Backend LLM & API Tests

**Goal:** LLM adapters have compliance tests and all API routes have contract tests
**Depends on:** Phase 28, Phase 29
**Plans:** 5 plans

Plans:
- [x] 30-01-PLAN.md — LLM adapter tests (Anthropic, Gemini, DeepSeek)
- [x] 30-02-PLAN.md — SSE helper and FTS5 search tests
- [x] 30-03-PLAN.md — Auth and Projects API contract tests
- [x] 30-04-PLAN.md — Documents and Threads API contract tests
- [x] 30-05-PLAN.md — Conversations, Artifacts, and error consistency tests

**Requirements:**
- BLLM-01: AnthropicAdapter has unit test coverage
- BLLM-02: GeminiAdapter has unit test coverage
- BLLM-03: DeepSeekAdapter has unit test coverage
- BLLM-04: SSE streaming test helper implemented
- BLLM-05: Document search (FTS5) has unit test coverage
- BAPI-01: Auth router has contract tests
- BAPI-02: Projects router has contract tests
- BAPI-03: Documents router has contract tests
- BAPI-04: Threads router has contract tests
- BAPI-05: Messages router has contract tests
- BAPI-06: Chat router has contract tests
- BAPI-07: Error response consistency verified

---

### Phase 31: Frontend Provider & Service Tests

**Goal:** All frontend providers and services have isolated unit test coverage
**Depends on:** Phase 28
**Plans:** 6 plans

Plans:
- [x] 31-01-PLAN.md — AuthProvider and ProjectProvider tests
- [x] 31-02-PLAN.md — DocumentProvider and ThreadProvider tests
- [x] 31-03-PLAN.md — ConversationProvider tests and ChatsProvider expansion
- [x] 31-04-PLAN.md — ThemeProvider, NavigationProvider, ProviderProvider, DocumentColumnProvider tests
- [x] 31-05-PLAN.md — AuthService and ProjectService tests
- [x] 31-06-PLAN.md — DocumentService, ThreadService, and AIService tests

**Requirements:**
- FPROV-01: AuthProvider has unit test coverage
- FPROV-02: ProjectsProvider has unit test coverage
- FPROV-03: DocumentsProvider has unit test coverage
- FPROV-04: ThreadsProvider has unit test coverage
- FPROV-05: MessagesProvider has unit test coverage
- FPROV-06: ChatsProvider has complete unit test coverage
- FPROV-07: ThemeProvider has unit test coverage
- FPROV-08: SettingsProvider has unit test coverage
- FSVC-01: ApiService has unit test coverage
- FSVC-02: AuthService has unit test coverage

---

### Phase 32: Frontend Widget & Model Tests

**Goal:** Key widgets have component tests and models have serialization coverage
**Depends on:** Phase 31
**Plans:** 5 plans

Plans:
- [x] 32-01-PLAN.md — Model tests (Message, Project, Document)
- [x] 32-02-PLAN.md — Model tests (Thread, PaginatedThreads, TokenUsage)
- [x] 32-03-PLAN.md — MessageBubble widget tests, fix project_list_screen tests
- [x] 32-04-PLAN.md — HomeScreen and SettingsScreen widget tests
- [x] 32-05-PLAN.md — Gap closure: fix DocumentListScreen and LoginScreen tests

**Requirements:**
- FWID-01: ChatInput widget has unit test coverage
- FWID-02: MessageBubble widget has unit test coverage
- FWID-03: ThreadList widget has unit test coverage
- FWID-04: DocumentList widget has unit test coverage
- FWID-05: All screens have test coverage
- FMOD-01: Model JSON serialization round-trip tests

---

### Phase 33: CI Integration

**Goal:** Coverage is tracked, enforced, and visible in CI pipeline
**Depends on:** Phases 29-32
**Plans:** 1 plan

Plans:
- [x] 33-01-PLAN.md — CI workflow with Codecov integration, thresholds, and README badge

**Requirements:**
- CI-01: Coverage reporting enabled in CI pipeline
- CI-02: All tests pass gate enforced
- CI-03: Coverage threshold enforcement (fail-under)
- CI-04: Coverage badges added to README

---

## Milestone Summary

**Key Decisions:**

- pytest_plugins for fixture discovery (proper pytest registration)
- MockLLMAdapter with call_history for input/output assertions
- Factory-boy with @register decorator for auto pytest fixtures
- Class-based test organization (TestXxx classes)
- Skip heartbeat timing tests (1s asyncio.sleep untestable)
- AIService.__new__ for mock injection pattern
- Separate authenticated_client fixture for API tests
- Return 404 for non-owned resources (security)
- SSE header verification instead of stream iteration (httpx lifecycle)
- Conditional export pattern for dart:html dependency
- informational: true for Codecov thresholds (warn-only)

**Issues Resolved:**

- Pre-existing test failure in test_cascade_delete_project (not related to v1.9.1)
- dart:html compilation failure in flutter test (conditional import pattern)
- DocumentListScreen assertion mismatches (updated to match current UI)

**Issues Deferred:**

- 100% coverage target (diminishing returns)
- E2E/integration test expansion
- Mutation testing

**Technical Debt Incurred:**

- Some timing-dependent code paths untested (heartbeat producer)
- SSE stream iteration tests skipped (httpx async generator lifecycle)

---

*For current project status, see .planning/PROJECT.md*

---

*Archived: 2026-02-02*
*Milestone duration: 1 day*
*Total tests: 1,098 (471 backend + 627 frontend)*

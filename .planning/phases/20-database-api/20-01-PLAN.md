---
phase: 20-database-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/models.py
  - backend/app/routes/threads.py
  - backend/app/routes/conversations.py
  - backend/alembic/versions/[new_migration].py
autonomous: true

must_haves:
  truths:
    - "Creating thread with provider parameter stores provider in database"
    - "Fetching thread returns its stored provider"
    - "Chat endpoint uses thread's provider to select adapter"
    - "Existing threads default to 'anthropic' after migration"
  artifacts:
    - path: "backend/app/models.py"
      provides: "Thread.model_provider column"
      contains: "model_provider"
    - path: "backend/app/routes/threads.py"
      provides: "Thread API with provider support"
      contains: "model_provider"
    - path: "backend/app/routes/conversations.py"
      provides: "Provider-aware chat endpoint"
      contains: "AIService(provider="
    - path: "backend/alembic/versions/"
      provides: "Migration adding model_provider column"
      contains: "model_provider"
  key_links:
    - from: "threads.py ThreadCreate"
      to: "Thread model"
      via: "Thread(model_provider=) in create_thread"
      pattern: "Thread\\(.*model_provider="
    - from: "conversations.py stream_chat"
      to: "AIService"
      via: "AIService(provider=thread.model_provider)"
      pattern: "AIService\\(provider=.*model_provider"
---

<objective>
Add `model_provider` column to Thread model and wire provider selection through the API.

Purpose: Enable threads to store which LLM provider they use, allowing conversation binding to specific providers for consistent multi-provider support.

Output: Database migration, updated Thread model, API endpoints accepting/returning provider, chat endpoint selecting correct adapter based on thread's stored provider.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-database-api/20-RESEARCH.md
@.planning/phases/20-database-api/20-CONTEXT.md
@.planning/phases/19-backend-abstraction/19-02-SUMMARY.md

@backend/app/models.py
@backend/app/routes/threads.py
@backend/app/routes/conversations.py
@backend/alembic/env.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add model_provider column to Thread model and create migration</name>
  <files>
    backend/app/models.py
    backend/alembic/versions/[timestamp]_add_model_provider_to_threads.py
  </files>
  <action>
1. **Update Thread model in models.py:**
   Add `model_provider` column to Thread class after `title`:
   ```python
   # LLM provider binding (anthropic, google, deepseek)
   model_provider: Mapped[Optional[str]] = mapped_column(
       String(20),
       nullable=True,
       default="anthropic"
   )
   ```
   Use `Optional[str]` and `nullable=True` for backward compatibility with existing threads.
   Default value `"anthropic"` ensures new threads without explicit provider use Claude.

2. **Generate Alembic migration:**
   Run from backend directory:
   ```bash
   cd backend && alembic revision --autogenerate -m "add model_provider to threads"
   ```

3. **Verify generated migration uses batch_alter_table:**
   The migration should use `batch_alter_table` for SQLite compatibility.
   If not auto-generated correctly, manually write:
   ```python
   def upgrade() -> None:
       with op.batch_alter_table('threads', schema=None) as batch_op:
           batch_op.add_column(
               sa.Column('model_provider', sa.String(20), nullable=True, server_default='anthropic')
           )

   def downgrade() -> None:
       with op.batch_alter_table('threads', schema=None) as batch_op:
           batch_op.drop_column('model_provider')
   ```

4. **Run migration:**
   ```bash
   cd backend && alembic upgrade head
   ```
  </action>
  <verify>
- `grep -n "model_provider" backend/app/models.py` shows column definition in Thread class
- Migration file exists in `backend/alembic/versions/` with "model_provider" in name
- `cd backend && alembic current` shows latest revision
- `sqlite3 backend/ba_assistant.db ".schema threads"` shows model_provider column
  </verify>
  <done>Thread model has model_provider column, migration applied, existing database updated with column defaulting to 'anthropic'</done>
</task>

<task type="auto">
  <name>Task 2: Update Thread API endpoints for provider support</name>
  <files>backend/app/routes/threads.py</files>
  <action>
1. **Update ThreadCreate schema:**
   Add optional `model_provider` field:
   ```python
   class ThreadCreate(BaseModel):
       """Request model for creating a thread."""
       title: Optional[str] = Field(None, max_length=255)
       model_provider: Optional[str] = Field(None, max_length=20)
   ```

2. **Update ThreadResponse schema:**
   Add `model_provider` field for all responses:
   ```python
   class ThreadResponse(BaseModel):
       """Response model for a thread."""
       id: str
       project_id: str
       title: Optional[str]
       model_provider: Optional[str] = "anthropic"  # Default for backward compat
       created_at: str
       updated_at: str
   ```
   Also add to ThreadListResponse and ThreadDetailResponse (they inherit from ThreadResponse, so automatic).

3. **Add provider validation constant:**
   At top of file (below imports):
   ```python
   VALID_PROVIDERS = ["anthropic", "google", "deepseek"]
   ```

4. **Update create_thread endpoint:**
   After title validation, add provider validation:
   ```python
   # Validate provider if provided
   if thread_data.model_provider and thread_data.model_provider not in VALID_PROVIDERS:
       raise HTTPException(
           status_code=status.HTTP_400_BAD_REQUEST,
           detail=f"Invalid provider. Valid options: {', '.join(VALID_PROVIDERS)}"
       )
   ```
   Update Thread creation to include provider:
   ```python
   thread = Thread(
       project_id=project_id,
       title=thread_data.title,
       model_provider=thread_data.model_provider or "anthropic"
   )
   ```

5. **Update all response constructions:**
   In create_thread, list_threads, get_thread, rename_thread - add `model_provider=thread.model_provider or "anthropic"` to all ThreadResponse, ThreadListResponse, ThreadDetailResponse constructions.
  </action>
  <verify>
- `grep -n "model_provider" backend/app/routes/threads.py` shows field in schemas and endpoint logic
- `grep -n "VALID_PROVIDERS" backend/app/routes/threads.py` shows validation constant
- Start backend: `cd backend && python run.py`
- Test create thread with provider: `curl -X POST http://localhost:8000/api/projects/{project_id}/threads -H "Authorization: Bearer {token}" -H "Content-Type: application/json" -d '{"model_provider": "google"}'`
- Verify response includes `"model_provider": "google"`
  </verify>
  <done>Thread API accepts provider on creation, returns provider in all responses, validates provider against allowed list</done>
</task>

<task type="auto">
  <name>Task 3: Wire chat endpoint to use thread's provider</name>
  <files>backend/app/routes/conversations.py</files>
  <action>
1. **Update validate_thread_access to return thread with provider:**
   The function already returns Thread with project loaded. No change needed - model_provider is on Thread model.

2. **Update stream_chat to pass provider to AIService:**
   Change:
   ```python
   ai_service = AIService()
   ```
   To:
   ```python
   # Select adapter based on thread's provider binding
   provider = thread.model_provider or "anthropic"
   ai_service = AIService(provider=provider)
   ```

3. **Add comment explaining provider binding:**
   Above the provider selection:
   ```python
   # Use thread's bound provider (set at creation time)
   # This ensures consistency - conversations stay with their original provider
   ```
  </action>
  <verify>
- `grep -n "AIService(provider=" backend/app/routes/conversations.py` shows provider parameter passed
- `grep -n "thread.model_provider" backend/app/routes/conversations.py` shows thread's provider used
- Backend still starts without errors: `cd backend && python -c "from app.routes.conversations import router; print('OK')"`
  </verify>
  <done>Chat endpoint selects correct adapter based on thread's stored provider, defaulting to anthropic for threads without explicit provider</done>
</task>

</tasks>

<verification>
1. **Model verification:**
   - Thread model has model_provider column
   - Migration exists and has been applied
   - Database schema includes column

2. **API verification:**
   - POST /projects/{id}/threads accepts model_provider parameter
   - GET /projects/{id}/threads returns model_provider in list
   - GET /threads/{id} returns model_provider in detail
   - Invalid provider returns 400 error

3. **Chat verification:**
   - AIService instantiated with thread's provider
   - Default to anthropic when provider is null
</verification>

<success_criteria>
- [ ] Thread.model_provider column exists in model and database
- [ ] Alembic migration applied successfully
- [ ] ThreadCreate accepts optional model_provider
- [ ] ThreadResponse includes model_provider in all response types
- [ ] Invalid provider returns 400 Bad Request
- [ ] Chat endpoint passes thread.model_provider to AIService
- [ ] Existing threads work (default to anthropic)
</success_criteria>

<output>
After completion, create `.planning/phases/20-database-api/20-01-SUMMARY.md`
</output>

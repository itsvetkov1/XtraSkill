---
phase: 02-project-document-management
plan: 04
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - backend/app/routes/threads.py
  - backend/main.py
  - frontend/lib/services/thread_service.dart
  - frontend/lib/providers/thread_provider.dart
  - frontend/lib/screens/threads/thread_list_screen.dart
  - frontend/lib/screens/threads/thread_create_dialog.dart
  - frontend/lib/screens/projects/project_detail_screen.dart
  - frontend/lib/main.dart
autonomous: true

must_haves:
  truths:
    - "User can create multiple conversation threads within a project"
    - "User can view list of threads in a project"
    - "User can open a thread to view conversation history (empty in MVP)"
    - "Threads display in chronological order with most recent first"
    - "Thread titles are optional (AI summaries in Phase 3)"
  artifacts:
    - path: "backend/app/routes/threads.py"
      provides: "Thread create, list, get endpoints"
      exports: ["router"]
      min_lines: 60
    - path: "frontend/lib/services/thread_service.dart"
      provides: "Thread API client"
      exports: ["ThreadService"]
    - path: "frontend/lib/providers/thread_provider.dart"
      provides: "Thread state management"
      exports: ["ThreadProvider"]
    - path: "frontend/lib/screens/threads/thread_list_screen.dart"
      provides: "Thread list UI"
      exports: ["ThreadListScreen"]
    - path: "frontend/lib/screens/threads/thread_create_dialog.dart"
      provides: "Create thread dialog"
      exports: ["ThreadCreateDialog"]
  key_links:
    - from: "backend/app/routes/threads.py"
      to: "backend/app/models.py:Thread"
      via: "creates Thread with project_id"
      pattern: "Thread\\("
    - from: "frontend/lib/providers/thread_provider.dart"
      to: "frontend/lib/services/thread_service.dart"
      via: "calls ThreadService methods"
      pattern: "ThreadService|_threadService"
    - from: "frontend/lib/screens/threads/thread_list_screen.dart"
      to: "frontend/lib/providers/thread_provider.dart"
      via: "Consumer<ThreadProvider>"
      pattern: "Consumer<ThreadProvider>"
---

<objective>
Implement conversation thread management for organizing AI discovery sessions.

Purpose: Enable users to create multiple conversation threads within projects. Threads serve as containers for AI conversations (Phase 3). In MVP, threads have optional titles and empty message lists - AI will generate summaries and populate messages in Phase 3. Covers requirements CONV-01, CONV-02, CONV-03, CONV-05.

Output: Complete thread management with backend API, frontend state management, and UI for creating and viewing threads within projects.
</objective>

<execution_context>
@G:\.claude\get-shit-done\workflows\execute-plan.md
@G:\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@G:\git_repos\BA_assistant\.planning\REQUIREMENTS.md
@G:\git_repos\BA_assistant\.planning\phases\02-project-document-management\02-RESEARCH.md

# Previous plans
@G:\git_repos\BA_assistant\.planning\phases\02-project-document-management\02-01-PLAN.md
@G:\git_repos\BA_assistant\.planning\phases\02-project-document-management\02-02-PLAN.md

# Phase 1 patterns
@G:\git_repos\BA_assistant\backend\app\routes\auth.py
@G:\git_repos\BA_assistant\frontend\lib\providers\auth_provider.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Thread API Endpoints</name>
  <files>
backend/app/routes/threads.py
backend/main.py
  </files>
  <action>
Create backend/app/routes/threads.py with FastAPI router:

**POST /projects/{project_id}/threads** - Create thread:
- Accepts: {"title": str | null}
- Validates:
  - Project exists and belongs to current_user (404 if not)
  - Title length 0-255 chars if provided (400 if invalid)
- Creates: Thread with project_id, title (or null), created_at, updated_at
- Returns: {"id": str, "project_id": str, "title": str | null, "created_at": str, "updated_at": str}
- Status: 201 Created

**GET /projects/{project_id}/threads** - List threads:
- Validates: project ownership (join with projects table to check user_id)
- Returns: [Thread...] ordered by created_at DESC (most recent first per CONV-05)
- Uses: selectinload for messages relationship to include message_count
- Returns: {"id": str, "title": str | null, "created_at": str, "updated_at": str, "message_count": int}

**GET /threads/{thread_id}** - Get thread details:
- Validates: thread belongs to user's project (join through projects)
- Uses: selectinload(Thread.messages) to load full conversation history
- Returns: {"id": str, "project_id": str, "title": str | null, "created_at": str, "updated_at": str, "messages": [Message...]}
- Message format: {"id": str, "role": str, "content": str, "created_at": str}
- Messages ordered by created_at ASC (chronological conversation flow)

**Note:** No delete or update endpoints in MVP (deferred per requirements). AI will update titles with summaries in Phase 3 via PUT endpoint added later.

All endpoints protected with Depends(get_current_user). Use async with selectinload to load relationships efficiently.

Register router in main.py:
```python
from app.routes import threads
app.include_router(threads.router, prefix="/api", tags=["threads"])
```
  </action>
  <verify>
- Test create: `curl -X POST http://localhost:8000/api/projects/<project_id>/threads -H "Authorization: Bearer <token>" -H "Content-Type: application/json" -d '{"title":"Login Flow Discussion"}'` → 201
- Test create without title: `curl -X POST http://localhost:8000/api/projects/<project_id>/threads -H "Authorization: Bearer <token>" -d '{}'` → 201, title is null
- Test list: `curl http://localhost:8000/api/projects/<project_id>/threads -H "Authorization: Bearer <token>"` → returns array ordered by created_at DESC
- Test get: `curl http://localhost:8000/api/threads/<thread_id> -H "Authorization: Bearer <token>"` → returns thread with empty messages array
- Test isolation: Try to access thread from another user's project → 404
- Test auth: `curl http://localhost:8000/api/threads/<id>` (no token) → 401
  </verify>
  <done>
Thread API endpoints working with proper authentication, validation, and relationship loading. Threads ordered chronologically (newest first in list, oldest first in messages).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Frontend Thread Service and Provider</name>
  <files>
frontend/lib/services/thread_service.dart
frontend/lib/providers/thread_provider.dart
frontend/lib/main.dart
  </files>
  <action>
**Create frontend/lib/services/thread_service.dart:**
- Use Dio for HTTP requests with Authorization header
- Methods:
  - getThreads(projectId) → GET /projects/{id}/threads
  - createThread(projectId, title) → POST /projects/{id}/threads
  - getThread(threadId) → GET /threads/{id} (includes messages)
- Parse responses using Thread.fromJson() and Message.fromJson()
- Handle errors (401 → logout, 404 → not found, 500 → server error)

**Create frontend/lib/providers/thread_provider.dart:**
- Extends ChangeNotifier
- State:
  - List<Thread> _threads (list for current project)
  - Thread? _selectedThread (with full message history)
  - bool _loading
  - String? _error
- Methods:
  - loadThreads(projectId) → fetches threads for project, updates _threads, notifyListeners()
  - createThread(projectId, title) → calls API, adds to _threads, notifyListeners()
  - selectThread(threadId) → loads thread with messages, sets _selectedThread, notifyListeners()
  - clearThreads() → resets state when switching projects
- Use try/catch with _loading and _error state tracking

**Update frontend/lib/main.dart:**
Add ThreadProvider to MultiProvider:
```dart
MultiProvider(
  providers: [
    ChangeNotifierProvider(create: (_) => AuthProvider()),
    ChangeNotifierProvider(create: (_) => ProjectProvider()),
    ChangeNotifierProvider(create: (_) => DocumentProvider()),
    ChangeNotifierProvider(create: (_) => ThreadProvider()), // NEW
  ],
  child: MyApp(),
)
```

Follow established Provider pattern from ProjectProvider and DocumentProvider.
  </action>
  <verify>
- Run `cd frontend && flutter analyze lib/services/thread_service.dart lib/providers/thread_provider.dart` → no errors
- Check ThreadService uses Dio with Authorization header
- Check ThreadProvider extends ChangeNotifier
- Check main.dart includes ThreadProvider in MultiProvider
- Verify createThread handles nullable title (sends null if not provided)
- Verify selectThread loads messages array from API
  </verify>
  <done>
Thread service and provider created following established patterns. State management integrated, ready for UI consumption.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Thread UI with List and Create Dialog</name>
  <files>
frontend/lib/screens/threads/thread_list_screen.dart
frontend/lib/screens/threads/thread_create_dialog.dart
frontend/lib/screens/projects/project_detail_screen.dart
  </files>
  <action>
**Create frontend/lib/screens/threads/thread_create_dialog.dart:**
- AlertDialog with title "New Conversation"
- TextField for thread title (optional, hint: "e.g., Login Flow Discussion")
- Cancel and Create buttons
- Create button calls: provider.createThread(projectId, titleController.text.isEmpty ? null : titleController.text)
- Dismisses dialog on success, shows SnackBar on error

**Create frontend/lib/screens/threads/thread_list_screen.dart:**
- Takes projectId as constructor parameter
- Uses Consumer<ThreadProvider> for reactive updates
- Calls provider.loadThreads(projectId) in initState
- Shows CircularProgressIndicator while loading
- Shows error message if _error is not null
- ListView of thread cards:
  - Title: thread.title ?? "New Conversation" (placeholder when null)
  - Subtitle: "Created ${formatDate(thread.createdAt)}, ${thread.messageCount} messages"
  - Leading: Icon (Icons.chat_bubble_outline)
  - Trailing: Icon (Icons.chevron_right)
- Empty state: "No conversations yet" with description "Start a conversation to discuss requirements" and Create button
- FloatingActionButton: "New Conversation" → opens ThreadCreateDialog
- OnTap thread: Navigate to thread detail screen (Phase 3) or show placeholder "Thread view coming in Phase 3"

**Update frontend/lib/screens/projects/project_detail_screen.dart:**
- In "Threads" tab: show ThreadListScreen(projectId: widget.projectId)
- When tab switches to Threads: call provider.loadThreads(projectId) to refresh

Use Material 3 ListTile with subtitle and proper spacing. Follow responsive layout patterns from Phase 1.
  </action>
  <verify>
- Run `cd frontend && flutter run -d chrome` → app launches
- Navigate to project detail → "Threads" tab visible
- Test empty state: No threads shows "No conversations yet" with create button
- Test create thread: Tap FAB, enter title "Test Discussion", submit → new thread appears in list
- Test create without title: Tap FAB, leave title empty, submit → thread created with "New Conversation" placeholder
- Test list ordering: Create multiple threads → newest appears first
- Test thread tap: Click thread → shows "Thread view coming in Phase 3" placeholder (actual conversation view is Phase 3)
- Test message count: New threads show "0 messages"
  </verify>
  <done>
Thread UI complete with create dialog, list view, and navigation integrated into project detail screen. All CONV requirements (01, 02, 03, 05) satisfied. Thread messaging (CONV-04) and AI summaries (CONV-06) deferred to Phase 3.
  </done>
</task>

</tasks>

<verification>
1. Backend API returns threads ordered by created_at DESC
2. Frontend state management updates UI on thread creation
3. Thread creation works with and without title (nullable title field)
4. Thread list displays threads with placeholders for null titles
5. Empty state appears when project has no threads
6. Thread isolation verified (threads only appear in correct project)
</verification>

<success_criteria>
- [ ] Backend: POST /projects/{id}/threads creates thread with optional title
- [ ] Backend: GET /projects/{id}/threads returns threads ordered by created_at DESC
- [ ] Backend: GET /threads/{id} returns thread with messages array (empty in MVP)
- [ ] Backend: Thread endpoints validate project ownership via user_id
- [ ] Frontend: ThreadProvider manages state and calls ThreadService
- [ ] Frontend: Thread list shows threads with title or "New Conversation" placeholder
- [ ] Frontend: Create thread dialog accepts optional title
- [ ] Frontend: Empty state displays when project has no threads
- [ ] Frontend: Threads display newest first (CONV-05)
- [ ] Frontend: Thread tap shows placeholder (actual conversation in Phase 3)
- [ ] Requirements: CONV-01, CONV-02, CONV-03, CONV-05 all satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-project-document-management/02-04-SUMMARY.md`
</output>

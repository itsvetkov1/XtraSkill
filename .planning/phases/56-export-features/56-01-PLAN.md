---
phase: 56-export-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/routes/documents.py
autonomous: true

must_haves:
  truths:
    - "GET /documents/{id}/export/xlsx returns a valid .xlsx file with Content-Disposition header"
    - "GET /documents/{id}/export/csv returns a valid .csv file with UTF-8 BOM and Content-Disposition header"
    - "Export endpoints reject non-tabular documents (PDF, Word, text) with 400 error"
    - "Export endpoints verify document ownership before generating file"
  artifacts:
    - path: "backend/app/routes/documents.py"
      provides: "Two export endpoints: export_document_xlsx and export_document_csv"
      contains: "export/xlsx"
  key_links:
    - from: "backend/app/routes/documents.py export_document_xlsx"
      to: "openpyxl.Workbook(write_only=True)"
      via: "In-memory BytesIO Excel generation"
      pattern: "write_only=True"
    - from: "backend/app/routes/documents.py export_document_csv"
      to: "csv.writer"
      via: "In-memory StringIO CSV generation with UTF-8-BOM encoding"
      pattern: "utf-8-sig"
---

<objective>
Add Excel (.xlsx) and CSV export endpoints to the backend document routes.

Purpose: Users who uploaded Excel/CSV files need to export the parsed data back to downloadable formats. This enables round-trip data flow: upload → view in PlutoGrid → export for external use.

Output: Two new GET endpoints in documents.py that generate Excel and CSV files from stored content_text and return them as file downloads.
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-export-features/56-RESEARCH.md
@.planning/phases/54-backend-foundation-document-parsing-security/54-03-SUMMARY.md
@backend/app/routes/documents.py
@backend/app/services/document_parser/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Excel and CSV export endpoints to document routes</name>
  <files>backend/app/routes/documents.py</files>
  <action>
Add two new export endpoints to the existing document routes file, positioned after the existing download_document endpoint and before the search endpoint.

**Import additions at top of file:**
- `import csv` (Python stdlib)
- `from io import BytesIO, StringIO`
- `import openpyxl` (already installed)

**Tabular format constant** (near top, after ALLOWED_CONTENT_TYPES):
```python
TABULAR_CONTENT_TYPES = [
    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    "text/csv",
]
```

**Endpoint 1: GET /documents/{document_id}/export/xlsx**
- Route: `@router.get("/documents/{document_id}/export/xlsx")`
- Auth: `current_user: dict = Depends(get_current_user)`
- DB: `db: AsyncSession = Depends(get_db)`
- Ownership check: Same pattern as get_document — `select(Document).join(Project).where(Document.id == document_id, Project.user_id == current_user["user_id"])`
- 404 if not found
- **Tabular format check:** If `doc.content_type not in TABULAR_CONTENT_TYPES`, return HTTPException 400 with detail "Export to Excel is only available for spreadsheet documents"
- Parse metadata for sheet name: `json.loads(doc.metadata_json)` → `metadata.get('sheet_names', ['Sheet1'])[0]`
- Generate Excel in memory:
  - `output = BytesIO()`
  - `wb = openpyxl.Workbook(write_only=True)` — CRITICAL: write_only mode for memory efficiency
  - `ws = wb.create_sheet(title=sheet_name)`
  - Parse `doc.content_text` line by line (split `\n`), skip empty lines
  - For each line: split by `\t` and `ws.append(cells)`
  - `wb.save(output)` then `output.seek(0)`
- Generate filename: strip extension from `doc.filename`, append `_export.xlsx`
- Return `Response(content=output.getvalue(), media_type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", headers={"Content-Disposition": f'attachment; filename="{export_filename}"'})`

**Endpoint 2: GET /documents/{document_id}/export/csv**
- Route: `@router.get("/documents/{document_id}/export/csv")`
- Same auth + ownership pattern as xlsx endpoint
- Same tabular format check: HTTPException 400 with "Export to CSV is only available for spreadsheet documents"
- Generate CSV in memory:
  - `output = StringIO()`
  - `writer = csv.writer(output, quoting=csv.QUOTE_MINIMAL)`
  - Parse `doc.content_text` line by line (split `\n`), skip empty lines
  - For each line: split by `\t` and `writer.writerow(cells)`
  - `csv_bytes = output.getvalue().encode('utf-8-sig')` — CRITICAL: UTF-8 BOM for Excel compatibility
- Generate filename: strip extension from `doc.filename`, append `_export.csv`
- Return `Response(content=csv_bytes, media_type="text/csv; charset=utf-8", headers={"Content-Disposition": f'attachment; filename="{export_filename}"'})`

**Helper function** (to reduce duplication between the two endpoints):
Create a private function `_get_tabular_document(document_id, current_user, db)` that:
1. Queries document with ownership check
2. Raises 404 if not found
3. Raises 400 if not tabular format
4. Returns the document object

Both export endpoints call this helper, then generate their respective format.

**Important notes:**
- Do NOT modify any existing endpoints
- Place new endpoints between download_document and search_project_documents
- Use `doc.content_text` for data (not content_encrypted) — this is the extracted tab-separated text from Phase 54 parsing
- Handle edge case: if `doc.content_text` is None or empty, return HTTPException 400 with "No data available for export"
  </action>
  <verify>
Run the following verification:
1. `cd /Users/a1testingmac/projects/XtraSkill/backend && python -c "from app.routes.documents import router; print('Import OK')"` — confirms no import errors
2. Grep for both endpoint routes: `grep -n "export/xlsx\|export/csv" backend/app/routes/documents.py`
3. Grep for write_only mode: `grep "write_only=True" backend/app/routes/documents.py`
4. Grep for utf-8-sig: `grep "utf-8-sig" backend/app/routes/documents.py`
5. Verify tabular format check exists: `grep "TABULAR_CONTENT_TYPES" backend/app/routes/documents.py`
  </verify>
  <done>
Both export endpoints exist and are importable. Excel endpoint uses openpyxl write_only mode. CSV endpoint uses utf-8-sig encoding. Both validate tabular format before export. Both include ownership verification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify export endpoints with curl test</name>
  <files>backend/app/routes/documents.py</files>
  <action>
Verify the export endpoints work correctly by checking:

1. **Syntax check:** Run `cd /Users/a1testingmac/projects/XtraSkill/backend && python -c "from app.routes import documents; print('Routes module loaded successfully')"` to confirm no Python syntax errors.

2. **Structure verification:** Check that:
   - Both endpoints are decorated with `@router.get`
   - Both use `Depends(get_current_user)` for auth
   - Both use `Depends(get_db)` for database
   - Excel endpoint returns proper MIME type (`application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`)
   - CSV endpoint returns proper MIME type (`text/csv; charset=utf-8`)
   - Both have Content-Disposition headers with attachment filenames

3. **Memory safety:** Confirm `write_only=True` is used in openpyxl Workbook constructor (not standard mode).

4. **UTF-8 BOM:** Confirm `encode('utf-8-sig')` is used for CSV (not plain `encode('utf-8')`).

5. **Edge cases:** Confirm empty content_text handling (400 error).

6. **Existing endpoints unchanged:** Verify upload, list, get, download, search, and delete endpoints still exist and are unmodified by comparing function signatures.
  </action>
  <verify>
All verification checks pass:
1. Module imports without errors
2. Both export endpoints have proper auth, DB, MIME types, and Content-Disposition
3. write_only=True used for Excel
4. utf-8-sig used for CSV
5. Empty content_text handled
6. All 6 existing endpoints unchanged
  </verify>
  <done>
Backend export endpoints verified — correct auth, format validation, memory-safe Excel generation, BOM-encoded CSV, and proper error handling. No regression in existing endpoints.
  </done>
</task>

</tasks>

<verification>
1. Both export endpoints exist in documents.py
2. Excel export uses openpyxl write_only=True mode
3. CSV export uses utf-8-sig encoding
4. Both endpoints verify document ownership
5. Both endpoints reject non-tabular documents with 400
6. Both endpoints handle empty content_text
7. Content-Disposition headers set with proper filenames
8. No existing endpoints modified
</verification>

<success_criteria>
- Two new GET endpoints: /documents/{id}/export/xlsx and /documents/{id}/export/csv
- Endpoints generate files from content_text (tab-separated format)
- Proper MIME types and Content-Disposition headers for browser download
- Tabular format validation (only Excel/CSV documents can be exported)
- Memory-efficient Excel generation (write_only mode)
- Excel-compatible CSV encoding (UTF-8 BOM)
</success_criteria>

<output>
After completion, create `.planning/phases/56-export-features/56-01-SUMMARY.md`
</output>

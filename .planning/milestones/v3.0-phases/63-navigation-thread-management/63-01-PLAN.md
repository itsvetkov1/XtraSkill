---
phase: 63-navigation-thread-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/main.dart
  - frontend/lib/widgets/responsive_scaffold.dart
  - frontend/lib/widgets/breadcrumb_bar.dart
  - frontend/lib/widgets/contextual_back_button.dart
  - frontend/lib/screens/assistant/assistant_list_screen.dart
  - frontend/lib/services/thread_service.dart
autonomous: true
requirements: [NAV-01, NAV-02, NAV-03, UI-01]

must_haves:
  truths:
    - "Sidebar shows an 'Assistant' entry above the Chats/BA Assistant entries"
    - "Clicking Assistant in sidebar navigates to /assistant and shows thread list screen"
    - "Assistant thread list shows only threads with thread_type=assistant (no BA threads)"
    - "Navigating to /assistant/:threadId in browser URL loads the conversation screen"
    - "Deep link to /assistant works on page refresh (no redirect or 404)"
    - "Breadcrumbs show 'Assistant' on /assistant and 'Assistant > Thread Title' on /assistant/:threadId"
  artifacts:
    - path: "frontend/lib/screens/assistant/assistant_list_screen.dart"
      provides: "Assistant thread list screen with API-filtered threads"
      contains: "thread_type.*assistant"
    - path: "frontend/lib/main.dart"
      provides: "StatefulShellBranch for /assistant routes"
      contains: "/assistant"
    - path: "frontend/lib/widgets/responsive_scaffold.dart"
      provides: "Assistant navigation destination in sidebar"
      contains: "Assistant"
  key_links:
    - from: "frontend/lib/main.dart"
      to: "frontend/lib/screens/assistant/assistant_list_screen.dart"
      via: "GoRoute path /assistant builder returns AssistantListScreen"
      pattern: "AssistantListScreen"
    - from: "frontend/lib/screens/assistant/assistant_list_screen.dart"
      to: "frontend/lib/services/thread_service.dart"
      via: "API call with thread_type=assistant filter"
      pattern: "thread_type=assistant"
    - from: "frontend/lib/widgets/responsive_scaffold.dart"
      to: "frontend/lib/main.dart"
      via: "NavigationRail destination index matches StatefulShellBranch index"
      pattern: "add_circle"
---

<objective>
Add the Assistant navigation section to the sidebar and route infrastructure, plus create the Assistant thread list screen that displays only Assistant-type threads filtered via the backend API.

Purpose: Users need a dedicated entry point for the Assistant section, separate from BA Assistant. This plan establishes the navigation foundation (routes, sidebar, breadcrumbs) and the primary list screen so Assistant threads are visually and functionally isolated.

Output: Working /assistant route with sidebar entry, breadcrumbs, and a thread list screen showing only assistant-type threads.
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/63-navigation-thread-management/63-CONTEXT.md
@.planning/phases/63-navigation-thread-management/63-RESEARCH.md
@.planning/phases/62-backend-foundation/62-02-SUMMARY.md

# Key source files to read before implementing:
@frontend/lib/main.dart
@frontend/lib/widgets/responsive_scaffold.dart
@frontend/lib/widgets/breadcrumb_bar.dart
@frontend/lib/widgets/contextual_back_button.dart
@frontend/lib/screens/chats_screen.dart
@frontend/lib/services/thread_service.dart
@frontend/lib/models/thread.dart
@frontend/lib/widgets/empty_state.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Assistant routes and sidebar navigation destination</name>
  <files>
    frontend/lib/main.dart
    frontend/lib/widgets/responsive_scaffold.dart
    frontend/lib/widgets/breadcrumb_bar.dart
    frontend/lib/widgets/contextual_back_button.dart
  </files>
  <action>
**CRITICAL: Index shift — adding Assistant as branch index 1 shifts ALL existing indices.**

**main.dart changes:**

1. Add import for AssistantListScreen:
   ```dart
   import 'screens/assistant/assistant_list_screen.dart';
   ```

2. Update `_getSelectedIndex()` — Assistant becomes index 1, all others shift:
   ```dart
   int _getSelectedIndex(String path) {
     if (path.startsWith('/home')) return 0;
     if (path.startsWith('/assistant')) return 1;  // NEW
     if (path.startsWith('/chats')) return 2;       // Was 1
     if (path.startsWith('/projects')) return 3;    // Was 2
     if (path.startsWith('/settings')) return 4;    // Was 3
     return 0;
   }
   ```

3. Add new StatefulShellBranch between Home (branch 0) and Chats (branch 2). Insert as branch index 1:
   ```dart
   // Branch 1: Assistant
   StatefulShellBranch(
     routes: [
       GoRoute(
         path: '/assistant',
         builder: (context, state) => const AssistantListScreen(),
         routes: [
           GoRoute(
             path: ':threadId',
             builder: (context, state) {
               final threadId = state.pathParameters['threadId']!;
               return ConversationScreen(
                 projectId: null,
                 threadId: threadId,
               );
             },
           ),
         ],
       ),
     ],
   ),
   ```

   Place this BETWEEN the Home branch and the Chats branch in the `branches: [...]` array. Comments for existing branches need index updates: Home=0 stays, Chats becomes "Branch 2", Projects becomes "Branch 3", Settings becomes "Branch 4".

**responsive_scaffold.dart changes:**

4. Add Assistant destination to `_destinations` list. Per locked decision: Assistant appears ABOVE Chats/BA. Insert at index 1 (between Home and Chats):
   ```dart
   _NavigationDestination(
     icon: Icons.add_circle_outline,
     selectedIcon: Icons.add_circle,
     label: 'Assistant',
   ),
   ```
   The full list becomes: Home(0), Assistant(1), Chats(2), Projects(3), Settings(4).

   Per user decision: use `Icons.add_circle` for bold "level up" plus icon (XtraSkill branding). Filled for selected, outline for unselected — matches the existing `Icons.chat_bubble` / `Icons.chat_bubble_outline` pattern.

**breadcrumb_bar.dart changes:**

5. Add breadcrumb handler for `/assistant` routes in `_buildBreadcrumbs()`. Add BEFORE the `/chats` handler block (or after it, ordering doesn't matter since they check different path prefixes):
   ```dart
   // /assistant routes
   if (segments.isNotEmpty && segments[0] == 'assistant') {
     if (segments.length == 1) {
       return [const Breadcrumb('Assistant')];
     }
     if (segments.length >= 2) {
       final conversationProvider = context.read<ConversationProvider>();
       final threadTitle = conversationProvider.thread?.title ?? 'Conversation';
       return [
         const Breadcrumb('Assistant', '/assistant'),
         Breadcrumb(threadTitle),
       ];
     }
   }
   ```

**contextual_back_button.dart changes:**

6. Update `_getParentLabel()` to handle `/assistant` routes:
   - Add `/assistant` to root pages list (no back button on thread list):
     ```dart
     if (path == '/home' || path == '/projects' || path == '/settings' || path == '/chats' || path == '/assistant') {
       return null;
     }
     ```
   - Add handler for `/assistant/:threadId` → "Assistant":
     ```dart
     if (path.startsWith('/assistant/')) {
       return 'Assistant';
     }
     ```
     Place this BEFORE the generic fallback block.
  </action>
  <verify>
1. Run `cd /Users/a1testingmac/projects/XtraSkill/frontend && flutter analyze` — no analysis errors in modified files.
2. Grep to verify index shift: `grep -n 'return [0-4]' lib/main.dart` should show 0,1,2,3,4 in order.
3. Grep to verify Assistant destination: `grep -n 'Assistant' lib/widgets/responsive_scaffold.dart` shows Assistant label.
4. Grep to verify breadcrumb: `grep -n 'assistant' lib/widgets/breadcrumb_bar.dart` shows assistant path handler.
5. Grep to verify back button: `grep -n 'assistant' lib/widgets/contextual_back_button.dart` shows assistant route handler.
  </verify>
  <done>
- Assistant appears as index 1 in sidebar navigation (between Home and Chats)
- Clicking Assistant navigates to /assistant
- /assistant/:threadId route exists and renders ConversationScreen
- Breadcrumbs show "Assistant" and "Assistant > Thread Title" for assistant routes
- Back button shows "Assistant" when on /assistant/:threadId, hidden on /assistant root
- All existing navigation indices (Home, Chats, Projects, Settings) work correctly with shifted indices
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AssistantListScreen with API-filtered thread list</name>
  <files>
    frontend/lib/screens/assistant/assistant_list_screen.dart
    frontend/lib/services/thread_service.dart
  </files>
  <action>
**thread_service.dart changes:**

1. Add `getAssistantThreads()` method to ThreadService. This calls the global threads endpoint with `thread_type=assistant` filter. Follows the existing `getGlobalThreads()` pattern but adds the filter:
   ```dart
   /// Get all Assistant-type threads for current user
   ///
   /// Returns threads filtered by thread_type=assistant, sorted by last_activity_at DESC.
   /// Uses the global threads endpoint with thread_type filter.
   Future<List<Thread>> getAssistantThreads() async {
     try {
       final headers = await _getAuthHeaders();
       final response = await _dio.get(
         '/api/threads?thread_type=assistant',
         options: Options(headers: headers),
       );
       // API returns paginated response, extract threads list
       final data = response.data as Map<String, dynamic>;
       final threadsData = data['threads'] as List;
       return threadsData
           .map((json) => Thread.fromJson(json as Map<String, dynamic>))
           .toList();
     } on DioException catch (e) {
       if (e.response?.statusCode == 401 || e.response?.statusCode == 403) {
         throw Exception('Authentication required');
       }
       throw Exception('Failed to load assistant threads: ${e.message}');
     }
   }
   ```

**assistant_list_screen.dart creation:**

2. Create new file at `frontend/lib/screens/assistant/assistant_list_screen.dart`. Model after ChatsScreen but simplified:

   **Key differences from ChatsScreen:**
   - No search bar (keep it minimal for v1 — Claude's discretion)
   - No sort selector (always sorted by most recent activity, API default)
   - No pagination (load all assistant threads — volume will be low)
   - Thread items show title + timestamp only (per locked decision)
   - Each thread item has visible delete icon (per locked decision — always visible, not hover-only)
   - Uses ThreadService.getAssistantThreads() directly (not ChatsProvider)
   - Empty state uses EmptyState widget with Icons.add_circle icon and "Start your first conversation" message

   **Screen structure:**
   ```
   Scaffold(
     body: Column(
       children: [
         // Header row: "Assistant" title + "New Thread" button
         Padding(child: Row(
           Text('Assistant', style: headlineMedium),
           FilledButton.icon(icon: add, label: 'New Thread', onPressed: _showCreateDialog),
         )),
         Divider,
         // Thread list or empty state
         Expanded(child: _isLoading ? skeleton : _threads.isEmpty ? emptyState : listView),
       ]
     )
   )
   ```

   **State management:** Use local state with StatefulWidget (not a separate provider). Keep it simple:
   - `List<Thread> _threads = []`
   - `bool _isLoading = true`
   - `String? _error`
   - Load threads in `initState` via `_loadThreads()` which calls `ThreadService().getAssistantThreads()`
   - Refresh via `RefreshIndicator`

   **Thread list item (ListTile with dense: true):**
   ```dart
   ListTile(
     dense: true,
     onTap: () => context.go('/assistant/${thread.id}'),
     title: Text(thread.title ?? 'Untitled', maxLines: 1, overflow: ellipsis),
     subtitle: Text(_formatTimestamp(thread.lastActivityAt ?? thread.updatedAt)),
     trailing: IconButton(
       icon: Icon(Icons.delete_outline, size: 20),
       tooltip: 'Delete',
       onPressed: () => _deleteThread(thread),
     ),
   )
   ```
   Per locked decision: delete icon is always visible (not hover-only).

   **Timestamp formatting:** Use relative timestamps (same as ChatsScreen `_formatDate` helper):
   - "Just now" (< 1 min)
   - "Xm ago" (< 1 hr)
   - "Xh ago" (< 1 day)
   - "Xd ago" (< 7 days)
   - "M/D" (>= 7 days)

   **Empty state:**
   ```dart
   EmptyState(
     icon: Icons.add_circle_outline,
     title: 'No conversations yet',
     message: 'Start your first conversation with the Assistant.',
     buttonLabel: 'New Conversation',
     buttonIcon: Icons.add,
     onPressed: _showCreateDialog,
   )
   ```

   **Delete method placeholder:** For now, implement `_deleteThread()` as a stub that shows a TODO comment. Plan 63-02 will wire this properly with ThreadProvider undo behavior. The delete icon must be visible now (UI-05 layout), but the full delete flow (undo, navigate-away) is completed in 63-02.

   Actually — since ThreadProvider.deleteThread already works and just needs a BuildContext, wire it directly here:
   ```dart
   void _deleteThread(Thread thread) {
     final threadProvider = context.read<ThreadProvider>();
     threadProvider.deleteThread(context, thread.id);
     // Remove from local list optimistically
     setState(() {
       _threads.removeWhere((t) => t.id == thread.id);
     });
   }
   ```
   NOTE: The full undo + navigate-away behavior for deleting the currently-viewed thread will be completed in Plan 63-02. This plan provides the basic delete path.

   **_showCreateDialog placeholder:** Leave as empty method for now. Plan 63-02 creates the dialog and wires it.
   ```dart
   void _showCreateDialog() {
     // Wired in Plan 63-02
   }
   ```

   **Public method for refreshing** (used after thread creation in Plan 63-02):
   ```dart
   Future<void> refreshThreads() async {
     await _loadThreads();
   }
   ```
  </action>
  <verify>
1. Run `cd /Users/a1testingmac/projects/XtraSkill/frontend && flutter analyze` — no analysis errors.
2. Verify file created: `ls lib/screens/assistant/assistant_list_screen.dart` exists.
3. Grep for thread_type filter: `grep 'thread_type=assistant' lib/services/thread_service.dart` shows the filter.
4. Grep for empty state: `grep 'EmptyState' lib/screens/assistant/assistant_list_screen.dart` shows usage.
5. Grep for delete icon: `grep 'delete_outline' lib/screens/assistant/assistant_list_screen.dart` shows visible delete button.
  </verify>
  <done>
- AssistantListScreen exists and renders a thread list filtered by thread_type=assistant
- Thread items show title + timestamp in compact ListTile format (dense: true)
- Each thread item has a visible delete icon (always visible, not hover-only)
- Empty state shows EmptyState widget with "Start your first conversation" CTA
- ThreadService.getAssistantThreads() method fetches only assistant threads from API
- Tapping a thread navigates to /assistant/:threadId
- Screen has header with "Assistant" title and "New Thread" button (dialog wired in Plan 63-02)
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes with no errors
2. Navigate to /assistant in browser — shows Assistant list screen
3. Sidebar highlights Assistant entry when on /assistant path
4. Breadcrumbs show "Assistant" on /assistant
5. Navigate to /assistant/:threadId — ConversationScreen loads (if valid thread exists)
6. Breadcrumbs show "Assistant > Thread Title" on /assistant/:threadId
7. Back button on /assistant/:threadId shows "Assistant"
8. All existing routes still work: /home, /chats, /projects, /settings with correct sidebar highlighting
</verification>

<success_criteria>
- Assistant appears in sidebar between Home and Settings
- /assistant route loads AssistantListScreen with thread list
- Only assistant-type threads appear in the list (no BA threads)
- /assistant/:threadId route loads ConversationScreen
- Deep links work on page refresh (no 404, no redirect to home)
- All existing navigation continues to work (no index mismatch)
</success_criteria>

<output>
After completion, create `.planning/phases/63-navigation-thread-management/63-01-SUMMARY.md`
</output>

---
phase: 25-global-chats-backend
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - frontend/lib/services/api_service.dart
  - frontend/lib/models/thread.dart
  - frontend/lib/providers/chats_provider.dart
  - frontend/lib/screens/chats_screen.dart
  - frontend/lib/screens/home_screen.dart
  - frontend/lib/widgets/app_shell.dart
autonomous: true

must_haves:
  truths:
    - "Chats section appears in navigation sidebar"
    - "Chats section shows all user threads with project context"
    - "New Chat button creates project-less thread"
    - "Clicking New Chat navigates to conversation view"
  artifacts:
    - path: "frontend/lib/providers/chats_provider.dart"
      provides: "State management for global chats"
      contains: "ChatsProvider"
    - path: "frontend/lib/screens/chats_screen.dart"
      provides: "Chats list screen with New Chat button"
      contains: "ChatsScreen"
    - path: "frontend/lib/services/api_service.dart"
      provides: "API methods for global threads"
      contains: "getGlobalThreads"
  key_links:
    - from: "ChatsProvider"
      to: "ApiService"
      via: "getGlobalThreads, createGlobalThread"
      pattern: "apiService\\.getGlobalThreads"
    - from: "AppShell"
      to: "ChatsScreen"
      via: "Navigation drawer item"
      pattern: "Chats"
---

<objective>
Frontend Chats navigation section and New Chat functionality.

Purpose: Allow users to see all their threads in one place and start new conversations without selecting a project first.

Output:
- Chats section in navigation sidebar (after Home, before Projects)
- ChatsScreen showing all threads with project badges
- New Chat buttons in Chats section and Home page
- Navigation to conversation view for new chats
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-global-chats-backend/25-CONTEXT.md
@.planning/phases/25-global-chats-backend/25-01-SUMMARY.md
@frontend/lib/services/api_service.dart
@frontend/lib/models/thread.dart
@frontend/lib/widgets/app_shell.dart
@frontend/lib/screens/home_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add API service methods and update Thread model</name>
  <files>
    frontend/lib/services/api_service.dart
    frontend/lib/models/thread.dart
  </files>
  <action>
Update frontend/lib/models/thread.dart:

1. Make projectId nullable and add new fields:
   ```dart
   class Thread {
     final String id;
     final String? projectId;  // Changed from required String
     final String? projectName;  // NEW: for global listing
     final String? title;
     final String modelProvider;
     final DateTime createdAt;
     final DateTime updatedAt;
     final DateTime? lastActivityAt;  // NEW: for sorting
     final int messageCount;
     final List<Message> messages;

     Thread({
       required this.id,
       this.projectId,  // Now optional
       this.projectName,
       this.title,
       required this.modelProvider,
       required this.createdAt,
       required this.updatedAt,
       this.lastActivityAt,
       this.messageCount = 0,
       this.messages = const [],
     });

     factory Thread.fromJson(Map<String, dynamic> json) {
       return Thread(
         id: json['id'],
         projectId: json['project_id'],  // Can be null
         projectName: json['project_name'],  // Can be null
         title: json['title'],
         modelProvider: json['model_provider'] ?? 'anthropic',
         createdAt: DateTime.parse(json['created_at']),
         updatedAt: DateTime.parse(json['updated_at']),
         lastActivityAt: json['last_activity_at'] != null
             ? DateTime.parse(json['last_activity_at'])
             : null,
         messageCount: json['message_count'] ?? 0,
         messages: (json['messages'] as List<dynamic>?)
                 ?.map((m) => Message.fromJson(m))
                 .toList() ??
             [],
       );
     }

     bool get hasProject => projectId != null && projectId!.isNotEmpty;
   }
   ```

2. Add PaginatedThreads response class:
   ```dart
   class PaginatedThreads {
     final List<Thread> threads;
     final int total;
     final int page;
     final int pageSize;
     final bool hasMore;

     PaginatedThreads({
       required this.threads,
       required this.total,
       required this.page,
       required this.pageSize,
       required this.hasMore,
     });

     factory PaginatedThreads.fromJson(Map<String, dynamic> json) {
       return PaginatedThreads(
         threads: (json['threads'] as List<dynamic>)
             .map((t) => Thread.fromJson(t))
             .toList(),
         total: json['total'],
         page: json['page'],
         pageSize: json['page_size'],
         hasMore: json['has_more'],
       );
     }
   }
   ```

Update frontend/lib/services/api_service.dart:

Add new methods:

```dart
/// Get all threads for current user (global listing)
Future<PaginatedThreads> getGlobalThreads({
  int page = 1,
  int pageSize = 25,
}) async {
  final response = await _authenticatedRequest(
    'GET',
    '/api/threads?page=$page&page_size=$pageSize',
  );
  return PaginatedThreads.fromJson(response);
}

/// Create a thread (optionally without project)
Future<Thread> createGlobalThread({
  String? title,
  String? projectId,
  String? modelProvider,
}) async {
  final body = <String, dynamic>{};
  if (title != null) body['title'] = title;
  if (projectId != null) body['project_id'] = projectId;
  if (modelProvider != null) body['model_provider'] = modelProvider;

  final response = await _authenticatedRequest(
    'POST',
    '/api/threads',
    body: body,
  );
  return Thread.fromJson(response);
}
```

Import the PaginatedThreads class if in separate file, or ensure it's in thread.dart.
  </action>
  <verify>
Run Flutter analyze:
```bash
cd frontend && flutter analyze lib/models/thread.dart lib/services/api_service.dart
```
No errors related to Thread model or API service methods.
  </verify>
  <done>
Thread model supports nullable projectId and projectName. ApiService has getGlobalThreads and createGlobalThread methods matching backend API.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ChatsProvider and ChatsScreen</name>
  <files>
    frontend/lib/providers/chats_provider.dart
    frontend/lib/screens/chats_screen.dart
  </files>
  <action>
Create frontend/lib/providers/chats_provider.dart:

```dart
import 'package:flutter/foundation.dart';
import '../models/thread.dart';
import '../services/api_service.dart';

/// Provider for global chats state management.
/// Manages all user threads across projects.
class ChatsProvider extends ChangeNotifier {
  final ApiService _apiService;

  List<Thread> _threads = [];
  bool _isLoading = false;
  String? _error;
  int _total = 0;
  int _currentPage = 1;
  bool _hasMore = true;

  ChatsProvider(this._apiService);

  // Getters
  List<Thread> get threads => _threads;
  bool get isLoading => _isLoading;
  String? get error => _error;
  int get total => _total;
  bool get hasMore => _hasMore;

  /// Load threads (first page or refresh)
  Future<void> loadThreads() async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final result = await _apiService.getGlobalThreads(page: 1);
      _threads = result.threads;
      _total = result.total;
      _currentPage = 1;
      _hasMore = result.hasMore;
    } catch (e) {
      _error = e.toString();
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  /// Load more threads (pagination)
  Future<void> loadMoreThreads() async {
    if (_isLoading || !_hasMore) return;

    _isLoading = true;
    notifyListeners();

    try {
      final result = await _apiService.getGlobalThreads(page: _currentPage + 1);
      _threads.addAll(result.threads);
      _currentPage++;
      _hasMore = result.hasMore;
    } catch (e) {
      _error = e.toString();
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  /// Create a new project-less thread
  Future<Thread?> createNewChat({String? modelProvider}) async {
    try {
      final thread = await _apiService.createGlobalThread(
        title: null,  // Will be "New Chat", auto-generates later
        projectId: null,  // Project-less
        modelProvider: modelProvider,
      );
      // Add to beginning of list
      _threads.insert(0, thread);
      _total++;
      notifyListeners();
      return thread;
    } catch (e) {
      _error = e.toString();
      notifyListeners();
      return null;
    }
  }

  /// Clear error state
  void clearError() {
    _error = null;
    notifyListeners();
  }
}
```

Create frontend/lib/screens/chats_screen.dart:

```dart
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';
import '../providers/chats_provider.dart';
import '../models/thread.dart';

/// Screen displaying all user's chats across projects.
class ChatsScreen extends StatefulWidget {
  const ChatsScreen({super.key});

  @override
  State<ChatsScreen> createState() => _ChatsScreenState();
}

class _ChatsScreenState extends State<ChatsScreen> {
  @override
  void initState() {
    super.initState();
    // Load threads on mount
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.read<ChatsProvider>().loadThreads();
    });
  }

  Future<void> _createNewChat() async {
    final provider = context.read<ChatsProvider>();
    final thread = await provider.createNewChat();
    if (thread != null && mounted) {
      // Navigate to conversation view
      context.go('/chats/${thread.id}');
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Consumer<ChatsProvider>(
        builder: (context, provider, child) {
          if (provider.isLoading && provider.threads.isEmpty) {
            return const Center(child: CircularProgressIndicator());
          }

          if (provider.error != null && provider.threads.isEmpty) {
            return Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Text('Error: ${provider.error}'),
                  const SizedBox(height: 16),
                  ElevatedButton(
                    onPressed: () => provider.loadThreads(),
                    child: const Text('Retry'),
                  ),
                ],
              ),
            );
          }

          return Column(
            children: [
              // Header with New Chat button
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text(
                      'Chats',
                      style: Theme.of(context).textTheme.headlineMedium,
                    ),
                    FilledButton.icon(
                      onPressed: _createNewChat,
                      icon: const Icon(Icons.add),
                      label: const Text('New Chat'),
                    ),
                  ],
                ),
              ),
              const Divider(height: 1),
              // Thread list
              Expanded(
                child: provider.threads.isEmpty
                    ? _buildEmptyState()
                    : _buildThreadList(provider),
              ),
            ],
          );
        },
      ),
    );
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.chat_bubble_outline,
            size: 64,
            color: Theme.of(context).colorScheme.outline,
          ),
          const SizedBox(height: 16),
          Text(
            'No chats yet',
            style: Theme.of(context).textTheme.titleLarge?.copyWith(
                  color: Theme.of(context).colorScheme.outline,
                ),
          ),
          const SizedBox(height: 8),
          Text(
            'Start a new conversation',
            style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                  color: Theme.of(context).colorScheme.outline,
                ),
          ),
          const SizedBox(height: 24),
          FilledButton.icon(
            onPressed: _createNewChat,
            icon: const Icon(Icons.add),
            label: const Text('New Chat'),
          ),
        ],
      ),
    );
  }

  Widget _buildThreadList(ChatsProvider provider) {
    return RefreshIndicator(
      onRefresh: () => provider.loadThreads(),
      child: ListView.builder(
        itemCount: provider.threads.length + (provider.hasMore ? 1 : 0),
        itemBuilder: (context, index) {
          if (index >= provider.threads.length) {
            // Load more trigger
            provider.loadMoreThreads();
            return const Center(
              child: Padding(
                padding: EdgeInsets.all(16.0),
                child: CircularProgressIndicator(),
              ),
            );
          }

          final thread = provider.threads[index];
          return _ChatListTile(
            thread: thread,
            onTap: () => _navigateToThread(thread),
          );
        },
      ),
    );
  }

  void _navigateToThread(Thread thread) {
    if (thread.hasProject) {
      // Navigate to project thread view
      context.go('/projects/${thread.projectId}/threads/${thread.id}');
    } else {
      // Navigate to global chat view
      context.go('/chats/${thread.id}');
    }
  }
}

/// List tile for a chat thread with project badge.
class _ChatListTile extends StatelessWidget {
  final Thread thread;
  final VoidCallback onTap;

  const _ChatListTile({
    required this.thread,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    return ListTile(
      onTap: onTap,
      leading: CircleAvatar(
        backgroundColor: theme.colorScheme.primaryContainer,
        child: Icon(
          Icons.chat_bubble,
          color: theme.colorScheme.onPrimaryContainer,
        ),
      ),
      title: Text(
        thread.title ?? 'New Chat',
        maxLines: 1,
        overflow: TextOverflow.ellipsis,
      ),
      subtitle: Row(
        children: [
          // Project badge or "No Project"
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
            decoration: BoxDecoration(
              color: thread.hasProject
                  ? theme.colorScheme.secondaryContainer
                  : theme.colorScheme.surfaceContainerHighest,
              borderRadius: BorderRadius.circular(12),
            ),
            child: Text(
              thread.projectName ?? 'No Project',
              style: theme.textTheme.labelSmall?.copyWith(
                color: thread.hasProject
                    ? theme.colorScheme.onSecondaryContainer
                    : theme.colorScheme.outline,
              ),
            ),
          ),
          const SizedBox(width: 8),
          // Message count
          Text(
            '${thread.messageCount} messages',
            style: theme.textTheme.bodySmall?.copyWith(
              color: theme.colorScheme.outline,
            ),
          ),
        ],
      ),
      trailing: Text(
        _formatDate(thread.lastActivityAt ?? thread.updatedAt),
        style: theme.textTheme.bodySmall?.copyWith(
          color: theme.colorScheme.outline,
        ),
      ),
    );
  }

  String _formatDate(DateTime date) {
    final now = DateTime.now();
    final diff = now.difference(date);

    if (diff.inMinutes < 1) return 'Just now';
    if (diff.inHours < 1) return '${diff.inMinutes}m ago';
    if (diff.inDays < 1) return '${diff.inHours}h ago';
    if (diff.inDays < 7) return '${diff.inDays}d ago';
    return '${date.month}/${date.day}';
  }
}
```
  </action>
  <verify>
Run Flutter analyze:
```bash
cd frontend && flutter analyze lib/providers/chats_provider.dart lib/screens/chats_screen.dart
```
No errors. Classes compile and have correct dependencies.
  </verify>
  <done>
ChatsProvider manages global thread state with load, pagination, and create. ChatsScreen displays thread list with project badges, New Chat button, and navigation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate Chats into navigation and add Home page New Chat</name>
  <files>
    frontend/lib/widgets/app_shell.dart
    frontend/lib/screens/home_screen.dart
    frontend/lib/main.dart
    frontend/lib/router.dart
  </files>
  <action>
Update frontend/lib/widgets/app_shell.dart:

Add Chats navigation item after Home, before Projects:

1. Find the navigation items list (NavigationDrawer or similar)
2. Add Chats item:
   ```dart
   NavigationDrawerDestination(
     icon: const Icon(Icons.chat_bubble_outline),
     selectedIcon: const Icon(Icons.chat_bubble),
     label: const Text('Chats'),
   ),
   ```

3. Update navigation index handling to include Chats route:
   - Index 0: Home (/home or /)
   - Index 1: Chats (/chats)
   - Index 2+: Projects

4. Handle Chats selection to navigate to /chats route.

Update frontend/lib/screens/home_screen.dart:

Add New Chat button to home screen (alongside existing quick actions):

1. Find the quick actions or welcome section
2. Add a "New Chat" card/button:
   ```dart
   // In the quick actions area
   FilledButton.icon(
     onPressed: () async {
       final chatsProvider = context.read<ChatsProvider>();
       final thread = await chatsProvider.createNewChat();
       if (thread != null && context.mounted) {
         context.go('/chats/${thread.id}');
       }
     },
     icon: const Icon(Icons.chat_bubble),
     label: const Text('New Chat'),
   ),
   ```

Update frontend/lib/main.dart:

Register ChatsProvider:

1. Import ChatsProvider
2. Add to MultiProvider list:
   ```dart
   ChangeNotifierProvider(
     create: (context) => ChatsProvider(
       context.read<ApiService>(),
     ),
   ),
   ```

Update frontend/lib/router.dart:

Add routes for Chats:

1. Add /chats route showing ChatsScreen:
   ```dart
   GoRoute(
     path: '/chats',
     builder: (context, state) => const ChatsScreen(),
   ),
   ```

2. Add /chats/:threadId route for project-less thread conversation:
   ```dart
   GoRoute(
     path: '/chats/:threadId',
     builder: (context, state) {
       final threadId = state.pathParameters['threadId']!;
       return ThreadDetailScreen(threadId: threadId, projectId: null);
     },
   ),
   ```

Note: ThreadDetailScreen may need to handle null projectId. If it currently requires projectId, update it to accept optional projectId and conditionally show/hide project-related UI elements.
  </action>
  <verify>
Run the app and verify:
1. Chats appears in navigation drawer after Home
2. Clicking Chats shows ChatsScreen with thread list
3. Home page has New Chat button
4. New Chat creates thread and navigates to conversation view
```bash
cd frontend && flutter run -d chrome
```
  </verify>
  <done>
Chats section in navigation (CHATS-01). New Chat buttons in Chats section (CHATS-05) and Home page (CHATS-06). Navigation to conversation view works (CHATS-07).
  </done>
</task>

</tasks>

<verification>
1. Chats navigation:
   - Chats section visible in navigation drawer
   - Position: After Home, before Projects
   - Icon: chat_bubble or similar

2. Chats list (CHATS-02, CHATS-03, CHATS-04):
   - Shows all user threads
   - Each thread shows project badge (or "No Project")
   - Sorted by most recent activity (newest first)
   - Pagination loads more threads on scroll

3. New Chat (CHATS-05, CHATS-06):
   - New Chat button in Chats section header
   - New Chat button on Home page
   - Creates project-less thread (project_id = null)
   - Default title: "New Chat"

4. Navigation (CHATS-07):
   - Clicking New Chat navigates to /chats/{threadId}
   - Conversation view loads for project-less thread
   - Can send messages in project-less thread

5. Project-based threads still work:
   - Existing thread routes unchanged
   - Creating thread within project still works
</verification>

<success_criteria>
- Chats section appears in left navigation (CHATS-01)
- Chats section shows all user threads with project context (CHATS-02, CHATS-03)
- Threads sorted by most recent activity (CHATS-04)
- New Chat in Chats section creates project-less thread (CHATS-05)
- New Chat on Home page creates project-less thread (CHATS-06)
- New chat navigates directly to conversation view (CHATS-07)
</success_criteria>

<output>
After completion, create `.planning/phases/25-global-chats-backend/25-02-SUMMARY.md`
</output>

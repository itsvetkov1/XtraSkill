---
phase: 32-frontend-widget-model-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/test/unit/models/thread_test.dart
  - frontend/test/unit/models/token_usage_test.dart
autonomous: true

must_haves:
  truths:
    - "Thread model handles complex nullable fields correctly"
    - "PaginatedThreads parses nested thread array"
    - "TokenUsage computed properties calculate correctly"
  artifacts:
    - path: "frontend/test/unit/models/thread_test.dart"
      provides: "Thread and PaginatedThreads serialization tests"
      min_lines: 100
    - path: "frontend/test/unit/models/token_usage_test.dart"
      provides: "TokenUsage serialization and computed property tests"
      min_lines: 50
  key_links:
    - from: "frontend/test/unit/models/thread_test.dart"
      to: "frontend/lib/models/thread.dart"
      via: "imports Thread, PaginatedThreads"
      pattern: "import.*models/thread"
    - from: "frontend/test/unit/models/thread_test.dart"
      to: "frontend/lib/models/message.dart"
      via: "imports Message for nested parsing"
      pattern: "import.*models/message"
---

<objective>
Create JSON serialization tests for Thread, PaginatedThreads, and TokenUsage models including computed property tests.

Purpose: Complete FMOD-01 requirement by testing remaining models with complex nested structures and computed properties.

Output: Two test files covering Thread (most complex model), PaginatedThreads, and TokenUsage with its computed getters.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-frontend-widget-model-tests/32-RESEARCH.md

# Source files
@frontend/lib/models/thread.dart
@frontend/lib/models/token_usage.dart
@frontend/lib/models/message.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Thread and PaginatedThreads model tests</name>
  <files>frontend/test/unit/models/thread_test.dart</files>
  <action>
Create test file at `frontend/test/unit/models/thread_test.dart`:

Thread is the most complex model with 10 fields (7 nullable), nested messages, and computed properties.

1. Test Thread.fromJson:
   - Complete JSON with all fields
   - Minimal JSON (only id, created_at, updated_at)
   - JSON with null projectId, projectName, title
   - JSON with null lastActivityAt, messageCount
   - JSON with null modelProvider
   - JSON with nested messages array
   - JSON with empty messages array

2. Test Thread.toJson:
   - Excludes null optional fields
   - Includes non-null optional fields
   - Serializes nested messages

3. Test Thread.hasProject computed property:
   - Returns true when projectId is non-null and non-empty
   - Returns false when projectId is null
   - Returns false when projectId is empty string

4. Test Thread round-trip:
   - Full object preserves all fields
   - Object with nulls preserves structure
   - Nested messages preserved

5. Test PaginatedThreads.fromJson:
   - Parses threads array
   - Parses pagination fields (total, page, pageSize, hasMore)
   - Empty threads array handled

Test structure:
```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:frontend/models/thread.dart';
import 'package:frontend/models/message.dart';

void main() {
  group('Thread', () {
    group('fromJson', () {
      test('creates instance from complete JSON');
      test('handles minimal required fields');
      test('handles null projectId');
      test('handles null lastActivityAt');
      test('parses nested messages array');
      test('handles empty messages array');
    });
    group('toJson', () {
      test('produces valid map');
      test('excludes null optional fields');
      test('serializes nested messages');
    });
    group('hasProject', () {
      test('returns true for non-null non-empty projectId');
      test('returns false for null projectId');
      test('returns false for empty projectId');
    });
    group('round-trip', () {
      test('preserves all fields');
      test('preserves nested messages');
    });
  });

  group('PaginatedThreads', () {
    group('fromJson', () {
      test('parses threads array');
      test('parses pagination fields');
      test('handles empty threads array');
    });
  });
}
```
  </action>
  <verify>Run `flutter test frontend/test/unit/models/thread_test.dart -v` - all tests pass</verify>
  <done>15-20 tests covering Thread (complex nullable fields, nested messages) and PaginatedThreads</done>
</task>

<task type="auto">
  <name>Task 2: Create TokenUsage model tests</name>
  <files>frontend/test/unit/models/token_usage_test.dart</files>
  <action>
Create test file at `frontend/test/unit/models/token_usage_test.dart`:

TokenUsage has computed properties that need testing beyond serialization.

1. Test fromJson:
   - Complete JSON creates valid instance
   - Number types coerced correctly (num -> double, int)

2. Test computed properties (key differentiator from other models):
   - `totalTokens` returns sum of input + output
   - `costPercentage` returns correct ratio
   - `costPercentage` clamps to 0.0 when cost is 0
   - `costPercentage` clamps to 1.0 when over budget
   - `costPercentageDisplay` formats correctly (e.g., "12.5%")
   - `costPercentageDisplay` shows "100.0%" when over budget

Test structure:
```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:frontend/models/token_usage.dart';

void main() {
  group('TokenUsage', () {
    group('fromJson', () {
      test('creates instance from complete JSON');
      test('handles numeric type coercion');
    });
    group('totalTokens', () {
      test('returns sum of input and output tokens');
    });
    group('costPercentage', () {
      test('returns correct ratio');
      test('clamps to 0 when cost is 0');
      test('clamps to 1.0 when over budget');
    });
    group('costPercentageDisplay', () {
      test('formats as percentage string');
      test('shows 100.0% when over budget');
      test('handles fractional percentages');
    });
  });
}
```

Key test case for computed properties:
```dart
test('computed properties calculate correctly', () {
  final usage = TokenUsage(
    totalCost: 12.5,
    totalRequests: 100,
    totalInputTokens: 5000,
    totalOutputTokens: 3000,
    monthStart: '2026-02-01',
    budget: 100.0,
  );

  expect(usage.totalTokens, 8000);
  expect(usage.costPercentage, 0.125);
  expect(usage.costPercentageDisplay, '12.5%');
});
```
  </action>
  <verify>Run `flutter test frontend/test/unit/models/token_usage_test.dart -v` - all tests pass</verify>
  <done>8-10 tests covering TokenUsage serialization and computed properties</done>
</task>

</tasks>

<verification>
Run all model tests to ensure complete coverage:
```bash
flutter test frontend/test/unit/models/ -v
```

Expected: All tests pass (plan 01 + plan 02 combined = 50+ tests)
</verification>

<success_criteria>
1. Thread model tests verify complex nullable field handling
2. Thread nested messages serialization works correctly
3. Thread.hasProject computed property tested
4. PaginatedThreads parses nested thread array
5. TokenUsage computed properties (totalTokens, costPercentage, costPercentageDisplay) verified
6. All tests run without errors
</success_criteria>

<output>
After completion, create `.planning/phases/32-frontend-widget-model-tests/32-02-SUMMARY.md`
</output>

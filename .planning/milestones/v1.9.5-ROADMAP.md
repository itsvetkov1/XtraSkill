# Milestone v1.9.5: Pilot Logging Infrastructure

**Status:** ✅ SHIPPED 2026-02-08
**Phases:** 43-48
**Total Plans:** 8

## Overview

This milestone adds comprehensive logging infrastructure for AI-powered debugging during pilot testing. The 6-phase build order starts with backend logging foundation (testable independently), adds admin API endpoints, then progressively integrates frontend logging with HTTP correlation, settings UI, and centralized flush to backend storage.

## Phases

### Phase 43: Backend Logging Foundation
**Goal**: All backend operations produce structured, async-safe logs stored in rotating files
**Depends on**: Nothing (first phase)
**Requirements**: LOG-01, LOG-02, LOG-03, LOG-04, LOG-06, LOG-08, BLOG-01, BLOG-02, BLOG-03, BLOG-04, BLOG-05, BLOG-06, BLOG-07, BLOG-08, SLOG-02, SLOG-03
**Success Criteria** (what must be TRUE):
  1. Backend HTTP requests/responses are logged with method, path, status, duration, and correlation ID
  2. AI service calls are logged with provider, model, token counts, and timing
  3. Database operations are logged with table, operation type, and duration
  4. All log entries are structured JSON with consistent schema (timestamp, level, category, correlationId)
  5. Logs rotate automatically and retain for 7 days
**Plans**: 3 plans in 3 waves

Plans:
- [x] 43-01-PLAN.md — Configuration & LoggingService core (structlog, QueueHandler, file rotation) ✓
- [x] 43-02-PLAN.md — Correlation ID & LoggingMiddleware (HTTP request/response logging) ✓
- [x] 43-03-PLAN.md — Service integration & sanitization (AI, DB logging, sensitive data redaction) ✓

### Phase 44: Backend Admin API
**Goal**: Administrators can access logs via authenticated API endpoints
**Depends on**: Phase 43
**Requirements**: LOG-07
**Success Criteria** (what must be TRUE):
  1. Admin can list available log files via GET /api/logs
  2. Admin can download log files via GET /api/logs/download
  3. Backend can receive frontend logs via POST /api/logs/ingest
**Plans**: 1 plan in 1 wave

Plans:
- [x] 44-01-PLAN.md — Admin role + log endpoints (is_admin field, get_admin_user dependency, routes/logs.py) ✓

### Phase 45: Frontend Logging Foundation
**Goal**: Frontend captures user actions, navigation, and errors with session grouping
**Depends on**: Phase 44 (needs ingest endpoint)
**Requirements**: FLOG-01, FLOG-02, FLOG-04, FLOG-05, FLOG-06, FLOG-07, SLOG-04
**Success Criteria** (what must be TRUE):
  1. User navigation events (screen views, route changes) are logged
  2. User actions (button clicks, form submits) are logged
  3. Errors are captured with exception type and stack trace
  4. All frontend logs include session ID and category tags
  5. Network state changes (connectivity, timeouts) are logged
**Plans**: 1 plan in 1 wave

Plans:
- [x] 45-01-PLAN.md — Core logging services, navigation observer, error handlers, connectivity monitoring ✓

### Phase 46: Frontend HTTP Integration
**Goal**: All HTTP requests include correlation ID and are logged with response metadata
**Depends on**: Phase 45
**Requirements**: FLOG-03
**Success Criteria** (what must be TRUE):
  1. Dio interceptor attaches X-Correlation-ID header to all requests
  2. API requests/responses are logged with endpoint, method, status, and duration
  3. Correlation ID links frontend requests to backend logs
**Plans**: 1 plan in 1 wave

Plans:
- [x] 46-01-PLAN.md — ApiClient singleton with Dio interceptor, LoggingService.logApi, service refactoring ✓

### Phase 47: Frontend Settings UI
**Goal**: Users can toggle detailed logging from Settings screen
**Depends on**: Phase 46
**Requirements**: LOG-05, SLOG-01
**Success Criteria** (what must be TRUE):
  1. Logging toggle appears in Settings screen
  2. Toggle state persists across app restarts via SharedPreferences
  3. Disabling logging stops all log capture (no privacy leakage)
**Plans**: 1 plan in 1 wave

Plans:
- [x] 47-01-PLAN.md — LoggingProvider with persistence, LoggingService isEnabled, Settings toggle UI ✓

### Phase 48: Frontend-to-Backend Flush
**Goal**: Buffered frontend logs are sent to backend for centralized storage
**Depends on**: Phase 47
**Requirements**: FLOG-08, SLOG-05
**Success Criteria** (what must be TRUE):
  1. Frontend logs are sent to backend via POST /api/logs/ingest
  2. Logs flush on configurable interval (default: 5 minutes)
  3. Logs flush on app lifecycle events (pause, terminate)
  4. Buffered logs persist until successfully delivered
**Plans**: 1 plan in 1 wave

Plans:
- [x] 48-01-PLAN.md — flush() method, AppLifecycleListener, Timer.periodic, logout flush ✓

## Progress

**Execution Order:**
Phases execute in numeric order: 43 -> 44 -> 45 -> 46 -> 47 -> 48

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
| 43. Backend Logging Foundation | 3/3 | ✓ Complete | 2026-02-07 |
| 44. Backend Admin API | 1/1 | ✓ Complete | 2026-02-08 |
| 45. Frontend Logging Foundation | 1/1 | ✓ Complete | 2026-02-08 |
| 46. Frontend HTTP Integration | 1/1 | ✓ Complete | 2026-02-08 |
| 47. Frontend Settings UI | 1/1 | ✓ Complete | 2026-02-08 |
| 48. Frontend-to-Backend Flush | 1/1 | ✓ Complete | 2026-02-08 |

---

## Milestone Summary

**Key Decisions:**

- QueueHandler + QueueListener pattern for async-safe logging (LOG-001)
- structlog for structured JSON output with processor chains (LOG-002)
- TimedRotatingFileHandler for daily rotation with 7-day retention (LOG-003)
- contextvars for request-scoped correlation ID storage (LOG-004)
- Boolean is_admin flag sufficient for pilot admin role (LOG-011)
- Frontend logs to same file with [FRONTEND] prefix (LOG-012)
- ApiClient singleton pattern for shared Dio interceptor (LOG-021)
- Default logging enabled for pilot to maximize diagnostic data (LOG-024)

**Issues Resolved:**

- Event loop blocking during file I/O (solved with QueueHandler)
- Request tracing across frontend/backend boundary (solved with X-Correlation-ID)
- Privacy concerns for logging (solved with user-controlled toggle and buffer clearing)
- Memory exhaustion from unbounded buffer (solved with 1000-entry limit and auto-trim)
- Lifecycle flush gaps (solved with Timer.periodic + AppLifecycleListener + logout hook)

**Technical Debt Incurred:**

- Admin user requires manual database update (is_admin=True) - acceptable for pilot
- No log viewer UI - direct file access sufficient for pilot scale

---

*Roadmap created: 2026-02-07*
*Milestone shipped: 2026-02-08*
*Requirements: 29 mapped across 6 phases*

---
phase: 14-thread-rename
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - frontend/lib/services/thread_service.dart
  - frontend/lib/providers/thread_provider.dart
  - frontend/lib/screens/threads/thread_rename_dialog.dart
  - frontend/lib/screens/threads/thread_list_screen.dart
  - frontend/lib/screens/conversation/conversation_screen.dart
autonomous: true

must_haves:
  truths:
    - "User can tap edit icon in ConversationScreen AppBar to open rename dialog"
    - "User can select Rename from thread list popup menu to open rename dialog"
    - "Rename dialog shows current thread title pre-filled and ready for editing"
    - "Saving updates thread title immediately in both thread list and conversation AppBar"
  artifacts:
    - path: "frontend/lib/services/thread_service.dart"
      provides: "renameThread() API method"
      contains: "_dio.patch"
    - path: "frontend/lib/providers/thread_provider.dart"
      provides: "renameThread() state method"
      contains: "renameThread"
    - path: "frontend/lib/screens/threads/thread_rename_dialog.dart"
      provides: "Rename dialog widget"
      contains: "ThreadRenameDialog"
    - path: "frontend/lib/screens/threads/thread_list_screen.dart"
      provides: "Rename option in popup menu"
      contains: "value: 'rename'"
    - path: "frontend/lib/screens/conversation/conversation_screen.dart"
      provides: "Edit icon in AppBar"
      contains: "Icons.edit_outlined"
  key_links:
    - from: "ThreadRenameDialog"
      to: "ThreadProvider.renameThread"
      via: "context.read<ThreadProvider>()"
      pattern: "provider\\.renameThread"
    - from: "ThreadProvider.renameThread"
      to: "ThreadService.renameThread"
      via: "await _threadService.renameThread"
      pattern: "_threadService\\.renameThread"
    - from: "ThreadService.renameThread"
      to: "PATCH /api/threads/{id}"
      via: "_dio.patch"
      pattern: "_dio\\.patch.*threads"
---

<objective>
Implement frontend thread rename with service, provider, dialog, and UI integration.

Purpose: Enable users to rename threads from both ConversationScreen AppBar and ThreadListScreen popup menu.
Output: Complete rename flow - service method, provider state management, reusable dialog, and two UI entry points.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-thread-rename/14-RESEARCH.md
@.planning/phases/14-thread-rename/14-01-SUMMARY.md

# Existing patterns to follow
@frontend/lib/services/thread_service.dart
@frontend/lib/providers/thread_provider.dart
@frontend/lib/screens/threads/thread_create_dialog.dart
@frontend/lib/screens/threads/thread_list_screen.dart
@frontend/lib/screens/conversation/conversation_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add renameThread to ThreadService</name>
  <files>frontend/lib/services/thread_service.dart</files>
  <action>
Add renameThread method to ThreadService (after deleteThread):

```dart
/// Rename a thread
///
/// [threadId] - ID of the thread to rename
/// [title] - New title (or null to clear)
///
/// Returns updated Thread object
Future<Thread> renameThread(String threadId, String? title) async {
  try {
    final headers = await _getAuthHeaders();
    final response = await _dio.patch(
      '$_baseUrl/api/threads/$threadId',
      options: Options(headers: headers),
      data: {
        'title': title,
      },
    );

    return Thread.fromJson(response.data as Map<String, dynamic>);
  } on DioException catch (e) {
    if (e.response?.statusCode == 401 || e.response?.statusCode == 403) {
      throw Exception('Authentication required');
    } else if (e.response?.statusCode == 404) {
      throw Exception('Thread not found');
    }
    throw Exception('Failed to rename thread: ${e.message}');
  }
}
```

Pattern matches existing createThread and deleteThread methods.
  </action>
  <verify>No compile errors in thread_service.dart</verify>
  <done>ThreadService.renameThread() method exists and makes PATCH request to backend.</done>
</task>

<task type="auto">
  <name>Task 2: Add renameThread to ThreadProvider</name>
  <files>frontend/lib/providers/thread_provider.dart</files>
  <action>
Add renameThread method to ThreadProvider (after selectThread, before clearThreads):

```dart
/// Rename a thread
///
/// Updates thread title via API and syncs local state.
/// Updates both _threads list and _selectedThread if applicable.
Future<Thread?> renameThread(String threadId, String? title) async {
  _loading = true;
  _error = null;
  notifyListeners();

  try {
    final updatedThread = await _threadService.renameThread(threadId, title);

    // Update in threads list
    final index = _threads.indexWhere((t) => t.id == threadId);
    if (index != -1) {
      _threads[index] = Thread(
        id: updatedThread.id,
        projectId: updatedThread.projectId,
        title: updatedThread.title,
        createdAt: updatedThread.createdAt,
        updatedAt: updatedThread.updatedAt,
        messageCount: _threads[index].messageCount, // Preserve local count
      );
    }

    // Update selected thread if it's the same one
    if (_selectedThread?.id == threadId) {
      _selectedThread = updatedThread;
    }

    _error = null;
    return updatedThread;
  } catch (e) {
    _error = e.toString();
    return null;
  } finally {
    _loading = false;
    notifyListeners();
  }
}
```

This follows the ProjectProvider.updateProject pattern. Key: preserve messageCount from local thread since API doesn't return it for rename response.
  </action>
  <verify>No compile errors in thread_provider.dart</verify>
  <done>ThreadProvider.renameThread() method exists, updates local state, and notifies listeners.</done>
</task>

<task type="auto">
  <name>Task 3: Create ThreadRenameDialog</name>
  <files>frontend/lib/screens/threads/thread_rename_dialog.dart</files>
  <action>
Create new file thread_rename_dialog.dart following ThreadCreateDialog pattern:

```dart
/// Dialog for renaming a conversation thread.
library;

import 'package:flutter/material.dart';
import 'package:provider/provider.dart';

import '../../providers/thread_provider.dart';

/// Dialog for renaming an existing thread
class ThreadRenameDialog extends StatefulWidget {
  const ThreadRenameDialog({
    super.key,
    required this.threadId,
    required this.currentTitle,
  });

  final String threadId;
  final String? currentTitle;

  @override
  State<ThreadRenameDialog> createState() => _ThreadRenameDialogState();
}

class _ThreadRenameDialogState extends State<ThreadRenameDialog> {
  late final TextEditingController _titleController;
  final _formKey = GlobalKey<FormState>();
  bool _isRenaming = false;

  @override
  void initState() {
    super.initState();
    _titleController = TextEditingController(text: widget.currentTitle ?? '');
  }

  @override
  void dispose() {
    _titleController.dispose();
    super.dispose();
  }

  Future<void> _renameThread() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() => _isRenaming = true);

    try {
      final provider = context.read<ThreadProvider>();
      final title = _titleController.text.trim();

      final result = await provider.renameThread(
        widget.threadId,
        title.isEmpty ? null : title,
      );

      if (mounted) {
        if (result != null) {
          Navigator.of(context).pop(true); // Return success
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('Conversation renamed')),
          );
        } else {
          setState(() => _isRenaming = false);
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(provider.error ?? 'Failed to rename conversation'),
              backgroundColor: Theme.of(context).colorScheme.error,
            ),
          );
        }
      }
    } catch (e) {
      if (mounted) {
        setState(() => _isRenaming = false);
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to rename: ${e.toString()}'),
            backgroundColor: Theme.of(context).colorScheme.error,
          ),
        );
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: const Text('Rename Conversation'),
      content: Form(
        key: _formKey,
        child: TextFormField(
          controller: _titleController,
          decoration: const InputDecoration(
            labelText: 'Title',
            hintText: 'e.g., Login Flow Discussion',
            border: OutlineInputBorder(),
          ),
          maxLength: 255,
          autofocus: true,
          enabled: !_isRenaming,
          validator: (value) {
            if (value != null && value.length > 255) {
              return 'Title must be 255 characters or less';
            }
            return null;
          },
        ),
      ),
      actions: [
        TextButton(
          onPressed: _isRenaming ? null : () => Navigator.of(context).pop(false),
          child: const Text('Cancel'),
        ),
        ElevatedButton(
          onPressed: _isRenaming ? null : _renameThread,
          child: _isRenaming
              ? const SizedBox(
                  width: 16,
                  height: 16,
                  child: CircularProgressIndicator(strokeWidth: 2),
                )
              : const Text('Rename'),
        ),
      ],
    );
  }
}
```

Key differences from ThreadCreateDialog:
- Takes threadId and currentTitle as required params
- Pre-fills TextEditingController with currentTitle
- Calls renameThread instead of createThread
- Returns true/false to indicate success (for caller to react)
  </action>
  <verify>No compile errors; `flutter analyze` passes</verify>
  <done>ThreadRenameDialog widget created with pre-filled title input and rename functionality.</done>
</task>

<task type="auto">
  <name>Task 4: Add rename option to ThreadListScreen popup menu</name>
  <files>frontend/lib/screens/threads/thread_list_screen.dart</files>
  <action>
Update ThreadListScreen to add "Rename" option to PopupMenuButton:

1. Add import at top:
   ```dart
   import 'thread_rename_dialog.dart';
   ```

2. Add _showRenameDialog method (after _deleteThread):
   ```dart
   /// Show rename dialog for a thread
   void _showRenameDialog(Thread thread) {
     showDialog(
       context: context,
       builder: (context) => ThreadRenameDialog(
         threadId: thread.id,
         currentTitle: thread.title,
       ),
     );
   }
   ```

3. Update PopupMenuButton onSelected (around line 174-176):
   ```dart
   onSelected: (value) {
     if (value == 'rename') {
       _showRenameDialog(thread);
     } else if (value == 'delete') {
       _deleteThread(context, thread.id);
     }
   },
   ```

4. Update itemBuilder to add Rename option BEFORE Delete (around line 179-190):
   ```dart
   itemBuilder: (context) => [
     const PopupMenuItem(
       value: 'rename',
       child: Row(
         children: [
           Icon(Icons.edit_outlined),
           SizedBox(width: 8),
           Text('Rename'),
         ],
       ),
     ),
     const PopupMenuItem(
       value: 'delete',
       child: Row(
         children: [
           Icon(Icons.delete_outline),
           SizedBox(width: 8),
           Text('Delete'),
         ],
       ),
     ),
   ],
   ```

This satisfies THREAD-02.
  </action>
  <verify>Flutter compiles; thread list shows Rename option in popup menu</verify>
  <done>THREAD-02 satisfied: "Rename" option appears in thread list popup menu and opens rename dialog.</done>
</task>

<task type="auto">
  <name>Task 5: Add edit icon to ConversationScreen AppBar</name>
  <files>frontend/lib/screens/conversation/conversation_screen.dart</files>
  <action>
Update ConversationScreen to add edit icon in AppBar:

1. Add import at top:
   ```dart
   import '../../providers/thread_provider.dart';
   import '../threads/thread_rename_dialog.dart';
   ```

2. Add _showRenameDialog method in _ConversationScreenState (after _deleteMessage):
   ```dart
   /// Show rename dialog for current thread
   void _showRenameDialog() {
     final provider = context.read<ConversationProvider>();
     final thread = provider.thread;
     if (thread == null) return;

     showDialog<bool>(
       context: context,
       builder: (dialogContext) => ThreadRenameDialog(
         threadId: thread.id,
         currentTitle: thread.title,
       ),
     ).then((renamed) {
       // Reload thread to get updated title
       if (renamed == true && mounted) {
         provider.loadThread(widget.threadId);
       }
     });
   }
   ```

3. Update AppBar (around line 111-113) to add actions:
   ```dart
   appBar: AppBar(
     title: Text(provider.thread?.title ?? 'New Conversation'),
     actions: [
       IconButton(
         icon: const Icon(Icons.edit_outlined),
         tooltip: 'Rename conversation',
         onPressed: provider.thread != null ? _showRenameDialog : null,
       ),
     ],
   ),
   ```

Key: After successful rename, reload thread via ConversationProvider.loadThread() to refresh the title in AppBar. The rename dialog updates ThreadProvider's state (for thread list), but ConversationProvider has its own copy of the thread.

This satisfies THREAD-01.
  </action>
  <verify>Flutter compiles; edit icon appears in conversation AppBar; tapping opens rename dialog</verify>
  <done>THREAD-01 satisfied: Edit icon in ConversationScreen AppBar opens rename dialog. Title updates after rename.</done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes with no errors
2. Rename from thread list:
   - Open project, see thread list
   - Tap popup menu on a thread
   - "Rename" option visible above "Delete"
   - Tap "Rename" opens dialog with current title
   - Change title, tap "Rename" button
   - Thread list shows new title immediately
3. Rename from conversation:
   - Open a conversation
   - Edit icon visible in AppBar
   - Tap edit icon opens dialog with current title
   - Change title, tap "Rename" button
   - AppBar title updates to new title
4. Empty title works:
   - Clear title in rename dialog
   - Thread shows "New Conversation" as fallback
</verification>

<success_criteria>
- THREAD-01 satisfied: Edit icon in ConversationScreen AppBar opens rename dialog
- THREAD-02 satisfied: "Rename" option in Thread List PopupMenu
- THREAD-03 satisfied: Dialog pre-fills current thread title
- Thread title updates optimistically in both thread list and conversation AppBar
- Error handling shows snackbar on failure
</success_criteria>

<output>
After completion, create `.planning/phases/14-thread-rename/14-02-SUMMARY.md`
</output>

---
phase: 68-core-conversation-memory-fix
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/test/unit/providers/assistant_conversation_provider_test.dart
  - frontend/test/unit/providers/assistant_conversation_provider_test.mocks.dart
autonomous: true
requirements:
  - TEST-04

must_haves:
  truths:
    - "AssistantConversationProvider loads thread with message history correctly"
    - "Sending a message adds user message to list and triggers streaming"
    - "Streaming completion adds assistant message to conversation list"
    - "Error handling preserves partial content and enables retry"
    - "Retry removes duplicate user message before resending"
    - "Skill selection prepends context to message content"
  artifacts:
    - path: "frontend/test/unit/providers/assistant_conversation_provider_test.dart"
      provides: "Unit tests for AssistantConversationProvider"
      contains: "AssistantConversationProvider Unit Tests"
    - path: "frontend/test/unit/providers/assistant_conversation_provider_test.mocks.dart"
      provides: "Generated mock classes for AIService, ThreadService, DocumentService"
      contains: "MockAIService"
  key_links:
    - from: "frontend/test/unit/providers/assistant_conversation_provider_test.dart"
      to: "frontend/lib/providers/assistant_conversation_provider.dart"
      via: "imports and tests AssistantConversationProvider"
      pattern: "AssistantConversationProvider"
    - from: "frontend/test/unit/providers/assistant_conversation_provider_test.dart"
      to: "frontend/test/unit/providers/assistant_conversation_provider_test.mocks.dart"
      via: "generated mocks from @GenerateNiceMocks"
      pattern: "MockAIService"
---

<objective>
Create comprehensive Flutter unit tests for AssistantConversationProvider covering message list integrity, streaming state management, error handling, retry with history, and skill prepending.

Purpose: Ensure the provider correctly manages conversation state across multiple turns, validating that message history is preserved through the send/receive cycle.
Output: Full test coverage for AssistantConversationProvider with generated mocks.
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/68-core-conversation-memory-fix/68-RESEARCH.md
@frontend/lib/providers/assistant_conversation_provider.dart
@frontend/test/unit/providers/conversation_provider_test.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AssistantConversationProvider test file with mock generation</name>
  <files>frontend/test/unit/providers/assistant_conversation_provider_test.dart</files>
  <action>
Create the test file following the exact pattern from `conversation_provider_test.dart`.

1. Create `frontend/test/unit/providers/assistant_conversation_provider_test.dart` with:
   - Library declaration: `library;`
   - Imports: `flutter_test`, `mockito/annotations`, `mockito/mockito`, models (Message, Thread, Skill), provider (AssistantConversationProvider), services (AIService, ThreadService, DocumentService)
   - Import generated mocks: `assistant_conversation_provider_test.mocks.dart`
   - `@GenerateNiceMocks([MockSpec<AIService>(), MockSpec<ThreadService>(), MockSpec<DocumentService>()])`

2. Setup in `main()`:
   - Create `MockAIService`, `MockThreadService`, `MockDocumentService` in setUp
   - Create `AssistantConversationProvider(aiService: ..., threadService: ..., documentService: ...)` in setUp
   - Helper `createTestThread()` returning a Thread with test data
   - Helper `createTestMessage()` returning a Message with configurable role and content

3. Test groups and individual tests:

   **Group: "loadThread"**
   - `test_load_thread_sets_messages`: Mock `threadService.getThread()` to return a thread with 3 messages. Call `loadThread('t1')`. Assert `provider.messages.length == 3`, `provider.loading == false`, `provider.thread != null`.
   - `test_load_thread_sets_not_found_on_404`: Mock `threadService.getThread()` to throw exception containing "404". Call `loadThread('missing')`. Assert `provider.isNotFound == true`, `provider.error == null`.
   - `test_load_thread_sets_error_on_failure`: Mock `threadService.getThread()` to throw generic exception. Call `loadThread('t1')`. Assert `provider.error != null`, `provider.isNotFound == false`.

   **Group: "sendMessage"**
   - `test_send_message_adds_user_message_to_list`: Set up thread via `provider.loadThread()`. Mock `aiService.streamChat()` to return Stream with `MessageCompleteEvent`. Call `sendMessage('Hello')`. Assert messages list contains user message with content 'Hello'.
   - `test_send_message_adds_assistant_response_after_completion`: Mock stream with `TextDeltaEvent('Hi')` then `MessageCompleteEvent`. Call sendMessage. Assert last message has role assistant.
   - `test_send_message_preserves_existing_messages`: Load thread with 2 existing messages, send new message. Assert messages list has 2 + 1 user + 1 assistant = 4 messages after completion.
   - `test_streaming_text_accumulates_during_stream`: Mock stream with two `TextDeltaEvent` events. Verify `streamingText` accumulates both deltas during streaming. After `MessageCompleteEvent`, `streamingText` is cleared.

   **Group: "error handling"**
   - `test_error_preserves_partial_content`: Mock stream with `TextDeltaEvent('partial')` then `ErrorEvent('network error')`. Assert `hasPartialContent == true`, `streamingText == 'partial'`, `error != null`.
   - `test_can_retry_is_true_after_error`: After error during send, assert `canRetry == true`.
   - `test_can_retry_is_false_initially`: Assert `provider.canRetry == false` before any send.

   **Group: "retryLastMessage"**
   - `test_retry_removes_duplicate_user_message`: Load thread, send message (mock error on first stream). After error, messages list has user message. Call `retryLastMessage()`. Assert the duplicate user message was removed before re-adding.

   **Group: "skill selection"**
   - `test_select_skill_sets_selected_skill`: Create a Skill object. Call `selectSkill(skill)`. Assert `provider.selectedSkill == skill`.
   - `test_clear_skill_removes_selected_skill`: Select then clear. Assert `provider.selectedSkill == null`.
   - `test_skill_context_prepended_to_message`: Select a skill named "business-analyst". Mock streamChat. Send message "analyze this". Verify `streamChat` was called with content containing `[Using skill: business-analyst]`.

   **Group: "clearConversation"**
   - `test_clear_conversation_resets_all_state`: Load thread, set error, set streaming text. Call `clearConversation()`. Assert all fields reset: messages empty, thread null, error null, streaming false, etc.

4. Run mock generation:
   ```bash
   cd frontend && dart run build_runner build --delete-conflicting-outputs
   ```
   This generates `assistant_conversation_provider_test.mocks.dart`.

Note on AIService.streamChat: The existing `conversation_provider_test.dart` documents an SSE streaming limitation — `flutter_client_sse` cannot be easily mocked. Follow the same approach: use mockito's `when().thenAnswer()` returning a `Stream<ChatEvent>` from a list of events using `Stream.fromIterable()`. The `ChatEvent` types (`TextDeltaEvent`, `MessageCompleteEvent`, `ErrorEvent`, `ToolExecutingEvent`) should be importable from the AI service.

Important: The auto-retry logic in `sendMessage()` includes a 2-second `Future.delayed`. For tests, either:
- Provide a stream that completes successfully (no error → no retry delay), OR
- For error tests, use `fakeAsync` or accept the 2-second wait

Prefer successful-path tests and simple error tests that don't trigger auto-retry to keep test execution fast.
  </action>
  <verify>
```bash
cd frontend && flutter test test/unit/providers/assistant_conversation_provider_test.dart --reporter expanded
```
All tests pass.
  </verify>
  <done>
16+ tests covering: thread loading (success, 404, error), message sending (user message added, assistant response, message accumulation, streaming text), error handling (partial content, retry availability), retry (duplicate removal), skill selection (set, clear, prepend), clear conversation. All pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify mock generation and run full frontend test suite</name>
  <files>frontend/test/unit/providers/assistant_conversation_provider_test.mocks.dart</files>
  <action>
1. Verify the mock file was generated successfully in Task 1:
   ```bash
   ls frontend/test/unit/providers/assistant_conversation_provider_test.mocks.dart
   ```

2. Run the full frontend test suite to verify no regressions:
   ```bash
   cd frontend && flutter test --reporter expanded 2>&1 | tail -30
   ```

3. If any existing tests fail, investigate whether it's related to the new test file (shared mock conflicts, import issues). The new test file should have NO impact on existing tests since it has its own isolated mock file.

4. Commit the generated `.mocks.dart` file alongside the test file (per project convention from Phase 28: "Commit generated .mocks.dart files — CI doesn't need to regenerate").
  </action>
  <verify>
```bash
cd frontend && flutter test test/unit/providers/assistant_conversation_provider_test.dart -q
cd frontend && flutter test -q 2>&1 | tail -5
```
New tests pass and no regressions in existing suite.
  </verify>
  <done>
Generated mock file committed. Full frontend test suite passes with new AssistantConversationProvider tests included. No regressions in existing tests.
  </done>
</task>

</tasks>

<verification>
1. New test file exists and is properly structured:
   ```bash
   head -20 frontend/test/unit/providers/assistant_conversation_provider_test.dart
   ```

2. Mock file was generated:
   ```bash
   ls -la frontend/test/unit/providers/assistant_conversation_provider_test.mocks.dart
   ```

3. New tests pass:
   ```bash
   cd frontend && flutter test test/unit/providers/assistant_conversation_provider_test.dart -q
   ```

4. Full frontend suite passes (no regressions):
   ```bash
   cd frontend && flutter test -q 2>&1 | tail -5
   ```
</verification>

<success_criteria>
- 16+ AssistantConversationProvider tests pass
- Tests cover: loading, sending, streaming, error handling, retry, skill selection, clear
- Generated mock file committed per project convention
- No regressions in existing frontend test suite
</success_criteria>

<output>
After completion, create `.planning/phases/68-core-conversation-memory-fix/68-02-SUMMARY.md`
</output>

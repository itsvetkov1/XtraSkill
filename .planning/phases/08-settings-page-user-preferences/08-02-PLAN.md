---
phase: 08-settings-page-user-preferences
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - frontend/lib/providers/auth_provider.dart
  - frontend/lib/services/auth_service.dart
  - frontend/lib/models/token_usage.dart
  - frontend/lib/screens/settings_screen.dart
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User can see their email and display name on Settings page"
    - "User can tap logout button and sees confirmation dialog"
    - "User confirms logout and is redirected to login screen"
    - "User can see monthly token usage with visual progress indicator"
  artifacts:
    - path: "frontend/lib/providers/auth_provider.dart"
      provides: "AuthProvider with displayName field"
      contains: "displayName"
    - path: "frontend/lib/models/token_usage.dart"
      provides: "TokenUsage data model"
      exports: ["TokenUsage"]
    - path: "frontend/lib/screens/settings_screen.dart"
      provides: "Complete settings UI with profile, logout, usage"
      min_lines: 100
  key_links:
    - from: "frontend/lib/screens/settings_screen.dart"
      to: "frontend/lib/providers/auth_provider.dart"
      via: "Consumer<AuthProvider> for profile display"
      pattern: "Consumer<AuthProvider>"
    - from: "frontend/lib/screens/settings_screen.dart"
      to: "/auth/usage"
      via: "HTTP fetch for token usage"
      pattern: "auth/usage"
---

<objective>
Complete the Settings page UI with user profile, logout confirmation, and token usage display.

Purpose: Users can view their account info (SET-01), log out with confirmation (SET-02), and see their monthly token budget usage (SET-05). This completes Phase 8 requirements.

Output:
- Enhanced AuthProvider with displayName field
- TokenUsage model for usage data
- Complete Settings screen with Account, Appearance, Usage, and Actions sections
- Logout confirmation dialog with proper async handling
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-settings-page-user-preferences/08-RESEARCH.md
@.planning/phases/08-settings-page-user-preferences/08-01-SUMMARY.md — Backend API changes

# Key existing files
@frontend/lib/providers/auth_provider.dart — To add displayName
@frontend/lib/services/auth_service.dart — To add getUsage() method
@frontend/lib/screens/settings_screen.dart — To expand with full UI
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance AuthProvider and AuthService for display name and usage</name>
  <files>
    frontend/lib/providers/auth_provider.dart
    frontend/lib/services/auth_service.dart
    frontend/lib/models/token_usage.dart
  </files>
  <action>
1. **Create TokenUsage model in `frontend/lib/models/token_usage.dart`:**
```dart
/// Token usage data model for monthly budget tracking.
library;

/// Monthly token usage statistics from /auth/usage endpoint
class TokenUsage {
  final double totalCost;
  final int totalRequests;
  final int totalInputTokens;
  final int totalOutputTokens;
  final String monthStart;
  final double budget;

  TokenUsage({
    required this.totalCost,
    required this.totalRequests,
    required this.totalInputTokens,
    required this.totalOutputTokens,
    required this.monthStart,
    required this.budget,
  });

  factory TokenUsage.fromJson(Map<String, dynamic> json) {
    return TokenUsage(
      totalCost: (json['total_cost'] as num).toDouble(),
      totalRequests: json['total_requests'] as int,
      totalInputTokens: json['total_input_tokens'] as int,
      totalOutputTokens: json['total_output_tokens'] as int,
      monthStart: json['month_start'] as String,
      budget: (json['budget'] as num).toDouble(),
    );
  }

  /// Total tokens used (input + output)
  int get totalTokens => totalInputTokens + totalOutputTokens;

  /// Cost as percentage of budget (0.0 to 1.0, clamped)
  double get costPercentage => (totalCost / budget).clamp(0.0, 1.0);

  /// Cost percentage as display string (e.g., "12.5%")
  String get costPercentageDisplay => '${(costPercentage * 100).toStringAsFixed(1)}%';
}
```

2. **Update AuthService in `frontend/lib/services/auth_service.dart`:**
   - Add `getUsage()` method after `getCurrentUser()`:
```dart
/// Get current month token usage for authenticated user
///
/// Returns TokenUsage object with monthly statistics
/// Throws exception if token invalid or request fails
Future<Map<String, dynamic>> getUsage() async {
  final token = await getStoredToken();
  if (token == null) {
    throw Exception('No authentication token found');
  }

  try {
    final response = await _dio.get(
      '$_baseUrl/auth/usage',
      options: Options(
        headers: {
          'Authorization': 'Bearer $token',
        },
      ),
    );

    return response.data as Map<String, dynamic>;
  } catch (e) {
    throw Exception('Failed to get usage info: $e');
  }
}
```

3. **Update AuthProvider in `frontend/lib/providers/auth_provider.dart`:**
   - Add `_displayName` field and getter after `_email`:
```dart
String? _displayName;

/// Current user display name (null if not authenticated or not available)
String? get displayName => _displayName;
```
   - In `checkAuthStatus()`, after `_email = user['email'] as String?;`:
```dart
_displayName = user['display_name'] as String?;
```
   - In `handleCallback()`, after `_email = user['email'] as String?;`:
```dart
_displayName = user['display_name'] as String?;
```
   - In `logout()`, add after `_email = null;`:
```dart
_displayName = null;
```

**Why in AuthProvider not separate UsageProvider:** Usage is simple fetch, doesn't need reactive state. Settings screen can fetch on demand. AuthProvider already handles user identity.
  </action>
  <verify>
    - File exists: `test -f frontend/lib/models/token_usage.dart && echo "Model exists"`
    - AuthProvider has displayName: `grep -n "displayName" frontend/lib/providers/auth_provider.dart`
    - AuthService has getUsage: `grep -n "getUsage" frontend/lib/services/auth_service.dart`
    - No syntax errors: `cd frontend && flutter analyze lib/models/token_usage.dart lib/providers/auth_provider.dart lib/services/auth_service.dart 2>&1 | head -20`
  </verify>
  <done>
    - TokenUsage model created with fromJson, totalTokens, costPercentage helpers
    - AuthService.getUsage() fetches /auth/usage with proper auth headers
    - AuthProvider stores and exposes displayName field
    - displayName populated on checkAuthStatus() and handleCallback()
    - displayName cleared on logout()
  </done>
</task>

<task type="auto">
  <name>Task 2: Expand Settings screen with profile, logout, and usage sections</name>
  <files>
    frontend/lib/screens/settings_screen.dart
  </files>
  <action>
Completely rewrite `settings_screen.dart` to include all sections:

**Structure:**
1. Account section - Profile tile with avatar (initials), display name, email
2. Appearance section - Dark mode toggle (existing)
3. Usage section - Token budget with LinearProgressIndicator
4. Actions section - Logout button with confirmation

**Key implementation details:**

1. **Import statements:**
```dart
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';

import '../models/token_usage.dart';
import '../providers/auth_provider.dart';
import '../providers/theme_provider.dart';
import '../services/auth_service.dart';
```

2. **Convert to StatefulWidget** for usage fetching:
   - Fetch usage in initState via WidgetsBinding.addPostFrameCallback
   - Store loading state and TokenUsage? result
   - Handle errors gracefully (show "Unable to load" message)

3. **Profile section pattern:**
```dart
Widget _buildProfileTile(BuildContext context, AuthProvider authProvider) {
  final email = authProvider.email ?? 'Unknown';
  final displayName = authProvider.displayName;
  final initials = _getInitials(displayName ?? email);

  return ListTile(
    leading: CircleAvatar(
      backgroundColor: Theme.of(context).colorScheme.primaryContainer,
      child: Text(
        initials,
        style: TextStyle(
          color: Theme.of(context).colorScheme.onPrimaryContainer,
          fontWeight: FontWeight.bold,
        ),
      ),
    ),
    title: Text(displayName ?? email),
    subtitle: displayName != null ? Text(email) : null,
  );
}

String _getInitials(String name) {
  final parts = name.split(RegExp(r'[\s@]+')).where((p) => p.isNotEmpty).toList();
  if (parts.isEmpty) return '?';
  if (parts.length == 1) return parts[0][0].toUpperCase();
  return '${parts[0][0]}${parts[1][0]}'.toUpperCase();
}
```

4. **Usage section with loading state:**
```dart
Widget _buildUsageTile(BuildContext context) {
  if (_isLoadingUsage) {
    return const ListTile(
      title: Text('Token Usage'),
      subtitle: LinearProgressIndicator(),
    );
  }

  if (_usage == null) {
    return const ListTile(
      title: Text('Token Usage'),
      subtitle: Text('Unable to load usage data'),
    );
  }

  final percentText = _usage!.costPercentageDisplay;
  final percentage = _usage!.costPercentage;

  return ListTile(
    title: const Text('Monthly Token Budget'),
    subtitle: Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const SizedBox(height: 8),
        LinearProgressIndicator(
          value: percentage,
          backgroundColor: Theme.of(context).colorScheme.surfaceContainerHighest,
          color: percentage > 0.8
              ? Colors.orange
              : Theme.of(context).colorScheme.primary,
        ),
        const SizedBox(height: 4),
        Text(
          '\$${_usage!.totalCost.toStringAsFixed(2)} / \$${_usage!.budget.toStringAsFixed(2)} used ($percentText)',
          style: Theme.of(context).textTheme.bodySmall,
        ),
      ],
    ),
  );
}
```

5. **Logout with confirmation dialog:**
```dart
Widget _buildLogoutTile(BuildContext context) {
  return ListTile(
    leading: Icon(Icons.logout, color: Theme.of(context).colorScheme.error),
    title: Text(
      'Log Out',
      style: TextStyle(color: Theme.of(context).colorScheme.error),
    ),
    onTap: () => _showLogoutConfirmation(context),
  );
}

Future<void> _showLogoutConfirmation(BuildContext context) async {
  final confirmed = await showDialog<bool>(
    context: context,
    barrierDismissible: false,
    builder: (BuildContext dialogContext) {
      return AlertDialog(
        title: const Text('Log Out'),
        content: const Text('Are you sure you want to log out?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(dialogContext).pop(false),
            child: const Text('Cancel'),
          ),
          TextButton(
            onPressed: () => Navigator.of(dialogContext).pop(true),
            style: TextButton.styleFrom(
              foregroundColor: Theme.of(dialogContext).colorScheme.error,
            ),
            child: const Text('Log Out'),
          ),
        ],
      );
    },
  );

  // CRITICAL: Check context.mounted before using context after await
  if (confirmed == true && context.mounted) {
    await context.read<AuthProvider>().logout();
    // GoRouter redirect handles navigation to login automatically
  }
}
```

**CRITICAL async safety:** Always check `context.mounted` after await before using context. Store provider reference before await if needed.

**Section order:** Account -> Appearance -> Usage -> Actions (destructive action last)
  </action>
  <verify>
    - File has all sections: `grep -c "SectionHeader\|_buildSectionHeader" frontend/lib/screens/settings_screen.dart` returns 4+
    - Has logout confirmation: `grep -n "showLogoutConfirmation\|AlertDialog" frontend/lib/screens/settings_screen.dart`
    - Has usage display: `grep -n "LinearProgressIndicator\|TokenUsage" frontend/lib/screens/settings_screen.dart`
    - No syntax errors: `cd frontend && flutter analyze lib/screens/settings_screen.dart 2>&1 | head -20`
  </verify>
  <done>
    - Settings screen has Account section with profile tile (avatar, name, email)
    - Settings screen has Appearance section with dark mode toggle (preserved from existing)
    - Settings screen has Usage section with progress bar and cost display
    - Settings screen has Actions section with logout button
    - Logout shows confirmation dialog before executing
    - context.mounted check prevents BuildContext async errors
    - Usage fetched on screen load with proper loading/error states
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Settings page with user profile, logout confirmation, and token usage display</what-built>
  <how-to-verify>
1. **Start backend:** `cd backend && python run.py`
2. **Start frontend:** `cd frontend && flutter run -d chrome`
3. **Login** with Google or Microsoft OAuth
4. **Navigate to Settings** (sidebar icon or menu)

**Verify SET-01 (Profile display):**
- [ ] Account section shows CircleAvatar with initials
- [ ] Display name shown (or email if no display name)
- [ ] Email shown as subtitle (if display name exists)

**Verify SET-02 (Logout with confirmation):**
- [ ] Tap "Log Out" button
- [ ] AlertDialog appears: "Are you sure you want to log out?"
- [ ] Tap "Cancel" - dialog closes, still logged in
- [ ] Tap "Log Out" again, then confirm
- [ ] Redirected to login screen
- [ ] Session cleared (refresh page shows login, not authenticated)

**Verify SET-05 (Token usage display):**
- [ ] Usage section shows "Monthly Token Budget"
- [ ] LinearProgressIndicator shows usage percentage
- [ ] Text shows "$X.XX / $50.00 used (Y%)"
- [ ] If no AI usage yet, shows $0.00 / $50.00 (0.0%)

**Verify theme toggle still works:**
- [ ] Dark mode toggle in Appearance section works
- [ ] Theme persists after logout/login

**Verify responsive layout:**
- [ ] Settings page looks good on mobile (narrow viewport)
- [ ] Settings page looks good on desktop (wide viewport)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Frontend phase verification:
1. Model exists: `test -f frontend/lib/models/token_usage.dart && echo "TokenUsage model exists"`
2. AuthProvider enhanced: `grep -c "displayName" frontend/lib/providers/auth_provider.dart` returns 4+
3. AuthService enhanced: `grep -c "getUsage\|auth/usage" frontend/lib/services/auth_service.dart` returns 2+
4. Settings complete: `wc -l frontend/lib/screens/settings_screen.dart` returns 100+ lines
5. Flutter analyze: `cd frontend && flutter analyze lib/screens/settings_screen.dart lib/providers/auth_provider.dart lib/services/auth_service.dart lib/models/token_usage.dart 2>&1 | grep -E "error|warning" | head -10`
</verification>

<success_criteria>
- User can see their profile (email, display name with initials avatar) on Settings page
- User can tap logout, sees confirmation dialog, can cancel or confirm
- Confirming logout clears session and redirects to login screen
- User can see monthly token usage with visual progress indicator
- Theme toggle still works correctly
- No BuildContext async errors on logout
- Settings page renders correctly on mobile and desktop
</success_criteria>

<output>
After completion, create `.planning/phases/08-settings-page-user-preferences/08-02-SUMMARY.md`
</output>

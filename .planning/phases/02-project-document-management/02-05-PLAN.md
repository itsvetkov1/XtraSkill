---
phase: 02-project-document-management
plan: 05
type: execute
wave: 3
depends_on: [02-02, 02-03, 02-04]
files_modified:
  - backend/tests/test_projects.py
  - backend/tests/test_documents.py
  - backend/tests/test_threads.py
  - frontend/test/integration/project_flow_test.dart
autonomous: false

must_haves:
  truths:
    - "All Phase 2 features work end-to-end"
    - "Project isolation verified (no cross-contamination)"
    - "Document encryption working (stored encrypted, decrypted on read)"
    - "FTS5 search returns relevant results"
    - "Cascade deletes work (deleting project removes documents and threads)"
  artifacts:
    - path: "backend/tests/test_projects.py"
      provides: "Integration tests for project API"
      exports: ["test_create_project", "test_list_projects", "test_update_project"]
      min_lines: 50
    - path: "backend/tests/test_documents.py"
      provides: "Integration tests for document API"
      exports: ["test_upload_document", "test_search_documents"]
      min_lines: 40
    - path: "backend/tests/test_threads.py"
      provides: "Integration tests for thread API"
      exports: ["test_create_thread", "test_list_threads"]
      min_lines: 30
  key_links:
    - from: "backend/tests/test_projects.py"
      to: "backend/app/routes/projects.py"
      via: "TestClient requests to /api/projects"
      pattern: "client\\.(get|post|put).*\\/api\\/projects"
    - from: "frontend/test/integration/project_flow_test.dart"
      to: "frontend/lib/screens/projects/project_list_screen.dart"
      via: "widget testing with pumpWidget"
      pattern: "testWidgets.*ProjectListScreen"
---

<objective>
Verify Phase 2 features through integration testing and human verification.

Purpose: Ensure all project, document, and thread features work end-to-end before moving to Phase 3. Validate that project isolation, encryption, search, and cascade deletes function correctly. Provides confidence that Phase 2 foundation is solid.

Output: Integration tests passing, human verification checkpoint completed with all success criteria validated.
</objective>

<execution_context>
@G:\.claude\get-shit-done\workflows\execute-plan.md
@G:\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@G:\git_repos\BA_assistant\.planning\REQUIREMENTS.md
@G:\git_repos\BA_assistant\.planning\ROADMAP.md

# Previous plans (all Wave 2 dependencies)
@G:\git_repos\BA_assistant\.planning\phases\02-project-document-management\02-02-PLAN.md
@G:\git_repos\BA_assistant\.planning\phases\02-project-document-management\02-03-PLAN.md
@G:\git_repos\BA_assistant\.planning\phases\02-project-document-management\02-04-PLAN.md

# Phase 1 testing patterns
@G:\git_repos\BA_assistant\backend\tests\
@G:\git_repos\BA_assistant\frontend\test\
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Backend Integration Tests</name>
  <files>
backend/tests/test_projects.py
backend/tests/test_documents.py
backend/tests/test_threads.py
  </files>
  <action>
**Create backend/tests/test_projects.py:**
- test_create_project: POST /api/projects with valid data → 201, returns project
- test_create_project_requires_auth: POST without token → 401
- test_list_projects: Create 2 projects, GET /api/projects → returns both
- test_list_projects_isolation: Create project with user1, list with user2 → empty list
- test_get_project: GET /api/projects/{id} → returns project with documents and threads
- test_get_project_not_found: GET with invalid id → 404
- test_update_project: PUT /api/projects/{id} → updates name and description
- test_update_project_not_owned: User2 tries to update User1's project → 404

**Create backend/tests/test_documents.py:**
- test_upload_document: POST with .txt file → 201, document created
- test_upload_document_invalid_type: POST with .pdf → 400
- test_upload_document_too_large: POST with >1MB file → 413
- test_list_documents: Upload 2 docs, GET /api/projects/{id}/documents → returns both
- test_get_document_content: GET /api/documents/{id} → returns decrypted content
- test_document_encrypted_at_rest: Upload doc, query database directly → content_encrypted is bytes, not plaintext
- test_search_documents: Upload doc with "requirements", search "req" → returns match with snippet
- test_document_isolation: Upload to project1, try to get from project2 → 404

**Create backend/tests/test_threads.py:**
- test_create_thread_with_title: POST with title → 201
- test_create_thread_without_title: POST with null title → 201
- test_list_threads_ordering: Create 3 threads, GET → ordered by created_at DESC
- test_get_thread: GET /api/threads/{id} → returns thread with empty messages array
- test_thread_isolation: Create in project1, try to access from project2 → 404

**Critical cascade delete test (in test_projects.py):**
- test_cascade_delete_project:
  1. Create project
  2. Upload document to project
  3. Create thread in project
  4. Delete project (DELETE endpoint to be added in Phase 3)
  5. Verify documents and threads are cascade deleted
  - For MVP without delete endpoint: Manually delete via SQLAlchemy session, verify cascade

Follow Phase 1 testing patterns from existing tests. Use TestClient, async test fixtures, create test users with valid JWTs.
  </action>
  <verify>
- Run `cd backend && pytest tests/test_projects.py -v` → all tests pass
- Run `cd backend && pytest tests/test_documents.py -v` → all tests pass
- Run `cd backend && pytest tests/test_threads.py -v` → all tests pass
- Check test coverage: `pytest --cov=app.routes tests/` → coverage >80% for routes/projects.py, routes/documents.py, routes/threads.py
- Verify isolation tests fail if user_id filtering removed (negative test)
  </verify>
  <done>
Integration tests passing for all Phase 2 APIs. Project isolation, document encryption, FTS5 search, and cascade deletes verified via automated tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Frontend Integration Tests</name>
  <files>
frontend/test/integration/project_flow_test.dart
  </files>
  <action>
Create frontend/test/integration/project_flow_test.dart:

**test_project_list_empty_state:**
- Mock ProjectProvider with empty list
- Pump ProjectListScreen
- Verify "No projects yet" text visible
- Verify create button visible

**test_project_list_displays_projects:**
- Mock ProjectProvider with 2 projects
- Pump ProjectListScreen
- Verify both project names visible
- Verify project descriptions visible

**test_create_project_dialog:**
- Pump ProjectListScreen
- Tap FloatingActionButton
- Verify dialog appears
- Enter project name and description
- Tap Create button
- Verify provider.createProject called with correct args

**test_project_detail_tabs:**
- Pump ProjectDetailScreen with project
- Verify "Documents" and "Threads" tabs visible
- Tap "Threads" tab
- Verify ThreadListScreen displayed

Follow Flutter widget testing patterns. Use mockito for provider mocking if needed, or use Provider.value for simpler mocks.

Note: Full E2E tests with actual API calls deferred (acceptable for MVP per STATE.md). These widget tests verify UI behavior.
  </action>
  <verify>
- Run `cd frontend && flutter test test/integration/project_flow_test.dart` → all tests pass
- Check test output shows 4+ passing tests
- Verify tests use find.text() and find.byType() for widget queries
- Verify tests use pump() and pumpAndSettle() for async rendering
  </verify>
  <done>
Frontend integration tests passing. UI behavior verified for project list, create dialog, and detail tabs.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 2 features: project management, document upload with encryption and search, thread management. All 14 Phase 2 requirements implemented (PROJ-01 through PROJ-05, DOC-01 through DOC-05, CONV-01, CONV-02, CONV-03, CONV-05).
  </what-built>
  <how-to-verify>
**Prerequisites:**
1. Backend running: `cd backend && uvicorn main:app --reload --port 8000`
2. Frontend running: `cd frontend && flutter run -d chrome`
3. Authenticated as test user (create account via OAuth if needed)

**Verification Steps:**

**Project Management (PROJ-01 to PROJ-05):**
1. Create project "Client Portal Redesign" with description "Modernize client-facing portal"
   - Expected: Project appears in list immediately
2. Create second project "Internal Tools Upgrade"
   - Expected: Both projects visible in list, newest first
3. Click "Client Portal Redesign" project
   - Expected: Project detail opens with "Documents" and "Threads" tabs
4. Update project name to "Customer Portal Redesign"
   - Expected: Name updates in list and detail view
5. Verify project isolation: Log in as different user (if multi-user testing available)
   - Expected: New user sees empty project list (no leak from first user)

**Document Management (DOC-01 to DOC-05):**
6. In "Client Portal Redesign" project, go to "Documents" tab
7. Upload text file "requirements.txt" with content "User must be able to reset password via email"
   - Expected: File uploads successfully, appears in document list
8. Upload markdown file "design-notes.md" with content "# Design Notes\n\nUse Material Design 3"
   - Expected: Second document appears in list
9. Try to upload .pdf file
   - Expected: File picker filters to .txt and .md only, or upload fails with error
10. Click "requirements.txt" in document list
    - Expected: Document viewer opens showing plaintext content
11. Search documents with query "password"
    - Expected: "requirements.txt" appears in search results with snippet highlighting "password"
12. Verify encryption: Open backend database `sqlite3 backend/ba_assistant.db "SELECT content_encrypted FROM documents LIMIT 1;"`
    - Expected: Shows binary/encrypted data (not plaintext "User must be able to reset password")

**Thread Management (CONV-01, CONV-02, CONV-03, CONV-05):**
13. In "Client Portal Redesign" project, go to "Threads" tab
14. Create thread with title "Login Flow Discussion"
    - Expected: Thread appears in list
15. Create thread without title (leave title empty)
    - Expected: Thread appears with "New Conversation" placeholder
16. Create third thread "Dashboard Features"
    - Expected: Three threads visible, newest first
17. Click "Login Flow Discussion" thread
    - Expected: Thread detail opens (may show placeholder "Coming in Phase 3" since messaging is Phase 3)
18. Verify thread isolation: Switch to "Internal Tools Upgrade" project
    - Expected: Thread list is empty (threads don't leak across projects)

**Cross-Platform Verification (PLAT-04, PLAT-05):**
19. On mobile breakpoint (<600px browser width): Verify drawer navigation works
20. On desktop breakpoint (>=900px): Verify master-detail layout for projects
21. Log out and log back in
    - Expected: All projects, documents, and threads persist (server-side storage)

**Pass Criteria:**
- All 21 verification steps pass
- No console errors in browser or backend logs
- Responsive layouts work at mobile and desktop breakpoints
- Data persists across sessions
- Project isolation confirmed (no cross-contamination)
  </how-to-verify>
  <resume-signal>
Type "approved" to confirm all verification steps passed, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
1. All backend integration tests pass (pytest)
2. All frontend widget tests pass (flutter test)
3. Human verification checkpoint completed successfully
4. All 14 Phase 2 requirements validated through testing
5. Project isolation confirmed (no data leakage between users/projects)
6. Document encryption verified (stored as bytes, decrypted on read)
7. FTS5 search returns relevant results with snippets
8. Responsive layouts work at mobile and desktop breakpoints
</verification>

<success_criteria>
- [ ] Backend: pytest shows all integration tests passing
- [ ] Frontend: flutter test shows all widget tests passing
- [ ] Human verification: All 21 steps completed successfully
- [ ] Project CRUD works end-to-end (create, list, view, update)
- [ ] Document upload works with encryption and decryption
- [ ] FTS5 search returns relevant documents with snippets
- [ ] Thread creation and listing works (empty message lists in MVP)
- [ ] Project isolation confirmed (no cross-project data leakage)
- [ ] Responsive UI works at mobile (<600px) and desktop (>=900px)
- [ ] Data persists across logout/login (server-side storage)
- [ ] All 14 Phase 2 requirements satisfied (PROJ-01 to PROJ-05, DOC-01 to DOC-05, CONV-01 to CONV-05)
- [ ] Phase 2 complete and ready for Phase 3 (AI-Powered Conversations)
</success_criteria>

<output>
After completion, create `.planning/phases/02-project-document-management/02-05-SUMMARY.md`
</output>

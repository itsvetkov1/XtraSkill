---
phase: 22-frontend-provider-ui
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - frontend/lib/screens/settings_screen.dart
  - frontend/lib/screens/conversation/widgets/provider_indicator.dart
  - frontend/lib/screens/conversation/conversation_screen.dart
  - frontend/lib/core/constants.dart
autonomous: false

must_haves:
  truths:
    - "User can select default provider from dropdown in Settings"
    - "Provider selection persists after app restart"
    - "Model indicator shows provider name with colored icon below chat messages"
    - "Indicator shows thread's bound provider, not current default"
  artifacts:
    - path: "frontend/lib/core/constants.dart"
      provides: "Provider configuration (names, colors, icons)"
      contains: "ProviderConfig"
    - path: "frontend/lib/screens/settings_screen.dart"
      provides: "Provider dropdown in Preferences section"
      contains: "DropdownButtonFormField"
    - path: "frontend/lib/screens/conversation/widgets/provider_indicator.dart"
      provides: "Provider indicator widget with colored icon"
      exports: ["ProviderIndicator"]
    - path: "frontend/lib/screens/conversation/conversation_screen.dart"
      provides: "Provider indicator between messages and input"
      contains: "ProviderIndicator"
  key_links:
    - from: "frontend/lib/screens/settings_screen.dart"
      to: "frontend/lib/providers/provider_provider.dart"
      via: "Consumer<ProviderProvider>"
      pattern: "Consumer.*ProviderProvider"
    - from: "frontend/lib/screens/conversation/widgets/provider_indicator.dart"
      to: "frontend/lib/core/constants.dart"
      via: "ProviderConfig lookup"
      pattern: "getProviderConfig"
    - from: "frontend/lib/screens/conversation/conversation_screen.dart"
      to: "frontend/lib/screens/conversation/widgets/provider_indicator.dart"
      via: "ProviderIndicator widget"
      pattern: "ProviderIndicator.*modelProvider"
---

<objective>
Add provider UI components to Settings and Conversation screens.

Purpose: Enable users to select their default LLM provider and see which provider is active in each conversation. Completes the v1.8 frontend provider UI requirements.

Output: Provider dropdown in Settings, colored provider indicator in conversation view, provider config constants.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-frontend-provider-ui/22-RESEARCH.md
@.planning/phases/22-frontend-provider-ui/22-CONTEXT.md
@.planning/phases/22-frontend-provider-ui/22-01-SUMMARY.md

# Files to modify
@frontend/lib/screens/settings_screen.dart
@frontend/lib/screens/conversation/conversation_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create provider constants with colors and display names</name>
  <files>frontend/lib/core/constants.dart</files>
  <action>
Create or update constants file with provider configuration:

1. Create `frontend/lib/core/constants.dart` (if doesn't exist):

```dart
/// Application constants and configuration.
library;

import 'package:flutter/material.dart';

/// Configuration for an LLM provider display.
class ProviderConfig {
  final String id;
  final String displayName;
  final Color color;
  final IconData icon;

  const ProviderConfig({
    required this.id,
    required this.displayName,
    required this.color,
    required this.icon,
  });
}

/// Provider configurations for UI display.
///
/// Colors from CONTEXT.md:
/// - Claude: Anthropic orange (#D97706)
/// - Gemini: Google blue (#4285F4)
/// - DeepSeek: Teal/cyan (#00B8D4)
class ProviderConfigs {
  static const anthropic = ProviderConfig(
    id: 'anthropic',
    displayName: 'Claude',
    color: Color(0xFFD97706),
    icon: Icons.smart_toy_outlined,
  );

  static const google = ProviderConfig(
    id: 'google',
    displayName: 'Gemini',
    color: Color(0xFF4285F4),
    icon: Icons.auto_awesome_outlined,
  );

  static const deepseek = ProviderConfig(
    id: 'deepseek',
    displayName: 'DeepSeek',
    color: Color(0xFF00B8D4),
    icon: Icons.psychology_outlined,
  );

  /// Get config by provider ID, falls back to anthropic if unknown.
  static ProviderConfig getConfig(String? providerId) {
    switch (providerId) {
      case 'google':
        return google;
      case 'deepseek':
        return deepseek;
      case 'anthropic':
      default:
        return anthropic;
    }
  }

  /// All available providers for dropdown.
  static const List<ProviderConfig> all = [anthropic, google, deepseek];
}
```
  </action>
  <verify>
File exists at frontend/lib/core/constants.dart with:
- ProviderConfig class
- ProviderConfigs with anthropic, google, deepseek static configs
- getConfig() static method
- Correct colors matching CONTEXT.md
  </verify>
  <done>
Provider constants defined with display names, colors (#D97706, #4285F4, #00B8D4), and icons.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add provider dropdown to Settings screen</name>
  <files>frontend/lib/screens/settings_screen.dart</files>
  <action>
Add provider selection dropdown to Settings:

1. Add imports at top:
   ```dart
   import '../core/constants.dart';
   import '../providers/provider_provider.dart';
   ```

2. In build() method, add a new "Preferences" section after "Appearance" section (before Usage):

After the Appearance Divider (around line 90), insert:

```dart
// Preferences Section
_buildSectionHeader(context, 'Preferences'),
Consumer<ProviderProvider>(
  builder: (context, providerProvider, _) {
    final currentConfig = ProviderConfigs.getConfig(providerProvider.selectedProvider);
    return ListTile(
      title: const Text('Default AI Provider'),
      subtitle: const Text('Provider for new conversations'),
      trailing: DropdownButton<String>(
        value: providerProvider.selectedProvider,
        underline: const SizedBox.shrink(),
        items: ProviderConfigs.all.map((config) {
          return DropdownMenuItem<String>(
            value: config.id,
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Icon(config.icon, color: config.color, size: 20),
                const SizedBox(width: 8),
                Text(config.displayName),
              ],
            ),
          );
        }).toList(),
        onChanged: (value) {
          if (value != null) {
            providerProvider.setProvider(value);
          }
        },
      ),
    );
  },
),
const Divider(),
```

Note: Use DropdownButton (not DropdownButtonFormField) with trailing placement for cleaner look. Silent save - no snackbar per CONTEXT.md.
  </action>
  <verify>
Run `flutter analyze` - no errors.
Check settings_screen.dart has:
- Import for constants.dart and provider_provider.dart
- Consumer<ProviderProvider> widget
- DropdownButton with three provider options
- onChanged calls setProvider
  </verify>
  <done>
Settings screen shows provider dropdown under Preferences section with Claude/Gemini/DeepSeek options.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ProviderIndicator widget and add to conversation screen</name>
  <files>frontend/lib/screens/conversation/widgets/provider_indicator.dart, frontend/lib/screens/conversation/conversation_screen.dart</files>
  <action>
Create ProviderIndicator widget:

1. Create `frontend/lib/screens/conversation/widgets/provider_indicator.dart`:

```dart
/// Provider indicator widget showing current model.
library;

import 'package:flutter/material.dart';

import '../../../core/constants.dart';

/// Displays the provider for a conversation with colored icon.
///
/// Shows provider name and icon above the chat input.
/// Per CONTEXT.md: icon gets color tint, text stays neutral.
class ProviderIndicator extends StatelessWidget {
  /// Provider ID (anthropic, google, deepseek)
  final String? provider;

  const ProviderIndicator({
    super.key,
    required this.provider,
  });

  @override
  Widget build(BuildContext context) {
    final config = ProviderConfigs.getConfig(provider);

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(
            config.icon,
            size: 16,
            color: config.color,
          ),
          const SizedBox(width: 8),
          Text(
            config.displayName,
            style: Theme.of(context).textTheme.bodySmall?.copyWith(
              color: Theme.of(context).colorScheme.onSurfaceVariant,
            ),
          ),
        ],
      ),
    );
  }
}
```

Update ConversationScreen:

2. Add import in conversation_screen.dart:
   ```dart
   import 'widgets/provider_indicator.dart';
   ```

3. In the Scaffold body Column (around line 173), add ProviderIndicator between Expanded message list and ChatInput:

```dart
body: Column(
  children: [
    // Error banner (existing)
    if (provider.error != null)
      MaterialBanner(...),  // existing code

    // Message list (existing)
    Expanded(
      child: _buildMessageList(provider),
    ),

    // Provider indicator - NEW
    ProviderIndicator(
      provider: provider.thread?.modelProvider,
    ),

    // Chat input (existing)
    ChatInput(
      onSend: provider.sendMessage,
      enabled: !provider.isStreaming,
    ),
  ],
),
```

The indicator reads from thread.modelProvider (bound provider), NOT from ProviderProvider (current default). This satisfies CONV-03.
  </action>
  <verify>
Run `flutter analyze` - no errors.
Check provider_indicator.dart exists with ProviderIndicator widget.
Check conversation_screen.dart imports and uses ProviderIndicator between message list and ChatInput.
  </verify>
  <done>
ProviderIndicator widget created and integrated into conversation screen, showing thread's bound provider with colored icon.
  </done>
</task>

</tasks>

<checkpoint type="human-verify" gate="blocking">
  <what-built>
    Complete provider UI: Settings dropdown and conversation indicator.
  </what-built>
  <how-to-verify>
    1. Start backend: `cd backend && python run.py`
    2. Start frontend: `cd frontend && flutter run -d chrome`
    3. Navigate to Settings
    4. Verify "Preferences" section appears with "Default AI Provider" dropdown
    5. Change provider to Gemini (blue icon)
    6. Close app completely and reopen - verify Gemini is still selected
    7. Create new conversation - note: backend should create with current default provider
    8. View conversation - verify indicator shows below messages with colored icon
    9. Change default to DeepSeek in Settings
    10. Return to existing conversation - indicator should still show original provider (not DeepSeek)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</checkpoint>

<verification>
1. Run `flutter analyze` from frontend directory - no errors
2. Settings screen shows provider dropdown with three options
3. Dropdown items show icon (colored) + name
4. Selection persists after app restart
5. Conversation screen shows provider indicator between messages and input
6. Indicator shows thread's modelProvider, not current default
</verification>

<success_criteria>
- User can change default provider in Settings via dropdown (SET-01)
- Provider selection persists across app restarts (SET-02)
- Model indicator displays in conversation with provider name (UI-01)
- Indicator uses provider-specific color on icon (UI-02)
- Existing conversation shows its bound provider, not current default (CONV-03)
</success_criteria>

<output>
After completion, create `.planning/phases/22-frontend-provider-ui/22-02-SUMMARY.md`
</output>

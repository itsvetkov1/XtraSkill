---
phase: 12-retry-failed-message
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/providers/conversation_provider.dart
  - frontend/lib/screens/conversation/conversation_screen.dart
autonomous: true

must_haves:
  truths:
    - "When AI request fails, error banner shows both 'Dismiss' and 'Retry' buttons"
    - "Tapping 'Retry' resends the original user message without retyping"
    - "Retry works for both network errors and API errors (SSE ErrorEvent)"
    - "After successful message, retry button is not available"
    - "Dismissing error clears retry state (user chose not to retry)"
  artifacts:
    - path: "frontend/lib/providers/conversation_provider.dart"
      provides: "Failed message state tracking and retry method"
      contains: "_lastFailedMessage"
    - path: "frontend/lib/screens/conversation/conversation_screen.dart"
      provides: "Retry button in error banner"
      contains: "provider.retryLastMessage"
  key_links:
    - from: "conversation_screen.dart"
      to: "ConversationProvider.retryLastMessage"
      via: "TextButton onPressed callback"
      pattern: "onPressed.*retryLastMessage"
    - from: "retryLastMessage()"
      to: "sendMessage()"
      via: "method call with stored content"
      pattern: "sendMessage.*content"
---

<objective>
Add retry functionality when AI requests fail, allowing users to resend their message without retyping.

Purpose: Users currently lose their message text when an AI request fails. This phase enables one-tap recovery from network errors and API failures.

Output: ConversationProvider with retry state tracking; error banner with "Dismiss | Retry" action buttons.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-retry-failed-message/12-RESEARCH.md

@frontend/lib/providers/conversation_provider.dart
@frontend/lib/screens/conversation/conversation_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add failed message state tracking and retry method to ConversationProvider</name>
  <files>frontend/lib/providers/conversation_provider.dart</files>
  <action>
Add retry state tracking to ConversationProvider:

1. Add new field after `_pendingDeleteThreadId`:
   ```dart
   /// Content of the last message that failed to send
   String? _lastFailedMessage;
   ```

2. Add getter after existing getters:
   ```dart
   /// Whether retry is available
   bool get canRetry => _lastFailedMessage != null && _error != null;
   ```

3. Modify `sendMessage()` method:
   - At the START (after the guard clause, before clearing _error):
     Set `_lastFailedMessage = content;`
   - In the `MessageCompleteEvent` handler (after adding assistant message):
     Set `_lastFailedMessage = null;` to clear on success
   - In the `ErrorEvent` handler: Keep `_lastFailedMessage` intact (already done by not clearing it)
   - In the catch block: Keep `_lastFailedMessage` intact (already done by not clearing it)

4. Add new method `retryLastMessage()` after `clearError()`:
   ```dart
   /// Retry the last failed message
   void retryLastMessage() {
     if (_lastFailedMessage == null) return;

     final content = _lastFailedMessage!;
     _lastFailedMessage = null;
     _error = null;

     // Remove the optimistic user message that was added on first attempt
     // to avoid duplicates when sendMessage adds it again
     if (_messages.isNotEmpty && _messages.last.role == MessageRole.user) {
       _messages.removeLast();
     }

     sendMessage(content);
   }
   ```

5. Modify `clearError()` to also clear retry state:
   ```dart
   /// Clear error message and failed message state
   void clearError() {
     _error = null;
     _lastFailedMessage = null;  // Dismiss means "I don't want to retry"
     notifyListeners();
   }
   ```

CRITICAL: The duplicate message prevention in `retryLastMessage()` is essential. Without it, the user would see their message twice after a successful retry.
  </action>
  <verify>
Run: `cd G:/git_repos/BA_assistant/frontend && flutter analyze lib/providers/conversation_provider.dart`
Expected: No errors or warnings.
Manual check: Verify `_lastFailedMessage` field exists, `canRetry` getter exists, `retryLastMessage()` method exists.
  </verify>
  <done>
ConversationProvider has:
- `_lastFailedMessage` field for storing failed message content
- `canRetry` getter returning true when retry is available
- `retryLastMessage()` method that removes duplicate, clears state, and resends
- `clearError()` clears both error and retry state
- `sendMessage()` sets `_lastFailedMessage` at start, clears on success
  </done>
</task>

<task type="auto">
  <name>Task 2: Add retry button to error banner UI</name>
  <files>frontend/lib/screens/conversation/conversation_screen.dart</files>
  <action>
Modify the error banner in the `build()` method to show a conditional "Retry" button.

Find the existing error banner (around line 117-127):
```dart
if (provider.error != null)
  MaterialBanner(
    content: SelectableText(provider.error!),
    backgroundColor: Theme.of(context).colorScheme.errorContainer,
    actions: [
      TextButton(
        onPressed: provider.clearError,
        child: const Text('Dismiss'),
      ),
    ],
  ),
```

Replace the `actions` array with:
```dart
actions: [
  TextButton(
    onPressed: provider.clearError,
    child: const Text('Dismiss'),
  ),
  if (provider.canRetry)
    TextButton(
      onPressed: provider.retryLastMessage,
      child: const Text('Retry'),
    ),
],
```

This shows:
- "Dismiss" always (clears error and retry state)
- "Retry" only when `canRetry` is true (failed message content is stored)

MaterialBanner automatically positions multiple actions - they'll appear side by side on wide screens or stacked on narrow screens.
  </action>
  <verify>
Run: `cd G:/git_repos/BA_assistant/frontend && flutter analyze lib/screens/conversation/conversation_screen.dart`
Expected: No errors or warnings.
Manual check: Verify the MaterialBanner actions array includes both Dismiss and conditional Retry buttons.
  </verify>
  <done>
Error banner shows:
- "Dismiss" button (always visible when error exists)
- "Retry" button (visible only when `provider.canRetry` is true)
- Both buttons call appropriate provider methods
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Static analysis:** Run `flutter analyze` on entire frontend - no errors
2. **Code inspection:**
   - `conversation_provider.dart` contains `_lastFailedMessage`, `canRetry`, `retryLastMessage()`
   - `conversation_screen.dart` MaterialBanner has conditional Retry button
3. **Build check:** Run `flutter build web --no-pub` to verify compiles without errors

Requirements coverage:
- RETRY-01: Error banner shows "Dismiss | Retry" - checked by UI code inspection
- RETRY-02: Retry resends last user message - checked by `retryLastMessage()` implementation
- RETRY-03: Failed message state tracked - checked by `_lastFailedMessage` field
- RETRY-04: Works for network/API errors - both error paths in sendMessage() preserve `_lastFailedMessage`
</verification>

<success_criteria>
1. ConversationProvider has retry state (`_lastFailedMessage`, `canRetry`, `retryLastMessage()`)
2. Error banner shows conditional "Retry" button when `canRetry` is true
3. Flutter analyze passes with no errors
4. Flutter build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/12-retry-failed-message/12-01-SUMMARY.md`
</output>

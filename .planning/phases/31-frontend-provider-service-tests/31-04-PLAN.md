---
phase: 31-frontend-provider-service-tests
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/test/unit/providers/theme_provider_test.dart
  - frontend/test/unit/providers/theme_provider_test.mocks.dart
  - frontend/test/unit/providers/navigation_provider_test.dart
  - frontend/test/unit/providers/navigation_provider_test.mocks.dart
  - frontend/test/unit/providers/provider_provider_test.dart
  - frontend/test/unit/providers/provider_provider_test.mocks.dart
  - frontend/test/unit/providers/document_column_provider_test.dart
autonomous: true

must_haves:
  truths:
    - "SharedPreferences-based providers test persistence correctly"
    - "ThemeProvider tests verify theme toggle and initial load"
    - "All four simple providers have comprehensive tests"
  artifacts:
    - path: "frontend/test/unit/providers/theme_provider_test.dart"
      provides: "ThemeProvider unit tests"
      min_lines: 80
    - path: "frontend/test/unit/providers/navigation_provider_test.dart"
      provides: "NavigationProvider unit tests"
      min_lines: 80
    - path: "frontend/test/unit/providers/provider_provider_test.dart"
      provides: "ProviderProvider unit tests"
      min_lines: 100
    - path: "frontend/test/unit/providers/document_column_provider_test.dart"
      provides: "DocumentColumnProvider unit tests"
      min_lines: 60
  key_links:
    - from: "theme_provider_test.dart"
      to: "ThemeProvider"
      via: "MockSharedPreferences injection"
      pattern: "MockSharedPreferences"
---

<objective>
Create unit tests for the four simpler providers: ThemeProvider, NavigationProvider, ProviderProvider, and DocumentColumnProvider.

Purpose: Cover FPROV-07 (ThemeProvider) and FPROV-08 (SettingsProvider - maps to NavigationProvider and ProviderProvider) requirements. These providers are simpler with SharedPreferences or pure state management.

Output: Four test files covering theme, navigation, LLM provider selection, and document column state.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-frontend-provider-service-tests/31-RESEARCH.md

# Source files under test
@frontend/lib/providers/theme_provider.dart
@frontend/lib/providers/navigation_provider.dart
@frontend/lib/providers/provider_provider.dart
@frontend/lib/providers/document_column_provider.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: ThemeProvider unit tests</name>
  <files>
    frontend/test/unit/providers/theme_provider_test.dart
  </files>
  <action>
Create unit tests for ThemeProvider following the research pattern for SharedPreferences testing.

Use @GenerateNiceMocks([MockSpec<SharedPreferences>()]) annotation.

Test groups to implement:
1. **ThemeProvider.load() factory**:
   - Loads saved dark mode preference (true)
   - Loads saved light mode preference (false)
   - Defaults to light mode when no preference saved (null)
   - Defaults to light mode when SharedPreferences read fails

2. **Initial State (via constructor)**:
   - isDarkMode matches constructor parameter
   - themeMode returns ThemeMode.dark when isDarkMode is true
   - themeMode returns ThemeMode.light when isDarkMode is false

3. **toggleTheme()**:
   - Toggles isDarkMode from false to true
   - Toggles isDarkMode from true to false
   - Persists immediately to SharedPreferences via setBool
   - Notifies listeners after toggle
   - Still toggles UI even if setBool fails (graceful degradation)

Test pattern for SharedPreferences:
```dart
@GenerateNiceMocks([MockSpec<SharedPreferences>()])
void main() {
  late MockSharedPreferences mockPrefs;

  setUp(() {
    mockPrefs = MockSharedPreferences();
  });

  test('loads saved dark mode preference', () async {
    when(mockPrefs.getBool('isDarkMode')).thenReturn(true);

    final provider = await ThemeProvider.load(mockPrefs);

    expect(provider.isDarkMode, isTrue);
    expect(provider.themeMode, equals(ThemeMode.dark));
  });

  test('toggleTheme persists and notifies', () async {
    when(mockPrefs.getBool('isDarkMode')).thenReturn(false);
    when(mockPrefs.setBool('isDarkMode', true)).thenAnswer((_) async => true);

    final provider = await ThemeProvider.load(mockPrefs);
    var notified = false;
    provider.addListener(() => notified = true);

    await provider.toggleTheme();

    expect(provider.isDarkMode, isTrue);
    verify(mockPrefs.setBool('isDarkMode', true)).called(1);
    expect(notified, isTrue);
  });
}
```
  </action>
  <verify>
Run: `cd frontend && flutter test test/unit/providers/theme_provider_test.dart -v`
All tests pass.
  </verify>
  <done>
ThemeProvider has unit test coverage for load, initial state, and toggle behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: NavigationProvider and ProviderProvider unit tests</name>
  <files>
    frontend/test/unit/providers/navigation_provider_test.dart
    frontend/test/unit/providers/provider_provider_test.dart
  </files>
  <action>
Create unit tests for NavigationProvider and ProviderProvider (both SharedPreferences-based).

**NavigationProvider tests:**
Use @GenerateNiceMocks([MockSpec<SharedPreferences>()]) annotation.

Test groups:
1. **NavigationProvider.load() factory**:
   - Loads saved expanded preference (true)
   - Loads saved collapsed preference (false)
   - Defaults to expanded when no preference saved
   - Defaults to expanded when read fails

2. **Initial State**:
   - isSidebarExpanded matches constructor parameter

3. **toggleSidebar()**:
   - Toggles isSidebarExpanded
   - Persists via setBool with key 'sidebarExpanded'
   - Notifies listeners
   - Still works if persistence fails

**ProviderProvider tests:**
Use @GenerateNiceMocks([MockSpec<SharedPreferences>()]) annotation.

Test groups:
1. **ProviderProvider.load() factory**:
   - Loads saved provider preference ('anthropic', 'google', 'deepseek')
   - Defaults to 'anthropic' when no preference saved
   - Defaults to 'anthropic' when saved value is invalid
   - Defaults to 'anthropic' when read fails

2. **Initial State**:
   - selectedProvider matches constructor parameter
   - providers getter returns unmodifiable list of ['anthropic', 'google', 'deepseek']

3. **setProvider()**:
   - Sets selectedProvider to valid provider
   - Throws ArgumentError for invalid provider
   - Persists via setString with key 'defaultLlmProvider'
   - Notifies listeners
   - Still works if persistence fails

Test pattern for setProvider validation:
```dart
test('throws ArgumentError for invalid provider', () async {
  when(mockPrefs.getString('defaultLlmProvider')).thenReturn(null);

  final provider = await ProviderProvider.load(mockPrefs);

  expect(
    () => provider.setProvider('invalid'),
    throwsA(isA<ArgumentError>()),
  );
});
```
  </action>
  <verify>
Run: `cd frontend && flutter test test/unit/providers/navigation_provider_test.dart test/unit/providers/provider_provider_test.dart -v`
All tests pass.
  </verify>
  <done>
NavigationProvider and ProviderProvider have unit test coverage.
  </done>
</task>

<task type="auto">
  <name>Task 3: DocumentColumnProvider unit tests and generate all mocks</name>
  <files>
    frontend/test/unit/providers/document_column_provider_test.dart
    frontend/test/unit/providers/theme_provider_test.mocks.dart
    frontend/test/unit/providers/navigation_provider_test.mocks.dart
    frontend/test/unit/providers/provider_provider_test.mocks.dart
  </files>
  <action>
Create unit tests for DocumentColumnProvider (no dependencies, pure state).

**DocumentColumnProvider tests:**
No mocks needed - this is the simplest provider with no external dependencies.

Test groups:
1. **Initial State**:
   - isExpanded starts as false (requirement: default collapsed)

2. **toggle()**:
   - Toggles from false to true
   - Toggles from true to false
   - Notifies listeners each time

3. **expand()**:
   - Sets isExpanded to true if currently false
   - Does NOT notify if already expanded (optimization)
   - Returns true after expand

4. **collapse()**:
   - Sets isExpanded to false if currently true
   - Does NOT notify if already collapsed (optimization)
   - Returns false after collapse

Test pattern for conditional notification:
```dart
test('expand does not notify if already expanded', () {
  final provider = DocumentColumnProvider();
  provider.expand(); // First expand

  var notifyCount = 0;
  provider.addListener(() => notifyCount++);

  provider.expand(); // Second expand (already expanded)

  expect(notifyCount, equals(0)); // Should not have notified
  expect(provider.isExpanded, isTrue);
});
```

**Generate all mocks:**
Run build_runner to generate mock files for all SharedPreferences-based providers:

```bash
cd frontend
flutter pub run build_runner build --delete-conflicting-outputs
```

Verify all mock files are created.
  </action>
  <verify>
Run: `cd frontend && flutter test test/unit/providers/document_column_provider_test.dart -v`
Run: `cd frontend && flutter test test/unit/providers/ -v`
All provider tests pass.
  </verify>
  <done>
DocumentColumnProvider has unit test coverage and all provider mocks are generated.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && flutter test test/unit/providers/theme_provider_test.dart` - ThemeProvider tests pass
2. `cd frontend && flutter test test/unit/providers/navigation_provider_test.dart` - NavigationProvider tests pass
3. `cd frontend && flutter test test/unit/providers/provider_provider_test.dart` - ProviderProvider tests pass
4. `cd frontend && flutter test test/unit/providers/document_column_provider_test.dart` - DocumentColumnProvider tests pass
5. Tests cover FPROV-07 and FPROV-08 requirements
</verification>

<success_criteria>
- ThemeProvider has 8+ test cases covering load and toggle
- NavigationProvider has 8+ test cases covering load and toggle
- ProviderProvider has 10+ test cases covering load, set, and validation
- DocumentColumnProvider has 8+ test cases covering toggle/expand/collapse
- All tests pass with `flutter test test/unit/providers/`
</success_criteria>

<output>
After completion, create `.planning/phases/31-frontend-provider-service-tests/31-04-SUMMARY.md`
</output>

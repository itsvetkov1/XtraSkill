---
phase: 31-frontend-provider-service-tests
plan: 05
type: execute
wave: 2
depends_on: []
files_modified:
  - frontend/test/unit/services/auth_service_test.dart
  - frontend/test/unit/services/auth_service_test.mocks.dart
  - frontend/test/unit/services/project_service_test.dart
  - frontend/test/unit/services/project_service_test.mocks.dart
autonomous: true

must_haves:
  truths:
    - "AuthService tests verify OAuth flow, token storage, and JWT validation"
    - "ProjectService tests verify CRUD HTTP operations with mocked Dio"
    - "Service tests mock Dio and FlutterSecureStorage dependencies"
  artifacts:
    - path: "frontend/test/unit/services/auth_service_test.dart"
      provides: "AuthService unit tests"
      min_lines: 200
    - path: "frontend/test/unit/services/project_service_test.dart"
      provides: "ProjectService unit tests"
      min_lines: 150
  key_links:
    - from: "auth_service_test.dart"
      to: "AuthService"
      via: "MockDio and MockFlutterSecureStorage injection"
      pattern: "MockDio.*MockFlutterSecureStorage"
---

<objective>
Create unit tests for AuthService and ProjectService.

Purpose: Cover FSVC-02 (AuthService) and partial FSVC-01 (ApiService - distributed across services) requirements. These services handle HTTP requests and need Dio mocking.

Output: Two service test files with comprehensive HTTP contract testing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-frontend-provider-service-tests/31-RESEARCH.md

# Source files under test
@frontend/lib/services/auth_service.dart
@frontend/lib/services/project_service.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: AuthService unit tests</name>
  <files>
    frontend/test/unit/services/auth_service_test.dart
  </files>
  <action>
Create comprehensive unit tests for AuthService.

Use @GenerateNiceMocks([MockSpec<Dio>(), MockSpec<FlutterSecureStorage>()]) annotation.

Test groups to implement:

1. **Constructor injection**:
   - Service accepts optional Dio, FlutterSecureStorage, baseUrl parameters
   - Defaults work correctly

2. **storeToken()**:
   - Writes token to secure storage with key 'auth_token'

3. **getStoredToken()**:
   - Reads and returns token from secure storage
   - Returns null if no token stored

4. **isTokenValid()**:
   - Returns false if no token stored
   - Returns false if token doesn't have 3 parts (invalid JWT format)
   - Returns false if token payload is not valid base64
   - Returns false if token is expired (exp < now)
   - Returns true if token is not expired

5. **getCurrentUser()**:
   - Throws exception if no token stored
   - Makes GET request to /auth/me with Bearer token header
   - Returns user data map on success
   - Throws exception on Dio error

6. **getUsage()**:
   - Throws exception if no token stored
   - Makes GET request to /auth/usage with Bearer token header
   - Returns usage data map on success
   - Throws exception on Dio error

7. **logout()**:
   - Deletes token from secure storage
   - Makes POST request to /auth/logout (optional, ignores errors)

8. **loginWithGoogle()/loginWithMicrosoft()** (partial):
   - Makes POST request to /auth/{provider}/initiate
   - Note: Can't fully test launchUrl in unit tests
   - Test that initiate endpoint is called correctly

Test pattern for Dio mocking:
```dart
test('getCurrentUser returns user data', () async {
  when(mockStorage.read(key: 'auth_token'))
      .thenAnswer((_) async => 'valid-token');
  when(mockDio.get(
    'http://test.api/auth/me',
    options: anyNamed('options'),
  )).thenAnswer((_) async => Response(
    data: {'id': '123', 'email': 'test@example.com'},
    statusCode: 200,
    requestOptions: RequestOptions(path: '/auth/me'),
  ));

  final result = await service.getCurrentUser();

  expect(result['id'], equals('123'));
  expect(result['email'], equals('test@example.com'));
});
```

For JWT validation testing, create test tokens:
```dart
String createTestJwt({required int expSeconds}) {
  final header = base64Url.encode(utf8.encode('{"alg":"HS256"}'));
  final payload = base64Url.encode(utf8.encode('{"exp":$expSeconds}'));
  return '$header.$payload.signature';
}

test('isTokenValid returns false for expired token', () async {
  final expiredToken = createTestJwt(
    expSeconds: DateTime.now().subtract(Duration(hours: 1)).millisecondsSinceEpoch ~/ 1000,
  );
  when(mockStorage.read(key: 'auth_token'))
      .thenAnswer((_) async => expiredToken);

  final result = await service.isTokenValid();

  expect(result, isFalse);
});
```
  </action>
  <verify>
Run: `cd frontend && flutter test test/unit/services/auth_service_test.dart -v`
All tests pass.
  </verify>
  <done>
AuthService has unit test coverage for token management, user info, and OAuth initiation.
  </done>
</task>

<task type="auto">
  <name>Task 2: ProjectService unit tests</name>
  <files>
    frontend/test/unit/services/project_service_test.dart
  </files>
  <action>
Create comprehensive unit tests for ProjectService.

First, read project_service.dart to understand its exact API, then create tests.

Use @GenerateNiceMocks([MockSpec<Dio>(), MockSpec<FlutterSecureStorage>()]) annotation.

Test groups to implement:

1. **getProjects()**:
   - Makes GET request to /projects with Bearer token
   - Returns list of Project objects parsed from response
   - Throws exception on error

2. **createProject()**:
   - Makes POST request to /projects with name and description
   - Returns created Project object
   - Handles null description correctly

3. **getProject()**:
   - Makes GET request to /projects/{id}
   - Returns Project object with details
   - Throws "not found" error on 404

4. **updateProject()**:
   - Makes PUT request to /projects/{id} with name and description
   - Returns updated Project object
   - Handles null description correctly

5. **deleteProject()**:
   - Makes DELETE request to /projects/{id}
   - Returns void on success
   - Throws exception on error

Test pattern for CRUD:
```dart
test('createProject sends POST with correct body', () async {
  when(mockStorage.read(key: 'auth_token'))
      .thenAnswer((_) async => 'test-token');
  when(mockDio.post(
    'http://test.api/projects',
    data: anyNamed('data'),
    options: anyNamed('options'),
  )).thenAnswer((_) async => Response(
    data: {
      'id': 'new-123',
      'name': 'Test Project',
      'description': 'Description',
      'created_at': DateTime.now().toIso8601String(),
      'updated_at': DateTime.now().toIso8601String(),
    },
    statusCode: 201,
    requestOptions: RequestOptions(path: '/projects'),
  ));

  final project = await service.createProject('Test Project', 'Description');

  expect(project.id, equals('new-123'));
  expect(project.name, equals('Test Project'));

  final captured = verify(mockDio.post(
    any,
    data: captureAnyNamed('data'),
    options: anyNamed('options'),
  )).captured;
  expect(captured.first['name'], equals('Test Project'));
  expect(captured.first['description'], equals('Description'));
});
```

Test 404 handling:
```dart
test('getProject throws on 404', () async {
  when(mockStorage.read(key: 'auth_token'))
      .thenAnswer((_) async => 'test-token');
  when(mockDio.get(any, options: anyNamed('options')))
      .thenThrow(DioException(
        type: DioExceptionType.badResponse,
        response: Response(
          statusCode: 404,
          requestOptions: RequestOptions(path: ''),
        ),
        requestOptions: RequestOptions(path: ''),
      ));

  expect(
    () => service.getProject('nonexistent'),
    throwsA(predicate((e) => e.toString().contains('not found') || e.toString().contains('404'))),
  );
});
```
  </action>
  <verify>
Run: `cd frontend && flutter test test/unit/services/project_service_test.dart -v`
All tests pass.
  </verify>
  <done>
ProjectService has unit test coverage for all CRUD operations.
  </done>
</task>

<task type="auto">
  <name>Task 3: Generate mocks and create services directory</name>
  <files>
    frontend/test/unit/services/auth_service_test.mocks.dart
    frontend/test/unit/services/project_service_test.mocks.dart
  </files>
  <action>
Create the test/unit/services/ directory structure and generate mocks.

```bash
cd frontend
mkdir -p test/unit/services
flutter pub run build_runner build --delete-conflicting-outputs
```

Verify:
1. test/unit/services/ directory exists
2. auth_service_test.mocks.dart contains MockDio and MockFlutterSecureStorage
3. project_service_test.mocks.dart contains MockDio and MockFlutterSecureStorage
4. Run service tests
  </action>
  <verify>
Run: `cd frontend && flutter test test/unit/services/ -v`
All service tests pass.
  </verify>
  <done>
Services directory created and mocks generated.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && flutter test test/unit/services/auth_service_test.dart` - AuthService tests pass
2. `cd frontend && flutter test test/unit/services/project_service_test.dart` - ProjectService tests pass
3. JWT validation tested with real token parsing logic
4. HTTP contracts verified with Dio mocking
5. Tests cover FSVC-02 requirement
</verification>

<success_criteria>
- AuthService has 15+ test cases covering token management, user info, and validation
- ProjectService has 10+ test cases covering CRUD operations
- Both services mock Dio and FlutterSecureStorage correctly
- 404 error handling tested
- All tests pass with `flutter test test/unit/services/`
</success_criteria>

<output>
After completion, create `.planning/phases/31-frontend-provider-service-tests/31-05-SUMMARY.md`
</output>

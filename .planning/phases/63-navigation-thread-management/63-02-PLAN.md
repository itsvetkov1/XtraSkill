---
phase: 63-navigation-thread-management
plan: 02
type: execute
wave: 2
depends_on: [63-01]
files_modified:
  - frontend/lib/screens/assistant/assistant_create_dialog.dart
  - frontend/lib/screens/assistant/assistant_list_screen.dart
  - frontend/lib/services/thread_service.dart
autonomous: true
requirements: [UI-02, UI-05]

must_haves:
  truths:
    - "User can create a new Assistant thread via a dialog with title (required) and description (optional) fields"
    - "After thread creation, user is navigated immediately to /assistant/:threadId conversation screen"
    - "New thread appears in the Assistant thread list"
    - "User can delete an Assistant thread via the visible trash icon on each thread item"
    - "Deleting a thread shows a bottom snackbar with Undo action and 10-second countdown"
    - "If deleting the currently-viewed thread, user is navigated back to /assistant"
    - "Undoing a delete restores the thread to the list"
  artifacts:
    - path: "frontend/lib/screens/assistant/assistant_create_dialog.dart"
      provides: "Simplified thread creation dialog for Assistant"
      contains: "AssistantCreateDialog"
    - path: "frontend/lib/screens/assistant/assistant_list_screen.dart"
      provides: "Thread list with create button wired to dialog and delete with undo"
      contains: "deleteThread"
  key_links:
    - from: "frontend/lib/screens/assistant/assistant_create_dialog.dart"
      to: "frontend/lib/services/thread_service.dart"
      via: "createAssistantThread API call"
      pattern: "createAssistantThread"
    - from: "frontend/lib/screens/assistant/assistant_create_dialog.dart"
      to: "frontend/lib/main.dart"
      via: "context.go('/assistant/${thread.id}') after creation"
      pattern: "context\\.go.*assistant"
    - from: "frontend/lib/screens/assistant/assistant_list_screen.dart"
      to: "frontend/lib/providers/thread_provider.dart"
      via: "ThreadProvider.deleteThread for undo behavior"
      pattern: "deleteThread"
---

<objective>
Complete thread creation and deletion flows for the Assistant section, including the simplified creation dialog (no project/mode selectors), post-create navigation, and delete with undo/navigate-away behavior.

Purpose: Users need to create and manage Assistant threads independently. The creation dialog is intentionally simpler than BA thread creation (no project, no mode), and deletion follows the existing 10-second undo pattern with the addition of navigating away when deleting the currently-viewed thread.

Output: Working end-to-end thread creation and deletion for the Assistant section.
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/63-navigation-thread-management/63-CONTEXT.md
@.planning/phases/63-navigation-thread-management/63-01-SUMMARY.md

# Key source files:
@frontend/lib/screens/assistant/assistant_list_screen.dart
@frontend/lib/screens/threads/thread_create_dialog.dart
@frontend/lib/services/thread_service.dart
@frontend/lib/providers/thread_provider.dart
@frontend/lib/models/thread.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AssistantCreateDialog and wire thread creation with post-create navigation</name>
  <files>
    frontend/lib/screens/assistant/assistant_create_dialog.dart
    frontend/lib/screens/assistant/assistant_list_screen.dart
    frontend/lib/services/thread_service.dart
  </files>
  <action>
**thread_service.dart changes:**

1. Add `createAssistantThread()` method to ThreadService. Uses the global thread creation endpoint with thread_type='assistant':
   ```dart
   /// Create a new Assistant thread
   ///
   /// [title] - Required title for the thread
   /// [description] - Optional description
   ///
   /// Returns created Thread object.
   /// Always sets thread_type='assistant' and no project_id.
   Future<Thread> createAssistantThread({
     required String title,
     String? description,
   }) async {
     try {
       final headers = await _getAuthHeaders();
       final data = <String, dynamic>{
         'title': title,
         'thread_type': 'assistant',
       };
       if (description != null && description.isNotEmpty) {
         data['description'] = description;
       }

       final response = await _dio.post(
         '/api/threads',
         options: Options(headers: headers),
         data: data,
       );

       return Thread.fromJson(response.data as Map<String, dynamic>);
     } on DioException catch (e) {
       if (e.response?.statusCode == 401 || e.response?.statusCode == 403) {
         throw Exception('Authentication required');
       } else if (e.response?.statusCode == 400) {
         throw Exception('Invalid thread data');
       }
       throw Exception('Failed to create assistant thread: ${e.message}');
     }
   }
   ```

**assistant_create_dialog.dart creation:**

2. Create new file at `frontend/lib/screens/assistant/assistant_create_dialog.dart`. Model after ThreadCreateDialog but simplified per locked decisions:

   **Dialog structure:**
   - AlertDialog with title "New Conversation"
   - Form with two fields:
     a. **Title** — TextFormField, required (validator: must not be empty, max 255 chars), placeholder hint: "e.g., Debug CSS Layout" (Claude's discretion for exact text), autofocus: true
     b. **Description** — TextFormField, optional, multi-line (maxLines: 3), placeholder hint: "Optional details about this conversation"
   - No project selector (Assistant threads are project-less by design)
   - No mode selector (mode is BA-specific feature)
   - Cancel and Create buttons in actions row
   - Loading spinner on Create button during API call (same pattern as ThreadCreateDialog)

   **Static show() method** (matches ModeChangeDialog pattern for consistency):
   ```dart
   static Future<Thread?> show(BuildContext context) {
     return showDialog<Thread>(
       context: context,
       builder: (context) => const AssistantCreateDialog(),
     );
   }
   ```

   **Creation flow:**
   ```dart
   Future<void> _createThread() async {
     if (!_formKey.currentState!.validate()) return;
     setState(() => _isCreating = true);

     try {
       final threadService = ThreadService();
       final thread = await threadService.createAssistantThread(
         title: _titleController.text.trim(),
         description: _descriptionController.text.trim().isEmpty
             ? null
             : _descriptionController.text.trim(),
       );

       if (mounted) {
         Navigator.of(context).pop(thread); // Return thread to caller
       }
     } catch (e) {
       if (mounted) {
         setState(() => _isCreating = false);
         ScaffoldMessenger.of(context).showSnackBar(
           SnackBar(
             content: Text('Failed to create conversation: ${e.toString()}'),
             backgroundColor: Theme.of(context).colorScheme.error,
           ),
         );
       }
     }
   }
   ```

   **Title field validation** — per locked decision, title is required (not optional like BA threads):
   ```dart
   validator: (value) {
     if (value == null || value.trim().isEmpty) {
       return 'Title is required';
     }
     if (value.length > 255) {
       return 'Title must be 255 characters or less';
     }
     return null;
   },
   ```

**assistant_list_screen.dart changes:**

3. Wire `_showCreateDialog()` method to open AssistantCreateDialog and navigate on success:
   ```dart
   Future<void> _showCreateDialog() async {
     final thread = await AssistantCreateDialog.show(context);
     if (thread != null && mounted) {
       // Add to local list (optimistic)
       setState(() {
         _threads.insert(0, thread);
       });
       // Navigate to conversation screen
       context.go('/assistant/${thread.id}');
     }
   }
   ```
   Add import for the dialog file at top of assistant_list_screen.dart.
  </action>
  <verify>
1. Run `cd /Users/a1testingmac/projects/XtraSkill/frontend && flutter analyze` — no analysis errors.
2. Verify file exists: `ls lib/screens/assistant/assistant_create_dialog.dart`.
3. Grep for title validation: `grep 'required' lib/screens/assistant/assistant_create_dialog.dart` shows title required.
4. Grep for no project field: `grep -c 'project' lib/screens/assistant/assistant_create_dialog.dart` should be 0 or very low (only in comments).
5. Grep for post-creation navigation: `grep 'context.go.*assistant' lib/screens/assistant/assistant_list_screen.dart` shows navigation.
6. Grep for thread_type=assistant: `grep 'thread_type.*assistant' lib/services/thread_service.dart` shows createAssistantThread sets type.
  </verify>
  <done>
- AssistantCreateDialog exists with title (required) and description (optional) fields
- No project selector or mode selector in the dialog
- Title validation enforces non-empty with 255 char limit
- After creation, dialog returns Thread object and caller navigates to /assistant/:threadId
- New thread inserted at top of local list before navigation
- createAssistantThread() method in ThreadService sends thread_type='assistant' with no project_id
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire delete with undo snackbar and navigate-away for current thread</name>
  <files>
    frontend/lib/screens/assistant/assistant_list_screen.dart
  </files>
  <action>
Update the `_deleteThread()` method in AssistantListScreen to properly implement the full delete-with-undo behavior per locked decisions.

**Requirements from locked decisions:**
- Delete triggered via visible trash/delete icon (already in place from 63-01)
- Undo via bottom snackbar with "Undo" action and 10-second countdown
- If deleting the currently-viewed thread: navigate back to /assistant thread list
- Thread is soft-deleted during undo window, hard-deleted after timeout

**Implementation approach:** Don't use ThreadProvider.deleteThread directly (it manages its own _threads list which is separate from our local state). Instead, implement the undo pattern locally in AssistantListScreen, following the same pattern:

1. **Add state fields** for pending delete:
   ```dart
   Thread? _pendingDelete;
   int _pendingDeleteIndex = 0;
   Timer? _deleteTimer;
   ```
   Import `dart:async` for Timer.

2. **Implement `_deleteThread()`** with undo support:
   ```dart
   Future<void> _deleteThread(Thread thread) async {
     final index = _threads.indexWhere((t) => t.id == thread.id);
     if (index == -1) return;

     // Commit any previous pending delete immediately
     if (_pendingDelete != null) {
       await _commitPendingDelete();
     }

     // Optimistically remove from list
     setState(() {
       _pendingDelete = _threads[index];
       _pendingDeleteIndex = index;
       _threads.removeAt(index);
     });

     // Check if we need to navigate away (deleting currently-viewed thread)
     // This applies when user is on /assistant/:threadId and deletes from sidebar or list
     // On the list screen itself, the thread is just in the list — no "currently viewed" concept
     // The navigate-away behavior will be relevant when the conversation screen has a delete action
     // For the list screen: just remove and show undo

     if (mounted) {
       ScaffoldMessenger.of(context).clearSnackBars();
       ScaffoldMessenger.of(context).showSnackBar(
         SnackBar(
           content: const Text('Thread deleted'),
           duration: const Duration(seconds: 10),
           action: SnackBarAction(
             label: 'Undo',
             onPressed: _undoDelete,
           ),
         ),
       );
     }

     _deleteTimer?.cancel();
     _deleteTimer = Timer(const Duration(seconds: 10), () {
       _commitPendingDelete();
     });
   }

   void _undoDelete() {
     _deleteTimer?.cancel();
     if (_pendingDelete != null) {
       setState(() {
         final insertIndex = _pendingDeleteIndex.clamp(0, _threads.length);
         _threads.insert(insertIndex, _pendingDelete!);
         _pendingDelete = null;
       });
     }
   }

   Future<void> _commitPendingDelete() async {
     if (_pendingDelete == null) return;
     final threadToDelete = _pendingDelete!;
     final originalIndex = _pendingDeleteIndex;
     _pendingDelete = null;

     try {
       final threadService = ThreadService();
       await threadService.deleteThread(threadToDelete.id);
     } catch (e) {
       // Rollback on failure
       if (mounted) {
         setState(() {
           final insertIndex = originalIndex.clamp(0, _threads.length);
           _threads.insert(insertIndex, threadToDelete);
         });
         ScaffoldMessenger.of(context).showSnackBar(
           SnackBar(
             content: Text('Failed to delete thread: $e'),
             backgroundColor: Theme.of(context).colorScheme.error,
           ),
         );
       }
     }
   }
   ```

3. **Dispose timer** in dispose():
   ```dart
   @override
   void dispose() {
     _deleteTimer?.cancel();
     super.dispose();
   }
   ```

4. **Navigate-away for conversation screen:** When a user is viewing `/assistant/:threadId` and triggers delete from within the conversation (e.g., via AppBar menu), they should navigate to `/assistant`. This behavior is handled at the conversation screen level (which is reused from existing code). However, the ConversationScreen currently navigates based on projectId — for project-less threads it stays on the screen. We need to ensure the AssistantListScreen's delete action, when triggered while a thread is currently navigated-to, performs the navigate-away.

   Since the list screen itself is the `/assistant` route and the conversation is `/assistant/:threadId`, deleting from the list screen while viewing the list is straightforward (thread just disappears). The navigate-away requirement applies when we're ON the conversation screen and delete it — but that's the conversation screen's responsibility, not the list screen's.

   For the list screen: the delete flow above is complete. The conversation-screen delete-and-navigate-away will work through existing ThreadProvider + route change in the StatefulShellBranch.

5. **Remove the simple delete stub** from Plan 63-01 (if any) and replace with the full undo implementation above. If Plan 63-01 already placed a simple `_deleteThread()`, replace its body entirely.
  </action>
  <verify>
1. Run `cd /Users/a1testingmac/projects/XtraSkill/frontend && flutter analyze` — no analysis errors.
2. Grep for undo: `grep 'Undo' lib/screens/assistant/assistant_list_screen.dart` shows undo button in snackbar.
3. Grep for timer: `grep 'Timer' lib/screens/assistant/assistant_list_screen.dart` shows 10-second timer.
4. Grep for commit delete: `grep 'commitPendingDelete' lib/screens/assistant/assistant_list_screen.dart` shows hard delete method.
5. Grep for dispose: `grep 'deleteTimer.*cancel' lib/screens/assistant/assistant_list_screen.dart` shows timer cleanup.
  </verify>
  <done>
- Delete triggered via visible trash icon shows snackbar with "Undo" action
- Snackbar has 10-second duration before hard delete
- Pressing Undo restores thread to list at original position
- Failed delete rolls back (thread reappears in list)
- Timer properly cancelled on dispose
- Thread immediately removed from list (optimistic UI)
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes with no errors
2. Click "New Thread" → dialog opens with title (required) and description (optional)
3. Enter title, click Create → new thread appears in list, user navigated to /assistant/:threadId
4. Navigate back to /assistant → thread visible in list
5. Click delete icon → thread removed from list, snackbar appears with "Undo" and countdown
6. Click "Undo" → thread restored to list
7. Wait 10 seconds without Undo → thread permanently deleted (refresh confirms)
8. Creating a thread and refreshing: thread persists (API stored it)
</verification>

<success_criteria>
- Thread creation dialog has only title + description fields (no project, no mode)
- Title is required, description is optional
- Post-creation navigation goes to /assistant/:threadId
- Delete shows 10-second undo snackbar
- Undo restores thread
- Delete failure rolls back UI
- All existing thread management (BA threads) unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/63-navigation-thread-management/63-02-SUMMARY.md`
</output>

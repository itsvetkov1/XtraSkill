---
phase: 05-cross-platform-polish-launch
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/pubspec.yaml
  - frontend/lib/screens/projects/project_list_screen.dart
  - frontend/lib/screens/documents/document_list_screen.dart
  - frontend/lib/screens/threads/thread_list_screen.dart
  - frontend/lib/screens/conversation/conversation_screen.dart
  - frontend/lib/main.dart
  - frontend/lib/providers/project_provider.dart
  - frontend/lib/providers/document_provider.dart
  - frontend/lib/providers/thread_provider.dart
autonomous: true

must_haves:
  truths:
    - User sees skeleton placeholders while data loads (no blank screens)
    - User sees helpful error messages with recovery actions when requests fail
    - App never crashes - all errors caught and handled gracefully
  artifacts:
    - path: "frontend/pubspec.yaml"
      provides: "skeletonizer package dependency"
      contains: "skeletonizer"
    - path: "frontend/lib/main.dart"
      provides: "Global error handlers"
      contains: "FlutterError.onError"
      min_lines: 150
    - path: "frontend/lib/screens/projects/project_list_screen.dart"
      provides: "Skeleton loader for project list"
      contains: "Skeletonizer"
    - path: "frontend/lib/screens/conversation/conversation_screen.dart"
      provides: "Error handling with SnackBar recovery"
      contains: "ScaffoldMessenger"
  key_links:
    - from: "frontend/lib/screens/projects/project_list_screen.dart"
      to: "ProjectProvider.isLoading"
      via: "Skeletonizer enabled flag"
      pattern: "Skeletonizer\\(\\s*enabled:\\s*provider\\.isLoading"
    - from: "frontend/lib/main.dart"
      to: "FlutterError.onError"
      via: "Global error handler registration"
      pattern: "FlutterError\\.onError\\s*="
---

<objective>
Add professional loading states and error handling to prevent blank screens and provide graceful failure recovery across all user-facing screens, plus implement responsive design breakpoints for mobile layouts.

Purpose: Eliminate jarring blank screens during data loads and provide clear feedback when operations fail, ensuring professional UX that meets production quality standards. Enable mobile-first responsive layouts that adapt to different screen sizes.

Output: All list screens display skeleton loaders during fetch, all error scenarios show Material 3 error UI with recovery actions, global error handlers prevent crashes, and responsive layouts adapt sidebar to drawer on mobile.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-cross-platform-polish-launch/05-RESEARCH.md

# Current UI state (from Phase 2-3)
@frontend/lib/screens/projects/project_list_screen.dart
@frontend/lib/screens/documents/document_list_screen.dart
@frontend/lib/screens/threads/thread_list_screen.dart
@frontend/lib/screens/conversation/conversation_screen.dart
@frontend/lib/main.dart

# Provider pattern for loading states
@frontend/lib/providers/project_provider.dart
@frontend/lib/providers/document_provider.dart
@frontend/lib/providers/thread_provider.dart
@frontend/lib/providers/conversation_provider.dart
</context>

<tasks>

<task type="auto">
  <name>Add skeleton loaders to all list screens with responsive layout</name>
  <files>
    frontend/pubspec.yaml
    frontend/lib/screens/projects/project_list_screen.dart
    frontend/lib/screens/documents/document_list_screen.dart
    frontend/lib/screens/threads/thread_list_screen.dart
    frontend/lib/providers/project_provider.dart
    frontend/lib/providers/document_provider.dart
    frontend/lib/providers/thread_provider.dart
  </files>
  <action>
    Install skeletonizer package (version 2.1.2+):
    - Add `skeletonizer: ^2.1.2` to pubspec.yaml dependencies
    - Run `flutter pub get`

    **FIRST: Verify/add isLoading flag to providers**
    Check ProjectProvider, DocumentProvider, ThreadProvider for `isLoading` boolean property.
    If missing, add:
    ```dart
    bool _isLoading = false;
    bool get isLoading => _isLoading;

    // Set to true before async calls, false after completion
    Future<void> loadData() async {
      _isLoading = true;
      notifyListeners();
      try {
        // ... existing fetch logic
      } finally {
        _isLoading = false;
        notifyListeners();
      }
    }
    ```

    Update project list screen:
    - Import skeletonizer package
    - Wrap ListView.builder with Skeletonizer widget
    - Set `enabled: provider.isLoading` (toggle skeleton on/off based on state)
    - When loading, show 5 placeholder Project objects with fake data (Project.placeholder())
    - When loaded, show actual projects from provider.projects
    - Keep existing empty state UI when projects list is empty AND not loading

    Update document list screen:
    - Same pattern: Skeletonizer wrapping ListView with enabled: provider.isLoading
    - Show 3 placeholder documents during load
    - Preserve empty state ("No documents uploaded yet") when not loading

    Update thread list screen:
    - Same pattern: Skeletonizer wrapping ListView with enabled: provider.isLoading
    - Show 4 placeholder threads during load
    - Preserve empty state ("No conversations yet") when not loading

    **Implement responsive layout:**
    - Wrap main layout with LayoutBuilder to detect screen width
    - At <600px width: Hide permanent sidebar, show AppBar with hamburger menu (IconButton with Icons.menu)
    - AppBar hamburger opens Drawer widget with navigation items
    - At ≥600px width: Show permanent sidebar as-is (current behavior)
    - Use MediaQuery.of(context).size.width to detect breakpoint
    - Implement grid layouts for card-based screens (2 columns at >900px, 1 column at <900px)

    Pattern to follow (from RESEARCH.md):
    ```dart
    return Skeletonizer(
      enabled: provider.isLoading,
      child: ListView.builder(
        itemCount: provider.isLoading ? 5 : provider.items.length,
        itemBuilder: (context, index) {
          final item = provider.isLoading
            ? Item.placeholder()
            : provider.items[index];
          return ListTile(title: Text(item.name));
        },
      ),
    );
    ```

    Responsive layout pattern:
    ```dart
    LayoutBuilder(
      builder: (context, constraints) {
        final isMobile = constraints.maxWidth < 600;
        return Scaffold(
          appBar: isMobile ? AppBar(
            leading: IconButton(
              icon: Icon(Icons.menu),
              onPressed: () => _scaffoldKey.currentState?.openDrawer(),
            ),
          ) : null,
          drawer: isMobile ? Drawer(child: NavigationItems()) : null,
          body: Row(
            children: [
              if (!isMobile) Sidebar(),
              Expanded(child: Content()),
            ],
          ),
        );
      },
    )
    ```

    Do NOT add placeholders to models yet - hard-code placeholder data inline for MVP.
  </action>
  <verify>
    1. flutter pub get succeeds
    2. flutter analyze shows no issues
    3. flutter build web --release succeeds
    4. Grep for Skeletonizer usage: `grep -r "Skeletonizer" frontend/lib/screens/`
    5. Verify enabled flag connects to provider.isLoading in all 3 screens
    6. Grep for isLoading in providers: `grep "isLoading" frontend/lib/providers/*.dart`
    7. Verify responsive layout: `grep "LayoutBuilder\|MediaQuery.*width" frontend/lib/screens/`
  </verify>
  <done>
    - skeletonizer package added to pubspec.yaml
    - isLoading boolean property added to ProjectProvider, DocumentProvider, ThreadProvider if missing
    - ProjectListScreen shows skeleton cards when provider.isLoading == true
    - DocumentListScreen shows skeleton list when provider.isLoading == true
    - ThreadListScreen shows skeleton list when provider.isLoading == true
    - All screens show real data when provider.isLoading == false
    - Empty states preserved for when list is empty and not loading
    - Responsive layout implemented: sidebar → drawer at <600px width
    - Grid layouts adapt to screen size (2 columns >900px, 1 column <900px)
    - No horizontal scrolling at any screen width
  </done>
</task>

<task type="auto">
  <name>Add Material 3 error handling with recovery actions</name>
  <files>
    frontend/lib/screens/projects/project_list_screen.dart
    frontend/lib/screens/documents/document_list_screen.dart
    frontend/lib/screens/threads/thread_list_screen.dart
    frontend/lib/screens/conversation/conversation_screen.dart
  </files>
  <action>
    Add error feedback to all screens with API calls using Material 3 patterns (SnackBar for non-blocking, AlertDialog for blocking).

    For each screen, check if provider has error state (provider.errorMessage or similar). If error exists:

    Project/Document/Thread list screens (non-blocking errors):
    - Add WidgetsBinding.instance.addPostFrameCallback in build() when errorMessage is present
    - Show SnackBar with error message: "Failed to load [projects|documents|threads]. Check your connection."
    - Add SnackBarAction with label "Retry" that calls provider.load() method
    - Duration: 5 seconds
    - Call provider.clearError() after showing SnackBar to prevent duplicate displays

    Conversation screen (already has error banner):
    - Review existing error handling in ConversationProvider
    - Ensure streaming errors show SnackBar with "Retry" action that resends last message
    - Network errors should show "Network error. Check your connection." with retry

    Pattern from RESEARCH.md:
    ```dart
    if (provider.errorMessage != null) {
      WidgetsBinding.instance.addPostFrameCallback((_) {
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(provider.errorMessage!),
              action: SnackBarAction(
                label: 'Retry',
                onPressed: () => provider.retryLastAction(),
              ),
              duration: Duration(seconds: 5),
            ),
          );
          provider.clearError();
        }
      });
    }
    ```

    Ensure all providers have clearError() method. If missing, add simple implementation:
    ```dart
    void clearError() {
      _errorMessage = null;
      notifyListeners();
    }
    ```

    Do NOT show errors for 401 Unauthorized (those should trigger logout via AuthProvider).
  </action>
  <verify>
    1. flutter analyze passes
    2. Grep for SnackBar usage: `grep -r "SnackBar" frontend/lib/screens/`
    3. Grep for clearError calls: `grep -r "clearError" frontend/lib/screens/`
    4. All providers have clearError method: `grep -r "clearError" frontend/lib/providers/`
  </verify>
  <done>
    - All list screens show SnackBar with retry action when provider.errorMessage is set
    - Conversation screen shows SnackBar for streaming errors with retry
    - All providers have clearError() method to prevent duplicate error displays
    - Errors clear after SnackBar is shown to avoid showing same error twice
    - 401 errors do not show SnackBar (handled by auth logout flow)
  </done>
</task>

<task type="auto">
  <name>Add global error handlers to prevent crashes</name>
  <files>
    frontend/lib/main.dart
  </files>
  <action>
    Configure global error handlers in main() before runApp() to catch uncaught errors and prevent app crashes.

    Add FlutterError.onError handler:
    - Capture Flutter framework errors (build/layout/paint)
    - Call FlutterError.presentError(details) to preserve console logging in debug mode
    - In release mode (kReleaseMode), log to console with print() for debugging
    - Do NOT integrate crash reporting service (Sentry/Firebase) in MVP - defer to post-launch

    Add PlatformDispatcher.instance.onError handler:
    - Capture async errors and platform channel errors
    - Print error and stack trace to console
    - Return true to mark error as handled (prevents crash)

    Add ErrorWidget.builder:
    - Replace Flutter's red debug screen with user-friendly error widget
    - Show Icon(Icons.error_outline, size: 48), gray color
    - Text: "Something went wrong"
    - Text: "Please restart the app"
    - Use Center and Column layout for centered error display
    - No restart button needed (user can refresh browser on web, close/reopen on mobile)

    Pattern from RESEARCH.md:
    ```dart
    Future<void> main() async {
      WidgetsFlutterBinding.ensureInitialized();

      // Global error handlers
      FlutterError.onError = (FlutterErrorDetails details) {
        FlutterError.presentError(details);
        if (kReleaseMode) {
          print('FlutterError: ${details.exception}');
          print('StackTrace: ${details.stack}');
        }
      };

      PlatformDispatcher.instance.onError = (error, stack) {
        print('PlatformError: $error');
        print('StackTrace: $stack');
        return true;
      };

      ErrorWidget.builder = (FlutterErrorDetails details) {
        return Scaffold(
          body: Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Icons.error_outline, size: 48, color: Colors.grey),
                SizedBox(height: 16),
                Text('Something went wrong', style: TextStyle(fontSize: 18)),
                SizedBox(height: 8),
                Text('Please restart the app', style: TextStyle(color: Colors.grey)),
              ],
            ),
          ),
        );
      };

      runApp(const MyApp());
    }
    ```

    Import required: `import 'dart:ui' show PlatformDispatcher;` and `import 'package:flutter/foundation.dart' show kReleaseMode;`
  </action>
  <verify>
    1. flutter analyze passes
    2. flutter build web --release succeeds
    3. Grep for error handlers: `grep "FlutterError.onError" frontend/lib/main.dart`
    4. Grep for platform handler: `grep "PlatformDispatcher" frontend/lib/main.dart`
    5. Grep for error widget: `grep "ErrorWidget.builder" frontend/lib/main.dart`
  </verify>
  <done>
    - FlutterError.onError configured to log errors and preserve debug output
    - PlatformDispatcher.instance.onError catches async/platform errors and prevents crashes
    - ErrorWidget.builder shows user-friendly error screen instead of red debug screen
    - All error handlers registered before runApp() call
    - No crash reporting integration (deferred to post-launch)
  </done>
</task>

</tasks>

<verification>
**Loading States:**
1. Start app, navigate to Projects screen - should see skeleton cards for ~1 second, then real projects
2. Open project, navigate to Documents tab - should see skeleton list, then real documents
3. Navigate to Threads tab - should see skeleton list, then real threads
4. No blank white screens during any data load

**Error Handling:**
1. Kill backend server, try to load projects - should see SnackBar "Failed to load projects" with Retry button
2. Click Retry with server still down - error SnackBar appears again
3. Start backend, click Retry - projects load successfully
4. Same test for documents and threads lists
5. Test conversation screen with network interruption - should show SnackBar with recovery

**Crash Prevention:**
1. flutter run in release mode: `flutter run --release -d chrome`
2. App should never show red debug screens or crash to white screen
3. Any errors should show "Something went wrong" centered error widget

**Responsive Design:**
1. Resize browser window from 1920px → 600px → 400px
2. Sidebar should convert to drawer with hamburger menu at <600px
3. Grid layouts adapt (2 columns at >900px, 1 column at <900px)
4. No horizontal scrolling at any width
5. All content remains readable and accessible on mobile
</verification>

<success_criteria>
- User never sees blank white screens - skeleton loaders appear within 100ms of navigation
- User sees actionable error messages (with Retry button) for all network failures
- App never crashes - uncaught errors show friendly "Something went wrong" screen
- All loading states tie directly to Provider.isLoading boolean (no hardcoded delays)
- Error messages provide context ("Failed to load projects") and recovery path (Retry action)
- Responsive layouts adapt: sidebar → drawer at <600px, 2-col grid → 1-col at <900px
- No horizontal scrolling on mobile devices
- All touch targets meet minimum 48dp size for mobile usability
</success_criteria>

<output>
After completion, create `.planning/phases/05-cross-platform-polish-launch/05-01-SUMMARY.md`
</output>

---
phase: 32-frontend-widget-model-tests
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/test/widget/message_bubble_test.dart
  - frontend/test/widget/project_list_screen_test.dart
autonomous: true

must_haves:
  truths:
    - "MessageBubble displays user messages aligned right"
    - "MessageBubble displays assistant messages aligned left with copy button"
    - "All project_list_screen tests pass"
  artifacts:
    - path: "frontend/test/widget/message_bubble_test.dart"
      provides: "MessageBubble widget tests"
      min_lines: 80
    - path: "frontend/test/widget/project_list_screen_test.dart"
      provides: "Fixed project list screen tests"
      contains: "get started!"
  key_links:
    - from: "frontend/test/widget/message_bubble_test.dart"
      to: "frontend/lib/screens/conversation/widgets/message_bubble.dart"
      via: "imports MessageBubble widget"
      pattern: "import.*message_bubble"
---

<objective>
Create MessageBubble widget tests and fix failing project_list_screen tests.

Purpose: Complete FWID-02 requirement for MessageBubble tests and ensure FWID-05 (all screens have test coverage) by fixing the 2 failing tests in project_list_screen_test.dart.

Output: New MessageBubble test file with 8-10 tests, fixed project_list_screen tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-frontend-widget-model-tests/32-RESEARCH.md

# Source files
@frontend/lib/screens/conversation/widgets/message_bubble.dart
@frontend/lib/screens/projects/project_list_screen.dart

# Existing test pattern
@frontend/test/widget/chats_screen_test.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MessageBubble widget tests</name>
  <files>frontend/test/widget/message_bubble_test.dart</files>
  <action>
Create test file at `frontend/test/widget/message_bubble_test.dart`:

MessageBubble is a simple widget that:
1. Displays message content
2. Aligns right for user messages, left for assistant messages
3. Shows copy button only for assistant messages
4. Uses different background colors for user vs assistant

Tests to create:

1. User message tests:
   - Aligned to center right
   - No copy button shown
   - Uses primary color background
   - Content text is displayed

2. Assistant message tests:
   - Aligned to center left
   - Copy button is shown
   - Uses surfaceContainerHighest background
   - Content text is displayed

3. Copy button functionality:
   - Copy button has tooltip "Copy to clipboard"
   - SKIP actual clipboard testing (platform channel issues in tests)

Test structure:
```dart
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:frontend/models/message.dart';
import 'package:frontend/screens/conversation/widgets/message_bubble.dart';

void main() {
  group('MessageBubble Widget Tests', () {
    Widget buildTestWidget(Message message) {
      return MaterialApp(
        home: Scaffold(
          body: SingleChildScrollView(
            child: MessageBubble(message: message),
          ),
        ),
      );
    }

    group('User Messages', () {
      late Message userMessage;

      setUp(() {
        userMessage = Message(
          id: 'test-1',
          role: MessageRole.user,
          content: 'Hello, this is a test message',
          createdAt: DateTime.now(),
        );
      });

      testWidgets('aligned to center right', (tester) async {
        await tester.pumpWidget(buildTestWidget(userMessage));

        final align = tester.widget<Align>(find.byType(Align));
        expect(align.alignment, Alignment.centerRight);
      });

      testWidgets('does not show copy button', (tester) async {
        await tester.pumpWidget(buildTestWidget(userMessage));

        expect(find.byIcon(Icons.copy), findsNothing);
      });

      testWidgets('displays message content', (tester) async {
        await tester.pumpWidget(buildTestWidget(userMessage));

        expect(find.text('Hello, this is a test message'), findsOneWidget);
      });
    });

    group('Assistant Messages', () {
      late Message assistantMessage;

      setUp(() {
        assistantMessage = Message(
          id: 'test-2',
          role: MessageRole.assistant,
          content: 'This is an assistant response',
          createdAt: DateTime.now(),
        );
      });

      testWidgets('aligned to center left', (tester) async {
        await tester.pumpWidget(buildTestWidget(assistantMessage));

        final align = tester.widget<Align>(find.byType(Align));
        expect(align.alignment, Alignment.centerLeft);
      });

      testWidgets('shows copy button', (tester) async {
        await tester.pumpWidget(buildTestWidget(assistantMessage));

        expect(find.byIcon(Icons.copy), findsOneWidget);
      });

      testWidgets('copy button has tooltip', (tester) async {
        await tester.pumpWidget(buildTestWidget(assistantMessage));

        final iconButton = tester.widget<IconButton>(
          find.byType(IconButton)
        );
        expect(iconButton.tooltip, 'Copy to clipboard');
      });

      testWidgets('displays message content', (tester) async {
        await tester.pumpWidget(buildTestWidget(assistantMessage));

        expect(find.text('This is an assistant response'), findsOneWidget);
      });
    });

    group('Text Content', () {
      testWidgets('uses SelectableText for content', (tester) async {
        final message = Message(
          id: 'test-3',
          role: MessageRole.user,
          content: 'Selectable text',
          createdAt: DateTime.now(),
        );

        await tester.pumpWidget(buildTestWidget(message));

        expect(find.byType(SelectableText), findsOneWidget);
      });
    });
  });
}
```
  </action>
  <verify>Run `flutter test frontend/test/widget/message_bubble_test.dart -v` - all tests pass</verify>
  <done>8-10 tests covering user/assistant message display, alignment, and copy button</done>
</task>

<task type="auto">
  <name>Task 2: Fix project_list_screen_test.dart failing tests</name>
  <files>frontend/test/widget/project_list_screen_test.dart</files>
  <action>
Fix the 2 failing tests in `frontend/test/widget/project_list_screen_test.dart`:

**Issue 1:** "Shows empty state when no projects" test
- Current expectation: `'Create your first project to get started'`
- Actual text in EmptyState widget: `'Create your first project to get started!'` (with exclamation mark)
- Fix: Update test expectation to include exclamation mark

**Issue 2:** "Project without description renders correctly" test
- Current expectation: `find.textContaining('Updated')`
- Actual: Screen uses `DateFormatter.format(project.updatedAt)` which doesn't include "Updated" prefix
- Fix: Look for the schedule icon instead, or verify project name is shown

Changes to make:

1. Line 48-49: Change expectation from:
```dart
expect(find.text('Create your first project to get started'), findsOneWidget);
```
to:
```dart
expect(find.text('Create your first project to get started!'), findsOneWidget);
```

2. Lines 215-217: Change from:
```dart
expect(find.text('Project No Description'), findsOneWidget);
// Description should not be shown
expect(find.textContaining('Updated'), findsOneWidget);
```
to:
```dart
expect(find.text('Project No Description'), findsOneWidget);
// Description should not be shown - verify schedule icon (date) is present
expect(find.byIcon(Icons.schedule), findsOneWidget);
```
  </action>
  <verify>Run `flutter test frontend/test/widget/project_list_screen_test.dart -v` - all 7 tests pass (0 failures)</verify>
  <done>Both failing tests fixed by correcting expectation text and icon assertions</done>
</task>

</tasks>

<verification>
Run all widget tests including the new and fixed files:
```bash
flutter test frontend/test/widget/message_bubble_test.dart frontend/test/widget/project_list_screen_test.dart -v
```

Expected: All tests pass (8+ MessageBubble tests, 7 ProjectListScreen tests)
</verification>

<success_criteria>
1. MessageBubble tests verify user message alignment (right) and no copy button
2. MessageBubble tests verify assistant message alignment (left) and copy button presence
3. MessageBubble tests verify SelectableText is used
4. project_list_screen_test.dart has all 7 tests passing (was 5/7)
5. Both test files run without errors
</success_criteria>

<output>
After completion, create `.planning/phases/32-frontend-widget-model-tests/32-03-SUMMARY.md`
</output>

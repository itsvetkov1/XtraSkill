---
phase: 71-cli-permissions-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/services/llm/claude_cli_adapter.py
  - backend/tests/unit/llm/test_claude_process_pool.py
  - backend/tests/unit/llm/test_claude_cli_adapter.py
autonomous: true
requirements:
  - CLI-01
  - CLI-02
  - CLI-03
  - CLI-04
  - CLI-05

must_haves:
  truths:
    - "All three CLI spawn paths include --dangerously-skip-permissions flag"
    - "Warm pool processes carry the skip-permissions flag from creation"
    - "Cold spawn fallback carries the skip-permissions flag"
    - "Direct fallback in stream_chat() carries the skip-permissions flag"
    - "Flag is defined as a module-level constant (single source of truth)"
  artifacts:
    - path: "backend/app/services/llm/claude_cli_adapter.py"
      provides: "DANGEROUSLY_SKIP_PERMISSIONS constant and flag in all 3 spawn sites"
      contains: "DANGEROUSLY_SKIP_PERMISSIONS"
    - path: "backend/tests/unit/llm/test_claude_process_pool.py"
      provides: "Flag presence assertions for _spawn_warm_process and _cold_spawn"
      contains: "--dangerously-skip-permissions"
    - path: "backend/tests/unit/llm/test_claude_cli_adapter.py"
      provides: "Flag presence assertion for direct fallback in stream_chat"
      contains: "--dangerously-skip-permissions"
  key_links:
    - from: "backend/app/services/llm/claude_cli_adapter.py"
      to: "asyncio.create_subprocess_exec"
      via: "DANGEROUSLY_SKIP_PERMISSIONS constant in positional args"
      pattern: "DANGEROUSLY_SKIP_PERMISSIONS"
    - from: "backend/tests/unit/llm/test_claude_process_pool.py"
      to: "backend/app/services/llm/claude_cli_adapter.py"
      via: "mock_exec.call_args assertion"
      pattern: "dangerously-skip-permissions.*call_args"
---

<objective>
Add `--dangerously-skip-permissions` flag to all three Claude CLI subprocess spawn paths so the backend runs non-interactively without blocking on permission prompts. Add test assertions verifying the flag is present in each spawn path.

Purpose: The Claude CLI binary prompts for user permission on certain operations. In a backend subprocess context, these prompts block indefinitely. The flag bypasses all permission checks, enabling fully non-interactive operation.

Output: Modified `claude_cli_adapter.py` with flag in all 3 spawn sites, plus test assertions in both test files confirming flag presence.
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/71-cli-permissions-fix/71-RESEARCH.md
@backend/app/services/llm/claude_cli_adapter.py
@backend/tests/unit/llm/test_claude_process_pool.py
@backend/tests/unit/llm/test_claude_cli_adapter.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DANGEROUSLY_SKIP_PERMISSIONS constant and insert flag in all 3 spawn sites</name>
  <files>backend/app/services/llm/claude_cli_adapter.py</files>
  <action>
1. Add a module-level constant after `DEFAULT_MODEL`:
   ```python
   DANGEROUSLY_SKIP_PERMISSIONS = '--dangerously-skip-permissions'
   ```

2. In `_spawn_warm_process()` (around line 179), add `DANGEROUSLY_SKIP_PERMISSIONS` after `'-p'` in the `create_subprocess_exec` call:
   ```python
   return await asyncio.create_subprocess_exec(
       self._cli_path,
       '-p',
       DANGEROUSLY_SKIP_PERMISSIONS,
       '--output-format', 'stream-json',
       '--verbose',
       '--model', self._model,
       ...
   )
   ```

3. In `_cold_spawn()` (around line 203), add the same flag after `'-p'`:
   ```python
   return await asyncio.create_subprocess_exec(
       self._cli_path,
       '-p',
       DANGEROUSLY_SKIP_PERMISSIONS,
       '--output-format', 'stream-json',
       '--verbose',
       '--model', self._model,
       ...
   )
   ```

4. In `stream_chat()` direct fallback `cmd` list (around line 604), add the flag after `"-p"`:
   ```python
   cmd = [
       self.cli_path,
       "-p",
       DANGEROUSLY_SKIP_PERMISSIONS,
       "--output-format", "stream-json",
       "--verbose",
       "--model", self.model,
   ]
   ```

Per locked decision: Flag is hardcoded (always on), no env var toggle, no config option. Placement after `-p` groups operating-mode flags together.
  </action>
  <verify>
    <automated>cd /Users/a1testingmac/projects/XtraSkill && grep -n "DANGEROUSLY_SKIP_PERMISSIONS" backend/app/services/llm/claude_cli_adapter.py | wc -l</automated>
    <manual>Output should be 4 (1 constant definition + 3 usage sites). Verify with: grep -n "DANGEROUSLY_SKIP_PERMISSIONS" backend/app/services/llm/claude_cli_adapter.py</manual>
  </verify>
  <done>DANGEROUSLY_SKIP_PERMISSIONS constant defined at module level. Flag appears in all 3 create_subprocess_exec call sites: _spawn_warm_process, _cold_spawn, and stream_chat direct fallback cmd list.</done>
</task>

<task type="auto">
  <name>Task 2: Add test assertions for flag presence in all 3 spawn paths</name>
  <files>
    backend/tests/unit/llm/test_claude_process_pool.py
    backend/tests/unit/llm/test_claude_cli_adapter.py
  </files>
  <action>
1. In `test_claude_process_pool.py`, add import for `DANGEROUSLY_SKIP_PERMISSIONS` from `claude_cli_adapter`:
   Update the existing import to include `DANGEROUSLY_SKIP_PERMISSIONS`.

2. In `test_claude_process_pool.py`, add two new test methods to `TestClaudeProcessPool` class:

   **Test for CLI-02 (_spawn_warm_process):**
   ```python
   @pytest.mark.asyncio
   @patch('app.services.llm.claude_cli_adapter.asyncio.create_subprocess_exec')
   async def test_spawn_warm_process_includes_skip_permissions(self, mock_exec):
       """CLI-02: _spawn_warm_process includes --dangerously-skip-permissions."""
       mock_exec.return_value = make_mock_process(returncode=None)
       pool = ClaudeProcessPool(cli_path='/usr/bin/claude', model=DEFAULT_MODEL)
       await pool._spawn_warm_process()
       args = mock_exec.call_args[0]
       assert '--dangerously-skip-permissions' in args
   ```

   **Test for CLI-03 (_cold_spawn):**
   ```python
   @pytest.mark.asyncio
   @patch('app.services.llm.claude_cli_adapter.asyncio.create_subprocess_exec')
   async def test_cold_spawn_includes_skip_permissions(self, mock_exec):
       """CLI-03: _cold_spawn includes --dangerously-skip-permissions."""
       mock_exec.return_value = make_mock_process(returncode=None)
       pool = ClaudeProcessPool(cli_path='/usr/bin/claude', model=DEFAULT_MODEL)
       await pool._cold_spawn()
       args = mock_exec.call_args[0]
       assert '--dangerously-skip-permissions' in args
   ```

   Place these after the existing `test_dead_process_triggers_cold_spawn` test.

3. In `test_claude_process_pool.py`, add a flag assertion to the existing `test_pool_not_initialized_falls_back_to_cold_spawn` test. After the existing `mock_exec.assert_called_once()` assertion, add:
   ```python
   # CLI-04: Direct fallback includes --dangerously-skip-permissions
   call_args = mock_exec.call_args[0]
   assert '--dangerously-skip-permissions' in call_args
   ```

   This tests CLI-04 because when `get_process_pool()` returns None, `stream_chat()` uses the direct `*cmd` path which is the third spawn site.

4. Run the full test suite for both files to verify no regressions.
  </action>
  <verify>
    <automated>cd /Users/a1testingmac/projects/XtraSkill/backend && python -m pytest tests/unit/llm/test_claude_process_pool.py tests/unit/llm/test_claude_cli_adapter.py -v --tb=short 2>&1 | tail -30</automated>
    <manual>All tests should pass. New tests should appear in output: test_spawn_warm_process_includes_skip_permissions, test_cold_spawn_includes_skip_permissions. The existing test_pool_not_initialized_falls_back_to_cold_spawn should still pass with the added assertion.</manual>
  </verify>
  <done>Three test assertions confirm the flag is present: one for _spawn_warm_process (CLI-02), one for _cold_spawn (CLI-03), and one in the existing direct fallback test (CLI-04). All tests pass with no regressions.</done>
</task>

</tasks>

<verification>
1. `grep -c "DANGEROUSLY_SKIP_PERMISSIONS" backend/app/services/llm/claude_cli_adapter.py` returns 4 (1 constant + 3 usages)
2. `grep -c "dangerously-skip-permissions" backend/tests/unit/llm/test_claude_process_pool.py` returns at least 3 (2 new tests + 1 added assertion)
3. `python -m pytest tests/unit/llm/test_claude_process_pool.py tests/unit/llm/test_claude_cli_adapter.py -v` â€” all tests pass
4. No other files modified (change is confined to the adapter and its test files)
</verification>

<success_criteria>
- DANGEROUSLY_SKIP_PERMISSIONS constant exists at module level in claude_cli_adapter.py
- Flag is present in _spawn_warm_process create_subprocess_exec args
- Flag is present in _cold_spawn create_subprocess_exec args
- Flag is present in stream_chat direct fallback cmd list
- Test for CLI-02 (_spawn_warm_process flag) passes
- Test for CLI-03 (_cold_spawn flag) passes
- Test for CLI-04 (direct fallback flag) passes
- All existing tests continue to pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/71-cli-permissions-fix/71-01-SUMMARY.md`
</output>

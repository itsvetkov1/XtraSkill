---
phase: 34-client-side-resilience
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/screens/documents/document_upload_screen.dart
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User sees validation error immediately after selecting oversized file (before upload starts)"
    - "User sees clear error message: 'File too large. Maximum size is 1MB.'"
    - "User can select a different file after validation failure without page reload"
  artifacts:
    - path: "frontend/lib/screens/documents/document_upload_screen.dart"
      provides: "Client-side file size validation before upload"
      contains: "File too large"
  key_links:
    - from: "document_upload_screen.dart"
      to: "file_picker"
      via: "Validation immediately after picker returns"
      pattern: "file\\.size.*1024.*1024"
---

<objective>
Implement client-side file size validation that runs immediately after file selection.

Purpose: Currently file size is validated on the backend after upload starts (PITFALL-09). This plan adds immediate client-side validation so users see errors before any upload attempt, improving UX and preventing wasted time/bandwidth.

Output:
- File size validated immediately after FilePicker returns
- Clear error message shows actual file size and limit
- User can immediately select another file without navigation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/PITFALLS-v1.9.2.md

# Key file to modify
@frontend/lib/screens/documents/document_upload_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add client-side file size validation</name>
  <files>frontend/lib/screens/documents/document_upload_screen.dart</files>
  <action>
Modify `_pickAndUploadFile()` to validate file size immediately after picker returns, BEFORE any upload UI or API call:

1. Add constant at top of class:
```dart
/// Maximum file size in bytes (1MB)
static const int _maxFileSizeBytes = 1024 * 1024;
```

2. Add helper method to format file size for display:
```dart
/// Formats file size in human-readable format
String _formatFileSize(int bytes) {
  if (bytes < 1024) {
    return '$bytes B';
  } else if (bytes < 1024 * 1024) {
    return '${(bytes / 1024).toStringAsFixed(1)} KB';
  } else {
    return '${(bytes / (1024 * 1024)).toStringAsFixed(1)} MB';
  }
}
```

3. Modify `_pickAndUploadFile()` to add validation IMMEDIATELY after file selection, BEFORE `setState`:

```dart
Future<void> _pickAndUploadFile() async {
  // Pick file with type filter (only .txt and .md)
  FilePickerResult? result = await FilePicker.platform.pickFiles(
    type: FileType.custom,
    allowedExtensions: ['txt', 'md'],
  );

  if (result == null) return;

  final file = result.files.single;
  if (file.bytes == null) {
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('File data not available')),
      );
    }
    return;
  }

  // VALIDATE FILE SIZE IMMEDIATELY (PITFALL-09: before any upload UI)
  final fileSize = file.bytes!.length;
  if (fileSize > _maxFileSizeBytes) {
    if (mounted) {
      _showFileSizeError(fileSize);
    }
    return;  // Stop here - user can select another file
  }

  // Only proceed to upload if validation passes
  setState(() {
    _uploading = true;
  });

  try {
    final provider = context.read<DocumentProvider>();
    await provider.uploadDocument(
      widget.projectId,
      file.bytes!,
      file.name,
    );

    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Document uploaded successfully'),
          backgroundColor: Colors.green,
        ),
      );
      Navigator.pop(context);
    }
  } catch (e) {
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Upload failed: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  } finally {
    if (mounted) {
      setState(() {
        _uploading = false;
      });
    }
  }
}
```

4. Add method to show file size error with clear message and option to retry:

```dart
/// Shows file size error dialog with actual size and limit
void _showFileSizeError(int actualSize) {
  showDialog<void>(
    context: context,
    builder: (dialogContext) => AlertDialog(
      icon: const Icon(Icons.warning_amber_rounded, color: Colors.orange, size: 48),
      title: const Text('File too large'),
      content: Text(
        'The selected file is ${_formatFileSize(actualSize)}.\n\n'
        'Maximum file size is 1MB.\n\n'
        'Please select a smaller file.',
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(dialogContext),
          child: const Text('Cancel'),
        ),
        FilledButton(
          onPressed: () {
            Navigator.pop(dialogContext);
            _pickAndUploadFile();  // Let user immediately select another file
          },
          child: const Text('Select Different File'),
        ),
      ],
    ),
  );
}
```

Key implementation notes:
- Validation happens IMMEDIATELY after `pickFiles()` returns, before ANY upload state change
- Error shows actual file size so user understands the problem
- Dialog offers immediate re-pick so user doesn't have to navigate away
- No upload progress shown for invalid files (validation happens before `_uploading = true`)
  </action>
  <verify>
Run: `cd G:\git_repos\BA_assistant\frontend && flutter analyze lib/screens/documents/document_upload_screen.dart`
Verify no analysis errors.
  </verify>
  <done>
File size validated immediately after picker, error shows actual size vs limit, user can select different file from error dialog.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update hint text to prominently show size limit</name>
  <files>frontend/lib/screens/documents/document_upload_screen.dart</files>
  <action>
Update the UI to make the file size limit more prominent BEFORE the user opens the file picker:

1. Modify the hint text (around line ~103-107) to be more prominent:

Change from:
```dart
const Text(
  'Only .txt and .md files are supported\nMaximum file size: 1MB',
  textAlign: TextAlign.center,
  style: TextStyle(color: Colors.grey),
),
```

To:
```dart
Column(
  children: [
    const Text(
      'Only .txt and .md files are supported',
      textAlign: TextAlign.center,
      style: TextStyle(color: Colors.grey),
    ),
    const SizedBox(height: 8),
    Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      decoration: BoxDecoration(
        color: Theme.of(context).colorScheme.surfaceContainerHighest,
        borderRadius: BorderRadius.circular(8),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(
            Icons.info_outline,
            size: 16,
            color: Theme.of(context).colorScheme.primary,
          ),
          const SizedBox(width: 8),
          Text(
            'Maximum file size: 1MB',
            style: TextStyle(
              color: Theme.of(context).colorScheme.onSurfaceVariant,
              fontWeight: FontWeight.w500,
            ),
          ),
        ],
      ),
    ),
  ],
),
```

This makes the size limit stand out with:
- Separate line with icon
- Container background for visual emphasis
- Bolder text weight
  </action>
  <verify>
Run: `cd G:\git_repos\BA_assistant\frontend && flutter analyze lib/screens/documents/document_upload_screen.dart`
Verify no analysis errors.
  </verify>
  <done>
File size limit displayed prominently before file selection with visual emphasis.
  </done>
</task>

</tasks>

<verification>
1. Static analysis passes: `cd G:\git_repos\BA_assistant\frontend && flutter analyze`
2. Code review checklist:
   - [ ] File size validation happens IMMEDIATELY after pickFiles() returns
   - [ ] Validation happens BEFORE setState({_uploading = true})
   - [ ] Error message includes actual file size (e.g., "2.4 MB")
   - [ ] Error message includes limit ("Maximum file size is 1MB")
   - [ ] User can select different file directly from error dialog
   - [ ] Size limit prominently displayed before file picker opens
</verification>

<success_criteria>
- FILE-01: File size validated client-side before upload attempt
- FILE-02: Clear error message: "File too large. Maximum size is 1MB." (with actual size shown)
- FILE-03: Invalid file selection cleared, user can immediately try again (via dialog button)
</success_criteria>

<output>
After completion, create `.planning/phases/34-client-side-resilience/34-02-SUMMARY.md`
</output>

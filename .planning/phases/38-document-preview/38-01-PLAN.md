---
phase: 38-document-preview
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/widgets/document_preview_dialog.dart
  - frontend/lib/screens/documents/document_upload_screen.dart
autonomous: true

must_haves:
  truths:
    - "User sees filename in preview dialog after selecting file"
    - "User sees file size in KB or MB format"
    - "User sees first 20 lines of file content"
    - "Content displays in monospace font"
    - "User can cancel to clear selection"
    - "User can confirm to proceed with upload"
  artifacts:
    - path: "frontend/lib/widgets/document_preview_dialog.dart"
      provides: "Preview dialog widget"
      min_lines: 60
      exports: ["DocumentPreviewDialog"]
    - path: "frontend/lib/screens/documents/document_upload_screen.dart"
      provides: "Upload flow with preview integration"
      contains: "DocumentPreviewDialog"
  key_links:
    - from: "document_upload_screen.dart"
      to: "document_preview_dialog.dart"
      via: "import and showDialog call"
      pattern: "DocumentPreviewDialog\\.show"
    - from: "document_preview_dialog.dart"
      to: "PlatformFile"
      via: "file parameter"
      pattern: "PlatformFile file"
---

<objective>
Add document preview confirmation dialog that appears after file selection but before upload.

Purpose: Reduce user errors by letting them verify the selected file (name, size, content) before committing to upload.

Output: New DocumentPreviewDialog widget integrated into DocumentUploadScreen's upload flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-document-preview/38-RESEARCH.md

@frontend/lib/screens/documents/document_upload_screen.dart
@frontend/lib/widgets/delete_confirmation_dialog.dart
@frontend/lib/widgets/mode_change_dialog.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DocumentPreviewDialog widget</name>
  <files>frontend/lib/widgets/document_preview_dialog.dart</files>
  <action>
Create a new StatelessWidget `DocumentPreviewDialog` that receives a `PlatformFile` and displays a confirmation dialog with:

1. Title showing filename (truncate if too long with ellipsis)
2. File size in human-readable format (B/KB/MB) - copy `_formatFileSize()` logic from DocumentUploadScreen
3. Content preview showing first 20 lines with truncation indicator
4. Monospace font for content (fontFamily: 'monospace', fontSize: 14)
5. Cancel and Upload action buttons

Implementation requirements:
- Static `show()` method pattern (from ModeChangeDialog) that returns `Future<bool>`
- Use `utf8.decode(bytes, allowMalformed: true)` for safe text decoding
- Handle empty files with "(Empty file)" message
- Use `ConstrainedBox(maxHeight: 300)` for preview area with `SingleChildScrollView`
- Set `barrierDismissible: false` to require explicit button action
- Use `TextButton` for Cancel, `FilledButton` for Upload
- Dialog width: use default AlertDialog width (sufficient for preview)

Preview content extraction:
```dart
String _getPreviewContent(List<int> bytes, {int maxLines = 20}) {
  if (bytes.isEmpty) return '(Empty file)';
  final content = utf8.decode(bytes, allowMalformed: true);
  final lines = content.split('\n');
  final previewLines = lines.take(maxLines);
  if (lines.length > maxLines) {
    return '${previewLines.join('\n')}\n\n... (${lines.length - maxLines} more lines)';
  }
  return previewLines.join('\n');
}
```

Imports needed:
- `dart:convert` for utf8
- `package:flutter/material.dart`
- `package:file_picker/file_picker.dart` for PlatformFile type
  </action>
  <verify>File exists at `frontend/lib/widgets/document_preview_dialog.dart` with exports and required methods</verify>
  <done>DocumentPreviewDialog widget created with static show() method, file metadata display, content preview with 20-line limit, and Cancel/Upload buttons</done>
</task>

<task type="auto">
  <name>Task 2: Integrate preview dialog into upload flow</name>
  <files>frontend/lib/screens/documents/document_upload_screen.dart</files>
  <action>
Modify `_pickAndUploadFile()` to show preview dialog after file selection and size validation, but before upload.

Changes to `_pickAndUploadFile()`:

1. Add import: `import '../../widgets/document_preview_dialog.dart';`

2. After the existing file size validation block (line ~93 `return;`), add preview dialog:

```dart
// After size validation passes, show preview for user confirmation
if (!mounted) return;
final shouldUpload = await DocumentPreviewDialog.show(context, file);
if (!shouldUpload) return;  // User cancelled
```

Flow becomes:
1. Pick file (existing)
2. Validate file.bytes not null (existing)
3. Validate file size <= 1MB (existing)
4. NEW: Show preview dialog
5. If user cancels, return (no upload)
6. If user confirms, proceed to upload (existing code)

Important:
- Check `mounted` before showing dialog (PITFALL-09)
- The preview dialog returns false if cancelled, true if confirmed
- Existing upload logic (setState, try/catch, snackbar) remains unchanged
  </action>
  <verify>Run `flutter analyze frontend` - no errors. Manual: Select a file, preview dialog appears with filename/size/content, Cancel returns to upload screen, Upload proceeds with actual upload.</verify>
  <done>Preview dialog integrated into upload flow - appears after file selection, before upload proceeds</done>
</task>

</tasks>

<verification>
1. `flutter analyze frontend` passes with no errors
2. Manual test flow:
   - Navigate to project, click Upload Document
   - Select a .txt or .md file
   - Preview dialog appears showing:
     - Filename in title
     - File size (e.g., "15.2 KB")
     - First 20 lines of content in monospace font
   - Click Cancel - dialog closes, ready to select different file
   - Select file again, click Upload - file uploads normally with success snackbar
3. Edge cases:
   - Empty file shows "(Empty file)" in preview
   - File with >20 lines shows truncation indicator
   - Large file (near 1MB) doesn't cause UI lag (only 20 lines rendered)
</verification>

<success_criteria>
- DOC-01: Preview dialog shows filename (in title)
- DOC-02: Preview dialog shows file size (human readable KB/MB)
- DOC-03: Preview dialog shows first 20 lines of content
- DOC-04: Preview uses monospace font (fontFamily: 'monospace')
- DOC-05: Cancel button clears selection (returns false, method returns)
- DOC-06: Upload button proceeds (returns true, upload continues)
</success_criteria>

<output>
After completion, create `.planning/phases/38-document-preview/38-01-SUMMARY.md`
</output>

---
phase: 06-theme-management-foundation
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - frontend/lib/main.dart
  - frontend/lib/screens/settings_screen.dart
autonomous: false

must_haves:
  truths:
    - "User can navigate to Settings page and see theme toggle switch"
    - "User can toggle theme and all screens immediately reflect new theme"
    - "User closes app, reopens app, theme persists without white flash"
    - "New user opens app for first time and sees light theme by default"
  artifacts:
    - path: "frontend/lib/main.dart"
      provides: "Async theme initialization before MaterialApp"
      contains: "WidgetsFlutterBinding.ensureInitialized()"
      exports: ["main"]
    - path: "frontend/lib/screens/settings_screen.dart"
      provides: "Settings page with theme toggle UI"
      min_lines: 40
      exports: ["SettingsScreen"]
  key_links:
    - from: "main()"
      to: "ThemeProvider.load(prefs)"
      via: "async initialization before runApp"
      pattern: "await ThemeProvider\\.load"
    - from: "MaterialApp.themeMode"
      to: "themeProvider.themeMode"
      via: "Consumer widget reactive binding"
      pattern: "Consumer<ThemeProvider>.*themeMode"
    - from: "SwitchListTile.onChanged"
      to: "themeProvider.toggleTheme()"
      via: "settings page toggle action"
      pattern: "toggleTheme\\(\\)"
    - from: "GoRouter /settings route"
      to: "SettingsScreen"
      via: "navigation routing"
      pattern: "path: '/settings'"
---

<objective>
Integrate theme management into application startup and create Settings page for user control.

**Purpose:** Wire ThemeProvider to main.dart with async initialization to prevent white flash (SET-06), create Settings screen with theme toggle switch (SET-03), and enable navigation to Settings. This completes the theme management feature with persistent preferences (SET-04) and system preference handling (SET-07).

**Output:** Fully functional theme switching accessible from Settings page, theme persists across app restarts with zero white flash, all requirements SET-03/04/06/07 satisfied.
</objective>

<execution_context>
@G:/git_repos/BA_assistant/.claude/get-shit-done/workflows/execute-plan.md
@G:/git_repos/BA_assistant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@G:/git_repos/BA_assistant/.planning/PROJECT.md
@G:/git_repos/BA_assistant/.planning/ROADMAP.md
@G:/git_repos/BA_assistant/.planning/STATE.md
@G:/git_repos/BA_assistant/.planning/phases/06-theme-management-foundation/06-CONTEXT.md
@G:/git_repos/BA_assistant/.planning/phases/06-theme-management-foundation/06-RESEARCH.md
@G:/git_repos/BA_assistant/.planning/phases/06-theme-management-foundation/06-01-SUMMARY.md

## Current State (from Plan 1)
ThemeProvider created with ChangeNotifier pattern
@G:/git_repos/BA_assistant/frontend/lib/providers/theme_provider.dart

Current main.dart structure
@G:/git_repos/BA_assistant/frontend/lib/main.dart

Current theme setup
@G:/git_repos/BA_assistant/frontend/lib/core/theme.dart
</context>

<tasks>

<task type="auto">
  <name>Update main.dart with async theme initialization</name>
  <files>frontend/lib/main.dart</files>
  <action>
Modify main() and MyApp to load theme preference before MaterialApp renders. This prevents white flash on dark mode startup (SET-06 critical requirement).

**Changes to main() function (currently starts at line 22):**

1. **Make main() async and load SharedPreferences:**
   ```dart
   Future<void> main() async {
     WidgetsFlutterBinding.ensureInitialized(); // ALREADY EXISTS - line 23

     // ADD AFTER ensureInitialized(), BEFORE error handlers:
     // Load theme preference to prevent white flash on dark mode (SET-06)
     final prefs = await SharedPreferences.getInstance();
     final themeProvider = await ThemeProvider.load(prefs);

     // Existing error handlers remain unchanged (lines 26-55)...

     usePathUrlStrategy(); // Already exists - line 58

     // MODIFY runApp() call:
     runApp(MyApp(themeProvider: themeProvider)); // Pass themeProvider
   }
   ```

2. **Add import at top of file:**
   ```dart
   import 'package:shared_preferences/shared_preferences.dart';
   import 'providers/theme_provider.dart'; // ADD this
   ```

3. **Update MyApp class to accept ThemeProvider:**
   ```dart
   class MyApp extends StatelessWidget {
     final ThemeProvider themeProvider;

     const MyApp({super.key, required this.themeProvider});

     @override
     Widget build(BuildContext context) {
       return MultiProvider(
         providers: [
           // ADD ThemeProvider.value at START of providers list:
           ChangeNotifierProvider.value(value: themeProvider),
           ChangeNotifierProvider(create: (_) => AuthProvider()),
           // ... rest of existing providers unchanged
         ],
         child: Builder(
           builder: (context) {
             // WRAP MaterialApp.router with Consumer:
             return Consumer<ThemeProvider>(
               builder: (context, theme, _) {
                 return MaterialApp.router(
                   title: 'Business Analyst Assistant',
                   theme: AppTheme.lightTheme,
                   darkTheme: AppTheme.darkTheme,
                   themeMode: theme.themeMode, // CHANGE from ThemeMode.system to theme.themeMode
                   routerConfig: _router(context),
                   debugShowCheckedModeBanner: false,
                 );
               },
             );
           },
         ),
       );
     }
   }
   ```

**Critical Implementation Notes:**

- **Async Loading (SET-06):** Loading SharedPreferences in main() before runApp() ensures theme preference is known before MaterialApp's first render. This prevents white flash when dark mode is saved.

- **User Decision Compliance:** Changing from `ThemeMode.system` to `theme.themeMode` implements user decision "Always default to light theme for new users" and "Ignore OS theme changes after app launch". ThemeProvider defaults to light (false), not system.

- **Provider Pattern:** Using `ChangeNotifierProvider.value` (not `create:`) because themeProvider instance is created outside the provider tree. This is the correct pattern for pre-initialized providers.

- **Placement:** ThemeProvider MUST be first in providers list to ensure theme is available during initial build of all screens.

Do NOT modify GoRouter setup, do NOT change existing providers, do NOT alter error handlers. Minimal surgical changes only.
  </action>
  <verify>
grep "await ThemeProvider.load" frontend/lib/main.dart
grep "Consumer<ThemeProvider>" frontend/lib/main.dart
grep "themeProvider.themeMode" frontend/lib/main.dart
dart analyze frontend/lib/main.dart
  </verify>
  <done>
main() is async, loads SharedPreferences and ThemeProvider before runApp(), MyApp accepts themeProvider parameter, MaterialApp.themeMode bound to themeProvider.themeMode via Consumer. No analyzer warnings. Theme loads before first frame preventing white flash.
  </done>
</task>

<task type="auto">
  <name>Create Settings screen with theme toggle</name>
  <files>frontend/lib/screens/settings_screen.dart, frontend/lib/main.dart</files>
  <action>
Create new SettingsScreen with theme toggle switch and add route to GoRouter.

**1. Create frontend/lib/screens/settings_screen.dart:**

```dart
/// Settings screen for user preferences.
library;

import 'package:flutter/material.dart';
import 'package:provider/provider.dart';

import '../providers/theme_provider.dart';

/// Settings screen displaying theme toggle and user preferences
class SettingsScreen extends StatelessWidget {
  const SettingsScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Settings'),
      ),
      body: ListView(
        children: [
          // Theme Section
          _buildSectionHeader('Appearance'),
          Consumer<ThemeProvider>(
            builder: (context, themeProvider, _) {
              return SwitchListTile(
                title: const Text('Dark Mode'),
                value: themeProvider.isDarkMode,
                onChanged: (_) => themeProvider.toggleTheme(),
              );
            },
          ),
          const Divider(),

          // Placeholder for future settings sections (SET-01, SET-02, SET-05 in Phase 8)
          _buildSectionHeader('Account'),
          const ListTile(
            title: Text('Profile'),
            subtitle: Text('Coming soon'),
            enabled: false,
          ),
        ],
      ),
    );
  }

  Widget _buildSectionHeader(String title) {
    return Padding(
      padding: const EdgeInsets.fromLTRB(16, 16, 16, 8),
      child: Text(
        title,
        style: const TextStyle(
          fontSize: 14,
          fontWeight: FontWeight.w600,
          color: Colors.grey,
        ),
      ),
    );
  }
}
```

**Implementation Notes (from 06-CONTEXT.md user decisions):**

- **Simple label:** "Dark Mode" with switch (no icons, no verbose descriptions)
- **Instant switching:** onChanged triggers toggleTheme() immediately (no animation, no confirmation)
- **Consumer placement:** Wraps only the SwitchListTile (not entire ListView) to minimize rebuild scope per research best practices
- **Placeholder sections:** Account section shows future settings from Phase 8 (SET-01 profile, SET-02 logout, SET-05 token usage)

**2. Add GoRouter route in frontend/lib/main.dart:**

In the `_router()` method's routes list, add after existing routes (around line 153, after '/projects/:id'):

```dart
GoRoute(
  path: '/settings',
  builder: (context, state) => const SettingsScreen(),
),
```

**3. Add import in frontend/lib/main.dart:**

At top of file with other screen imports (around line 18):

```dart
import 'screens/settings_screen.dart';
```

**Why this structure:** ListView with section headers provides standard settings page pattern. Consumer scoped to SwitchListTile prevents unnecessary rebuilds when theme changes. Placeholder sections document future Phase 8 work without implementing it now.

**User Decision Compliance:**
- "Settings page only (no quick-access)" - toggle lives here, not in app bar
- "Standard switch toggle (Light ↔ Dark)" - SwitchListTile is Flutter's standard switch
- "Instant theme switch with no animation" - direct toggleTheme() call, no transitions

Do NOT implement logout button, do NOT implement profile display, do NOT implement token usage (those are Phase 8 / SET-01/02/05). Only theme toggle for now.
  </action>
  <verify>
ls frontend/lib/screens/settings_screen.dart
grep "path: '/settings'" frontend/lib/main.dart
grep "import 'screens/settings_screen.dart'" frontend/lib/main.dart
dart analyze frontend/lib/screens/settings_screen.dart
  </verify>
  <done>
SettingsScreen exists with SwitchListTile for Dark Mode toggle, Consumer wraps toggle for scoped rebuilds, GoRouter has /settings route, imports added. No analyzer warnings. Settings accessible via navigation.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete theme management system: async initialization prevents white flash, Settings page with theme toggle, persistent preferences across app restarts.

**Automated by Claude:**
- SharedPreferences loaded before MaterialApp renders
- ThemeProvider wired to MaterialApp.themeMode reactively
- Settings screen created with SwitchListTile toggle
- Navigation route added for /settings
  </what-built>

  <how-to-verify>
**Test Sequence (cross-platform verification for SET-03, SET-04, SET-06, SET-07):**

**Desktop/Web Browser Test:**
1. Run `cd frontend && flutter run -d chrome` (or `-d windows`/`-d macos`)
2. Navigate to Settings page (need to implement navigation link - for now use direct URL: `http://localhost:XXXX/settings`)
3. Verify you see "Settings" page with "Dark Mode" switch toggle
4. Toggle switch ON -> verify all screens immediately switch to dark theme with no animation
5. Navigate to Projects screen -> verify dark theme persists across navigation
6. Close browser/app completely
7. Reopen browser, navigate to app -> **CRITICAL: Verify NO white flash during startup, app opens directly in dark theme**
8. Navigate to Settings -> verify toggle is still ON (persisted)
9. Toggle switch OFF -> verify immediate switch to light theme
10. Refresh browser (F5 or Cmd+R) -> verify light theme persists, no flash

**Mobile Test (if available):**
11. Run `flutter run -d android` or `-d ios` (if devices available)
12. Repeat steps 3-10 on mobile device
13. **Additional mobile test:** Force-close app (swipe away from app switcher), reopen -> verify theme persists

**First Launch Test (SET-07 verification - defaults to light):**
14. Clear app data:
    - Web: Clear browser localStorage (F12 -> Application -> Local Storage -> delete all)
    - Mobile: Uninstall and reinstall app
15. Launch app -> **Verify it opens in LIGHT theme by default** (not dark, not system preference)
16. Toggle to dark, restart -> verify dark persists

**Expected Behaviors:**
- Theme toggle switch works instantly with no lag
- No white flash when opening app in dark mode (SET-06 CRITICAL)
- Theme preference survives app restarts (SET-04)
- New users see light theme first (user decision from 06-CONTEXT.md)
- All screens (Home, Projects, Thread, etc.) reflect theme change immediately

**Known Issue to Ignore:**
- If navigation link to Settings not yet in sidebar (Phase 7 work), manually type `/settings` in URL bar or add temporary navigation button for testing

**Failure Scenarios to Test:**
- Toggle theme, force-close app before 1 second passes -> reopen -> should still show toggled theme (immediate persistence)
- Toggle theme rapidly 5 times in quick succession -> verify no lag, no crashes, final state persists correctly
  </how-to-verify>

  <resume-signal>
Reply "approved" if all tests pass (instant theme switching, no white flash on dark mode startup, preference persists across restarts, defaults to light theme for new users).

If any test fails, describe the specific failure (e.g., "White flash still occurs on dark mode startup" or "Theme resets to light after app restart").
  </resume-signal>
</task>

</tasks>

<verification>
**Code Quality:**
- `dart analyze frontend/` reports no errors or warnings
- main() properly async with WidgetsFlutterBinding.ensureInitialized() before async operations
- ThemeProvider loaded before runApp() preventing white flash
- Consumer<ThemeProvider> scoped to minimize rebuild performance impact

**Functional Verification:**
- `grep "await ThemeProvider.load" frontend/lib/main.dart` returns match
- `grep "themeProvider.themeMode" frontend/lib/main.dart` returns match (not ThemeMode.system)
- `grep "SwitchListTile" frontend/lib/screens/settings_screen.dart` returns match
- `grep "path: '/settings'" frontend/lib/main.dart` returns match

**Requirements Coverage:**
- SET-03: Settings page includes light/dark theme toggle switch ✓
- SET-04: Theme preference persists across app restarts (SharedPreferences) ✓
- SET-06: Theme loads before MaterialApp initialization (prevent white flash) ✓
- SET-07: Theme respects system preference on first launch → User decided to default to LIGHT instead, implemented ✓

**Architecture Alignment:**
- ThemeProvider.value pattern used for pre-initialized provider
- Consumer placement minimizes widget rebuild scope
- Async initialization follows Flutter best practices from research
- Settings screen follows established screen patterns (Scaffold + AppBar + ListView)
</verification>

<success_criteria>
**Measurable Outcomes:**
1. `flutter run` launches app with no white flash when dark mode saved
2. User can navigate to /settings route and see Settings page
3. Dark Mode toggle switch visible and functional
4. Toggling switch immediately changes all screen themes with no animation
5. App restart preserves theme selection (test with flutter hot restart)
6. New user (cleared prefs) sees light theme on first launch
7. No BuildContext async issues, no analyzer warnings
8. Settings screen compiles and renders on web, Android, iOS

**Cross-Platform Verification:**
- Web: Theme persists in browser localStorage, survives page refresh
- Android: Theme persists in SharedPreferences, survives app restart
- iOS: Theme persists in NSUserDefaults, survives app restart
- All platforms: Zero white flash on dark mode startup

**Phase 6 Complete:**
All four requirements (SET-03, SET-04, SET-06, SET-07) implemented and verified. Theme management foundation ready for Phase 8 integration (profile display, logout button, token usage display in same Settings page).
</success_criteria>

<output>
After completion, create `G:/git_repos/BA_assistant/.planning/phases/06-theme-management-foundation/06-02-SUMMARY.md` using the summary template.

Include:
- Files created: settings_screen.dart
- Files modified: main.dart (async initialization, Consumer wrapper, /settings route)
- Integration complete: ThemeProvider wired to MaterialApp, Settings accessible
- Requirements satisfied: SET-03, SET-04, SET-06, SET-07
- Cross-platform testing results: Web/Android/iOS theme persistence verification
- Phase 6 status: COMPLETE
</output>

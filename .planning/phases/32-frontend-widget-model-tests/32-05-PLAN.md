---
phase: 32-frontend-widget-model-tests
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/test/widget/document_list_screen_test.dart
  - frontend/lib/services/url_storage_service.dart
  - frontend/lib/services/url_storage_service_stub.dart
  - frontend/lib/screens/auth/login_screen.dart
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "DocumentListScreen tests pass with current UI text"
    - "LoginScreen test compiles and runs in flutter test environment"
  artifacts:
    - path: "frontend/test/widget/document_list_screen_test.dart"
      provides: "Fixed test assertions matching actual UI"
      contains: "No documents yet"
    - path: "frontend/lib/services/url_storage_service_stub.dart"
      provides: "Stub implementation for non-web platforms"
      exports: ["UrlStorageService"]
    - path: "frontend/lib/services/url_storage_service.dart"
      provides: "Conditional export selecting web or stub implementation"
      contains: "export"
  key_links:
    - from: "frontend/lib/screens/auth/login_screen.dart"
      to: "frontend/lib/services/url_storage_service.dart"
      via: "import"
      pattern: "import.*url_storage_service"
    - from: "frontend/lib/services/url_storage_service.dart"
      to: "url_storage_service_web.dart OR url_storage_service_stub.dart"
      via: "conditional export"
      pattern: "export.*if"
---

<objective>
Fix DocumentListScreen test assertions and LoginScreen dart:html compilation failure.

Purpose: Close verification gaps from Phase 32 to achieve 6/6 requirement coverage.

Output: All Phase 32 widget tests pass; 7/7 DocumentListScreen tests, LoginScreen compiles and runs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-frontend-widget-model-tests/32-VERIFICATION.md

# Relevant source files
@frontend/lib/screens/documents/document_list_screen.dart
@frontend/lib/widgets/empty_state.dart
@frontend/lib/utils/date_formatter.dart
@frontend/lib/services/url_storage_service.dart
@frontend/lib/screens/auth/login_screen.dart
@frontend/test/widget/document_list_screen_test.dart
@frontend/test/widget/login_screen_test.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix DocumentListScreen test assertions</name>
  <files>frontend/test/widget/document_list_screen_test.dart</files>
  <action>
Update test assertions to match actual DocumentListScreen UI:

1. **Empty state test (line 46-48):**
   - Change `'No documents uploaded'` to `'No documents yet'`
   - Change `'Tap the + button to upload a document'` to `'Upload documents to provide context for AI conversations.'`
   - Change `Icons.folder_open` to `Icons.description_outlined`

2. **Document date test (line 175-176):**
   The UI uses `DateFormatter.format()` which returns relative dates for <7 days and absolute for >=7 days.
   - Remove assertions for `'Uploaded:'` prefix - actual text is `'Uploaded ${DateFormatter.format(date)}'`
   - For a date from 2026-01-15 tested in 2026-02-02, it's >7 days old so will show `'Uploaded Jan 15, 2026'`
   - Update test to use `find.textContaining('Uploaded')` or use a recent date within 7 days

   Recommended fix: Change testDate to a recent date (e.g., DateTime.now().subtract(Duration(hours: 2)))
   and assert `find.textContaining('Uploaded')` without specific format, since timeago output varies.
  </action>
  <verify>
Run: `cd G:\git_repos\BA_assistant\frontend && flutter test test/widget/document_list_screen_test.dart -v`
All 7 tests should pass.
  </verify>
  <done>DocumentListScreen tests pass: 7/7 tests green, empty state and date assertions match current UI</done>
</task>

<task type="auto">
  <name>Task 2: Create conditional import for UrlStorageService</name>
  <files>
    frontend/lib/services/url_storage_service_web.dart
    frontend/lib/services/url_storage_service_stub.dart
    frontend/lib/services/url_storage_service.dart
  </files>
  <action>
Create conditional import pattern to handle dart:html dependency:

1. **Rename existing file to url_storage_service_web.dart:**
   - Keep the current implementation with dart:html
   - This is the real implementation used on web platform

2. **Create url_storage_service_stub.dart:**
   - Create stub implementation that throws UnsupportedError or returns null
   - Same class name and method signatures as web version
   - Example:
   ```dart
   /// Stub implementation for non-web platforms.
   class UrlStorageService {
     void storeReturnUrl(String url) {
       // No-op on non-web platforms
     }
     String? getReturnUrl() => null;
     void clearReturnUrl() {
       // No-op on non-web platforms
     }
   }
   ```

3. **Update url_storage_service.dart to be conditional export:**
   ```dart
   export 'url_storage_service_stub.dart'
       if (dart.library.html) 'url_storage_service_web.dart';
   ```

This pattern is Flutter's standard approach for platform-conditional code.
LoginScreen import remains unchanged - it imports url_storage_service.dart which conditionally exports the right implementation.
  </action>
  <verify>
Run: `cd G:\git_repos\BA_assistant\frontend && flutter test test/widget/login_screen_test.dart -v`
Test should compile and all 5 tests should pass.
  </verify>
  <done>LoginScreen test compiles: conditional import resolves dart:html dependency, 5/5 tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Run full widget test suite and regenerate mocks if needed</name>
  <files>frontend/test/widget/</files>
  <action>
1. Regenerate mocks if needed:
   `cd G:\git_repos\BA_assistant\frontend && dart run build_runner build --delete-conflicting-outputs`

2. Run full widget test suite:
   `flutter test test/widget/ -v`

3. Verify all widget tests pass (expected: ~99 tests)

4. If any failures, diagnose and fix:
   - Check mock generation for login_screen_test.mocks.dart
   - Verify no other dart:html contamination
  </action>
  <verify>
Run: `cd G:\git_repos\BA_assistant\frontend && flutter test test/widget/ -v`
All widget tests pass.
  </verify>
  <done>Full widget test suite passes: all tests green, no compilation errors</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. DocumentListScreen tests: 7/7 pass
2. LoginScreen tests: 5/5 pass (no compilation error)
3. Full widget test suite: all pass
4. No new test failures introduced

Run verification:
```bash
cd G:\git_repos\BA_assistant\frontend
flutter test test/widget/ -v
```

Expected: ~99+ widget tests pass
</verification>

<success_criteria>
- [ ] document_list_screen_test.dart assertions match current UI (EmptyState widget text, DateFormatter output)
- [ ] url_storage_service.dart uses conditional export pattern
- [ ] url_storage_service_stub.dart provides no-op implementation for non-web
- [ ] url_storage_service_web.dart contains original dart:html implementation
- [ ] login_screen_test.dart compiles without dart:html error
- [ ] All 7 DocumentListScreen tests pass
- [ ] All 5 LoginScreen tests pass
- [ ] Full widget test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/32-frontend-widget-model-tests/32-05-SUMMARY.md`
</output>

---
phase: 07-responsive-navigation-infrastructure
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - frontend/lib/widgets/breadcrumb_bar.dart
  - frontend/lib/widgets/contextual_back_button.dart
  - frontend/lib/widgets/responsive_scaffold.dart
  - frontend/lib/screens/home_screen.dart
  - frontend/lib/screens/settings_screen.dart
  - frontend/lib/screens/projects/project_list_screen.dart
  - frontend/lib/screens/projects/project_detail_screen.dart
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Breadcrumb shows path: Projects > Project Name > Thread Name (clickable segments)"
    - "Back arrow shows destination: <- Projects instead of generic arrow"
    - "Screens no longer have redundant navigation (single Scaffold from shell)"
    - "Mobile hamburger menu works without double AppBar"
    - "Desktop has no duplicate header/AppBar"
    - "Breadcrumbs truncate gracefully on narrow screens"
  artifacts:
    - path: "frontend/lib/widgets/breadcrumb_bar.dart"
      provides: "Route-based breadcrumb navigation widget"
      exports: ["BreadcrumbBar", "Breadcrumb"]
      min_lines: 60
    - path: "frontend/lib/widgets/contextual_back_button.dart"
      provides: "Back button showing destination context"
      exports: ["ContextualBackButton"]
      min_lines: 30
    - path: "frontend/lib/screens/home_screen.dart"
      provides: "Home content without redundant navigation"
      contains: "HomeContent"
    - path: "frontend/lib/screens/settings_screen.dart"
      provides: "Settings content without redundant Scaffold"
    - path: "frontend/lib/screens/projects/project_list_screen.dart"
      provides: "Project list content without redundant Scaffold"
    - path: "frontend/lib/screens/projects/project_detail_screen.dart"
      provides: "Project detail content without redundant Scaffold"
  key_links:
    - from: "frontend/lib/widgets/breadcrumb_bar.dart"
      to: "GoRouterState.of(context).uri.path"
      via: "Route parsing"
      pattern: "GoRouterState\\.of\\(context\\)"
    - from: "frontend/lib/widgets/contextual_back_button.dart"
      to: "context.pop()"
      via: "Navigation action"
      pattern: "context\\.pop\\(\\)"
    - from: "frontend/lib/widgets/responsive_scaffold.dart"
      to: "frontend/lib/widgets/breadcrumb_bar.dart"
      via: "AppBar title replacement"
      pattern: "BreadcrumbBar"
---

<objective>
Create breadcrumb navigation, contextual back arrows, and refactor screens to remove redundant navigation now that shell handles it.

Purpose: Complete the navigation UX with breadcrumbs (NAV-02), contextual back arrows (NAV-03), and clean up screens to work properly within the ResponsiveScaffold shell.

Output:
- BreadcrumbBar widget showing clickable path segments
- ContextualBackButton widget showing destination name
- All authenticated screens refactored to be content-only (no Scaffold/AppBar)
- ResponsiveScaffold updated with breadcrumb and back button integration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-responsive-navigation-infrastructure/07-RESEARCH.md
@.planning/phases/07-responsive-navigation-infrastructure/07-02-SUMMARY.md

# Files to modify/create
@frontend/lib/widgets/responsive_scaffold.dart
@frontend/lib/screens/home_screen.dart
@frontend/lib/screens/settings_screen.dart
@frontend/lib/screens/projects/project_list_screen.dart
@frontend/lib/screens/projects/project_detail_screen.dart

# Providers for name resolution
@frontend/lib/providers/project_provider.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BreadcrumbBar widget</name>
  <files>frontend/lib/widgets/breadcrumb_bar.dart</files>
  <action>
Create BreadcrumbBar widget that displays clickable path segments based on current route:

1. Create Breadcrumb data class:
   ```dart
   class Breadcrumb {
     final String label;
     final String? route; // null = current page (not clickable)

     const Breadcrumb(this.label, [this.route]);
   }
   ```

2. Create BreadcrumbBar StatelessWidget:
   - Get current path from `GoRouterState.of(context).uri.path`
   - Parse path segments to build breadcrumb list
   - Resolve names for dynamic segments (project name from ProjectProvider)

3. Path parsing logic:
   ```dart
   List<Breadcrumb> _buildBreadcrumbs(BuildContext context, String path) {
     final breadcrumbs = <Breadcrumb>[];
     final segments = path.split('/').where((s) => s.isNotEmpty).toList();

     // /home -> Home
     if (path == '/home' || path == '/') {
       return [const Breadcrumb('Home')];
     }

     // /projects -> Projects
     if (segments.contains('projects')) {
       if (segments.length == 1) {
         return [const Breadcrumb('Projects')];
       }

       // /projects/:id -> Projects > {Project Name}
       breadcrumbs.add(const Breadcrumb('Projects', '/projects'));

       final projectIndex = segments.indexOf('projects');
       if (projectIndex + 1 < segments.length) {
         final projectId = segments[projectIndex + 1];
         final projectProvider = context.read<ProjectProvider>();
         final projectName = projectProvider.selectedProject?.name ?? 'Project';
         breadcrumbs.add(Breadcrumb(projectName));
       }
     }

     // /settings -> Settings
     if (path == '/settings') {
       return [const Breadcrumb('Settings')];
     }

     return breadcrumbs;
   }
   ```

4. Render breadcrumbs with separators:
   ```dart
   @override
   Widget build(BuildContext context) {
     final path = GoRouterState.of(context).uri.path;
     final breadcrumbs = _buildBreadcrumbs(context, path);

     if (breadcrumbs.isEmpty) return const SizedBox();

     return Row(
       mainAxisSize: MainAxisSize.min,
       children: [
         for (int i = 0; i < breadcrumbs.length; i++) ...[
           if (i > 0)
             Padding(
               padding: const EdgeInsets.symmetric(horizontal: 8),
               child: Icon(Icons.chevron_right, size: 16, color: Theme.of(context).colorScheme.onSurfaceVariant),
             ),
           breadcrumbs[i].route != null
             ? TextButton(
                 onPressed: () => context.go(breadcrumbs[i].route!),
                 style: TextButton.styleFrom(
                   padding: const EdgeInsets.symmetric(horizontal: 8),
                   minimumSize: Size.zero,
                 ),
                 child: Text(breadcrumbs[i].label),
               )
             : Text(
                 breadcrumbs[i].label,
                 style: Theme.of(context).textTheme.titleMedium?.copyWith(
                   fontWeight: FontWeight.bold,
                 ),
               ),
         ],
       ],
     );
   }
   ```

5. Mobile treatment: For narrow screens, show only last 2 segments with "..." prefix if truncated:
   ```dart
   // In _buildBreadcrumbs, add optional maxVisible parameter
   // If breadcrumbs.length > maxVisible, prepend "..." and show only last maxVisible
   ```

Import requirements: go_router, provider, project_provider.
  </action>
  <verify>
Run `flutter analyze frontend/lib/widgets/breadcrumb_bar.dart` - no errors.
Verify widget exports Breadcrumb class and BreadcrumbBar widget.
  </verify>
  <done>
BreadcrumbBar widget exists, parses current route, displays clickable segments, handles project name resolution.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ContextualBackButton widget</name>
  <files>frontend/lib/widgets/contextual_back_button.dart</files>
  <action>
Create ContextualBackButton widget that shows destination context (e.g., "<- Projects"):

1. Create ContextualBackButton StatelessWidget:
   ```dart
   class ContextualBackButton extends StatelessWidget {
     const ContextualBackButton({super.key});

     @override
     Widget build(BuildContext context) {
       final parentLabel = _getParentLabel(context);

       if (parentLabel == null) {
         // No parent (root page) - no back button
         return const SizedBox();
       }

       return TextButton.icon(
         onPressed: () => context.pop(),
         icon: const Icon(Icons.arrow_back, size: 20),
         label: Text(parentLabel),
         style: TextButton.styleFrom(
           padding: const EdgeInsets.symmetric(horizontal: 8),
         ),
       );
     }
   }
   ```

2. Parent label detection:
   ```dart
   String? _getParentLabel(BuildContext context) {
     final path = GoRouterState.of(context).uri.path;

     // /projects/:id -> Back to Projects
     if (RegExp(r'^/projects/[^/]+$').hasMatch(path)) {
       return 'Projects';
     }

     // /projects/:id/threads/:tid -> Back to {Project Name}
     if (path.contains('/threads/')) {
       final projectProvider = context.read<ProjectProvider>();
       return projectProvider.selectedProject?.name ?? 'Project';
     }

     // Root pages (/home, /projects, /settings) have no back button
     if (path == '/home' || path == '/projects' || path == '/settings') {
       return null;
     }

     // Default: no back button
     return null;
   }
   ```

3. Alternative: Use Router.of(context).canPop() to determine if back is available:
   ```dart
   // Only show if there's somewhere to go back to
   final canPop = context.canPop();
   if (!canPop) return const SizedBox();
   ```

Import requirements: go_router, provider, project_provider.
  </action>
  <verify>
Run `flutter analyze frontend/lib/widgets/contextual_back_button.dart` - no errors.
  </verify>
  <done>
ContextualBackButton widget exists, shows destination label, handles root pages (no back button), nested pages (contextual label).
  </done>
</task>

<task type="auto">
  <name>Task 3: Refactor screens to be content-only and update ResponsiveScaffold</name>
  <files>
    frontend/lib/widgets/responsive_scaffold.dart
    frontend/lib/screens/home_screen.dart
    frontend/lib/screens/settings_screen.dart
    frontend/lib/screens/projects/project_list_screen.dart
    frontend/lib/screens/projects/project_detail_screen.dart
  </files>
  <action>
Refactor all authenticated screens to remove their Scaffold/AppBar (shell provides it):

**1. Update home_screen.dart:**
- Remove ResponsiveLayout, _MobileLayout, _DesktopLayout, _NavigationDrawer, _NavigationSidebar (all handled by shell)
- Export only HomeContent (the actual content)
- Rename file widget from HomeScreen to HomeContent for clarity
- Keep _HomeContent implementation as-is (the welcome card and next steps)

```dart
/// Home content shown in the navigation shell
class HomeContent extends StatelessWidget {
  const HomeContent({super.key});

  @override
  Widget build(BuildContext context) {
    // Reuse existing _HomeContent implementation
    return Center(
      child: ConstrainedBox(
        // ... existing content
      ),
    );
  }
}
```

**2. Update settings_screen.dart:**
- Remove Scaffold and AppBar
- Return just the ListView content
- Shell provides the AppBar

```dart
class SettingsScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return ListView(
      children: [
        _buildSectionHeader('Appearance'),
        // ... existing content
      ],
    );
  }
}
```

**3. Update project_list_screen.dart:**
- Remove Scaffold and AppBar
- Keep Consumer<ProjectProvider> and all list logic
- Return just the body content (RefreshIndicator with ListView)

**4. Update project_detail_screen.dart:**
- Remove Scaffold wrapper
- Keep TabBar + TabBarView structure
- Shell will provide AppBar, this screen adds its TabBar as a PreferredSizeWidget

This one is tricky because it has TabBar. Options:
a) Keep Scaffold but set `appBar: null`, shell wraps it (nested Scaffold OK)
b) Return Column with TabBar + TabBarView, shell adds TabBar to its AppBar

Option (a) is simpler - keep the screen's Scaffold for TabController but remove AppBar.

**5. Update responsive_scaffold.dart:**
- Add BreadcrumbBar to desktop layout header
- Add ContextualBackButton to mobile AppBar leading (if can pop)
- Desktop: Show breadcrumbs in the top bar area
- Mobile: Show breadcrumbs in AppBar title area (or below AppBar)

```dart
// Desktop layout header modification
Container(
  decoration: BoxDecoration(...),
  child: Padding(
    padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
    child: Row(
      children: [
        ContextualBackButton(),
        const SizedBox(width: 8),
        BreadcrumbBar(),
        const Spacer(),
        // Future: user avatar, notifications
      ],
    ),
  ),
),
```

```dart
// Mobile AppBar modification
appBar: AppBar(
  leading: context.canPop() ? ContextualBackButton() : null,
  title: BreadcrumbBar(),
  automaticallyImplyLeading: false, // We provide our own back button
),
```

IMPORTANT: Update main.dart imports if HomeScreen renamed to HomeContent.
  </action>
  <verify>
Run `flutter analyze` on all modified files - no errors.
Run `flutter run -d chrome` and verify:
1. Home screen shows content without double navigation
2. Projects list shows without double AppBar
3. Project detail shows with TabBar working
4. Settings shows content properly
5. Breadcrumbs visible on desktop and mobile
6. Back button shows "Projects" when on /projects/:id
7. Mobile hamburger opens drawer, no double AppBar
  </verify>
  <done>
All authenticated screens are content-only, ResponsiveScaffold includes BreadcrumbBar and ContextualBackButton, no duplicate navigation elements.
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes for all modified files
2. App runs without crashes
3. Breadcrumbs show: "Projects > Project Name" on project detail
4. Back button shows "Projects" when on /projects/:id
5. Mobile layout: single AppBar with hamburger, no duplication
6. Desktop layout: NavigationRail + content area with breadcrumb header
7. All NAV requirements verified:
   - NAV-01: Persistent sidebar (from Plan 01/02)
   - NAV-02: Breadcrumb navigation (this plan)
   - NAV-03: Back arrows with destination context (this plan)
   - NAV-04: Navigation highlighting (from Plan 02)
   - NAV-05: Sidebar state persistence (from Plan 01)
</verification>

<success_criteria>
1. BreadcrumbBar displays clickable path segments with project name resolution
2. ContextualBackButton shows destination instead of generic arrow
3. All authenticated screens work without redundant Scaffold/AppBar
4. Mobile and desktop layouts render correctly without visual duplication
5. All 5 NAV requirements satisfied across Phase 7 plans
</success_criteria>

<output>
After completion, create `.planning/phases/07-responsive-navigation-infrastructure/07-03-SUMMARY.md`
</output>

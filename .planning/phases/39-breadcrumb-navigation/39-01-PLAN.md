---
phase: 39-breadcrumb-navigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/main.dart
  - frontend/lib/widgets/breadcrumb_bar.dart
  - frontend/lib/widgets/documents_column.dart
  - frontend/lib/screens/documents/document_list_screen.dart
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Thread screen shows breadcrumb: Projects > {Project Name} > Threads > {Thread Title}"
    - "Project-less thread shows breadcrumb: Chats > {Thread Title}"
    - "Document Viewer shows breadcrumb: Projects > {Project Name} > Documents > {Doc Name}"
    - "Each breadcrumb segment (except current page) is clickable and navigates"
    - "Document Viewer has URL /projects/:id/documents/:docId visible in browser"
    - "Browser back button from Document Viewer returns to project"
  artifacts:
    - path: "frontend/lib/main.dart"
      provides: "Document route definition"
      contains: "documents/:docId"
    - path: "frontend/lib/widgets/breadcrumb_bar.dart"
      provides: "Extended breadcrumb building for threads and documents"
      contains: "Threads"
    - path: "frontend/lib/widgets/documents_column.dart"
      provides: "GoRouter navigation for document viewer"
      contains: "context.push"
    - path: "frontend/lib/screens/documents/document_list_screen.dart"
      provides: "GoRouter navigation for document viewer"
      contains: "context.push"
  key_links:
    - from: "frontend/lib/widgets/documents_column.dart"
      to: "/projects/:id/documents/:docId"
      via: "context.push call"
      pattern: "context\\.push.*documents"
    - from: "frontend/lib/widgets/breadcrumb_bar.dart"
      to: "DocumentProvider"
      via: "provider read for document name"
      pattern: "read<DocumentProvider>"
---

<objective>
Enhance breadcrumb navigation to show full context including thread titles and document names, and convert Document Viewer from modal push to proper GoRouter route.

Purpose: Users see clear navigation hierarchy (Projects > Project > Threads > Thread) and can use browser navigation with Document Viewer having a proper URL.

Output: Updated router with document route, extended breadcrumb bar handling all route patterns, and GoRouter-based document viewer navigation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-breadcrumb-navigation/39-RESEARCH.md

# Key source files
@frontend/lib/main.dart
@frontend/lib/widgets/breadcrumb_bar.dart
@frontend/lib/widgets/documents_column.dart
@frontend/lib/screens/documents/document_list_screen.dart
@frontend/lib/screens/documents/document_viewer_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add document route to router</name>
  <files>frontend/lib/main.dart</files>
  <action>
Add nested document route under the projects/:id route in main.dart.

In the StatefulShellBranch for Projects, find the `:id` route that has `threads/:threadId` nested route. Add a sibling route for documents:

```dart
GoRoute(
  path: 'documents/:docId',
  builder: (context, state) {
    final docId = state.pathParameters['docId']!;
    return DocumentViewerScreen(documentId: docId);
  },
),
```

Add the necessary import at the top:
```dart
import 'screens/documents/document_viewer_screen.dart';
```

This enables URL-based navigation like `/projects/abc-123/documents/xyz-456`.

IMPORTANT: Use `push` when navigating to documents (in Task 3) so browser back button works. The route definition itself just needs to exist.
  </action>
  <verify>
1. Run `flutter analyze` - no errors
2. App starts without router errors
3. Manually navigate to `/projects/{any-project-id}/documents/{any-doc-id}` in browser - should show Document Viewer (may show error if IDs invalid, but route should resolve)
  </verify>
  <done>Document route `/projects/:id/documents/:docId` is registered in GoRouter and resolves to DocumentViewerScreen</done>
</task>

<task type="auto">
  <name>Task 2: Extend breadcrumb building for all route patterns</name>
  <files>frontend/lib/widgets/breadcrumb_bar.dart</files>
  <action>
Extend `_buildBreadcrumbs` method to handle all required route patterns.

1. Add import for DocumentProvider:
```dart
import '../providers/document_provider.dart';
```

2. Update the `/projects/:id/threads/:threadId` handler to add "Threads" intermediate segment (NAV-01):
```dart
// /projects/:id/threads/:threadId -> Projects > {Project} > Threads > {Thread}
if (segments.length >= 4 && segments[0] == 'projects' && segments[2] == 'threads') {
  final projectId = segments[1];
  final projectProvider = context.read<ProjectProvider>();
  final projectName = projectProvider.selectedProject?.name ?? 'Project';
  final conversationProvider = context.read<ConversationProvider>();
  final threadTitle = conversationProvider.thread?.title ?? 'Conversation';

  return [
    const Breadcrumb('Projects', '/projects'),
    Breadcrumb(projectName, '/projects/$projectId'),
    Breadcrumb('Threads', '/projects/$projectId'),  // NEW: intermediate segment
    Breadcrumb(threadTitle),
  ];
}
```

3. Add handler for `/chats/:threadId` route BEFORE the /projects check (NAV-02):
```dart
// /chats routes (project-less threads)
if (segments.isNotEmpty && segments[0] == 'chats') {
  // /chats -> Chats
  if (segments.length == 1) {
    return [const Breadcrumb('Chats')];
  }
  // /chats/:threadId -> Chats > {Thread Title}
  if (segments.length >= 2) {
    final conversationProvider = context.read<ConversationProvider>();
    final threadTitle = conversationProvider.thread?.title ?? 'Conversation';
    return [
      const Breadcrumb('Chats', '/chats'),
      Breadcrumb(threadTitle),
    ];
  }
}
```

4. Add handler for `/projects/:id/documents/:docId` route INSIDE the /projects block, BEFORE the existing `:id` handling (NAV-03):
```dart
// /projects/:id/documents/:docId -> Projects > {Project} > Documents > {Document}
if (segments.length >= 4 && segments[0] == 'projects' && segments[2] == 'documents') {
  final projectId = segments[1];
  final projectProvider = context.read<ProjectProvider>();
  final projectName = projectProvider.selectedProject?.name ?? 'Project';
  final documentProvider = context.read<DocumentProvider>();
  final documentName = documentProvider.selectedDocument?.filename ?? 'Document';

  return [
    const Breadcrumb('Projects', '/projects'),
    Breadcrumb(projectName, '/projects/$projectId'),
    Breadcrumb('Documents', '/projects/$projectId'),  // Links to project (user clicks Documents tab)
    Breadcrumb(documentName),
  ];
}
```

Order of checks in _buildBreadcrumbs should be:
1. Home/root
2. Settings
3. Chats (NEW)
4. Projects (with internal order: documents check, threads check, simple project check)
5. Fallback

All intermediate segments ("Threads", "Documents") link to `/projects/$projectId` because there's no separate route for tabs - user can click the tab after landing on project detail.
  </action>
  <verify>
1. Run `flutter analyze` - no errors
2. Navigate to a thread within a project - breadcrumb shows "Projects > {Name} > Threads > {Title}"
3. Navigate to a project-less chat - breadcrumb shows "Chats > {Title}"
4. Navigate to a document - breadcrumb shows "Projects > {Name} > Documents > {Filename}"
5. Click "Projects" segment - navigates to project list
6. Click project name segment - navigates to project detail
  </verify>
  <done>Breadcrumb bar displays full hierarchy for threads and documents, with clickable segments navigating to correct locations</done>
</task>

<task type="auto">
  <name>Task 3: Update document navigation to use GoRouter</name>
  <files>frontend/lib/widgets/documents_column.dart, frontend/lib/screens/documents/document_list_screen.dart</files>
  <action>
Update both files to use GoRouter `context.push` instead of `Navigator.push` for document viewing.

**documents_column.dart:**

1. Add import:
```dart
import 'package:go_router/go_router.dart';
```

2. Update `_onView` method in `_DocumentList` class:
```dart
void _onView(BuildContext context, String documentId) {
  // Use push to add to browser history (back button returns to project)
  context.push('/projects/$projectId/documents/$documentId');
}
```

Note: `projectId` is already available via the `projectId` field in `_DocumentList`.

**document_list_screen.dart:**

1. Add import:
```dart
import 'package:go_router/go_router.dart';
```

2. Update the three places that navigate to DocumentViewerScreen:

In PopupMenuButton onSelected (around line 121):
```dart
if (value == 'view') {
  context.push('/projects/${widget.projectId}/documents/${doc.id}');
}
```

In ListTile onTap (around line 170):
```dart
onTap: provider.isLoading
    ? null
    : () {
        context.push('/projects/${widget.projectId}/documents/${doc.id}');
      },
```

IMPORTANT: Use `context.push` (not `context.go`) so browser back button returns to project. `push` adds to history stack, `go` replaces.

Remove unused import if no longer needed:
```dart
// Remove if not used elsewhere
// import 'document_viewer_screen.dart';
```
Actually keep the import - it may still be referenced in the file. Check before removing.
  </action>
  <verify>
1. Run `flutter analyze` - no errors
2. From documents column, click a document - URL changes to `/projects/{id}/documents/{docId}`
3. From document list screen, click a document - URL changes to `/projects/{id}/documents/{docId}`
4. Press browser back button - returns to project detail screen
5. Breadcrumb shows correct path on document viewer
  </verify>
  <done>Document viewer navigation uses GoRouter with URL reflection and proper browser history</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **NAV-01 Thread breadcrumb:**
   - Navigate to `/projects/{id}/threads/{threadId}`
   - Breadcrumb shows: Projects > {Project Name} > Threads > {Thread Title}
   - Click "Projects" -> goes to /projects
   - Click project name -> goes to /projects/{id}
   - Click "Threads" -> goes to /projects/{id} (project detail, user clicks tab)

2. **NAV-02 Project-less thread breadcrumb:**
   - Navigate to `/chats/{threadId}`
   - Breadcrumb shows: Chats > {Thread Title}
   - Click "Chats" -> goes to /chats

3. **NAV-03 Document breadcrumb:**
   - Navigate to `/projects/{id}/documents/{docId}`
   - Breadcrumb shows: Projects > {Project Name} > Documents > {Document Name}
   - All segments except current page are clickable

4. **NAV-04 Clickable segments:**
   - All breadcrumb segments (except last) are clickable and navigate correctly

5. **NAV-05 Mobile truncation:**
   - Already supported via `maxVisible` parameter (no changes needed)

6. **NAV-06 Document URL route:**
   - Document viewer URL is `/projects/{id}/documents/{docId}` (visible in browser)
   - Browser back button returns to project

Run full verification:
```bash
cd frontend && flutter analyze
flutter test
```
</verification>

<success_criteria>
- Thread breadcrumbs show full hierarchy with "Threads" segment (NAV-01)
- Project-less threads show "Chats > Thread" (NAV-02)
- Document viewer shows full hierarchy with "Documents" segment (NAV-03)
- All breadcrumb segments are clickable (NAV-04)
- Mobile truncation works (NAV-05 - already implemented)
- Document viewer has proper URL route (NAV-06)
- Browser back button works correctly after viewing document
- No flutter analyze errors
</success_criteria>

<output>
After completion, create `.planning/phases/39-breadcrumb-navigation/39-01-SUMMARY.md`
</output>

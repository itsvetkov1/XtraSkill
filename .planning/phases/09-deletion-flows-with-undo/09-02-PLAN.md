---
phase: 09-deletion-flows-with-undo
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - frontend/lib/services/project_service.dart
  - frontend/lib/services/thread_service.dart
  - frontend/lib/services/document_service.dart
  - frontend/lib/services/ai_service.dart
  - frontend/lib/providers/project_provider.dart
  - frontend/lib/providers/thread_provider.dart
  - frontend/lib/providers/document_provider.dart
  - frontend/lib/providers/conversation_provider.dart
  - frontend/lib/widgets/delete_confirmation_dialog.dart
autonomous: true

must_haves:
  truths:
    - "Services have deleteX() methods that call DELETE endpoints"
    - "Providers have deleteX() methods with optimistic removal and undo"
    - "Deleted items show SnackBar with Undo action for 10 seconds"
    - "Tapping Undo restores item to list immediately"
    - "After 10 seconds, deletion is committed to backend"
    - "If backend delete fails, item is restored with error message"
    - "Reusable confirmation dialog exists for all delete operations"
  artifacts:
    - path: "frontend/lib/services/project_service.dart"
      provides: "deleteProject() API method"
      contains: "deleteProject"
    - path: "frontend/lib/services/thread_service.dart"
      provides: "deleteThread() API method"
      contains: "deleteThread"
    - path: "frontend/lib/services/document_service.dart"
      provides: "deleteDocument() API method"
      contains: "deleteDocument"
    - path: "frontend/lib/services/ai_service.dart"
      provides: "deleteMessage() API method"
      contains: "deleteMessage"
    - path: "frontend/lib/providers/project_provider.dart"
      provides: "Optimistic delete with undo for projects"
      contains: "_pendingDelete"
    - path: "frontend/lib/providers/thread_provider.dart"
      provides: "Optimistic delete with undo for threads"
      contains: "_pendingDelete"
    - path: "frontend/lib/providers/document_provider.dart"
      provides: "Optimistic delete with undo for documents"
      contains: "_pendingDelete"
    - path: "frontend/lib/providers/conversation_provider.dart"
      provides: "Optimistic delete with undo for messages"
      contains: "_pendingDelete"
    - path: "frontend/lib/widgets/delete_confirmation_dialog.dart"
      provides: "Reusable confirmation dialog"
      contains: "showDeleteConfirmationDialog"
  key_links:
    - from: "frontend/lib/providers/project_provider.dart"
      to: "frontend/lib/services/project_service.dart"
      via: "deleteProject() call in _commitPendingDelete()"
      pattern: "_projectService.deleteProject"
    - from: "frontend/lib/providers/project_provider.dart"
      to: "SnackBar"
      via: "ScaffoldMessenger.of(context).showSnackBar"
      pattern: "showSnackBar"
---

<objective>
Implement frontend deletion infrastructure: service methods, provider delete logic with optimistic UI and undo support, and reusable confirmation dialog.

Purpose: Create the complete deletion flow where items are removed immediately from UI, user can undo within 10 seconds, and backend deletion is deferred until undo window expires.

Output: Services with delete methods, providers with optimistic delete + undo + rollback, and a reusable confirmation dialog widget.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-deletion-flows-with-undo/09-RESEARCH.md
@.planning/phases/09-deletion-flows-with-undo/09-CONTEXT.md

# Existing patterns
@frontend/lib/services/project_service.dart
@frontend/lib/providers/project_provider.dart
@frontend/lib/screens/settings_screen.dart (confirmation dialog pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add delete methods to all services</name>
  <files>
    - frontend/lib/services/project_service.dart
    - frontend/lib/services/thread_service.dart
    - frontend/lib/services/document_service.dart
    - frontend/lib/services/ai_service.dart
  </files>
  <action>
Add deleteProject() to ProjectService:
```dart
/// Delete a project by ID
///
/// Returns successfully if deleted, throws on error.
/// Backend cascades to threads, documents, messages.
Future<void> deleteProject(String id) async {
  try {
    final headers = await _getHeaders();
    await _dio.delete(
      '$_baseUrl/api/projects/$id',
      options: Options(headers: headers),
    );
  } on DioException catch (e) {
    if (e.response?.statusCode == 401) {
      throw Exception('Unauthorized - please login again');
    } else if (e.response?.statusCode == 404) {
      throw Exception('Project not found');
    }
    throw Exception('Failed to delete project: ${e.message}');
  }
}
```

Add deleteThread() to ThreadService (same pattern, endpoint: /api/threads/$id)

Add deleteDocument() to DocumentService (same pattern, endpoint: /api/documents/$id)

Add deleteMessage() to AIService:
```dart
/// Delete a message from a thread
Future<void> deleteMessage(String threadId, String messageId) async {
  try {
    final headers = await _getHeaders();
    await _dio.delete(
      '$_baseUrl/api/threads/$threadId/messages/$messageId',
      options: Options(headers: headers),
    );
  } on DioException catch (e) {
    if (e.response?.statusCode == 401) {
      throw Exception('Unauthorized - please login again');
    } else if (e.response?.statusCode == 404) {
      throw Exception('Message not found');
    }
    throw Exception('Failed to delete message: ${e.message}');
  }
}
```

Note: AIService may need to add _getHeaders() method if it doesn't exist (copy pattern from other services).
  </action>
  <verify>
Flutter analyze passes:
```bash
cd frontend && flutter analyze lib/services/
```
  </verify>
  <done>All four services have delete methods that call corresponding DELETE endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Create reusable delete confirmation dialog</name>
  <files>
    - frontend/lib/widgets/delete_confirmation_dialog.dart
  </files>
  <action>
Create new file frontend/lib/widgets/delete_confirmation_dialog.dart:

```dart
/// Reusable delete confirmation dialog.
library;

import 'package:flutter/material.dart';

/// Show delete confirmation dialog
///
/// Returns true if user confirms deletion, false if cancelled.
/// Follows CONTEXT.md decisions:
/// - Summary cascade info only (no exact counts)
/// - Neutral visual style (no red/warning treatment)
/// - Generic item references ("Delete this project?")
/// - Button labels: "Delete" / "Cancel"
Future<bool> showDeleteConfirmationDialog({
  required BuildContext context,
  required String itemType,
  String? cascadeMessage,
}) async {
  final confirmed = await showDialog<bool>(
    context: context,
    barrierDismissible: false,
    builder: (BuildContext dialogContext) {
      return AlertDialog(
        title: Text('Delete this $itemType?'),
        content: cascadeMessage != null ? Text(cascadeMessage) : null,
        actions: [
          TextButton(
            onPressed: () => Navigator.of(dialogContext).pop(false),
            child: const Text('Cancel'),
          ),
          TextButton(
            onPressed: () => Navigator.of(dialogContext).pop(true),
            child: const Text('Delete'),
          ),
        ],
      );
    },
  );

  return confirmed ?? false;
}
```

Note: The dialog is intentionally neutral (no red button) per CONTEXT.md decisions.
  </action>
  <verify>
File exists and has no syntax errors:
```bash
cd frontend && flutter analyze lib/widgets/delete_confirmation_dialog.dart
```
  </verify>
  <done>Reusable delete confirmation dialog created following CONTEXT.md style decisions</done>
</task>

<task type="auto">
  <name>Task 3: Add optimistic delete with undo to all providers</name>
  <files>
    - frontend/lib/providers/project_provider.dart
    - frontend/lib/providers/thread_provider.dart
    - frontend/lib/providers/document_provider.dart
    - frontend/lib/providers/conversation_provider.dart
  </files>
  <action>
Add to ProjectProvider (use as template for others):

1. Add imports at top:
```dart
import 'dart:async';
import 'package:flutter/material.dart';
```

2. Add fields after existing fields:
```dart
/// Item pending deletion (during undo window)
Project? _pendingDelete;

/// Index where item was before removal (for restoration)
int _pendingDeleteIndex = 0;

/// Timer for deferred deletion
Timer? _deleteTimer;
```

3. Add deleteProject method:
```dart
/// Delete project with optimistic UI and undo support
///
/// Immediately removes from list, shows SnackBar with undo.
/// Actual deletion happens after 10 seconds unless undone.
Future<void> deleteProject(BuildContext context, String projectId) async {
  // Find project in list
  final index = _projects.indexWhere((p) => p.id == projectId);
  if (index == -1) return;

  // Cancel any previous pending delete (commit it immediately)
  if (_pendingDelete != null) {
    await _commitPendingDelete();
  }

  // Remove optimistically
  _pendingDelete = _projects[index];
  _pendingDeleteIndex = index;
  _projects.removeAt(index);

  // Clear selected if it was the deleted project
  if (_selectedProject?.id == projectId) {
    _selectedProject = null;
  }

  notifyListeners();

  // Show undo SnackBar
  if (context.mounted) {
    ScaffoldMessenger.of(context).clearSnackBars();
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: const Text('Project deleted'),
        duration: const Duration(seconds: 10),
        action: SnackBarAction(
          label: 'Undo',
          onPressed: () => _undoDelete(),
        ),
      ),
    );
  }

  // Start deletion timer
  _deleteTimer?.cancel();
  _deleteTimer = Timer(const Duration(seconds: 10), () {
    _commitPendingDelete();
  });
}

void _undoDelete() {
  _deleteTimer?.cancel();
  if (_pendingDelete != null) {
    // Restore at original position (or start if index invalid)
    final insertIndex = _pendingDeleteIndex.clamp(0, _projects.length);
    _projects.insert(insertIndex, _pendingDelete!);
    _pendingDelete = null;
    notifyListeners();
  }
}

Future<void> _commitPendingDelete() async {
  if (_pendingDelete == null) return;

  final projectToDelete = _pendingDelete!;
  final originalIndex = _pendingDeleteIndex;
  _pendingDelete = null;

  try {
    await _projectService.deleteProject(projectToDelete.id);
  } catch (e) {
    // Rollback: restore to list
    final insertIndex = originalIndex.clamp(0, _projects.length);
    _projects.insert(insertIndex, projectToDelete);
    _error = 'Failed to delete project: $e';
    notifyListeners();
  }
}
```

4. Update dispose():
```dart
@override
void dispose() {
  _deleteTimer?.cancel();
  super.dispose();
}
```

Apply same pattern to ThreadProvider:
- Fields: Thread? _pendingDelete, int _pendingDeleteIndex, Timer? _deleteTimer
- Methods: deleteThread(context, threadId), _undoDelete(), _commitPendingDelete()
- SnackBar text: 'Thread deleted'

Apply same pattern to DocumentProvider:
- Fields: Document? _pendingDelete, int _pendingDeleteIndex, Timer? _deleteTimer
- Methods: deleteDocument(context, documentId), _undoDelete(), _commitPendingDelete()
- SnackBar text: 'Document deleted'

Apply same pattern to ConversationProvider:
- Fields: Message? _pendingDelete, int _pendingDeleteIndex, Timer? _deleteTimer
- Methods: deleteMessage(context, threadId, messageId), _undoDelete(), _commitPendingDelete()
- SnackBar text: 'Message deleted'
- Note: ConversationProvider uses _messages list, and needs both threadId and messageId
- The _aiService.deleteMessage(threadId, messageId) call needs thread ID stored or passed

For ConversationProvider specifically, store the thread ID for commit:
```dart
Message? _pendingDelete;
int _pendingDeleteIndex = 0;
String? _pendingDeleteThreadId;
Timer? _deleteTimer;
```

Important: All providers need `import 'package:flutter/material.dart';` for BuildContext and ScaffoldMessenger.
  </action>
  <verify>
Flutter analyze passes on all providers:
```bash
cd frontend && flutter analyze lib/providers/
```
  </verify>
  <done>All four providers have optimistic delete with undo support (10-second window, rollback on error)</done>
</task>

</tasks>

<verification>
- [ ] All services have delete methods (deleteProject, deleteThread, deleteDocument, deleteMessage)
- [ ] Delete confirmation dialog exists at lib/widgets/delete_confirmation_dialog.dart
- [ ] All providers have delete methods with optimistic removal
- [ ] All providers show SnackBar with Undo action (10-second duration)
- [ ] All providers have _undoDelete() that restores item
- [ ] All providers have _commitPendingDelete() that calls service and rolls back on error
- [ ] All providers cancel timer in dispose()
- [ ] Flutter analyze passes with no errors
</verification>

<success_criteria>
- Services can call DELETE endpoints
- Providers remove items immediately from list (optimistic UI)
- SnackBar appears with "Undo" action for 10 seconds
- Tapping "Undo" restores item to original position
- After 10 seconds, backend DELETE is called
- If backend fails, item is restored and error is shown
- Reusable confirmation dialog ready for UI integration
</success_criteria>

<output>
After completion, create `.planning/phases/09-deletion-flows-with-undo/09-02-SUMMARY.md`
</output>

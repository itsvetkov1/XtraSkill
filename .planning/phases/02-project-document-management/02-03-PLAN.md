---
phase: 02-project-document-management
plan: 03
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - backend/app/services/encryption.py
  - backend/app/services/document_search.py
  - backend/app/routes/documents.py
  - backend/main.py
  - backend/alembic/versions/003_add_fts5_document_search.py
  - frontend/lib/services/document_service.dart
  - frontend/lib/providers/document_provider.dart
  - frontend/lib/screens/documents/document_list_screen.dart
  - frontend/lib/screens/documents/document_upload_screen.dart
  - frontend/lib/screens/documents/document_viewer_screen.dart
  - frontend/pubspec.yaml
autonomous: true

must_haves:
  truths:
    - "User can upload text documents (.txt, .md) to a project"
    - "User can view list of documents in a project"
    - "User can view document content within the application"
    - "Documents are stored encrypted at rest"
    - "Documents are indexed for full-text search"
    - "User can search documents within a project"
  artifacts:
    - path: "backend/app/services/encryption.py"
      provides: "Fernet encryption/decryption service"
      exports: ["EncryptionService"]
      min_lines: 30
    - path: "backend/app/services/document_search.py"
      provides: "FTS5 search helpers"
      exports: ["index_document", "search_documents"]
    - path: "backend/app/routes/documents.py"
      provides: "Document upload, list, view, search endpoints"
      exports: ["router"]
      min_lines: 100
    - path: "frontend/lib/services/document_service.dart"
      provides: "Document API client with file upload"
      exports: ["DocumentService"]
    - path: "frontend/lib/screens/documents/document_upload_screen.dart"
      provides: "File picker and upload UI"
      exports: ["DocumentUploadScreen"]
  key_links:
    - from: "backend/app/routes/documents.py"
      to: "backend/app/services/encryption.py"
      via: "calls encrypt_document/decrypt_document"
      pattern: "encryption_service\\.(encrypt|decrypt)"
    - from: "backend/app/routes/documents.py"
      to: "backend/app/services/document_search.py"
      via: "calls index_document after upload"
      pattern: "index_document"
    - from: "frontend/lib/screens/documents/document_upload_screen.dart"
      to: "file_picker package"
      via: "FilePicker.platform.pickFiles"
      pattern: "FilePicker\\.platform\\.pickFiles"
---

<objective>
Implement document management with encryption, search, and cross-platform upload.

Purpose: Enable users to upload context documents that will be referenced by AI in Phase 3. Documents are encrypted at rest for security and indexed with FTS5 for fast search. Covers requirements DOC-01, DOC-02, DOC-03, DOC-04, DOC-05.

Output: Complete document management with encrypted storage, FTS5 search, and cross-platform file upload using file_picker.
</objective>

<execution_context>
@G:\.claude\get-shit-done\workflows\execute-plan.md
@G:\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@G:\git_repos\BA_assistant\.planning\REQUIREMENTS.md
@G:\git_repos\BA_assistant\.planning\phases\02-project-document-management\02-RESEARCH.md

# Previous plans
@G:\git_repos\BA_assistant\.planning\phases\02-project-document-management\02-01-PLAN.md

# Phase 1 patterns
@G:\git_repos\BA_assistant\backend\app\config.py
@G:\git_repos\BA_assistant\frontend\pubspec.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Encryption Service and FTS5 Setup</name>
  <files>
backend/app/services/encryption.py
backend/app/services/document_search.py
backend/alembic/versions/003_add_fts5_document_search.py
backend/.env
  </files>
  <action>
**Create backend/app/services/encryption.py:**
```python
import os
from cryptography.fernet import Fernet

class EncryptionService:
    def __init__(self):
        key = os.getenv("FERNET_KEY")
        if not key:
            raise ValueError("FERNET_KEY environment variable not set")
        self.fernet = Fernet(key.encode())

    def encrypt_document(self, plaintext: str) -> bytes:
        """Encrypt document content."""
        return self.fernet.encrypt(plaintext.encode('utf-8'))

    def decrypt_document(self, ciphertext: bytes) -> str:
        """Decrypt document content."""
        return self.fernet.decrypt(ciphertext).decode('utf-8')

# Global instance
encryption_service = EncryptionService()
```

**Generate Fernet key and add to backend/.env:**
```python
# Run once to generate key
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
# Add to .env: FERNET_KEY=<generated_key>
```

**Create backend/app/services/document_search.py:**
Helper functions for FTS5 operations:
- async def index_document(db: AsyncSession, doc_id: str, filename: str, content: str) → inserts into document_fts
- async def search_documents(db: AsyncSession, project_id: str, query: str) → returns matched documents with snippets and BM25 scores

Use research Pattern 4 "FTS5 Full-Text Search" for implementation.

**Create Alembic migration for FTS5:**
```bash
cd backend
alembic revision -m "Add FTS5 virtual table for document search"
```

In upgrade():
```python
op.execute("""
    CREATE VIRTUAL TABLE document_fts USING fts5(
        document_id UNINDEXED,
        filename,
        content,
        tokenize = 'porter ascii'
    )
""")
```

In downgrade():
```python
op.execute("DROP TABLE document_fts")
```

Run migration: `alembic upgrade head`

Install cryptography: `pip install cryptography`
  </action>
  <verify>
- Run `python -c "from app.services.encryption import encryption_service; enc = encryption_service.encrypt_document('test'); print(encryption_service.decrypt_document(enc))"` → prints "test"
- Check .env contains FERNET_KEY (44-char base64 string)
- Run `sqlite3 ba_assistant.db "SELECT name FROM sqlite_master WHERE type='table' AND name='document_fts';"` → returns "document_fts"
- Verify FTS5 tokenizer: `sqlite3 ba_assistant.db "INSERT INTO document_fts VALUES ('test-id', 'test.txt', 'hello world'); SELECT * FROM document_fts WHERE document_fts MATCH 'hello';"` → returns row
  </verify>
  <done>
Encryption service working with Fernet, FTS5 virtual table created with porter tokenizer, document_search helpers implemented. Ready for document upload endpoints.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Document API Endpoints</name>
  <files>
backend/app/routes/documents.py
backend/main.py
  </files>
  <action>
Create backend/app/routes/documents.py with FastAPI router:

**POST /projects/{project_id}/documents** - Upload document:
- Accepts: multipart/form-data with file parameter (UploadFile)
- Validates:
  - Project exists and belongs to current_user (404 if not)
  - File content_type in ["text/plain", "text/markdown"] (400 if not)
  - File size <= 1MB (413 if larger)
  - Content is valid UTF-8 (400 if not)
- Process:
  1. Read file content: `content_bytes = await file.read()`
  2. Decode UTF-8: `plaintext = content_bytes.decode('utf-8')`
  3. Encrypt: `encrypted = encryption_service.encrypt_document(plaintext)`
  4. Create Document in database with content_encrypted=encrypted
  5. Index for search: `await index_document(db, doc.id, file.filename, plaintext)`
- Returns: {"id": str, "filename": str, "created_at": str}
- Status: 201 Created
- Install: `pip install python-multipart` (required for File())

**GET /projects/{project_id}/documents** - List documents:
- Validates: project ownership
- Returns: [{"id": str, "filename": str, "created_at": str}, ...] ordered by created_at DESC
- Does NOT return content (decrypt on demand)

**GET /documents/{document_id}** - Get document content:
- Validates: document exists and belongs to user's project (join through projects table)
- Decrypts: `plaintext = encryption_service.decrypt_document(doc.content_encrypted)`
- Returns: {"id": str, "filename": str, "content": str, "created_at": str}

**GET /projects/{project_id}/documents/search?q={query}** - Search documents:
- Validates: project ownership
- Calls: search_documents(db, project_id, query)
- Returns: [{"id": str, "filename": str, "snippet": str, "score": float}, ...]

All endpoints protected with Depends(get_current_user). Follow research Pattern 5 "FastAPI File Upload with Validation".

Register router in main.py:
```python
from app.routes import documents
app.include_router(documents.router, prefix="/api", tags=["documents"])
```
  </action>
  <verify>
- Test upload: `curl -X POST http://localhost:8000/api/projects/<project_id>/documents -H "Authorization: Bearer <token>" -F "file=@test.txt"` → 201, returns document id
- Test list: `curl http://localhost:8000/api/projects/<project_id>/documents -H "Authorization: Bearer <token>"` → returns array with uploaded document
- Test get: `curl http://localhost:8000/api/documents/<doc_id> -H "Authorization: Bearer <token>"` → returns decrypted content
- Test search: `curl "http://localhost:8000/api/projects/<project_id>/documents/search?q=test" -H "Authorization: Bearer <token>"` → returns matches with snippets
- Test validation: Upload .pdf file → 400 error
- Test validation: Upload 2MB file → 413 error
- Test isolation: Try to get document from another user's project → 404
  </verify>
  <done>
Document API endpoints working with encryption, FTS5 search, and proper validation. File uploads restricted to text files, content encrypted at rest, search returns ranked results.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Frontend Document UI with File Upload</name>
  <files>
frontend/lib/services/document_service.dart
frontend/lib/providers/document_provider.dart
frontend/lib/screens/documents/document_list_screen.dart
frontend/lib/screens/documents/document_upload_screen.dart
frontend/lib/screens/documents/document_viewer_screen.dart
frontend/lib/screens/projects/project_detail_screen.dart
frontend/pubspec.yaml
  </files>
  <action>
**Add file_picker to frontend/pubspec.yaml:**
```yaml
dependencies:
  file_picker: ^10.3.8
```
Run: `cd frontend && flutter pub get`

**Create frontend/lib/services/document_service.dart:**
- uploadDocument(projectId, filePath, filename) → uses FormData with MultipartFile
- getDocuments(projectId) → returns List<Document>
- getDocumentContent(documentId) → returns Document with content field
- searchDocuments(projectId, query) → returns search results

**Create frontend/lib/providers/document_provider.dart:**
- State: List<Document> _documents, String? _selectedDocumentContent, bool _loading, String? _error
- Methods: loadDocuments(projectId), uploadDocument(projectId, filePath), selectDocument(docId), searchDocuments(projectId, query)
- Extends ChangeNotifier, follows ProjectProvider pattern

**Create frontend/lib/screens/documents/document_upload_screen.dart:**
- FloatingActionButton: "Upload Document"
- Taps button → calls FilePicker.platform.pickFiles(type: FileType.custom, allowedExtensions: ['txt', 'md'])
- If file selected → shows upload progress (LinearProgressIndicator)
- Calls provider.uploadDocument(projectId, file.path)
- Shows SnackBar on success/error

**Create frontend/lib/screens/documents/document_list_screen.dart:**
- Consumer<DocumentProvider>
- ListView of document cards: filename, created date, file icon
- Empty state: "No documents uploaded" with upload button
- Taps document → navigate to DocumentViewerScreen

**Create frontend/lib/screens/documents/document_viewer_screen.dart:**
- AppBar with document filename
- Loads document content in initState: provider.selectDocument(docId)
- Shows content in scrollable Text widget (monospace font for code/markdown)
- Loading state while fetching content

**Update frontend/lib/screens/projects/project_detail_screen.dart:**
- In "Documents" tab: show DocumentListScreen
- Pass projectId to DocumentListScreen

**Update frontend/lib/main.dart:**
Add DocumentProvider to MultiProvider:
```dart
ChangeNotifierProvider(create: (_) => DocumentProvider()),
```

Follow research Pattern 6 "Flutter File Picker with Upload Progress".
  </action>
  <verify>
- Run `cd frontend && flutter pub get` → file_picker installed
- Run `cd frontend && flutter analyze` → no errors
- Test upload (web): Click upload button, select .txt file → file uploads, appears in list
- Test upload (mobile emulator): Click upload, select file from picker → uploads successfully
- Test view: Click document in list → content displays in viewer
- Test validation: Try to select .pdf file → file picker filters to .txt/.md only
- Test empty state: Project with no documents shows "No documents uploaded"
- Test loading state: Upload large file → progress indicator shows
  </verify>
  <done>
Document UI complete with file picker, upload progress, list view, and content viewer. Cross-platform file selection working on web, Android, iOS. All DOC requirements (01-05) satisfied.
  </done>
</task>

</tasks>

<verification>
1. Backend encryption/decryption works (plaintext → encrypted → plaintext matches)
2. FTS5 search returns relevant results with snippets
3. File upload restricted to .txt and .md files only
4. Documents stored encrypted in database (content_encrypted is bytes)
5. Frontend file picker filters to allowed file types
6. Document content decrypted and displayed correctly in viewer
7. Search functionality returns ranked results
</verification>

<success_criteria>
- [ ] Backend: EncryptionService encrypts/decrypts documents successfully
- [ ] Backend: FTS5 virtual table created and indexing documents
- [ ] Backend: POST /projects/{id}/documents uploads and encrypts files
- [ ] Backend: GET /projects/{id}/documents lists documents without content
- [ ] Backend: GET /documents/{id} returns decrypted content
- [ ] Backend: GET /projects/{id}/documents/search returns FTS5 results
- [ ] Backend: File validation rejects non-text files and files >1MB
- [ ] Frontend: file_picker allows selecting .txt and .md files only
- [ ] Frontend: Upload progress indicator shows during upload
- [ ] Frontend: Document list displays uploaded files
- [ ] Frontend: Document viewer shows decrypted content
- [ ] Requirements: DOC-01, DOC-02, DOC-03, DOC-04, DOC-05 all satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-project-document-management/02-03-SUMMARY.md`
</output>

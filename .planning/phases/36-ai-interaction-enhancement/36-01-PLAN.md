---
phase: 36-ai-interaction-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/services/agent_service.py
autonomous: true

must_haves:
  truths:
    - "AI responses include list of document IDs used when search_documents_tool ran"
    - "Frontend receives documents_used array in message_complete SSE event"
    - "If no documents searched, documents_used is empty array (not null)"
  artifacts:
    - path: "backend/app/services/agent_service.py"
      provides: "Source attribution tracking in search_documents_tool"
      contains: "documents_used"
  key_links:
    - from: "search_documents_tool"
      to: "message_complete SSE event"
      via: "context variable accumulation"
      pattern: "_documents_used_context"
---

<objective>
Add source attribution tracking to backend agent service

Purpose: Enable frontend to show which documents informed AI responses (SRC-01, SRC-02)
Output: Modified agent_service.py that tracks documents used and includes them in message_complete event
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-ai-interaction-enhancement/36-RESEARCH.md

@backend/app/services/agent_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Track documents used in search_documents_tool</name>
  <files>backend/app/services/agent_service.py</files>
  <action>
Add a context variable to accumulate documents used during a chat session:

1. Add new context variable at module level:
   ```python
   _documents_used_context: ContextVar[list] = ContextVar("documents_used_context")
   ```

2. In `stream_chat` method, initialize it before streaming:
   ```python
   _documents_used_context.set([])
   ```

3. In `search_documents_tool`, after getting results, track the documents:
   ```python
   # Track documents used for source attribution
   try:
       docs_used = _documents_used_context.get()
       for doc_id, filename, snippet, score in results[:5]:
           if not any(d['id'] == doc_id for d in docs_used):  # Avoid duplicates
               docs_used.append({'id': doc_id, 'filename': filename})
       _documents_used_context.set(docs_used)
   except LookupError:
       pass  # Context not available, skip tracking
   ```

Per PITFALL-05: Track actual documents searched at backend level, not LLM-reported documents.
  </action>
  <verify>
Review code for correct context variable usage and duplicate prevention.
  </verify>
  <done>
search_documents_tool accumulates document IDs and filenames in context variable during execution.
  </done>
</task>

<task type="auto">
  <name>Task 2: Include documents_used in message_complete event</name>
  <files>backend/app/services/agent_service.py</files>
  <action>
Modify the message_complete SSE event emission to include documents_used:

1. Before yielding the message_complete event (around line 363-369), retrieve accumulated documents:
   ```python
   # Get documents used for source attribution
   try:
       documents_used = _documents_used_context.get()
   except LookupError:
       documents_used = []
   ```

2. Update both message_complete yield statements to include documents_used:
   ```python
   yield {
       "event": "message_complete",
       "data": json.dumps({
           "content": accumulated_text,
           "usage": usage_data,
           "documents_used": documents_used  # NEW: source attribution
       })
   }
   ```

This affects:
- Line ~363-369 (inside ResultMessage handler)
- Line ~372-378 (fallback yield after async for loop)

Per SRC-04: Empty array when no documents used (not null/undefined).
  </action>
  <verify>
Run backend tests to ensure no regressions:
```bash
cd backend && python -m pytest tests/unit/services/test_agent_service.py -v
```
If no agent_service tests exist, verify by inspection.
  </verify>
  <done>
message_complete SSE event includes documents_used array with id and filename for each document referenced.
  </done>
</task>

</tasks>

<verification>
1. Code inspection: search_documents_tool tracks documents in context variable
2. Code inspection: message_complete event includes documents_used array
3. Backend starts without errors: `cd backend && python -c "from app.services.agent_service import AgentService"`
</verification>

<success_criteria>
- search_documents_tool accumulates document IDs during search
- message_complete SSE event includes documents_used array
- Documents are tracked by actual search results, not LLM hallucination (PITFALL-05)
- Empty array returned when no documents searched (SRC-04)
</success_criteria>

<output>
After completion, create `.planning/phases/36-ai-interaction-enhancement/36-01-SUMMARY.md`
</output>

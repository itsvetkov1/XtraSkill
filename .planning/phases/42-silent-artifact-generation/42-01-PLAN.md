---
phase: 42-silent-artifact-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/routes/conversations.py
autonomous: true

must_haves:
  truths:
    - "ChatRequest accepts optional artifact_generation boolean flag"
    - "When artifact_generation is true, user message is NOT saved to database"
    - "When artifact_generation is true, assistant response is NOT saved to database"
    - "Artifact IS still saved via save_artifact tool (core functionality preserved)"
    - "text_delta SSE events are suppressed when artifact_generation is true"
    - "artifact_created and message_complete SSE events still emitted in silent mode"
    - "Regular chat without flag is completely unaffected"
    - "Thread summary update is skipped for silent requests"
    - "Token tracking still works for artifact generation requests"
    - "Silent generation failures are logged to backend for debugging"
  artifacts:
    - path: "backend/app/routes/conversations.py"
      provides: "ChatRequest with artifact_generation field, conditional persistence, SSE event filtering"
      contains: "artifact_generation"
  key_links:
    - from: "ChatRequest.artifact_generation"
      to: "save_message conditional"
      via: "if not body.artifact_generation"
      pattern: "not body\\.artifact_generation"
    - from: "event_generator"
      to: "text_delta suppression"
      via: "conditional continue"
      pattern: "body\\.artifact_generation.*text_delta"
---

<objective>
Add silent artifact generation support to the backend streaming endpoint.

Purpose: When the frontend sends `artifact_generation: true`, the backend skips message persistence (user + assistant), suppresses text_delta SSE events, skips thread summary update, but preserves artifact saving via the tool, token tracking, and message_complete/artifact_created events. This is the backend half of Layer 4 deduplication.

Output: Modified `conversations.py` with conditional persistence, event filtering, and ephemeral instruction appending.
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/app/routes/conversations.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ChatRequest and add conditional persistence with event filtering</name>
  <files>backend/app/routes/conversations.py</files>
  <action>
  Modify `backend/app/routes/conversations.py` with the following changes:

  1. **ChatRequest model** (line ~34-36): Add optional `artifact_generation` field:
     ```python
     class ChatRequest(BaseModel):
         """Request model for chat message."""
         content: str = Field(..., min_length=1, max_length=32000)
         artifact_generation: bool = Field(default=False)
     ```

  2. **stream_chat endpoint** - Conditional user message save (line ~126): Wrap the `save_message` call:
     ```python
     # Save user message to database (skip for silent artifact generation)
     if not body.artifact_generation:
         await save_message(db, thread_id, "user", body.content)
     ```

  3. **Conversation context** (after line ~134): After building conversation context, append ephemeral instruction for silent mode. This in-memory-only message guides the model to generate artifact without conversational text:
     ```python
     # Append ephemeral instruction for silent generation (in-memory only, NOT persisted)
     if body.artifact_generation:
         conversation.append({
             "role": "user",
             "content": f"{body.content}\n\n"
                        "IMPORTANT: Generate the artifact silently. "
                        "Do not include any conversational text. "
                        "Only call the save_artifact tool and stop."
         })
     ```
     If NOT artifact_generation, leave conversation as-is (current user message was already saved and will be in context).

  4. **event_generator** - SSE event filtering (line ~158-179): After the heartbeat check and before yielding events, add text_delta suppression:
     ```python
     # Suppress text_delta for silent artifact generation
     if body.artifact_generation and event.get("event") == "text_delta":
         continue  # Skip yielding - frontend doesn't need text for silent mode
     ```
     CRITICAL: Do NOT suppress `message_complete`, `artifact_created`, `tool_executing`, or `error` events. Only suppress `text_delta`.

  5. **event_generator** - Conditional text accumulation: Only accumulate text when NOT in silent mode (optimization - text won't be saved anyway):
     ```python
     # Track accumulated text for saving (skip for silent mode)
     if not body.artifact_generation and event.get("event") == "text_delta":
         data = json.loads(event["data"])
         accumulated_text += data.get("text", "")
     ```

  6. **event_generator** - Conditional assistant message save (line ~182-183): Wrap the save:
     ```python
     # Save assistant message after streaming completes (skip for silent generation)
     if accumulated_text and not body.artifact_generation:
         await save_message(db, thread_id, "assistant", accumulated_text)
     ```

  7. **event_generator** - Conditional summary update (line ~197): Wrap the summary call:
     ```python
     # Update thread summary (skip for silent generation - no new messages to summarize)
     if not body.artifact_generation:
         await maybe_update_summary(db, thread_id, current_user["user_id"])
     ```

  8. **event_generator** - Error logging for silent generation (in the except block, line ~199-203): Add logging for silent generation failures:
     ```python
     except Exception as e:
         import logging
         logger = logging.getLogger(__name__)
         if body.artifact_generation:
             logger.error(f"Silent artifact generation failed for thread {thread_id}: {e}")
         yield {
             "event": "error",
             "data": json.dumps({"message": str(e)})
         }
     ```

  **What NOT to change:**
  - Token tracking (usage_data block) remains unconditional - tokens are always tracked (ERR-04)
  - Thread activity timestamp update remains unconditional
  - validate_thread_access and check_user_budget remain unchanged
  - delete_message endpoint remains unchanged
  </action>
  <verify>
  1. Run: `cd /Users/a1testingmac/projects/XtraSkill && python -c "from backend.app.routes.conversations import ChatRequest; r = ChatRequest(content='test', artifact_generation=True); assert r.artifact_generation == True; r2 = ChatRequest(content='test'); assert r2.artifact_generation == False; print('ChatRequest model OK')"` - should print "ChatRequest model OK"
  2. Run existing backend tests to ensure no regressions: `cd /Users/a1testingmac/projects/XtraSkill/backend && python -m pytest tests/api/test_conversation_routes.py -v --tb=short 2>&1 | tail -20`
  3. Verify the file has all expected patterns: grep for `artifact_generation`, `text_delta`, `not body.artifact_generation`, `silent` in the modified file
  </verify>
  <done>
  - ChatRequest has `artifact_generation: bool = Field(default=False)`
  - User message save is conditional on `not body.artifact_generation`
  - Assistant message save is conditional on `not body.artifact_generation`
  - text_delta events are suppressed when `body.artifact_generation` is true
  - message_complete, artifact_created, error events pass through in all modes
  - Thread summary update skipped for silent generation
  - Token tracking remains unconditional
  - Silent generation failures logged with thread context
  - Existing tests pass (no regressions for normal chat flow)
  </done>
</task>

</tasks>

<verification>
1. ChatRequest model accepts artifact_generation field (defaults to False)
2. Normal chat flow (artifact_generation=False or absent) is completely unaffected
3. Silent mode skips both user and assistant message saves
4. Silent mode suppresses text_delta but not message_complete or artifact_created
5. Token tracking works in both modes
6. Summary update skipped in silent mode
7. Error logging captures silent generation failures
8. All existing backend tests pass
</verification>

<success_criteria>
Backend endpoint supports silent artifact generation mode via `artifact_generation: true` flag on ChatRequest, with conditional message persistence, SSE event filtering (text_delta suppressed, message_complete/artifact_created preserved), skipped summary updates, continued token tracking, and error logging for debugging.
</success_criteria>

<output>
After completion, create `.planning/phases/42-silent-artifact-generation/42-01-SUMMARY.md`
</output>

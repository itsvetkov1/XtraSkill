---
phase: 27-thread-search-filter
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/models/thread_sort.dart
  - frontend/lib/providers/chats_provider.dart
  - frontend/lib/screens/chats_screen.dart
autonomous: true

must_haves:
  truths:
    - "User can type in search bar to filter chats instantly"
    - "User can change sort order via segmented button"
    - "Search term remains visible and active until cleared"
    - "No chats matching 'X' shown when search has no results"
  artifacts:
    - path: "frontend/lib/models/thread_sort.dart"
      provides: "ThreadSortOption enum with labels"
      contains: "enum ThreadSortOption"
    - path: "frontend/lib/providers/chats_provider.dart"
      provides: "Search/sort state and filteredThreads getter"
      contains: "filteredThreads"
    - path: "frontend/lib/screens/chats_screen.dart"
      provides: "SearchBar and SegmentedButton UI"
      contains: "SearchBar"
  key_links:
    - from: "frontend/lib/screens/chats_screen.dart"
      to: "ChatsProvider.setSearchQuery"
      via: "SearchBar onChanged callback"
      pattern: "setSearchQuery"
    - from: "frontend/lib/screens/chats_screen.dart"
      to: "ChatsProvider.filteredThreads"
      via: "Consumer using filteredThreads instead of threads"
      pattern: "provider.filteredThreads"
---

<objective>
Add search and sort functionality to the ChatsScreen (global chats view).

Purpose: Users need to quickly find specific chats among many threads. SEARCH-01 through SEARCH-04 requirements.
Output: Working search bar and sort selector on ChatsScreen with filtered results.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-thread-search-filter/27-RESEARCH.md

@frontend/lib/providers/chats_provider.dart
@frontend/lib/screens/chats_screen.dart
@frontend/lib/models/thread.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ThreadSortOption enum and add filter state to ChatsProvider</name>
  <files>
    frontend/lib/models/thread_sort.dart
    frontend/lib/providers/chats_provider.dart
  </files>
  <action>
    1. Create `frontend/lib/models/thread_sort.dart`:
       ```dart
       enum ThreadSortOption {
         newest('Newest'),
         oldest('Oldest'),
         alphabetical('A-Z');

         final String label;
         const ThreadSortOption(this.label);
       }
       ```

    2. Update `frontend/lib/providers/chats_provider.dart`:
       - Import `thread_sort.dart`
       - Add private fields: `_searchQuery` (String, default ''), `_sortOption` (ThreadSortOption, default newest)
       - Add getters: `searchQuery`, `sortOption`
       - Add computed getter `filteredThreads`:
         - Filter by searchQuery (case-insensitive match on thread.title ?? '')
         - Sort by sortOption (newest: updatedAt desc, oldest: updatedAt asc, alphabetical: title asc)
         - Return filtered and sorted list
       - Add methods: `setSearchQuery(String)`, `setSortOption(ThreadSortOption)`, `clearSearch()`
       - Each method calls notifyListeners()

    Note: Use `lastActivityAt ?? updatedAt` for sorting since lastActivityAt better reflects recent activity.
  </action>
  <verify>
    Run `flutter analyze` from frontend directory - no new errors.
    Unit test: Create ChatsProvider, call setSearchQuery('test'), verify filteredThreads filters correctly.
  </verify>
  <done>
    - ThreadSortOption enum exists with 3 options and labels
    - ChatsProvider has searchQuery, sortOption state
    - ChatsProvider.filteredThreads returns filtered/sorted list
    - setSearchQuery, setSortOption, clearSearch methods work
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SearchBar and SegmentedButton UI to ChatsScreen</name>
  <files>
    frontend/lib/screens/chats_screen.dart
  </files>
  <action>
    1. Add TextEditingController for search input
    2. In initState, restore search query from provider (if any) to controller
    3. In dispose, dispose the controller
    4. Update header section to include:
       - Existing title row with "Chats" and "New Chat" button
       - SearchBar widget below title:
         - hintText: 'Search chats...'
         - leading: Icon(Icons.search)
         - trailing: clear button (IconButton with Icons.clear) only when text is not empty
         - onChanged: calls provider.setSearchQuery(value)
       - SegmentedButton below SearchBar:
         - segments: ThreadSortOption.values mapped to ButtonSegment
         - selected: {provider.sortOption}
         - onSelectionChanged: calls provider.setSortOption(selected.first)

    5. Update _buildEmptyState to differentiate:
       - If provider.searchQuery.isNotEmpty AND filteredThreads.isEmpty: Show "No chats matching 'X'" with clear button
       - Else (truly no threads): Show existing empty state

    6. Update _buildThreadList:
       - Use provider.filteredThreads instead of provider.threads
       - Keep itemCount logic using filteredThreads.length

    7. Add _clearSearch helper method that clears controller and calls provider.clearSearch()

    Important: Keep SegmentedButton compact - use showSelectedIcon: false if it takes too much space.
  </action>
  <verify>
    Run app, navigate to Chats:
    - SearchBar appears below header
    - SegmentedButton shows Newest/Oldest/A-Z
    - Typing in search filters list instantly
    - Clear button appears when search has text
    - Changing sort reorders list
    - With no matches: "No chats matching 'X'" message appears
    - With no threads at all: "No chats yet" message appears
  </verify>
  <done>
    - ChatsScreen has SearchBar with clear button
    - ChatsScreen has SegmentedButton for sort options
    - Filtering works instantly on typing
    - Empty state differentiates "no threads" vs "no matches"
    - Search persists across rebuilds (stored in provider)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Flutter tests for search/sort functionality</name>
  <files>
    frontend/test/widget/chats_screen_test.dart
  </files>
  <action>
    Update existing `chats_screen_test.dart` or create if needed:

    1. Test: "search bar filters threads by title"
       - Setup mock with 3 threads (titles: 'Alpha', 'Beta', 'Gamma')
       - Enter 'Beta' in search field
       - Verify only 'Beta' thread is displayed

    2. Test: "sort options change thread order"
       - Setup mock with threads having different updatedAt dates
       - Verify default shows newest first
       - Select 'Oldest' sort
       - Verify order reverses

    3. Test: "empty search results show appropriate message"
       - Setup mock with threads
       - Enter search term that matches nothing
       - Verify "No chats matching 'xyz'" text appears

    4. Test: "clear button clears search"
       - Enter search term
       - Tap clear button
       - Verify search field empty and all threads shown

    Use mockito/mocktail for ThreadService mocking (follow existing test patterns).
  </action>
  <verify>
    Run: `cd frontend && flutter test test/widget/chats_screen_test.dart`
    All tests pass.
  </verify>
  <done>
    - 4 test cases covering search filtering, sort order, empty results, and clear functionality
    - All tests pass
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && flutter analyze` - no errors
2. `cd frontend && flutter test` - all tests pass
3. Manual: Open app, go to Chats, verify search and sort work
4. Requirements coverage:
   - SEARCH-01: Search bar filters by title (Task 2)
   - SEARCH-02: Sort options Newest/Oldest/A-Z (Task 2)
   - SEARCH-03: Search persists until cleared (Task 1 provider state)
   - SEARCH-04: Empty result message (Task 2 empty state)
</verification>

<success_criteria>
- SearchBar visible on ChatsScreen
- Typing filters threads instantly (case-insensitive title match)
- SegmentedButton switches between Newest, Oldest, A-Z sort
- Clear button in SearchBar clears search
- "No chats matching 'X'" shown when no results
- "No chats yet" shown when truly empty
- Search/sort state persists across navigation
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/27-thread-search-filter/27-01-SUMMARY.md`
</output>

---
phase: 37-document-download
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/screens/documents/document_viewer_screen.dart
  - frontend/lib/screens/documents/document_list_screen.dart
autonomous: true

must_haves:
  truths:
    - "User can download document from viewer screen"
    - "User can download document from list context menu"
    - "Downloaded file has original filename"
    - "Success message shows after download"
  artifacts:
    - path: "frontend/lib/screens/documents/document_viewer_screen.dart"
      provides: "Download button in AppBar, download method"
      contains: "FileSaver.instance.saveFile"
    - path: "frontend/lib/screens/documents/document_list_screen.dart"
      provides: "Download menu option, content fetch then download"
      contains: "value == 'download'"
  key_links:
    - from: "document_viewer_screen.dart"
      to: "file_saver"
      via: "FileSaver.instance.saveFile()"
      pattern: "FileSaver\\.instance\\.saveFile"
    - from: "document_list_screen.dart"
      to: "DocumentProvider"
      via: "selectDocument() to fetch content before download"
      pattern: "selectDocument.*_downloadDocument"
---

<objective>
Add document download capability to both the Document Viewer screen and Document List screen.

Purpose: Users can save documents to their device for offline access or sharing, completing the document workflow alongside upload and view.

Output: Download icon in DocumentViewerScreen AppBar, download option in DocumentListScreen context menu, success snackbar after download.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/37-document-download/37-RESEARCH.md

Key source files:
@frontend/lib/screens/documents/document_viewer_screen.dart
@frontend/lib/screens/documents/document_list_screen.dart
@frontend/lib/services/artifact_service.dart (file_saver pattern to copy)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add download to DocumentViewerScreen</name>
  <files>frontend/lib/screens/documents/document_viewer_screen.dart</files>
  <action>
Add document download capability to the viewer screen:

1. Add imports at top:
   ```dart
   import 'dart:convert';
   import 'dart:typed_data';
   import 'package:file_saver/file_saver.dart';
   ```

2. Add `_downloadDocument()` method to `_DocumentViewerScreenState`:
   ```dart
   Future<void> _downloadDocument(Document doc) async {
     if (doc.content == null) {
       ScaffoldMessenger.of(context).showSnackBar(
         const SnackBar(content: Text('Document content not loaded')),
       );
       return;
     }

     try {
       final bytes = Uint8List.fromList(utf8.encode(doc.content!));
       final extension = doc.filename.contains('.')
           ? doc.filename.split('.').last
           : 'txt';
       final nameWithoutExt = doc.filename.replaceAll(RegExp(r'\.[^.]+$'), '');

       await FileSaver.instance.saveFile(
         name: nameWithoutExt,
         bytes: bytes,
         ext: extension,
         mimeType: MimeType.text,
       );

       if (mounted) {
         ScaffoldMessenger.of(context).showSnackBar(
           SnackBar(
             content: Text('Downloaded ${doc.filename}'),
             action: SnackBarAction(label: 'OK', onPressed: () {}),
           ),
         );
       }
     } catch (e) {
       if (mounted) {
         ScaffoldMessenger.of(context).showSnackBar(
           SnackBar(
             content: Text('Download failed: $e'),
             backgroundColor: Theme.of(context).colorScheme.error,
           ),
         );
       }
     }
   }
   ```

3. Add import for Document model:
   ```dart
   import '../../models/document.dart';
   ```

4. Add download IconButton to AppBar actions. Wrap AppBar in Consumer to access provider:
   ```dart
   appBar: Consumer<DocumentProvider>(
     builder: (context, provider, child) {
       return AppBar(
         title: Text(provider.selectedDocument?.filename ?? 'Loading...'),
         actions: [
           if (provider.selectedDocument != null)
             IconButton(
               icon: const Icon(Icons.download),
               tooltip: 'Download',
               onPressed: () => _downloadDocument(provider.selectedDocument!),
             ),
         ],
       );
     },
   ),
   ```

IMPORTANT: The download button should only appear when document is loaded (not during loading state).
  </action>
  <verify>
Run `flutter analyze` - no errors.
Run app, navigate to a document viewer, verify download icon appears in AppBar.
Click download icon - file should download with original filename.
Snackbar shows "Downloaded {filename}".
  </verify>
  <done>
DOWNLOAD-01: Download icon button visible in Document Viewer AppBar.
DOWNLOAD-03: Downloaded file has original filename (parsed correctly for file_saver).
DOWNLOAD-04: Success snackbar displays "Downloaded {filename}".
DOWNLOAD-05: Uses file_saver which works on web, Android, iOS.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add download to DocumentListScreen context menu</name>
  <files>frontend/lib/screens/documents/document_list_screen.dart</files>
  <action>
Add download option to the document list context menu. Key challenge: documents in list don't have content loaded, so must fetch first.

1. Add imports at top:
   ```dart
   import 'dart:convert';
   import 'dart:typed_data';
   import 'package:file_saver/file_saver.dart';
   ```

2. Add `_downloadDocument()` method to `_DocumentListScreenState`:
   ```dart
   /// Download document - fetches content first if needed
   Future<void> _downloadDocument(BuildContext context, Document doc) async {
     final provider = context.read<DocumentProvider>();

     try {
       // Show loading indicator
       ScaffoldMessenger.of(context).showSnackBar(
         const SnackBar(
           content: Row(
             children: [
               SizedBox(
                 width: 20,
                 height: 20,
                 child: CircularProgressIndicator(strokeWidth: 2),
               ),
               SizedBox(width: 16),
               Text('Preparing download...'),
             ],
           ),
           duration: Duration(seconds: 30), // Will be dismissed on completion
         ),
       );

       // Fetch content (documents in list don't have content loaded)
       await provider.selectDocument(doc.id);

       if (!mounted) return;

       final loadedDoc = provider.selectedDocument;
       if (loadedDoc == null || loadedDoc.content == null) {
         ScaffoldMessenger.of(context).clearSnackBars();
         ScaffoldMessenger.of(context).showSnackBar(
           const SnackBar(content: Text('Failed to load document content')),
         );
         return;
       }

       // Download the file
       final bytes = Uint8List.fromList(utf8.encode(loadedDoc.content!));
       final extension = loadedDoc.filename.contains('.')
           ? loadedDoc.filename.split('.').last
           : 'txt';
       final nameWithoutExt = loadedDoc.filename.replaceAll(RegExp(r'\.[^.]+$'), '');

       await FileSaver.instance.saveFile(
         name: nameWithoutExt,
         bytes: bytes,
         ext: extension,
         mimeType: MimeType.text,
       );

       // Clear the selected document (we just needed it for download)
       provider.clearSelectedDocument();

       if (mounted) {
         ScaffoldMessenger.of(context).clearSnackBars();
         ScaffoldMessenger.of(context).showSnackBar(
           SnackBar(
             content: Text('Downloaded ${loadedDoc.filename}'),
             action: SnackBarAction(label: 'OK', onPressed: () {}),
           ),
         );
       }
     } catch (e) {
       if (mounted) {
         ScaffoldMessenger.of(context).clearSnackBars();
         ScaffoldMessenger.of(context).showSnackBar(
           SnackBar(
             content: Text('Download failed: $e'),
             backgroundColor: Theme.of(context).colorScheme.error,
           ),
         );
       }
     }
   }
   ```

3. Add download option to PopupMenuButton (between 'view' and 'delete'):
   ```dart
   const PopupMenuItem(
     value: 'download',
     child: Row(
       children: [
         Icon(Icons.download),
         SizedBox(width: 8),
         Text('Download'),
       ],
     ),
   ),
   ```

4. Handle 'download' in onSelected:
   ```dart
   onSelected: (value) {
     if (value == 'view') {
       Navigator.push(
         context,
         MaterialPageRoute(
           builder: (context) => DocumentViewerScreen(documentId: doc.id),
         ),
       );
     } else if (value == 'download') {
       _downloadDocument(context, doc);
     } else if (value == 'delete') {
       _deleteDocument(context, doc.id);
     }
   },
   ```

IMPORTANT: The download from list fetches content first, shows a loading snackbar, then downloads. This handles the fact that documents in the list don't have content loaded.
  </action>
  <verify>
Run `flutter analyze` - no errors.
Run app, navigate to document list, click three-dot menu on a document.
Verify "Download" option appears between "View" and "Delete".
Click Download - should show "Preparing download..." briefly, then download file and show success snackbar.
  </verify>
  <done>
DOWNLOAD-02: Download option available in document list context menu.
DOWNLOAD-03: Downloaded file has original filename.
DOWNLOAD-04: Success snackbar displays "Downloaded {filename}".
DOWNLOAD-05: Uses file_saver which works on web, Android, iOS.
  </done>
</task>

</tasks>

<verification>
All requirements verified:

| Requirement | Verification |
|-------------|--------------|
| DOWNLOAD-01 | Download icon visible in Document Viewer AppBar |
| DOWNLOAD-02 | Download option in document list context menu |
| DOWNLOAD-03 | File downloads with original filename |
| DOWNLOAD-04 | Snackbar shows "Downloaded {filename}" |
| DOWNLOAD-05 | file_saver package handles web/Android/iOS |

Run full verification:
```bash
cd frontend && flutter analyze
```

Manual testing:
1. Open Document Viewer - download icon should appear
2. Click download - file saves with correct name
3. Open Document List - context menu shows Download option
4. Click Download from list - file saves after brief loading
</verification>

<success_criteria>
1. `flutter analyze` passes with no errors
2. Download icon visible in Document Viewer AppBar when document is loaded
3. Download option visible in Document List context menu
4. Downloaded files have correct original filename (no double extension, no missing extension)
5. Success snackbar shows "Downloaded {filename}" after each download
6. Error handling shows error snackbar on failure
</success_criteria>

<output>
After completion, create `.planning/phases/37-document-download/37-01-SUMMARY.md`
</output>

---
phase: 05-cross-platform-polish-launch
plan: 03
type: execute
wave: 2
depends_on: []
files_modified:
  - backend/app/config.py
  - backend/.env.example
  - backend/main.py
autonomous: true

must_haves:
  truths:
    - Backend fails to start if production SECRET_KEY is default value
    - Backend fails to start if ANTHROPIC_API_KEY is missing
    - Separate OAuth credentials used for development vs production
  artifacts:
    - path: "backend/app/config.py"
      provides: "Environment validation logic"
      contains: "validate_required"
      min_lines: 80
    - path: "backend/.env.example"
      provides: "Environment variable template"
      contains: "# Production OAuth (separate registration)"
    - path: "backend/main.py"
      provides: "Startup validation call"
      contains: "settings.validate_required()"
  key_links:
    - from: "backend/main.py"
      to: "backend/app/config.py"
      via: "settings.validate_required() call"
      pattern: "settings\\.validate_required\\(\\)"
    - from: "backend/app/config.py"
      to: "environment variable"
      via: "Production validation checks"
      pattern: "if self\\.environment == ['\"]production['\"]"
---

<objective>
Add production environment validation to prevent deployment with development credentials and provide clear configuration guidance for separate dev/prod OAuth registrations.

Purpose: Prevent security issues from deploying with default secrets, enforce separate OAuth app registrations per environment, and fail fast at startup if configuration is invalid.

Output: Backend validates all required environment variables at startup, raises ValueError with helpful message if misconfigured, and .env.example documents required variables for each environment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-cross-platform-polish-launch/05-RESEARCH.md

# Current configuration
@backend/app/config.py
@backend/main.py

# OAuth setup from Phase 1
@backend/app/routes/auth.py
@backend/app/services/auth_service.py
</context>

<tasks>

<task type="auto">
  <name>Add production environment validation to config.py</name>
  <files>
    backend/app/config.py
  </files>
  <action>
    Add validate_required() method to Settings class that checks critical environment variables based on environment.

    Method should raise ValueError with helpful messages if:
    1. environment == "production" AND secret_key is still default value
    2. environment == "production" AND anthropic_api_key is empty/None
    3. environment == "production" AND (google_client_id is empty OR microsoft_client_id is empty)
    4. environment == "production" AND database_url still points to sqlite (warn about using PostgreSQL)

    Add environment property that reads ENVIRONMENT env var (defaults to "development"):
    ```python
    environment: str = Field(default="development", env="ENVIRONMENT")
    ```

    Add validate_required() method:
    ```python
    def validate_required(self) -> None:
        """Validate required configuration for current environment."""
        if self.environment == "production":
            # Check SECRET_KEY
            if self.secret_key == "dev-secret-key-change-in-production":
                raise ValueError(
                    "SECRET_KEY must be changed for production. "
                    "Generate a secure key with: openssl rand -hex 32"
                )

            # Check ANTHROPIC_API_KEY
            if not self.anthropic_api_key:
                raise ValueError(
                    "ANTHROPIC_API_KEY must be set for AI features. "
                    "Get API key from https://console.anthropic.com/"
                )

            # Check OAuth credentials
            if not self.google_client_id or not self.microsoft_client_id:
                raise ValueError(
                    "OAuth credentials required for production. "
                    "Create separate OAuth app registrations for production environment."
                )

            # Warn about SQLite in production
            if "sqlite" in self.database_url.lower():
                print(
                    "WARNING: Using SQLite in production. "
                    "Consider PostgreSQL for better concurrency and data safety."
                )
    ```

    Add oauth_redirect_base_url property that returns correct base URL per environment:
    ```python
    @property
    def oauth_redirect_base_url(self) -> str:
        """OAuth redirect base URL varies by environment."""
        if self.environment == "production":
            # Read from BACKEND_URL env var (e.g., https://api.example.com)
            backend_url = os.getenv("BACKEND_URL", "")
            if not backend_url:
                raise ValueError("BACKEND_URL must be set in production for OAuth redirects")
            return backend_url
        return "http://localhost:8000"  # Development default
    ```

    Update Settings class to use Pydantic BaseSettings (already should be). Ensure env var loading works.

    Do NOT change existing default values for development (keep localhost, dev keys, etc.). Validation only applies when environment="production".
  </action>
  <verify>
    1. Python syntax check: `python -m py_compile backend/app/config.py`
    2. Import check: `cd backend && python -c "from app.config import settings; print(settings.environment)"`
    3. Grep for validate_required: `grep "def validate_required" backend/app/config.py`
  </verify>
  <done>
    - Settings class has environment field reading ENVIRONMENT env var
    - validate_required() method checks SECRET_KEY, ANTHROPIC_API_KEY, OAuth credentials in production
    - ValueError raised with helpful messages if validation fails
    - oauth_redirect_base_url property returns environment-specific base URL
    - SQLite warning printed in production (not blocking error)
    - Development environment unchanged (no validation failures)
  </done>
</task>

<task type="auto">
  <name>Call validation at application startup</name>
  <files>
    backend/main.py
  </files>
  <action>
    Update main.py to call settings.validate_required() during application startup, BEFORE FastAPI app is created.

    Pattern from RESEARCH.md:
    ```python
    from app.config import settings
    import logging

    logger = logging.getLogger(__name__)

    # Validate configuration before starting
    try:
        settings.validate_required()
    except ValueError as e:
        logger.error(f"Configuration validation failed: {e}")
        raise

    app = FastAPI(
        title="Business Analyst Assistant API",
        version="1.0.0",
        docs_url="/docs" if settings.environment != "production" else None,
    )
    ```

    This ensures:
    - Invalid configuration prevents server from starting
    - Error message is clear and actionable
    - Production deployment fails fast if misconfigured
    - Development environment works without extra setup

    Also update FastAPI docs_url to disable Swagger docs in production (security best practice).

    If main.py already has app initialization in a function, add validation at the top of that function. If app is module-level, add validation immediately before app = FastAPI(...).
  </action>
  <verify>
    1. Start backend in dev mode: `cd backend && uvicorn main:app` (should succeed)
    2. Test production validation: `ENVIRONMENT=production SECRET_KEY=dev-secret-key-change-in-production uvicorn main:app` (should fail with ValueError)
    3. Grep for validation call: `grep "validate_required" backend/main.py`
  </verify>
  <done>
    - settings.validate_required() called at startup before FastAPI app creation
    - ValueError caught and logged if validation fails
    - Server refuses to start if production config is invalid
    - Development mode works without changes (ENVIRONMENT defaults to "development")
    - Swagger docs disabled in production (docs_url=None when environment=="production")
  </done>
</task>

<task type="auto">
  <name>Create .env.example with environment-specific guidance</name>
  <files>
    backend/.env.example
  </files>
  <action>
    Create comprehensive .env.example file documenting all required environment variables with separate sections for development and production.

    Structure:
    ```bash
    # Environment Configuration
    # Copy this file to .env and fill in your values
    # DO NOT commit .env to git (it's in .gitignore)

    # ===== ENVIRONMENT =====
    # Options: development, production
    ENVIRONMENT=development

    # ===== DATABASE =====
    # Development: SQLite (file-based, zero setup)
    DATABASE_URL=sqlite+aiosqlite:///./ba_assistant.db

    # Production: PostgreSQL (recommended for Railway/Render)
    # DATABASE_URL=postgresql+asyncpg://user:password@host:5432/dbname

    # ===== SECURITY =====
    # Development: Default key (DO NOT use in production)
    SECRET_KEY=dev-secret-key-change-in-production

    # Production: Generate secure key with: openssl rand -hex 32
    # SECRET_KEY=your-secure-random-key-here

    # ===== ANTHROPIC API =====
    # Required for AI features
    # Get from: https://console.anthropic.com/
    ANTHROPIC_API_KEY=sk-ant-api03-...

    # ===== OAUTH - DEVELOPMENT =====
    # Google OAuth (localhost redirect)
    # Console: https://console.cloud.google.com/apis/credentials
    # Redirect URI: http://localhost:8000/auth/google/callback
    GOOGLE_CLIENT_ID=your-dev-google-client-id
    GOOGLE_CLIENT_SECRET=your-dev-google-client-secret

    # Microsoft OAuth (localhost redirect)
    # Portal: https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps
    # Redirect URI: http://localhost:8000/auth/microsoft/callback
    MICROSOFT_CLIENT_ID=your-dev-microsoft-client-id
    MICROSOFT_CLIENT_SECRET=your-dev-microsoft-client-secret

    # ===== OAUTH - PRODUCTION (separate app registrations required) =====
    # Google OAuth (production redirect)
    # Create SEPARATE app registration in Google Cloud Console
    # Redirect URI: https://your-backend.railway.app/auth/google/callback
    # GOOGLE_CLIENT_ID=your-prod-google-client-id
    # GOOGLE_CLIENT_SECRET=your-prod-google-client-secret

    # Microsoft OAuth (production redirect)
    # Create SEPARATE app registration in Azure AD
    # Redirect URI: https://your-backend.railway.app/auth/microsoft/callback
    # MICROSOFT_CLIENT_ID=your-prod-microsoft-client-id
    # MICROSOFT_CLIENT_SECRET=your-prod-microsoft-client-secret

    # Backend base URL (required in production for OAuth redirect construction)
    # BACKEND_URL=https://your-backend.railway.app

    # ===== CORS =====
    # Development: Localhost frontend
    CORS_ORIGINS=http://localhost:8080

    # Production: Your deployed frontend URL
    # CORS_ORIGINS=https://your-frontend.railway.app,https://app.example.com
    ```

    Add comments explaining:
    - Why separate OAuth registrations are required (security, redirect URI validation)
    - How to generate secure SECRET_KEY
    - Where to get ANTHROPIC_API_KEY
    - Which values must change for production
    - Common PaaS patterns (Railway DATABASE_URL format)

    Keep existing .env (if present) unchanged. This is just example/template.
  </action>
  <verify>
    1. File exists: `ls backend/.env.example`
    2. Check structure: `grep "ENVIRONMENT" backend/.env.example`
    3. Check OAuth sections: `grep -A 5 "OAUTH - PRODUCTION" backend/.env.example`
  </verify>
  <done>
    - .env.example created with comprehensive environment variable documentation
    - Separate sections for development and production configurations
    - OAuth configuration explains need for separate app registrations
    - Security guidance included (SECRET_KEY generation, ANTHROPIC_API_KEY source)
    - Comments explain which values are safe defaults vs must-change
    - Example values for Railway/Render deployment patterns
  </done>
</task>

</tasks>

<verification>
**Development Mode (should work unchanged):**
1. cd backend && uvicorn main:app --reload
2. Server starts successfully without errors
3. API docs visible at http://localhost:8000/docs

**Production Validation (should fail fast):**
1. Test with default SECRET_KEY:
   ```bash
   ENVIRONMENT=production SECRET_KEY=dev-secret-key-change-in-production uvicorn main:app
   ```
   Expected: ValueError with message about SECRET_KEY

2. Test with missing ANTHROPIC_API_KEY:
   ```bash
   ENVIRONMENT=production SECRET_KEY=abc123 uvicorn main:app
   ```
   Expected: ValueError with message about ANTHROPIC_API_KEY

3. Test with missing OAuth:
   ```bash
   ENVIRONMENT=production SECRET_KEY=abc123 ANTHROPIC_API_KEY=sk-test uvicorn main:app
   ```
   Expected: ValueError with message about OAuth credentials

4. Test with valid production config:
   ```bash
   ENVIRONMENT=production SECRET_KEY=abc123 ANTHROPIC_API_KEY=sk-test \
   GOOGLE_CLIENT_ID=prod-google MICROSOFT_CLIENT_ID=prod-ms \
   GOOGLE_CLIENT_SECRET=secret1 MICROSOFT_CLIENT_SECRET=secret2 \
   BACKEND_URL=https://api.example.com uvicorn main:app
   ```
   Expected: Server starts, no /docs endpoint

**Documentation:**
1. cat backend/.env.example - shows clear sections and guidance
2. Grep for "separate" - explains OAuth separation requirement
</verification>

<success_criteria>
- Backend calls settings.validate_required() at startup before app creation
- Production environment requires non-default SECRET_KEY or server fails to start
- Production environment requires ANTHROPIC_API_KEY or server fails to start
- Production environment requires OAuth credentials or server fails to start
- .env.example documents all required variables with dev/prod sections
- Development mode works without any configuration changes (defaults are safe)
- Error messages are actionable (tell user how to fix the problem)
- Swagger docs disabled in production (docs_url=None when ENVIRONMENT=production)
</success_criteria>

<output>
After completion, create `.planning/phases/05-cross-platform-polish-launch/05-03-SUMMARY.md`
</output>

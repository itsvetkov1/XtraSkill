---
phase: 33-ci-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/flutter-ci.yml
  - codecov.yml
  - README.md
autonomous: true
user_setup:
  - service: codecov
    why: "Coverage tracking and badge generation"
    env_vars:
      - name: CODECOV_TOKEN
        source: "Codecov Dashboard -> Settings -> General -> Repository Upload Token (after linking repo)"
    dashboard_config:
      - task: "Link repository to Codecov"
        location: "https://app.codecov.io/gh -> Add new repository -> Select itsvetkov1/XtraSkill"

must_haves:
  truths:
    - "CI workflow runs pytest with coverage on manual/scheduled trigger"
    - "CI workflow runs flutter test with coverage on manual/scheduled trigger"
    - "CI fails if any test fails (zero tolerance)"
    - "Coverage uploads to Codecov with backend/frontend flags"
    - "README displays coverage badge"
  artifacts:
    - path: ".github/workflows/flutter-ci.yml"
      provides: "CI workflow with coverage generation and Codecov upload"
      contains: "codecov/codecov-action"
    - path: "codecov.yml"
      provides: "Codecov configuration with thresholds and flags"
      contains: "informational: true"
    - path: "README.md"
      provides: "Project README with coverage badge"
      contains: "codecov.io"
  key_links:
    - from: ".github/workflows/flutter-ci.yml"
      to: "codecov.yml"
      via: "Codecov action reads config"
      pattern: "codecov-action"
    - from: ".github/workflows/flutter-ci.yml"
      to: "CODECOV_TOKEN secret"
      via: "secrets.CODECOV_TOKEN"
      pattern: "secrets.CODECOV_TOKEN"
---

<objective>
Configure CI pipeline to track and enforce test coverage with Codecov integration.

Purpose: Enable automated coverage tracking, quality gates, and visibility into test health across backend (Python) and frontend (Flutter) codebases.

Output:
- Modified CI workflow with coverage generation and Codecov uploads
- Codecov configuration file with thresholds and flags
- Root README with coverage badge
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-ci-integration/33-RESEARCH.md
@.github/workflows/flutter-ci.yml
@backend/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify CI workflow for coverage generation and Codecov upload</name>
  <files>.github/workflows/flutter-ci.yml</files>
  <action>
Modify the existing flutter-ci.yml workflow:

1. **Replace triggers** (remove push/PR, add manual/scheduled):
```yaml
on:
  workflow_dispatch:
  schedule:
    - cron: '0 9 * * 1'  # Monday 9 AM UTC
  repository_dispatch:
    types: [test-command]
  push:
    branches: [main, master]
```

2. **Add condition to jobs** to only run on push if commit contains /test:
```yaml
jobs:
  backend-test:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      github.event_name == 'repository_dispatch' ||
      (github.event_name == 'push' && contains(github.event.head_commit.message, '/test'))
```

3. **Backend job changes**:
   - Run ALL tests: `pytest tests/ --cov=app --cov-report=xml --cov-report=term-missing -v`
   - Add environment variables for test mocking: `TESTING=true`
   - Add step to upload coverage to Codecov with `backend` flag

4. **Frontend job changes**:
   - Change `flutter test test/widget/` and separate integration test step to: `flutter test --coverage` (runs ALL tests)
   - Remove separate integration test step (combined into one)
   - Add step to upload coverage to Codecov with `frontend` flag

5. **Codecov upload steps** (add after each test step):
```yaml
- name: Upload backend coverage to Codecov
  uses: codecov/codecov-action@v5
  with:
    files: ./backend/coverage.xml
    flags: backend
    token: ${{ secrets.CODECOV_TOKEN }}
    fail_ci_if_error: false

- name: Upload frontend coverage to Codecov
  uses: codecov/codecov-action@v5
  with:
    files: ./frontend/coverage/lcov.info
    flags: frontend
    token: ${{ secrets.CODECOV_TOKEN }}
    fail_ci_if_error: false
```

6. **Keep flutter-build-web job** but add same trigger condition.

Do NOT add slash-command-dispatch workflow (requires PAT which adds complexity - defer to user request).
  </action>
  <verify>
cat .github/workflows/flutter-ci.yml | grep -E "(workflow_dispatch|codecov|--cov|--coverage)" | wc -l
# Should show 4+ lines indicating triggers and coverage commands present
  </verify>
  <done>
CI workflow has:
- Manual dispatch trigger (workflow_dispatch)
- Scheduled trigger (Monday 9 AM UTC)
- Repository dispatch trigger (for /test command integration)
- Push trigger with /test commit message check
- Backend tests run ALL tests with --cov flags
- Frontend tests run with --coverage flag
- Codecov upload steps with backend/frontend flags
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Codecov configuration with thresholds and flags</name>
  <files>codecov.yml</files>
  <action>
Create codecov.yml in repository root with:

```yaml
# Codecov configuration
# Docs: https://docs.codecov.com/docs/codecovyml-reference

codecov:
  require_ci_to_pass: yes

coverage:
  precision: 2
  round: down
  status:
    project:
      default:
        target: auto
        threshold: 5%
        informational: true  # Warn only, don't fail PR
      backend:
        flags:
          - backend
        target: 60%
        informational: true
      frontend:
        flags:
          - frontend
        target: 50%
        informational: true
    patch:
      default:
        target: 50%
        informational: true

flags:
  backend:
    paths:
      - app/
    carryforward: true
  frontend:
    paths:
      - lib/
    carryforward: true

comment:
  layout: "reach,diff,flags,files"
  behavior: default
  require_changes: true
```

Key configuration choices:
- `informational: true` on all status checks: Coverage changes warn but don't block PRs
- `target: 60%` for backend (currently ~67%)
- `target: 50%` for frontend (conservative start)
- `carryforward: true`: If only backend changes, frontend coverage carries forward
- PR comments show coverage diff and file breakdown
  </action>
  <verify>
cat codecov.yml | grep -E "(informational|backend|frontend)" | wc -l
# Should show 6+ lines with flag and informational settings
  </verify>
  <done>
codecov.yml exists with:
- Project-level and per-flag coverage targets
- informational: true (warn-only mode)
- Backend flag pointing to app/
- Frontend flag pointing to lib/
- PR comment configuration
  </done>
</task>

<task type="auto">
  <name>Task 3: Create root README with coverage badge</name>
  <files>README.md</files>
  <action>
Create README.md in repository root:

```markdown
# BA Assistant

Business Analyst Assistant - AI-powered tool for requirement documentation.

[![codecov](https://codecov.io/github/itsvetkov1/XtraSkill/graph/badge.svg)](https://codecov.io/github/itsvetkov1/XtraSkill)

## Overview

BA Assistant helps business analysts reduce time spent on requirement documentation while improving completeness through AI-assisted discovery conversations that systematically explore edge cases and generate production-ready artifacts.

## Project Structure

```
BA_assistant/
  backend/     # FastAPI backend (Python)
  frontend/    # Flutter web application
```

## Quick Start

### Backend

```bash
cd backend
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
python run.py
```

### Frontend

```bash
cd frontend
flutter pub get
flutter run -d chrome
```

## Documentation

- [Frontend README](frontend/README.md) - Flutter app setup and testing
- [API Documentation](http://localhost:8000/docs) - OpenAPI/Swagger (when backend running)

## Testing

### Backend Tests

```bash
cd backend
pytest tests/ -v                           # Run all tests
pytest tests/ --cov=app --cov-report=html  # With coverage
```

### Frontend Tests

```bash
cd frontend
flutter test                    # Run all tests
flutter test --coverage         # With coverage
./coverage_report.sh            # Generate HTML report
```

## License

Proprietary - All rights reserved.
```

Note: Badge URL uses `itsvetkov1/XtraSkill` as per repository name from research.
If the Codecov token is not yet configured, badge will show "unknown" until first successful upload.
  </action>
  <verify>
cat README.md | grep -E "(codecov.io|BA Assistant)" | head -3
# Should show badge URL and title
  </verify>
  <done>
README.md exists at repo root with:
- Codecov coverage badge (auto-updates after CI runs)
- Project overview
- Quick start instructions for backend and frontend
- Testing commands
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Syntax check** - Ensure YAML files are valid:
```bash
python -c "import yaml; yaml.safe_load(open('.github/workflows/flutter-ci.yml'))"
python -c "import yaml; yaml.safe_load(open('codecov.yml'))"
```

2. **Workflow trigger check**:
```bash
grep -A5 "^on:" .github/workflows/flutter-ci.yml
# Should show workflow_dispatch, schedule, repository_dispatch, push
```

3. **Coverage command check**:
```bash
grep -E "(--cov|--coverage)" .github/workflows/flutter-ci.yml
# Should show pytest --cov and flutter test --coverage
```

4. **Codecov upload check**:
```bash
grep -c "codecov-action" .github/workflows/flutter-ci.yml
# Should show 2 (backend + frontend uploads)
```

5. **Badge check**:
```bash
grep "codecov.io" README.md
# Should show badge URL
```
</verification>

<success_criteria>
Phase 33 requirements met:

- CI-01 (Coverage reporting): flutter-ci.yml generates coverage for both backend (--cov) and frontend (--coverage), uploads to Codecov
- CI-02 (All tests pass gate): CI naturally fails if pytest or flutter test exits non-zero
- CI-03 (Coverage threshold): codecov.yml defines thresholds with informational: true (warn-only as specified)
- CI-04 (Coverage badges): README.md contains Codecov badge that auto-updates

Manual verification needed after merge:
1. Add CODECOV_TOKEN secret to GitHub repository settings
2. Trigger workflow manually via Actions tab
3. Verify Codecov receives upload and badge displays
</success_criteria>

<output>
After completion, create `.planning/phases/33-ci-integration/33-01-SUMMARY.md`
</output>

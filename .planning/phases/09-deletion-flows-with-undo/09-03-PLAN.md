---
phase: 09-deletion-flows-with-undo
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - frontend/lib/screens/projects/project_detail_screen.dart
  - frontend/lib/screens/projects/project_list_screen.dart
  - frontend/lib/screens/threads/thread_list_screen.dart
  - frontend/lib/screens/threads/thread_detail_screen.dart
  - frontend/lib/screens/documents/document_list_screen.dart
autonomous: false

must_haves:
  truths:
    - "User can delete project from project detail screen"
    - "User can delete thread from thread list or detail screen"
    - "User can delete document from document list"
    - "User can delete message from thread detail screen"
    - "All delete actions show confirmation dialog before proceeding"
    - "After confirming delete, item disappears and undo SnackBar appears"
    - "Deleting from detail screen navigates back to parent list"
  artifacts:
    - path: "frontend/lib/screens/projects/project_detail_screen.dart"
      provides: "Delete project button in AppBar"
      contains: "showDeleteConfirmationDialog"
    - path: "frontend/lib/screens/threads/thread_list_screen.dart"
      provides: "Delete thread option"
      contains: "deleteThread"
    - path: "frontend/lib/screens/documents/document_list_screen.dart"
      provides: "Delete document option"
      contains: "deleteDocument"
    - path: "frontend/lib/screens/threads/thread_detail_screen.dart"
      provides: "Delete message option"
      contains: "deleteMessage"
  key_links:
    - from: "frontend/lib/screens/projects/project_detail_screen.dart"
      to: "frontend/lib/providers/project_provider.dart"
      via: "context.read<ProjectProvider>().deleteProject()"
      pattern: "deleteProject"
    - from: "frontend/lib/screens/projects/project_detail_screen.dart"
      to: "frontend/lib/widgets/delete_confirmation_dialog.dart"
      via: "import and showDeleteConfirmationDialog call"
      pattern: "showDeleteConfirmationDialog"
---

<objective>
Integrate delete functionality into all relevant screens with confirmation dialogs and post-delete navigation.

Purpose: Allow users to trigger deletions from the UI. Each delete shows confirmation dialog, then calls provider delete method which handles optimistic removal and undo.

Output: Delete buttons/options on project detail, thread list, document list, and thread detail screens.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-deletion-flows-with-undo/09-CONTEXT.md
@.planning/phases/09-deletion-flows-with-undo/09-02-SUMMARY.md

# Screens to modify
@frontend/lib/screens/projects/project_detail_screen.dart
@frontend/lib/screens/threads/thread_list_screen.dart
@frontend/lib/screens/documents/document_list_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add delete button to project detail screen</name>
  <files>
    - frontend/lib/screens/projects/project_detail_screen.dart
  </files>
  <action>
Add delete functionality to ProjectDetailScreen:

1. Add imports:
```dart
import 'package:go_router/go_router.dart';
import '../../widgets/delete_confirmation_dialog.dart';
```

2. Add delete icon button to the AppBar actions (or screen header area):
```dart
IconButton(
  icon: const Icon(Icons.delete_outline),
  tooltip: 'Delete project',
  onPressed: () => _deleteProject(context),
),
```

3. Add _deleteProject method:
```dart
Future<void> _deleteProject(BuildContext context) async {
  final confirmed = await showDeleteConfirmationDialog(
    context: context,
    itemType: 'project',
    cascadeMessage: 'This will delete all threads and documents in this project.',
  );

  if (confirmed && context.mounted) {
    final projectId = /* get current project ID from widget or provider */;
    context.read<ProjectProvider>().deleteProject(context, projectId);

    // Navigate back to projects list
    context.go('/projects');
  }
}
```

Note: The exact implementation depends on how ProjectDetailScreen gets its project ID (likely from route params or provider). Check existing code structure.

The cascade message follows CONTEXT.md: summary info only, no exact counts.
  </action>
  <verify>
Flutter analyze passes and delete button appears in project detail:
```bash
cd frontend && flutter analyze lib/screens/projects/project_detail_screen.dart
```
  </verify>
  <done>Project detail screen has delete button that shows confirmation and navigates back after delete</done>
</task>

<task type="auto">
  <name>Task 2: Add delete options to thread list and document list screens</name>
  <files>
    - frontend/lib/screens/threads/thread_list_screen.dart
    - frontend/lib/screens/documents/document_list_screen.dart
  </files>
  <action>
For ThreadListScreen, add delete option to each thread item:

1. Add imports:
```dart
import '../../widgets/delete_confirmation_dialog.dart';
```

2. Add trailing menu or long-press handler to thread list items:
Option A (PopupMenuButton):
```dart
trailing: PopupMenuButton<String>(
  onSelected: (value) {
    if (value == 'delete') {
      _deleteThread(context, thread.id);
    }
  },
  itemBuilder: (context) => [
    const PopupMenuItem(
      value: 'delete',
      child: Text('Delete'),
    ),
  ],
),
```

Option B (IconButton):
```dart
trailing: IconButton(
  icon: const Icon(Icons.delete_outline),
  onPressed: () => _deleteThread(context, thread.id),
),
```

3. Add _deleteThread method:
```dart
Future<void> _deleteThread(BuildContext context, String threadId) async {
  final confirmed = await showDeleteConfirmationDialog(
    context: context,
    itemType: 'thread',
    cascadeMessage: 'This will delete all messages in this thread.',
  );

  if (confirmed && context.mounted) {
    context.read<ThreadProvider>().deleteThread(context, threadId);
  }
}
```

For DocumentListScreen, apply same pattern:

1. Add import for delete_confirmation_dialog.dart

2. Add delete option to document list items (PopupMenuButton or IconButton)

3. Add _deleteDocument method:
```dart
Future<void> _deleteDocument(BuildContext context, String documentId) async {
  final confirmed = await showDeleteConfirmationDialog(
    context: context,
    itemType: 'document',
    // No cascade message for documents - they don't have children
  );

  if (confirmed && context.mounted) {
    context.read<DocumentProvider>().deleteDocument(context, documentId);
  }
}
```

Use Claude's discretion for button placement - prefer consistency with existing UI patterns in the codebase.
  </action>
  <verify>
Flutter analyze passes:
```bash
cd frontend && flutter analyze lib/screens/threads/thread_list_screen.dart lib/screens/documents/document_list_screen.dart
```
  </verify>
  <done>Thread list and document list screens have delete options with confirmation dialogs</done>
</task>

<task type="auto">
  <name>Task 3: Add delete option for messages in thread detail</name>
  <files>
    - frontend/lib/screens/threads/thread_detail_screen.dart
  </files>
  <action>
Add ability to delete individual messages from thread conversation view:

1. Add imports:
```dart
import '../../widgets/delete_confirmation_dialog.dart';
```

2. For each message bubble/item, add a delete option.
Options (choose based on existing UI pattern):
- Long-press to show context menu
- Swipe-to-delete
- Three-dot menu on message

Example with long-press:
```dart
GestureDetector(
  onLongPress: () => _showMessageOptions(context, message),
  child: MessageBubble(message: message),
)

void _showMessageOptions(BuildContext context, Message message) {
  showModalBottomSheet(
    context: context,
    builder: (context) => SafeArea(
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          ListTile(
            leading: const Icon(Icons.delete_outline),
            title: const Text('Delete message'),
            onTap: () {
              Navigator.pop(context);
              _deleteMessage(context, message.id);
            },
          ),
        ],
      ),
    ),
  );
}
```

3. Add _deleteMessage method:
```dart
Future<void> _deleteMessage(BuildContext context, String messageId) async {
  final confirmed = await showDeleteConfirmationDialog(
    context: context,
    itemType: 'message',
    // No cascade message - messages don't have children
  );

  if (confirmed && context.mounted) {
    final threadId = /* get from widget or provider */;
    context.read<ConversationProvider>().deleteMessage(context, threadId, messageId);
  }
}
```

Note: Check how thread_detail_screen.dart currently renders messages. The delete option should integrate with existing message rendering pattern.
  </action>
  <verify>
Flutter analyze passes:
```bash
cd frontend && flutter analyze lib/screens/threads/thread_detail_screen.dart
```
  </verify>
  <done>Thread detail screen allows deleting individual messages with confirmation</done>
</task>

</tasks>

<verification>
- [ ] Project detail screen has delete button with confirmation dialog
- [ ] Deleting project navigates back to projects list
- [ ] Thread list items have delete option with confirmation
- [ ] Document list items have delete option with confirmation
- [ ] Thread detail allows deleting individual messages
- [ ] All confirmation dialogs use the reusable showDeleteConfirmationDialog
- [ ] All delete actions show cascade info where appropriate
- [ ] Flutter analyze passes for all modified screens
</verification>

<success_criteria>
- User can delete project from project detail (with cascade warning)
- User can delete thread from thread list (with cascade warning)
- User can delete document from document list (no cascade)
- User can delete message from thread detail (no cascade)
- All deletions show confirmation dialog before proceeding
- All deletions trigger provider methods (optimistic removal + undo SnackBar)
- Post-delete navigation works correctly (detail screens go to parent)
</success_criteria>

<output>
After completion, create `.planning/phases/09-deletion-flows-with-undo/09-03-SUMMARY.md`
</output>

<checkpoint type="human-verify" gate="blocking">
  <what-built>
Complete deletion flow for all resource types:
- Backend DELETE endpoints (Plan 01)
- Frontend services, providers with undo support (Plan 02)
- UI integration with confirmation dialogs (Plan 03)
  </what-built>
  <how-to-verify>
1. Start backend: `cd backend && python run.py`
2. Start frontend: `cd frontend && flutter run -d chrome`
3. Log in and create a test project with a thread and document

Test project deletion:
- Open the test project
- Click delete button in project header
- Confirm dialog appears with cascade warning
- Click "Delete" - project disappears, SnackBar shows "Undo"
- Click "Undo" within 10 seconds - project reappears

Test thread deletion:
- Create a new test project with a thread
- Go to thread list
- Delete the thread
- Confirm cascade warning, delete happens, SnackBar shows
- Wait 10 seconds - thread is permanently gone

Test document deletion:
- Upload a document to a project
- Delete it from document list
- Confirm, see SnackBar, can undo

Test message deletion:
- Open a thread with messages
- Long-press (or use delete option) on a message
- Confirm, message disappears with undo option

Test rollback (optional):
- Stop the backend while undo timer is running
- Wait for timer to expire
- Message should reappear with error since backend is down
  </how-to-verify>
  <resume-signal>Type "approved" if all deletion flows work correctly, or describe any issues found</resume-signal>
</checkpoint>

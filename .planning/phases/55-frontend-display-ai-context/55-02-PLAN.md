---
phase: 55-frontend-display-ai-context
plan: 02
type: execute
wave: 2
depends_on: ["55-01"]
files_modified:
  - frontend/lib/screens/documents/document_viewer_screen.dart
  - frontend/lib/screens/documents/widgets/excel_table_viewer.dart
  - frontend/lib/screens/documents/widgets/pdf_text_viewer.dart
  - frontend/lib/screens/documents/widgets/word_text_viewer.dart
  - frontend/lib/screens/documents/document_list_screen.dart
  - frontend/pubspec.yaml
autonomous: true

must_haves:
  truths:
    - "Excel/CSV documents display as sortable table grid with column headers"
    - "PDF documents display with page number markers visible"
    - "Word documents display with structured paragraphs"
    - "Document Viewer shows metadata header (row count for Excel/CSV, page count for PDF, sheet names for Excel)"
    - "1000+ row Excel files render without browser freeze (PlutoGrid virtualization)"
    - "Document list shows format-specific icons for different file types"
  artifacts:
    - path: "frontend/lib/screens/documents/document_viewer_screen.dart"
      provides: "Conditional rendering routing by content_type"
      contains: "spreadsheet"
    - path: "frontend/lib/screens/documents/widgets/excel_table_viewer.dart"
      provides: "PlutoGrid-based table viewer for Excel/CSV with sorting"
      contains: "PlutoGrid"
    - path: "frontend/lib/screens/documents/widgets/pdf_text_viewer.dart"
      provides: "Text viewer with page number markers for PDF"
      contains: "Page"
    - path: "frontend/lib/screens/documents/widgets/word_text_viewer.dart"
      provides: "Structured paragraph viewer for Word documents"
      contains: "paragraph"
  key_links:
    - from: "frontend/lib/screens/documents/document_viewer_screen.dart"
      to: "frontend/lib/screens/documents/widgets/excel_table_viewer.dart"
      via: "conditional switch on document.contentType"
      pattern: "ExcelTableViewer"
    - from: "frontend/lib/screens/documents/widgets/excel_table_viewer.dart"
      to: "frontend/lib/models/document.dart"
      via: "Document.contentType and metadata for rendering"
      pattern: "contentType|metadata"
    - from: "frontend/lib/screens/documents/document_viewer_screen.dart"
      to: "backend GET /documents/{id}"
      via: "DocumentProvider.selectDocument loading content + metadata"
      pattern: "selectDocument"
---

<objective>
Create format-aware Document Viewer with conditional rendering: PlutoGrid table for Excel/CSV, text with page markers for PDF, structured paragraphs for Word. Add metadata header showing format-specific info.

Purpose: Users uploading rich documents need to see them rendered appropriately — tables as tables, not as tab-separated text. PlutoGrid handles 1000+ rows with virtualization, preventing browser freeze.

Output: Document Viewer with 4 format-specific renderers, metadata header, format icons in document list.
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-frontend-display-ai-context/55-RESEARCH.md
@.planning/phases/55-frontend-display-ai-context/55-01-SUMMARY.md
@frontend/lib/models/document.dart
@frontend/lib/screens/documents/document_viewer_screen.dart
@frontend/lib/screens/documents/document_list_screen.dart
@frontend/lib/providers/document_provider.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PlutoGrid dependency and create format-specific viewer widgets</name>
  <files>
    frontend/pubspec.yaml
    frontend/lib/screens/documents/widgets/excel_table_viewer.dart
    frontend/lib/screens/documents/widgets/pdf_text_viewer.dart
    frontend/lib/screens/documents/widgets/word_text_viewer.dart
  </files>
  <action>
    **pubspec.yaml**: Add `pluto_grid: ^8.7.0` to dependencies. Run `flutter pub get`.

    **Create `frontend/lib/screens/documents/widgets/` directory** if it doesn't exist.

    **Excel Table Viewer** (`excel_table_viewer.dart`):
    Create a StatefulWidget `ExcelTableViewer` that takes `content` (String — tab-separated text from backend), and `metadata` (Map with sheet_names, row_count, etc.).

    Implementation:
    1. Parse `content` string (tab-separated format from backend's content_text):
       - Split by `\n` to get rows
       - First row = column headers (split by `\t`)
       - Remaining rows = data rows (split by `\t`)
    2. Build `List<PlutoColumn>` from headers with `enableSorting: true` and `type: PlutoColumnType.text()`
    3. Build `List<PlutoRow>` from data rows
    4. Use `FutureBuilder` pattern: show CircularProgressIndicator while parsing, then PlutoGrid
    5. PlutoGrid configuration:
       ```dart
       PlutoGrid(
         columns: columns,
         rows: rows,
         onLoaded: (PlutoGridOnLoadedEvent event) {
           stateManager = event.stateManager;
         },
         configuration: PlutoGridConfiguration(
           style: PlutoGridStyleConfig(
             enableGridBorderShadow: false,
           ),
         ),
       )
       ```
    6. Handle edge cases: empty content, single row (headers only), mismatched column counts

    **Metadata header** (built into ExcelTableViewer): Show row count and sheet name above the grid:
    ```dart
    Container(
      padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      child: Row(children: [
        Icon(Icons.table_chart, size: 18),
        SizedBox(width: 8),
        Text('${metadata['total_rows'] ?? metadata['row_count'] ?? rows.length} rows'),
        if (sheetNames.isNotEmpty) ...[
          SizedBox(width: 16),
          Text('Sheet: ${sheetNames.join(', ')}'),
        ],
      ]),
    )
    ```

    **PDF Text Viewer** (`pdf_text_viewer.dart`):
    Create a StatelessWidget `PdfTextViewer` that takes `content` (String) and `metadata` (Map with page_count).

    Implementation:
    1. Show metadata header with page count:
       ```dart
       Row(children: [
         Icon(Icons.picture_as_pdf, size: 18),
         SizedBox(width: 8),
         Text('${metadata['page_count'] ?? 0} pages'),
       ])
       ```
    2. Display content in SelectableText with monospace font
    3. The content already contains `[Page N]` markers from backend PDF parser — these are visible naturally in the text
    4. Wrap in SingleChildScrollView for scrolling

    **Word Text Viewer** (`word_text_viewer.dart`):
    Create a StatelessWidget `WordTextViewer` that takes `content` (String) and `metadata` (Map).

    Implementation:
    1. Show metadata header with document type icon
    2. Display content in SelectableText
    3. Use slightly larger line height (1.6) for paragraph readability
    4. Content from backend Word parser preserves paragraph structure with double newlines
    5. Wrap in SingleChildScrollView
  </action>
  <verify>
    1. `grep -n 'pluto_grid' frontend/pubspec.yaml` — dependency added
    2. `ls frontend/lib/screens/documents/widgets/` — all 3 viewer files exist
    3. `grep -n 'PlutoGrid' frontend/lib/screens/documents/widgets/excel_table_viewer.dart` — PlutoGrid used
    4. `grep -n 'page_count' frontend/lib/screens/documents/widgets/pdf_text_viewer.dart` — metadata shown
    5. `cd frontend && flutter pub get` passes
  </verify>
  <done>
    Three format-specific viewer widgets created: ExcelTableViewer with PlutoGrid and sort support, PdfTextViewer with page count header, WordTextViewer with paragraph formatting. PlutoGrid dependency installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Document Viewer and List screens for conditional rendering</name>
  <files>
    frontend/lib/screens/documents/document_viewer_screen.dart
    frontend/lib/screens/documents/document_list_screen.dart
  </files>
  <action>
    **Document Viewer** (`document_viewer_screen.dart`):

    1. Add imports for the three new viewer widgets:
       ```dart
       import 'widgets/excel_table_viewer.dart';
       import 'widgets/pdf_text_viewer.dart';
       import 'widgets/word_text_viewer.dart';
       ```

    2. Replace the existing `_buildBody()` method's content rendering section. After loading/error checks and null check, instead of always showing SelectableText, add conditional rendering by contentType:

       ```dart
       Widget _buildDocumentContent(Document doc) {
         final contentType = doc.contentType ?? 'text/plain';
         final content = doc.content ?? '';
         final metadata = doc.metadata ?? {};

         // Excel/CSV: table viewer with PlutoGrid
         if (contentType.contains('spreadsheet') || contentType == 'text/csv') {
           return ExcelTableViewer(
             content: content,
             metadata: metadata,
           );
         }

         // PDF: text viewer with page markers
         if (contentType == 'application/pdf') {
           return PdfTextViewer(
             content: content,
             metadata: metadata,
           );
         }

         // Word: structured paragraph viewer
         if (contentType.contains('wordprocessing')) {
           return WordTextViewer(
             content: content,
             metadata: metadata,
           );
         }

         // Default: plain text (existing behavior for .txt, .md)
         return SingleChildScrollView(
           padding: const EdgeInsets.all(16.0),
           child: SelectableText(
             content,
             style: const TextStyle(
               fontFamily: 'monospace',
               fontSize: 14,
               height: 1.5,
             ),
           ),
         );
       }
       ```

    3. Update the `_buildBody()` method to call `_buildDocumentContent()` instead of directly rendering SelectableText. The ExcelTableViewer uses PlutoGrid which needs `Expanded` — so the viewer content should fill available space. Wrap in `Expanded` inside a Column layout when using table formats.

    4. Update the download button behavior: For rich documents (isRichFormat), use the `downloadDocument()` method from DocumentService to download original binary. For text documents, keep existing behavior. The download button in the AppBar should call the service's download endpoint for rich formats:
       ```dart
       Future<void> _downloadDocument(Document doc) async {
         try {
           if (doc.isRichFormat) {
             // Rich format: download original binary via download endpoint
             final service = DocumentService();
             final bytes = await service.downloadDocument(doc.id);
             // ... save using FileSaver with correct MIME type
           } else {
             // Text format: existing behavior (encode content to bytes)
             // ... existing code
           }
         }
       }
       ```

    **Document List** (`document_list_screen.dart`):

    1. Update the document list icon to be format-specific. Replace the hardcoded `Icons.description` with a helper:
       ```dart
       IconData _getDocumentIcon(Document doc) {
         final ct = doc.contentType ?? 'text/plain';
         if (ct.contains('spreadsheet') || ct == 'text/csv') return Icons.table_chart;
         if (ct == 'application/pdf') return Icons.picture_as_pdf;
         if (ct.contains('wordprocessing')) return Icons.article;
         return Icons.description;
       }
       ```

    2. Add a subtitle hint showing format-specific metadata (optional, in addition to date):
       - Excel/CSV: "N rows" from metadata
       - PDF: "N pages" from metadata
       - Keep existing date display

    3. Update `_downloadDocument()` to use the new download endpoint for rich formats (same pattern as viewer).
  </action>
  <verify>
    1. `grep -n 'ExcelTableViewer\|PdfTextViewer\|WordTextViewer' frontend/lib/screens/documents/document_viewer_screen.dart` — conditional imports
    2. `grep -n 'spreadsheet\|application/pdf\|wordprocessing' frontend/lib/screens/documents/document_viewer_screen.dart` — content type routing
    3. `grep -n 'table_chart\|picture_as_pdf\|article' frontend/lib/screens/documents/document_list_screen.dart` — format icons
    4. `cd frontend && flutter analyze --no-fatal-infos` passes
  </verify>
  <done>
    Document Viewer conditionally renders PlutoGrid for Excel/CSV, text with page markers for PDF, structured text for Word, and plain text for txt/md. Document list shows format-specific icons. Download works correctly for both text and binary formats.
  </done>
</task>

</tasks>

<verification>
1. Excel document opens in PlutoGrid with sortable column headers
2. CSV document opens in PlutoGrid with sortable column headers
3. PDF document shows page count header and text with [Page N] markers
4. Word document shows structured paragraphs with readable formatting
5. Text/Markdown documents display as before (monospace SelectableText)
6. Document list shows distinct icons per format type
7. Metadata header visible for Excel/CSV (row count, sheet names) and PDF (page count)
8. Download button works for all formats (binary for rich, text for legacy)
9. `flutter analyze` passes without errors
</verification>

<success_criteria>
- Format-specific rendering routes documents to correct viewer widget based on contentType
- PlutoGrid handles large Excel files with virtualization (no browser freeze)
- Metadata headers display row count, page count, and sheet names where applicable
- All 6 document formats render correctly in Document Viewer
- Document list shows format-specific icons
</success_criteria>

<output>
After completion, create `.planning/phases/55-frontend-display-ai-context/55-02-SUMMARY.md`
</output>

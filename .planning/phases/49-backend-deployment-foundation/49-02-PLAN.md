---
phase: 49-backend-deployment-foundation
plan: 02
type: execute
wave: 2
depends_on: ["49-01"]
files_modified: []
autonomous: false
user_setup:
  - service: railway
    why: "Backend hosting platform"
    env_vars:
      - name: ENVIRONMENT
        source: "Set to: production"
      - name: DATABASE_URL
        source: "Set to: sqlite+aiosqlite:////data/ba_assistant.db"
      - name: SECRET_KEY
        source: "Generate with: openssl rand -hex 32 (or python -c 'import secrets; print(secrets.token_hex(32))')"
      - name: BACKEND_URL
        source: "Copy from Railway deployment URL (e.g., https://xxx.up.railway.app)"
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials"
      - name: MICROSOFT_CLIENT_ID
        source: "Azure Portal -> App registrations -> Application (client) ID"
      - name: MICROSOFT_CLIENT_SECRET
        source: "Azure Portal -> App registrations -> Certificates & secrets"
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys"
      - name: CORS_ORIGINS
        source: "Set to Railway URL for now (e.g., https://xxx.up.railway.app). Update when frontend deployed."
      - name: LOG_LEVEL
        source: "Set to: INFO"
      - name: FERNET_KEY
        source: "Generate with: python -c 'from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())'"
    dashboard_config:
      - task: "Create new project and service"
        location: "Railway Dashboard -> New Project -> Deploy from GitHub Repo"
      - task: "Connect GitHub repository"
        location: "Railway Dashboard -> Service -> Settings -> Source"
      - task: "Set root directory to backend/"
        location: "Railway Dashboard -> Service -> Settings -> Root Directory"
      - task: "Add persistent volume mounted at /data"
        location: "Railway Dashboard -> Service -> Volumes -> Add Volume"
      - task: "Enable volume backups"
        location: "Railway Dashboard -> Service -> Volumes -> Backup settings"

must_haves:
  truths:
    - "Backend API responds to health check at the Railway-provided URL"
    - "SQLite database persists across Railway redeployments (data survives redeploy)"
    - "All secrets are configured via environment variables with no hardcoded values"
    - "Database backup mechanism is operational"
  artifacts: []
  key_links:
    - from: "Railway environment variables"
      to: "backend/app/config.py"
      via: "pydantic Settings reads from environment"
      pattern: "ENVIRONMENT|DATABASE_URL|SECRET_KEY"
    - from: "Railway persistent volume at /data"
      to: "SQLite database file"
      via: "DATABASE_URL=sqlite+aiosqlite:////data/ba_assistant.db"
      pattern: "/data/ba_assistant.db"
---

<objective>
Deploy the backend to Railway with persistent volume, environment variables, and backup configuration.

Purpose: This is the core deployment plan. The user performs Railway dashboard configuration (project creation, volume attachment, env vars) and then verifies the deployment works end-to-end.

Output: Live backend API on Railway with persistent SQLite database and automated backups.
</objective>

<execution_context>
@C:\Users\ibcve\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ibcve\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/49-backend-deployment-foundation/49-RESEARCH.md
@.planning/phases/49-backend-deployment-foundation/49-01-SUMMARY.md
@backend/railway.json
@backend/app/config.py
@backend/main.py
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Create Railway project and deploy backend</name>
  <action>
User must perform these steps in the Railway dashboard (https://railway.app):

**Step 1: Create Project**
1. Log in to Railway (create account if needed — GitHub login recommended)
2. Click "New Project" -> "Deploy from GitHub Repo"
3. Select the BA_assistant repository
4. Railway will detect the Python project and start building

**Step 2: Set Root Directory**
1. Go to Service -> Settings -> Root Directory
2. Set to `backend/` (Railway must build from the backend subdirectory, not root)
3. Save and wait for rebuild

**Step 3: Add Persistent Volume**
1. Go to Service -> Volumes
2. Click "Add Volume"
3. Set mount path to `/data`
4. Name it `ba_assistant_data`
5. Save — this creates persistent storage for SQLite

**Step 4: Configure Environment Variables**
1. Go to Service -> Variables
2. Add each variable (one by one or bulk import):

```
ENVIRONMENT=production
DATABASE_URL=sqlite+aiosqlite:////data/ba_assistant.db
SECRET_KEY=<generate: openssl rand -hex 32>
BACKEND_URL=https://<your-service>.up.railway.app
GOOGLE_CLIENT_ID=<from Google Cloud Console>
GOOGLE_CLIENT_SECRET=<from Google Cloud Console>
MICROSOFT_CLIENT_ID=<from Azure Portal>
MICROSOFT_CLIENT_SECRET=<from Azure Portal>
ANTHROPIC_API_KEY=<from Anthropic Console>
GOOGLE_API_KEY=<from Google AI Studio, if using Gemini>
CORS_ORIGINS=https://<your-service>.up.railway.app
LOG_LEVEL=INFO
FERNET_KEY=<generate: python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())">
```

**CRITICAL:** The DATABASE_URL must have FOUR slashes before `data`: `sqlite+aiosqlite:////data/ba_assistant.db`. Three slashes = relative path (WRONG), four slashes = absolute path /data/ (CORRECT).

**CRITICAL:** Copy the BACKEND_URL from Railway's "Networking" section (the *.up.railway.app domain). This is needed for OAuth redirects.

**Step 5: Update OAuth Redirect URIs**
1. Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client ID
   - Add authorized redirect URI: `https://<your-service>.up.railway.app/auth/google/callback`
2. Azure Portal -> App registrations -> Authentication
   - Add redirect URI: `https://<your-service>.up.railway.app/auth/microsoft/callback`

**Step 6: Enable Volume Backups**
1. Go to Service -> Volumes -> ba_assistant_data
2. Enable automated backups (if available in Railway dashboard)
3. If automated not available, create a manual backup after first successful deployment

**Step 7: Deploy**
1. After setting all env vars, Railway should auto-deploy
2. Watch the deployment logs for:
   - "Database initialized" (startup successful)
   - No "Configuration validation failed" errors
   - Health check passing
3. Note the deployment URL from Networking section
  </action>
  <resume-signal>Provide the Railway deployment URL (e.g., https://xxx.up.railway.app) and confirm deployment logs show "Database initialized" with no errors. Or describe any issues encountered.</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Backend deployed to Railway with persistent volume and production environment configuration</what-built>
  <how-to-verify>
**Test 1: Health Check**
1. Open browser or run: `curl https://<your-railway-url>/health`
2. Expected: `{"status":"healthy","database":"connected","version":"1.0.0"}`

**Test 2: API Root**
1. Open: `https://<your-railway-url>/`
2. Expected: JSON with message, version, docs, health fields
3. Verify: `/docs` should NOT be accessible (production mode disables Swagger UI)

**Test 3: Data Persistence**
1. Trigger a deployment (push a trivial commit or click "Redeploy" in Railway)
2. After redeploy, check `https://<your-railway-url>/health` again
3. Expected: Still returns healthy (database file survived redeploy on /data volume)

**Test 4: OAuth Flow (basic check)**
1. Open: `https://<your-railway-url>/auth/google/login`
2. Expected: Redirects to Google OAuth consent screen (may show error if redirect URI not whitelisted yet — that's OK for now, just verify the redirect happens)

**Test 5: Verify No Hardcoded Secrets**
1. In Railway dashboard -> Variables, confirm SECRET_KEY is NOT "dev-secret-key-change-in-production"
2. Confirm all API keys are set (non-empty values)

**Test 6: Volume Backup**
1. In Railway dashboard -> Service -> Volumes
2. Confirm volume shows data (non-zero size after deployment)
3. If backup was created, confirm it shows in backup list
  </how-to-verify>
  <resume-signal>Report results of each test (pass/fail). Type "approved" if all pass, or describe failures.</resume-signal>
</task>

</tasks>

<verification>
Phase 49 success criteria from roadmap:
1. Backend API responds to health check at Railway URL -> Verified in Test 1
2. SQLite database persists across deployments -> Verified in Test 3
3. All secrets configured via env vars, no hardcoded values -> Verified in Test 5
4. Database backup mechanism operational -> Verified in Test 6
</verification>

<success_criteria>
- Health check returns 200 at Railway URL
- Data persists across redeploy (volume mounted at /data)
- All environment variables configured (ENVIRONMENT=production, SECRET_KEY rotated, API keys set)
- Volume backup created or automated backups enabled
- /docs endpoint disabled in production
</success_criteria>

<output>
After completion, create `.planning/phases/49-backend-deployment-foundation/49-02-SUMMARY.md`
</output>

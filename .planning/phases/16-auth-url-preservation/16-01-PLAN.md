---
phase: 16-auth-url-preservation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/services/url_storage_service.dart
  - frontend/lib/main.dart
autonomous: true

must_haves:
  truths:
    - "Unauthenticated user accessing protected route is redirected to /login with returnUrl query parameter"
    - "Authenticated user on /login with returnUrl is redirected to that URL"
    - "Authenticated user on /login without returnUrl is redirected to /home"
    - "Auth check loading state preserves intended URL through /splash"
  artifacts:
    - path: "frontend/lib/services/url_storage_service.dart"
      provides: "sessionStorage wrapper for returnUrl"
      exports: ["UrlStorageService"]
    - path: "frontend/lib/main.dart"
      provides: "Extended redirect logic with returnUrl handling"
      contains: "returnUrl"
  key_links:
    - from: "frontend/lib/main.dart"
      to: "GoRouter redirect callback"
      via: "Query parameter extraction and forwarding"
      pattern: "queryParameters\\['returnUrl'\\]"
---

<objective>
Create URL preservation foundation with sessionStorage service and extended redirect logic.

Purpose: Enable deep linking by preserving intended destination through authentication flow.
Output: UrlStorageService class and extended GoRouter redirect logic handling returnUrl query parameter.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-auth-url-preservation/16-RESEARCH.md

# Key source files
@frontend/lib/main.dart
@frontend/lib/services/auth_service.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UrlStorageService for session storage</name>
  <files>frontend/lib/services/url_storage_service.dart</files>
  <action>
Create a new service class that wraps browser sessionStorage for returnUrl:

```dart
// For web platform - uses dart:html sessionStorage
import 'dart:html' as html;

class UrlStorageService {
  static const String _returnUrlKey = 'auth_return_url';

  /// Store return URL before OAuth redirect (browser will leave app)
  void storeReturnUrl(String url) {
    html.window.sessionStorage[_returnUrlKey] = url;
  }

  /// Retrieve return URL after OAuth callback
  String? getReturnUrl() {
    return html.window.sessionStorage[_returnUrlKey];
  }

  /// Clear return URL after successful navigation (one-time use)
  void clearReturnUrl() {
    html.window.sessionStorage.remove(_returnUrlKey);
  }
}
```

Key points:
- Use dart:html (not package:web) - simpler, works now
- sessionStorage auto-clears on tab close (ephemeral, correct for returnUrl)
- Constant key prevents typos
- Simple API: store, get, clear
  </action>
  <verify>
Run: `cd G:/git_repos/BA_assistant/frontend && flutter analyze lib/services/url_storage_service.dart`
Expected: No analysis issues
  </verify>
  <done>UrlStorageService exists with store, get, clear methods for sessionStorage access</done>
</task>

<task type="auto">
  <name>Task 2: Extend GoRouter redirect logic with returnUrl handling</name>
  <files>frontend/lib/main.dart</files>
  <action>
Modify the redirect callback in _createRouter to capture and forward returnUrl through the auth flow.

Import the new service at top of file:
```dart
import 'services/url_storage_service.dart';
```

Replace the existing redirect callback with enhanced version:

```dart
redirect: (context, state) {
  final isAuthenticated = authProvider.isAuthenticated;
  final isLoading = authProvider.isLoading;
  final currentPath = state.matchedLocation;
  final currentUri = state.uri;
  final isSplash = currentPath == '/splash';
  final isLogin = currentPath == '/login';
  final isCallback = currentPath == '/auth/callback';

  // Extract existing returnUrl from query params
  final existingReturnUrl = currentUri.queryParameters['returnUrl'];

  // Callback: let CallbackScreen handle navigation (it reads from sessionStorage)
  if (isCallback) {
    return null; // Stay on callback, it handles its own navigation
  }

  // Authenticated user on splash/login: go to returnUrl or /home
  if (isAuthenticated && (isSplash || isLogin)) {
    if (existingReturnUrl != null) {
      return Uri.decodeComponent(existingReturnUrl);
    }
    return '/home';
  }

  // Loading: redirect to splash, preserve returnUrl
  if (isLoading && !isSplash && !isLogin && !isCallback) {
    final intendedUrl = currentUri.toString();
    return '/splash?returnUrl=${Uri.encodeComponent(intendedUrl)}';
  }

  // Splash done loading, not authenticated: go to login with returnUrl
  if (isSplash && !isLoading && !isAuthenticated) {
    if (existingReturnUrl != null) {
      return '/login?returnUrl=$existingReturnUrl'; // Already encoded
    }
    return '/login';
  }

  // Unauthenticated on protected route: redirect to login with returnUrl
  if (!isAuthenticated && !isLoading && !isSplash && !isLogin && !isCallback) {
    final intendedUrl = currentUri.toString();
    return '/login?returnUrl=${Uri.encodeComponent(intendedUrl)}';
  }

  return null; // No redirect needed
},
```

Key changes from existing:
1. Extract returnUrl from query parameters
2. When loading, capture current URL and pass to splash as returnUrl
3. When splash->login, forward returnUrl
4. When unauthenticated on protected route, capture URL and pass to login
5. When authenticated on login with returnUrl, go to returnUrl instead of /home
6. Callback stays on callback (doesn't redirect to /home) - CallbackScreen handles navigation

CRITICAL: Use `state.uri.toString()` to capture full URL including query params, not just `state.matchedLocation` which loses query params.

AVOID: Do NOT add returnUrl to callback route handling - CallbackScreen will handle reading from sessionStorage.
  </action>
  <verify>
Run: `cd G:/git_repos/BA_assistant/frontend && flutter analyze lib/main.dart`
Expected: No analysis issues

Run: `cd G:/git_repos/BA_assistant/frontend && flutter build web --no-tree-shake-icons`
Expected: Build succeeds
  </verify>
  <done>GoRouter redirect logic captures intended URL and forwards it through splash/login as returnUrl query parameter</done>
</task>

</tasks>

<verification>
1. `flutter analyze lib/services/url_storage_service.dart` - No issues
2. `flutter analyze lib/main.dart` - No issues
3. `flutter build web --no-tree-shake-icons` - Build succeeds
4. Code review: returnUrl extracted, encoded, forwarded correctly
</verification>

<success_criteria>
- UrlStorageService created with sessionStorage access
- GoRouter redirect captures intended URL as returnUrl query parameter
- returnUrl forwarded through splash to login
- Authenticated user with returnUrl redirected to that URL
- Build passes with no analysis issues
</success_criteria>

<output>
After completion, create `.planning/phases/16-auth-url-preservation/16-01-SUMMARY.md`
</output>

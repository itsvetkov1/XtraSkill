---
phase: 16-auth-url-preservation
plan: 02
type: execute
wave: 2
depends_on: [16-01]
files_modified:
  - frontend/lib/screens/auth/login_screen.dart
  - frontend/lib/screens/auth/callback_screen.dart
autonomous: true

must_haves:
  truths:
    - "User deep linking to /projects/abc while logged out completes OAuth and lands on /projects/abc"
    - "User clicking login button directly (no returnUrl) completes OAuth and lands on /home"
    - "returnUrl is cleared after successful navigation (not reused on next login)"
    - "Invalid returnUrl (external URL) falls back to /home for security"
  artifacts:
    - path: "frontend/lib/screens/auth/login_screen.dart"
      provides: "OAuth button stores returnUrl to sessionStorage before redirect"
      contains: "storeReturnUrl"
    - path: "frontend/lib/screens/auth/callback_screen.dart"
      provides: "Post-auth navigation reads returnUrl from sessionStorage"
      contains: "getReturnUrl"
  key_links:
    - from: "frontend/lib/screens/auth/login_screen.dart"
      to: "UrlStorageService.storeReturnUrl"
      via: "Called before OAuth redirect"
      pattern: "urlStorage\\.storeReturnUrl"
    - from: "frontend/lib/screens/auth/callback_screen.dart"
      to: "UrlStorageService.getReturnUrl"
      via: "Called after successful auth"
      pattern: "urlStorage\\.getReturnUrl"
    - from: "frontend/lib/screens/auth/callback_screen.dart"
      to: "UrlStorageService.clearReturnUrl"
      via: "Called after retrieval (one-time use)"
      pattern: "urlStorage\\.clearReturnUrl"
---

<objective>
Integrate returnUrl handling into OAuth login flow screens.

Purpose: Complete the deep linking experience by persisting returnUrl through OAuth redirect and navigating there after successful authentication.
Output: LoginScreen stores returnUrl before OAuth; CallbackScreen retrieves and navigates to it.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-auth-url-preservation/16-RESEARCH.md
@.planning/phases/16-auth-url-preservation/16-01-SUMMARY.md

# Key source files
@frontend/lib/screens/auth/login_screen.dart
@frontend/lib/screens/auth/callback_screen.dart
@frontend/lib/services/url_storage_service.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update LoginScreen to store returnUrl before OAuth redirect</name>
  <files>frontend/lib/screens/auth/login_screen.dart</files>
  <action>
Modify LoginScreen to extract returnUrl from query params and store to sessionStorage before OAuth redirect.

Add imports at top:
```dart
import 'package:go_router/go_router.dart';
import '../../services/url_storage_service.dart';
```

Update _handleGoogleLogin method:
```dart
void _handleGoogleLogin(BuildContext context) {
  // Extract returnUrl from current URL query params
  final uri = GoRouterState.of(context).uri;
  final returnUrl = uri.queryParameters['returnUrl'];

  // Store before OAuth redirect (browser will leave app)
  if (returnUrl != null) {
    final urlStorage = UrlStorageService();
    urlStorage.storeReturnUrl(Uri.decodeComponent(returnUrl));
  }

  // Proceed with OAuth
  final authProvider = context.read<AuthProvider>();
  authProvider.loginWithGoogle();
}
```

Update _handleMicrosoftLogin similarly:
```dart
void _handleMicrosoftLogin(BuildContext context) {
  // Extract returnUrl from current URL query params
  final uri = GoRouterState.of(context).uri;
  final returnUrl = uri.queryParameters['returnUrl'];

  // Store before OAuth redirect (browser will leave app)
  if (returnUrl != null) {
    final urlStorage = UrlStorageService();
    urlStorage.storeReturnUrl(Uri.decodeComponent(returnUrl));
  }

  // Proceed with OAuth
  final authProvider = context.read<AuthProvider>();
  authProvider.loginWithMicrosoft();
}
```

Key points:
- Decode returnUrl before storing (it's URL-encoded in query param)
- Only store if returnUrl exists (direct login has no returnUrl)
- Storage happens BEFORE OAuth redirect (browser will leave Flutter app)
  </action>
  <verify>
Run: `cd G:/git_repos/BA_assistant/frontend && flutter analyze lib/screens/auth/login_screen.dart`
Expected: No analysis issues
  </verify>
  <done>LoginScreen extracts returnUrl from query params and stores to sessionStorage before OAuth redirect</done>
</task>

<task type="auto">
  <name>Task 2: Update CallbackScreen to navigate to stored returnUrl</name>
  <files>frontend/lib/screens/auth/callback_screen.dart</files>
  <action>
Modify CallbackScreen to read returnUrl from sessionStorage after successful auth and navigate there.

Add import at top:
```dart
import '../../services/url_storage_service.dart';
```

Update _processCallback method - replace the success handling section:

```dart
Future<void> _processCallback() async {
  if (!mounted) return;

  try {
    // Extract token from URL query parameters
    final uri = GoRouterState.of(context).uri;
    print('DEBUG: Full URI: $uri');
    print('DEBUG: Query params: ${uri.queryParameters}');

    final token = uri.queryParameters['token'];
    print('DEBUG: Extracted token: ${token?.substring(0, 20)}...');

    if (token == null || token.isEmpty) {
      print('DEBUG: No token found!');
      setState(() {
        _error = 'No authentication token received';
        _isProcessing = false;
      });
      return;
    }

    // Handle callback through auth provider
    print('DEBUG: Calling handleCallback...');
    final authProvider = context.read<AuthProvider>();
    await authProvider.handleCallback(token);

    print('DEBUG: After handleCallback - isAuthenticated: ${authProvider.isAuthenticated}');
    print('DEBUG: Error message: ${authProvider.errorMessage}');

    // Navigate to return URL or home on success
    if (mounted && authProvider.isAuthenticated) {
      // Get stored return URL from sessionStorage
      final urlStorage = UrlStorageService();
      final returnUrl = urlStorage.getReturnUrl();
      print('DEBUG: Retrieved returnUrl from storage: $returnUrl');

      // Clear after retrieval (one-time use, prevents stale redirects)
      urlStorage.clearReturnUrl();

      // Validate returnUrl (security: prevent open redirect)
      String destination = '/home';
      if (returnUrl != null && returnUrl.startsWith('/')) {
        destination = returnUrl;
        print('DEBUG: Using returnUrl as destination: $destination');
      } else if (returnUrl != null) {
        print('DEBUG: Invalid returnUrl (not relative path), falling back to /home');
      }

      // Navigate directly - don't rely on GoRouter redirect
      context.go(destination);
    } else if (mounted) {
      print('DEBUG: Authentication failed, showing error');
      setState(() {
        _error = authProvider.errorMessage ?? 'Authentication failed';
        _isProcessing = false;
      });
    }
  } catch (e) {
    print('DEBUG: Exception caught: $e');
    setState(() {
      _error = 'Failed to process authentication: ${e.toString()}';
      _isProcessing = false;
    });
  }
}
```

Key changes from existing:
1. Import UrlStorageService
2. After successful auth, retrieve returnUrl from sessionStorage
3. Clear returnUrl immediately after retrieval (one-time use)
4. Validate returnUrl starts with '/' (relative path only - security)
5. Navigate directly with context.go() instead of relying on GoRouter redirect
6. Default to /home if no returnUrl or invalid returnUrl

SECURITY: Reject external URLs (anything not starting with '/') to prevent open redirect vulnerability.
  </action>
  <verify>
Run: `cd G:/git_repos/BA_assistant/frontend && flutter analyze lib/screens/auth/callback_screen.dart`
Expected: No analysis issues

Run: `cd G:/git_repos/BA_assistant/frontend && flutter build web --no-tree-shake-icons`
Expected: Build succeeds
  </verify>
  <done>CallbackScreen retrieves returnUrl from sessionStorage, clears it, validates it, and navigates there</done>
</task>

</tasks>

<verification>
1. `flutter analyze lib/screens/auth/login_screen.dart` - No issues
2. `flutter analyze lib/screens/auth/callback_screen.dart` - No issues
3. `flutter build web --no-tree-shake-icons` - Build succeeds
4. Code review: returnUrl stored before OAuth, retrieved and cleared after, security validation in place
</verification>

<success_criteria>
- LoginScreen stores returnUrl to sessionStorage before OAuth redirect
- CallbackScreen retrieves returnUrl from sessionStorage after auth
- returnUrl cleared after retrieval (one-time use)
- Invalid returnUrl (external URL) rejected, falls back to /home
- Build passes with no analysis issues
</success_criteria>

<output>
After completion, create `.planning/phases/16-auth-url-preservation/16-02-SUMMARY.md`
</output>

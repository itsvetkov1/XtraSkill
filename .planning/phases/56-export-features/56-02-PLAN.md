---
phase: 56-export-features
plan: 02
type: execute
wave: 2
depends_on: ["56-01"]
files_modified:
  - frontend/lib/services/document_service.dart
  - frontend/lib/screens/documents/widgets/excel_table_viewer.dart
  - frontend/lib/screens/documents/document_viewer_screen.dart
autonomous: true

must_haves:
  truths:
    - "User sees export button (download icon with popup menu) in ExcelTableViewer metadata header"
    - "User can select 'Export to Excel (.xlsx)' from the export popup menu"
    - "User can select 'Export to CSV' from the export popup menu"
    - "Export triggers file download in the browser with correct filename"
    - "User sees loading feedback during export and success/error snackbar after"
    - "Export button only appears for tabular documents (Excel/CSV), not PDF/Word/text"
  artifacts:
    - path: "frontend/lib/services/document_service.dart"
      provides: "exportDocument() method for binary download with FileSaver"
      contains: "exportDocument"
    - path: "frontend/lib/screens/documents/widgets/excel_table_viewer.dart"
      provides: "Export PopupMenuButton in metadata header with xlsx/csv options"
      contains: "PopupMenuButton"
    - path: "frontend/lib/screens/documents/document_viewer_screen.dart"
      provides: "Passes documentId to ExcelTableViewer for export capability"
      contains: "documentId"
  key_links:
    - from: "frontend/lib/screens/documents/widgets/excel_table_viewer.dart"
      to: "frontend/lib/services/document_service.dart exportDocument()"
      via: "_handleExport calls DocumentService.exportDocument"
      pattern: "exportDocument"
    - from: "frontend/lib/services/document_service.dart exportDocument()"
      to: "backend /documents/{id}/export/{format}"
      via: "Dio GET with ResponseType.bytes"
      pattern: "export/\\$format"
    - from: "frontend/lib/screens/documents/document_viewer_screen.dart"
      to: "frontend/lib/screens/documents/widgets/excel_table_viewer.dart"
      via: "Passes documentId prop to ExcelTableViewer"
      pattern: "documentId:"
---

<objective>
Add export UI to the frontend: service method for downloading export files and export buttons in the ExcelTableViewer.

Purpose: Users viewing spreadsheet data in the Document Viewer need a way to export that data back to Excel or CSV format. This completes the round-trip workflow: upload → view → export.

Output: DocumentService.exportDocument() method, PopupMenuButton in ExcelTableViewer with xlsx/csv options, and snackbar feedback during export.
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-export-features/56-RESEARCH.md
@.planning/phases/56-export-features/56-01-SUMMARY.md
@frontend/lib/services/document_service.dart
@frontend/lib/screens/documents/widgets/excel_table_viewer.dart
@frontend/lib/screens/documents/document_viewer_screen.dart
@frontend/lib/models/document.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add exportDocument method to DocumentService and export UI to ExcelTableViewer</name>
  <files>
frontend/lib/services/document_service.dart
frontend/lib/screens/documents/widgets/excel_table_viewer.dart
frontend/lib/screens/documents/document_viewer_screen.dart
  </files>
  <action>
**File 1: frontend/lib/services/document_service.dart**

Add an `exportDocument` method to the existing DocumentService class (after the `downloadDocument` method):

```dart
/// Export document data to Excel or CSV format.
///
/// [documentId] - ID of the document to export
/// [format] - Export format: 'xlsx' or 'csv'
///
/// Downloads the generated file and saves it using FileSaver.
Future<void> exportDocument(String documentId, String format) async {
  final endpoint = '/api/documents/$documentId/export/$format';

  // Download binary from backend
  final response = await _dio.get(
    endpoint,
    options: Options(
      responseType: ResponseType.bytes,
      headers: (await _getAuthHeaders()).headers,
    ),
  );

  // Extract filename from Content-Disposition header
  String filename = 'export.$format';
  final contentDisposition = response.headers.value('content-disposition');
  if (contentDisposition != null) {
    final filenameMatch = RegExp(r'filename="(.+)"').firstMatch(contentDisposition);
    if (filenameMatch != null) {
      filename = filenameMatch.group(1)!;
    }
  }

  // Determine MIME type and extension
  final mimeType = format == 'xlsx' ? MimeType.microsoftExcel : MimeType.csv;
  final nameWithoutExt = filename.replaceAll(RegExp(r'\.[^.]+$'), '');
  final ext = format == 'xlsx' ? 'xlsx' : 'csv';

  // Save file using FileSaver (cross-platform download)
  await FileSaver.instance.saveFile(
    name: nameWithoutExt,
    bytes: Uint8List.fromList(response.data as List<int>),
    ext: ext,
    mimeType: mimeType,
  );
}
```

**Required imports to add at top of document_service.dart:**
- `import 'dart:typed_data';` (for Uint8List)
- `import 'package:file_saver/file_saver.dart';` (for FileSaver and MimeType)

**File 2: frontend/lib/screens/documents/widgets/excel_table_viewer.dart**

Modify ExcelTableViewer to accept a `documentId` parameter and add export buttons:

1. **Add `documentId` constructor parameter:**
   ```dart
   class ExcelTableViewer extends StatefulWidget {
     final String content;
     final Map<String, dynamic> metadata;
     final String documentId;  // NEW: required for export

     const ExcelTableViewer({
       super.key,
       required this.content,
       required this.metadata,
       required this.documentId,  // NEW
     });
   ```

2. **Add import** at top: `import '../../../services/document_service.dart';`

3. **Add `_isExporting` state** to _ExcelTableViewerState: `bool _isExporting = false;`

4. **Add export button** to the metadata header Row, after the sheet names display and before the closing of the Row children list. Insert a `Spacer()` followed by a `PopupMenuButton<String>`:
   ```dart
   const Spacer(),
   // Export menu
   PopupMenuButton<String>(
     icon: Icon(
       Icons.download_rounded,
       color: Theme.of(context).colorScheme.primary,
     ),
     tooltip: 'Export original data',
     enabled: !_isExporting,
     onSelected: (format) => _handleExport(context, format),
     itemBuilder: (context) => [
       const PopupMenuItem(
         value: 'xlsx',
         child: Row(
           children: [
             Icon(Icons.table_chart, size: 20),
             SizedBox(width: 12),
             Text('Export to Excel (.xlsx)'),
           ],
         ),
       ),
       const PopupMenuItem(
         value: 'csv',
         child: Row(
           children: [
             Icon(Icons.insert_drive_file, size: 20),
             SizedBox(width: 12),
             Text('Export to CSV'),
           ],
         ),
       ),
     ],
   ),
   ```

5. **Add `_handleExport` method** to _ExcelTableViewerState:
   ```dart
   Future<void> _handleExport(BuildContext context, String format) async {
     setState(() => _isExporting = true);

     // Show loading snackbar
     ScaffoldMessenger.of(context).showSnackBar(
       SnackBar(
         content: Row(
           children: [
             const SizedBox(
               width: 16,
               height: 16,
               child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white),
             ),
             const SizedBox(width: 12),
             Text('Exporting to ${format.toUpperCase()}...'),
           ],
         ),
         duration: const Duration(seconds: 30),
       ),
     );

     try {
       final service = DocumentService();
       await service.exportDocument(widget.documentId, format);

       if (!context.mounted) return;
       ScaffoldMessenger.of(context).hideCurrentSnackBar();
       ScaffoldMessenger.of(context).showSnackBar(
         SnackBar(
           content: Row(
             children: [
               const Icon(Icons.check_circle, color: Colors.white),
               const SizedBox(width: 12),
               Text('Exported to ${format.toUpperCase()} successfully'),
             ],
           ),
           backgroundColor: Colors.green,
           duration: const Duration(seconds: 3),
         ),
       );
     } catch (e) {
       if (!context.mounted) return;
       ScaffoldMessenger.of(context).hideCurrentSnackBar();
       ScaffoldMessenger.of(context).showSnackBar(
         SnackBar(
           content: Row(
             children: [
               const Icon(Icons.error, color: Colors.white),
               const SizedBox(width: 12),
               Expanded(child: Text('Export failed: $e')),
             ],
           ),
           backgroundColor: Colors.red,
           duration: const Duration(seconds: 4),
         ),
       );
     } finally {
       if (mounted) {
         setState(() => _isExporting = false);
       }
     }
   }
   ```

**File 3: frontend/lib/screens/documents/document_viewer_screen.dart**

Update the `_buildDocumentContent` method to pass `documentId` to ExcelTableViewer:

Change the ExcelTableViewer constructor call from:
```dart
return ExcelTableViewer(
  content: content,
  metadata: metadata,
);
```
to:
```dart
return ExcelTableViewer(
  content: content,
  metadata: metadata,
  documentId: doc.id,
);
```

This is the ONLY change to document_viewer_screen.dart.
  </action>
  <verify>
1. Run `cd /Users/a1testingmac/projects/XtraSkill/frontend && flutter analyze lib/services/document_service.dart lib/screens/documents/widgets/excel_table_viewer.dart lib/screens/documents/document_viewer_screen.dart` — should pass without new errors
2. Grep for exportDocument method: `grep -n "exportDocument" frontend/lib/services/document_service.dart`
3. Grep for PopupMenuButton in viewer: `grep -n "PopupMenuButton" frontend/lib/screens/documents/widgets/excel_table_viewer.dart`
4. Grep for documentId passing: `grep -n "documentId" frontend/lib/screens/documents/document_viewer_screen.dart`
5. Grep for FileSaver import: `grep "file_saver" frontend/lib/services/document_service.dart`
  </verify>
  <done>
DocumentService has exportDocument() method with Dio binary download and FileSaver. ExcelTableViewer has PopupMenuButton with xlsx/csv options, loading/success/error snackbar feedback, and _isExporting state. DocumentViewerScreen passes documentId to ExcelTableViewer. Flutter analyze passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify full export flow and run flutter analyze</name>
  <files>
frontend/lib/services/document_service.dart
frontend/lib/screens/documents/widgets/excel_table_viewer.dart
frontend/lib/screens/documents/document_viewer_screen.dart
  </files>
  <action>
Run comprehensive verification of the export feature integration:

1. **Flutter analyze**: Run `flutter analyze` on the entire project (or at least the 3 modified files) to ensure no compilation errors or warnings.

2. **Export method signature check**: Verify `exportDocument(String documentId, String format)` exists in DocumentService.

3. **ExcelTableViewer integration check**: Verify:
   - `documentId` constructor parameter exists
   - `PopupMenuButton<String>` exists in build method
   - `_handleExport` method exists
   - `_isExporting` state variable exists
   - `DocumentService` import is present

4. **DocumentViewerScreen integration check**: Verify `documentId: doc.id` is passed to ExcelTableViewer.

5. **No regression check**: Verify:
   - ExcelTableViewer still has `content` and `metadata` parameters
   - DocumentViewerScreen still renders PDF, Word, and text formats correctly (those code paths unchanged)
   - DocumentService still has all existing methods (uploadDocument, getDocuments, getDocumentContent, searchDocuments, deleteDocument, downloadDocument)

6. **Export is ONLY for table formats**: Verify export buttons only appear in ExcelTableViewer (which is only rendered for spreadsheet/CSV contentTypes), not in PdfTextViewer or WordTextViewer.
  </action>
  <verify>
1. Flutter analyze passes without new errors
2. exportDocument method exists with correct signature
3. ExcelTableViewer has documentId, PopupMenuButton, _handleExport, _isExporting
4. DocumentViewerScreen passes documentId to ExcelTableViewer
5. No regression in existing functionality (all 6 document types still render correctly)
6. Export buttons only visible for tabular documents
  </verify>
  <done>
Full export flow verified. Frontend properly calls backend export endpoints via DocumentService, ExcelTableViewer provides export UI only for tabular formats, DocumentViewerScreen passes documentId for export capability. No regression in existing features. Flutter analyze passes.
  </done>
</task>

</tasks>

<verification>
1. DocumentService.exportDocument() downloads binary and triggers FileSaver
2. ExcelTableViewer shows PopupMenuButton with xlsx/csv export options
3. Export button disabled during export (prevents double-click)
4. Loading snackbar shown during export
5. Success/error snackbar shown after export completes
6. DocumentViewerScreen passes documentId to ExcelTableViewer
7. Export buttons only appear for tabular documents (not PDF/Word/text)
8. Content-Disposition header parsed for correct filename
9. Flutter analyze passes without new errors
</verification>

<success_criteria>
- User can click export button in ExcelTableViewer and choose xlsx or csv
- File downloads to user's device with correct filename (document_export.xlsx or .csv)
- Loading feedback during export, success/error feedback after
- Export only available for tabular documents (Excel/CSV)
- No regression in existing Document Viewer functionality
</success_criteria>

<output>
After completion, create `.planning/phases/56-export-features/56-02-SUMMARY.md`
</output>

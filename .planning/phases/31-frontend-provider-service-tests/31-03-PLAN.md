---
phase: 31-frontend-provider-service-tests
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/test/unit/providers/conversation_provider_test.dart
  - frontend/test/unit/providers/conversation_provider_test.mocks.dart
  - frontend/test/unit/chats_provider_test.dart
autonomous: true

must_haves:
  truths:
    - "ConversationProvider tests verify streaming chat flow and message management"
    - "ChatsProvider tests expanded to cover additional edge cases"
    - "SSE streaming events are mocked to test different event types"
  artifacts:
    - path: "frontend/test/unit/providers/conversation_provider_test.dart"
      provides: "ConversationProvider unit tests"
      min_lines: 250
    - path: "frontend/test/unit/chats_provider_test.dart"
      provides: "Expanded ChatsProvider tests"
      min_lines: 450
  key_links:
    - from: "conversation_provider_test.dart"
      to: "ConversationProvider"
      via: "MockAIService and MockThreadService injection"
      pattern: "MockAIService.*MockThreadService"
---

<objective>
Create unit tests for ConversationProvider and expand ChatsProvider tests.

Purpose: Cover FPROV-05 (MessagesProvider/ConversationProvider) and FPROV-06 (ChatsProvider expansion) requirements. ConversationProvider is the most complex provider with SSE streaming, so it gets dedicated focus.

Output: Comprehensive ConversationProvider tests covering streaming chat and expanded ChatsProvider tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-frontend-provider-service-tests/31-RESEARCH.md

# Template for testing pattern
@frontend/test/unit/chats_provider_test.dart

# Source files under test
@frontend/lib/providers/conversation_provider.dart
@frontend/lib/providers/chats_provider.dart
@frontend/lib/services/ai_service.dart
@frontend/lib/services/thread_service.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: ConversationProvider unit tests</name>
  <files>
    frontend/test/unit/providers/conversation_provider_test.dart
  </files>
  <action>
Create comprehensive unit tests for ConversationProvider.

Use @GenerateNiceMocks([MockSpec<AIService>(), MockSpec<ThreadService>()]) annotation.

Test groups to implement:
1. **Initial State** - null thread, empty messages, empty streamingText, null statusMessage, isStreaming false, loading false, no error, isNotFound false, canRetry false

2. **loadThread** - sets loading during call, sets thread and messages on success, sets isNotFound on 404 error, sets error on other errors, resets isNotFound on new load

3. **sendMessage** - complex streaming flow:
   - Does nothing if thread is null
   - Does nothing if already streaming
   - Adds user message optimistically
   - Sets isStreaming true, clears streamingText
   - Stores content in _lastFailedMessage for potential retry

4. **Streaming events** (mock AIService.streamChat to yield events):
   - **TextDeltaEvent** - appends to streamingText
   - **ToolExecutingEvent** - sets statusMessage
   - **MessageCompleteEvent** - adds assistant message, clears streaming state, clears _lastFailedMessage
   - **ErrorEvent** - sets error, clears streaming state
   - **Exception in stream** - catches, sets error, clears streaming state

5. **clearConversation** - resets all state including thread, messages, streaming

6. **clearError** - clears error, isNotFound, AND _lastFailedMessage

7. **canRetry** - true only when _lastFailedMessage != null AND error != null

8. **retryLastMessage** - does nothing if _lastFailedMessage null, removes last user message (to avoid duplicate), calls sendMessage with saved content

9. **associateWithProject** - returns false if no thread, calls threadService, reloads thread on success, sets error on failure

For streaming tests, mock AIService.streamChat to return a Stream:
```dart
test('handles TextDeltaEvent', () async {
  when(mockAIService.streamChat(any, any)).thenAnswer((_) => Stream.fromIterable([
    TextDeltaEvent('Hello'),
    TextDeltaEvent(' World'),
    MessageCompleteEvent('Hello World'),
  ]));

  // Load thread first
  final thread = Thread(id: 't1', ...);
  when(mockThreadService.getThread('t1')).thenAnswer((_) async => thread);
  await provider.loadThread('t1');

  await provider.sendMessage('Hi');

  expect(provider.messages.last.content, contains('Hello World'));
  expect(provider.isStreaming, isFalse);
});
```

For optimistic delete (deleteMessage):
- Test immediate state changes only (message removed from list)
- Skip timer-based logic (requires BuildContext)

Create mock Thread and Message objects with required fields.
Note: Import event classes from ai_service.dart (TextDeltaEvent, ToolExecutingEvent, MessageCompleteEvent, ErrorEvent).
  </action>
  <verify>
Run: `cd frontend && flutter test test/unit/providers/conversation_provider_test.dart -v`
All tests pass without errors.
  </verify>
  <done>
ConversationProvider has comprehensive unit test coverage including streaming event handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Expand ChatsProvider tests</name>
  <files>
    frontend/test/unit/chats_provider_test.dart
  </files>
  <action>
Expand the existing ChatsProvider tests to improve coverage per FPROV-06.

Review existing tests (440 lines) and add missing edge cases:

Additional test cases to add:
1. **loadThreads edge cases**:
   - Verify isLoading is false after both success and failure
   - Verify threads list is replaced (not appended) on reload

2. **loadMoreThreads edge cases**:
   - Does not load while already loading
   - Page number increments correctly on successive loads

3. **createNewChat edge cases**:
   - Works even when not initialized (no threads loaded yet)
   - Passes projectId if provided
   - Increments total even before first load

4. **Listener notifications**:
   - Add tests verifying notifyListeners() is called at appropriate times:
   ```dart
   test('notifies listeners on loadThreads start and complete', () async {
     var notifyCount = 0;
     provider.addListener(() => notifyCount++);

     when(mockThreadService.getGlobalThreads(page: 1)).thenAnswer(
       (_) async => PaginatedThreads(threads: [], total: 0, page: 1, pageSize: 25, hasMore: false),
     );

     await provider.loadThreads();

     // Should notify at least twice: loading start, loading complete
     expect(notifyCount, greaterThanOrEqualTo(2));
   });
   ```

5. **Thread with project association**:
   - Verify threads with projectId and projectName are handled correctly

Keep existing tests intact, add new test groups at the end.
  </action>
  <verify>
Run: `cd frontend && flutter test test/unit/chats_provider_test.dart -v`
All tests pass (existing + new).
  </verify>
  <done>
ChatsProvider tests expanded with additional edge cases and listener verification.
  </done>
</task>

<task type="auto">
  <name>Task 3: Generate mocks and verify</name>
  <files>
    frontend/test/unit/providers/conversation_provider_test.mocks.dart
  </files>
  <action>
Run build_runner to generate mock files:

```bash
cd frontend
flutter pub run build_runner build --delete-conflicting-outputs
```

Verify:
1. conversation_provider_test.mocks.dart exists and contains MockAIService and MockThreadService classes
2. Run all provider tests together
  </action>
  <verify>
Run: `cd frontend && flutter test test/unit/providers/ -v`
All provider tests pass.
  </verify>
  <done>
Mock files generated and all provider tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && flutter test test/unit/providers/conversation_provider_test.dart` - ConversationProvider tests pass
2. `cd frontend && flutter test test/unit/chats_provider_test.dart` - ChatsProvider tests pass (existing + new)
3. SSE streaming events (TextDeltaEvent, ToolExecutingEvent, MessageCompleteEvent, ErrorEvent) are tested
4. Tests cover FPROV-05 and FPROV-06 requirements
</verification>

<success_criteria>
- ConversationProvider has unit test coverage with 20+ test cases
- ChatsProvider tests expanded from ~440 lines to ~500+ lines
- Streaming chat flow tested with all event types
- Retry mechanism tested
- All tests pass with `flutter test test/unit/providers/`
</success_criteria>

<output>
After completion, create `.planning/phases/31-frontend-provider-service-tests/31-03-SUMMARY.md`
</output>

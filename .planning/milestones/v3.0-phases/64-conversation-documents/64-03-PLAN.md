---
phase: 64-conversation-documents
plan: 03
type: execute
wave: 2
depends_on: [64-02]
files_modified:
  - frontend/lib/screens/assistant/assistant_chat_screen.dart
  - frontend/lib/screens/assistant/widgets/assistant_message_bubble.dart
  - frontend/lib/screens/assistant/widgets/assistant_streaming_message.dart
  - frontend/lib/main.dart
autonomous: true
requirements: [UI-03]

must_haves:
  truths:
    - "User can navigate to an Assistant thread and see a dedicated chat screen (not the BA ConversationScreen)"
    - "User can send a message and see streaming response text appear progressively with markdown formatting"
    - "Thinking indicator shows with elapsed time while AI is processing"
    - "Copy button works on assistant messages to copy content to clipboard"
    - "Retry button appears on failed messages and resends the last message"
    - "Error states show clear message with recovery option"
  artifacts:
    - path: "frontend/lib/screens/assistant/assistant_chat_screen.dart"
      provides: "Main Assistant chat screen"
      contains: "AssistantChatScreen"
    - path: "frontend/lib/screens/assistant/widgets/assistant_message_bubble.dart"
      provides: "Message bubble with markdown rendering"
      contains: "AssistantMessageBubble"
    - path: "frontend/lib/screens/assistant/widgets/assistant_streaming_message.dart"
      provides: "Streaming message with markdown and thinking timer"
      contains: "AssistantStreamingMessage"
  key_links:
    - from: "frontend/lib/screens/assistant/assistant_chat_screen.dart"
      to: "frontend/lib/providers/assistant_conversation_provider.dart"
      via: "Provider.of / context.watch"
      pattern: "AssistantConversationProvider"
    - from: "frontend/lib/main.dart"
      to: "frontend/lib/screens/assistant/assistant_chat_screen.dart"
      via: "GoRoute builder for /assistant/:threadId"
      pattern: "AssistantChatScreen"
---

<objective>
Create the AssistantChatScreen with message list, streaming display, and controls — the core conversation UI for Assistant threads.

Purpose: Users need a dedicated chat screen for Assistant threads that shows messages with markdown formatting, streaming responses with thinking indicators, and copy/retry controls — without any BA-specific UI elements (no artifact picker, no mode badge, no budget warnings, no project context).

Output: AssistantChatScreen + supporting message widgets + router integration
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/64-conversation-documents/64-RESEARCH.md
@.planning/phases/64-conversation-documents/64-02-SUMMARY.md
@frontend/lib/screens/conversation/conversation_screen.dart
@frontend/lib/screens/conversation/widgets/message_bubble.dart
@frontend/lib/screens/conversation/widgets/streaming_message.dart
@frontend/lib/screens/conversation/widgets/chat_input.dart
@frontend/lib/screens/conversation/widgets/error_state_message.dart
@frontend/lib/providers/assistant_conversation_provider.dart
@frontend/lib/main.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AssistantChatScreen and Message Widgets</name>
  <files>
    frontend/lib/screens/assistant/assistant_chat_screen.dart
    frontend/lib/screens/assistant/widgets/assistant_message_bubble.dart
    frontend/lib/screens/assistant/widgets/assistant_streaming_message.dart
  </files>
  <action>
**1. Create AssistantMessageBubble** (`frontend/lib/screens/assistant/widgets/assistant_message_bubble.dart`):

A message bubble for Assistant chat that uses MarkdownMessage for AI responses:

- **User messages**: Standard bubble with primary color background, plain text (same as BA MessageBubble). Aligned right.
- **Assistant messages**: Surface-colored bubble aligned left. Content rendered via `MarkdownMessage` widget (from 64-02) instead of raw `Text()`. Include:
  - Copy button: Icon button below message content. On tap, copy the raw markdown content (not rendered) to clipboard. Show brief SnackBar "Copied to clipboard". Use the synchronous clipboard pattern for Safari compatibility (from Phase 11 decision).
  - Retry button: If the message is the last message AND there's an error state, show a retry TextButton below the message.
- **Attached files display**: If the message has associated documents/attachments (stored in message metadata or a separate field), show a row of small file chips (filename + icon) below the user message text. File chips are not tappable in v1 (just visual).
- Take `Message` model and `VoidCallback? onRetry` as parameters.
- Max width: 80% of screen width (same as BA).
- Bubble styling: rounded corners with assistant-side flat corner (same pattern as BA MessageBubble).

**2. Create AssistantStreamingMessage** (`frontend/lib/screens/assistant/widgets/assistant_streaming_message.dart`):

Streaming indicator + progressive markdown rendering:

- Shows thinking indicator with elapsed time when `text` is empty and `statusMessage` is null:
  ```
  [spinner] Thinking... (5s)
  ```
  The elapsed time is calculated from `thinkingStartTime` parameter — show seconds elapsed, updating every second via a Timer.periodic.
- When `statusMessage` is set (e.g., "Searching documents..."): show status with spinner (same as BA StreamingMessage)
- When `text` is not empty: render accumulated text via `MarkdownMessage(content: text, isStreaming: true)`
- This is a StatefulWidget because of the periodic timer for elapsed time display
- Dispose timer in dispose()
- Parameters: `String text`, `String? statusMessage`, `DateTime? thinkingStartTime`

**3. Create AssistantChatScreen** (`frontend/lib/screens/assistant/assistant_chat_screen.dart`):

The main chat screen layout. Takes `threadId` as parameter.

**Structure:**
```
Scaffold(
  body: Column(
    children: [
      Expanded(
        child: ListView.builder(
          // Messages + streaming indicator
        ),
      ),
      // Chat input area (placeholder — will be replaced by AssistantChatInput in Plan 64-04)
      // For now, use a simple TextField + Send button so chat works end-to-end
    ],
  ),
)
```

**Screen behavior:**
- On init: Create `AssistantConversationProvider` (or get from Provider tree — see router wiring below) and call `loadThread(threadId)`
- Show loading spinner while loading
- Show `ResourceNotFoundState` if thread not found (404)
- Show error state with retry if loading fails

**Message list:**
- `ListView.builder` with `reverse: false` (oldest at top, newest at bottom)
- Auto-scroll to bottom on new messages (use ScrollController.animateTo)
- Auto-scroll on streaming text update (throttled — not every character, just every ~200ms)
- For each message: render `AssistantMessageBubble`
- After last message (if streaming): render `AssistantStreamingMessage`
- If error with partial content: show error banner above input with retry button

**Temporary chat input (will be replaced in Plan 64-04):**
- Use a simple Row with TextField + IconButton(Icons.send)
- Enter sends, Shift+Enter newline (reuse the FocusNode.onKeyEvent pattern from existing ChatInput)
- Multi-line (maxLines: 4, minLines: 1)
- Disabled while streaming
- On send: call `provider.sendMessage(text)`, clear input, auto-scroll

**Error handling:**
- Loading error: full-screen error with retry
- Streaming error with partial content: show partial content with error banner + retry
- Streaming error without content: show error message in message list + retry

**NO BA-specific elements:**
- No AppBar mode badge
- No budget warning banner
- No artifact type picker or generate artifact button
- No mode selector chips
- No provider indicator
- No "Add to Project" button
- No source chips
  </action>
  <verify>
Run: `cd /Users/a1testingmac/projects/XtraSkill/frontend && flutter analyze lib/screens/assistant/assistant_chat_screen.dart lib/screens/assistant/widgets/assistant_message_bubble.dart lib/screens/assistant/widgets/assistant_streaming_message.dart` — should pass with no errors.

Check: `grep -c 'artifact\|Artifact\|budget\|Budget\|ModeSelector\|ProviderIndicator\|source_chips\|AddToProject' frontend/lib/screens/assistant/assistant_chat_screen.dart` — should return 0 (no BA elements).

Check: `grep 'MarkdownMessage\|AssistantStreamingMessage\|AssistantMessageBubble' frontend/lib/screens/assistant/assistant_chat_screen.dart` — should show all widget references.
  </verify>
  <done>AssistantChatScreen renders messages with markdown formatting, shows streaming with thinking timer, supports copy/retry, and has a temporary chat input. Zero BA-specific UI elements.</done>
</task>

<task type="auto">
  <name>Task 2: Wire AssistantChatScreen into Router and Provider Tree</name>
  <files>
    frontend/lib/main.dart
  </files>
  <action>
**1. Update router** in `frontend/lib/main.dart`:

Replace the current `/assistant/:threadId` route that points to `ConversationScreen` with the new `AssistantChatScreen`:

Current (from Phase 63):
```dart
GoRoute(
  path: ':threadId',
  builder: (context, state) {
    final threadId = state.pathParameters['threadId']!;
    return ConversationScreen(
      projectId: null,
      threadId: threadId,
    );
  },
),
```

Change to:
```dart
GoRoute(
  path: ':threadId',
  builder: (context, state) {
    final threadId = state.pathParameters['threadId']!;
    return AssistantChatScreen(
      threadId: threadId,
    );
  },
),
```

**2. Add AssistantConversationProvider to the provider tree:**

In the `MultiProvider` section of `main.dart` (or in the `_MyAppState` build method), add `ChangeNotifierProvider<AssistantConversationProvider>`. Initialize it the same way ConversationProvider is initialized — with `AIService()` and `ThreadService()`.

If ConversationProvider is created inline (not pre-created), do the same for AssistantConversationProvider:
```dart
ChangeNotifierProvider(
  create: (_) => AssistantConversationProvider(
    AIService(),
    ThreadService(),
  ),
),
```

**3. Add imports:**
- `import 'screens/assistant/assistant_chat_screen.dart';`
- `import 'providers/assistant_conversation_provider.dart';`

**4. Remove unused import** if ConversationScreen is no longer referenced from the assistant route:
- Keep the ConversationScreen import (it's still used by Chats and Projects routes)

IMPORTANT: Do NOT change any existing ConversationScreen routing or provider setup. Only change the /assistant/:threadId route builder.
  </action>
  <verify>
Run: `cd /Users/a1testingmac/projects/XtraSkill/frontend && flutter analyze lib/main.dart` — should pass with no errors.

Check: `grep 'AssistantChatScreen\|AssistantConversationProvider' frontend/lib/main.dart` — should show both the screen import/usage and provider registration.

Check: `grep 'ConversationScreen' frontend/lib/main.dart` — should still show ConversationScreen used for Chats and Projects routes (not removed).
  </verify>
  <done>AssistantChatScreen wired into /assistant/:threadId route. AssistantConversationProvider registered in provider tree. BA ConversationScreen routing unchanged for Chats and Projects.</done>
</task>

</tasks>

<verification>
1. Navigate to /assistant/:threadId in browser — shows AssistantChatScreen (not BA ConversationScreen)
2. Type message and send — message appears in list, streaming response appears with thinking indicator
3. AI response renders with markdown formatting (headers, code blocks, bold/italic)
4. Copy button on assistant message copies content to clipboard
5. Retry button appears on error and resends last message
6. No BA-specific UI elements visible (no artifacts, budget, mode, provider indicator)
7. Existing BA chat at /chats/:threadId and /projects/:pid/threads/:tid still works with ConversationScreen
</verification>

<success_criteria>
- AssistantChatScreen is the screen for /assistant/:threadId (not ConversationScreen)
- Messages render with markdown formatting via MarkdownMessage
- Streaming shows thinking indicator with elapsed time
- Copy and retry controls work
- Clean UI — no BA artifacts, budget, mode, project elements
- Existing BA routing is unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/64-conversation-documents/64-03-SUMMARY.md`
</output>

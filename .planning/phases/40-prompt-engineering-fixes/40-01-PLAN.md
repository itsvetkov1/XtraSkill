---
phase: 40-prompt-engineering-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/services/ai_service.py
autonomous: true

must_haves:
  truths:
    - "When a user has generated 3+ artifacts in a thread, sending a new chat message produces exactly one artifact (not duplicates of previous artifacts)"
    - "When a user says 'regenerate the BRD with more detail,' the model honors the request as a new generation (escape hatch works)"
    - "The save_artifact tool description no longer contains 'multiple times' language"
    - "Regular chat messages (non-artifact) are completely unaffected by the prompt changes"
  artifacts:
    - path: "backend/app/services/ai_service.py"
      provides: "Deduplication rule in SYSTEM_PROMPT critical_rules + single-call SAVE_ARTIFACT_TOOL description"
      contains: "ONLY act on the MOST RECENT user message"
  key_links:
    - from: "SYSTEM_PROMPT critical_rules"
      to: "LLM behavior"
      via: "system prompt injection in stream_chat"
      pattern: "rule priority.*artifact deduplication"
    - from: "SAVE_ARTIFACT_TOOL description"
      to: "LLM tool-call decisions"
      via: "tools parameter in stream_chat"
      pattern: "Call this tool ONCE per user request"
---

<objective>
Add artifact deduplication rule to SYSTEM_PROMPT and enforce single-call behavior in SAVE_ARTIFACT_TOOL description. These are Layers 1+2 of the defense-in-depth strategy for BUG-016 (artifact multiplication).

Purpose: When conversation history contains N fulfilled artifact generation requests, the model currently re-executes all N on the next turn because nothing distinguishes fulfilled from pending requests, and the tool description says "You may call this tool multiple times." This plan adds a deduplication rule (Layer 1) and fixes the tool description (Layer 2), providing ~95% reduction in duplicate artifact generation.

Output: Modified `ai_service.py` with deduplication rule at priority 2 in critical_rules and rewritten SAVE_ARTIFACT_TOOL description.
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md
@backend/app/services/ai_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add artifact deduplication rule to SYSTEM_PROMPT critical_rules</name>
  <files>backend/app/services/ai_service.py</files>
  <action>
In the SYSTEM_PROMPT string constant, modify the `<critical_rules>` section (currently lines 120-126).

Insert a NEW rule at priority 2 with this exact content:

```xml
<rule priority="2">ARTIFACT DEDUPLICATION - ONLY act on the MOST RECENT user message when deciding whether to call save_artifact. If you see save_artifact tool results earlier in the conversation, those artifact requests are ALREADY COMPLETE - do not re-generate them. HOWEVER, if the user explicitly asks to regenerate, revise, update, or create a new version of an artifact, that IS a new request - honor it fully.</rule>
```

Then renumber the EXISTING rules by +1 so they become priorities 3 through 6:
- Old priority 2 (PROACTIVE MODE DETECTION) becomes priority 3
- Old priority 3 (ZERO-ASSUMPTION PROTOCOL) becomes priority 4
- Old priority 4 (TECHNICAL BOUNDARY ENFORCEMENT) becomes priority 5
- Old priority 5 (TOOL USAGE) becomes priority 6

The resulting critical_rules section should have 6 rules total, priorities 1-6, with the new deduplication rule at position 2.

Key design points (from research):
- Uses positive framing ("ONLY act on the MOST RECENT") per PROMPT-02
- References save_artifact tool results as completion evidence per PROMPT-04
- Includes explicit re-generation escape hatch per PROMPT-03 to avoid PITFALL-03
- Does NOT block "regenerate with more detail" type requests
  </action>
  <verify>
Read `backend/app/services/ai_service.py` and confirm:
1. The critical_rules section contains exactly 6 rules
2. Priority 2 rule contains "ARTIFACT DEDUPLICATION" and "MOST RECENT user message"
3. Priority 2 rule contains the escape hatch text "regenerate, revise, update, or create a new version"
4. Priority 2 rule references "save_artifact tool results" as completion evidence
5. All other rules are renumbered correctly (3 through 6)
6. Run `cd /Users/a1testingmac/projects/XtraSkill/backend && python -m pytest tests/test_service_architecture.py -v` to confirm existing tests still pass
  </verify>
  <done>SYSTEM_PROMPT critical_rules has 6 rules. New deduplication rule is at priority 2 with positive framing, completion evidence reference, and re-generation escape hatch. Existing rules renumbered 3-6. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Enforce single-call behavior in SAVE_ARTIFACT_TOOL description</name>
  <files>backend/app/services/ai_service.py</files>
  <action>
In the SAVE_ARTIFACT_TOOL dictionary constant (currently starting around line 649), replace the entire `description` string value.

Current description to REMOVE:
```
Save a business analysis artifact to the current conversation thread.

USE THIS TOOL WHEN:
- User requests user stories, acceptance criteria, or requirements documents
- You have gathered enough context from conversation and documents
- User asks to "create", "generate", "write", or "document" requirements

BEFORE USING:
- Consider using search_documents first to gather project context
- Review the full conversation for ALL requirements discussed
- Ensure comprehensive coverage, not just recent messages

You may call this tool multiple times to create multiple artifacts.
```

Replace with this NEW description:
```
Save a business analysis artifact to the current conversation thread.

Call this tool ONCE per user request. Each user message that requests an artifact should result in exactly one save_artifact call.

USE THIS TOOL WHEN:
- User requests user stories, acceptance criteria, or requirements documents
- You have gathered enough context from conversation and documents
- User asks to "create", "generate", "write", or "document" requirements

BEFORE USING:
- Consider using search_documents first to gather project context
- Review the full conversation for ALL requirements discussed
- Ensure comprehensive coverage, not just recent messages

If the user sends a NEW message explicitly asking to regenerate, revise, or create another artifact, that is a separate request - call this tool once for that new request.
```

Key changes:
- REMOVES "You may call this tool multiple times to create multiple artifacts." (PROMPT-07)
- ADDS "Call this tool ONCE per user request" enforcement (PROMPT-06)
- ADDS re-generation allowance for NEW user messages (PROMPT-08)
- Preserves all useful guidance (WHEN, BEFORE USING sections)
  </action>
  <verify>
Read `backend/app/services/ai_service.py` and confirm:
1. The SAVE_ARTIFACT_TOOL description contains "Call this tool ONCE per user request"
2. The description does NOT contain "multiple times"
3. The description contains the re-generation clause "new message explicitly asking to regenerate"
4. The input_schema is unchanged (artifact_type, title, content_markdown)
5. Run `cd /Users/a1testingmac/projects/XtraSkill/backend && python -m pytest tests/ -v` to confirm ALL tests pass (not just architecture tests)
  </verify>
  <done>SAVE_ARTIFACT_TOOL description enforces single-call behavior. "Multiple times" language removed. Re-generation via new user message explicitly allowed. All backend tests pass.</done>
</task>

</tasks>

<verification>
1. Read the modified `ai_service.py` and verify both changes are present and correctly formatted
2. Verify the SYSTEM_PROMPT is still valid XML (no unclosed tags, no broken structure)
3. Run full backend test suite: `cd /Users/a1testingmac/projects/XtraSkill/backend && python -m pytest tests/ -v`
4. Confirm zero test failures and zero test errors
5. Grep for "multiple times" in `ai_service.py` -- should return zero matches
6. Grep for "ARTIFACT DEDUPLICATION" in `ai_service.py` -- should return exactly one match
7. Grep for "ONCE per user request" in `ai_service.py` -- should return exactly one match
</verification>

<success_criteria>
- SYSTEM_PROMPT has 6 critical rules with deduplication at priority 2
- Deduplication rule uses positive framing, references tool results as evidence, includes escape hatch
- SAVE_ARTIFACT_TOOL says "ONCE per user request" (not "multiple times")
- Both changes include re-generation escape hatch (no legitimate workflows blocked)
- All existing backend tests pass without modification
- Requirements PROMPT-01 through PROMPT-08 are all satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/40-prompt-engineering-fixes/40-01-SUMMARY.md`
</output>

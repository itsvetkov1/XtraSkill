---
phase: 64-conversation-documents
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/routes/skills.py
  - backend/app/routes/documents.py
  - backend/app/routes/__init__.py
  - backend/main.py
autonomous: true
requirements: [UI-03, UI-04]

must_haves:
  truths:
    - "GET /api/skills returns a list of discovered skills from .claude/ directory"
    - "POST /api/threads/{thread_id}/documents uploads a document and associates it with the thread"
    - "GET /api/threads/{thread_id}/documents returns documents uploaded to a specific thread"
    - "Existing BA document upload flow is unaffected"
  artifacts:
    - path: "backend/app/routes/skills.py"
      provides: "Skills discovery API endpoint"
      contains: "list_skills"
    - path: "backend/app/routes/documents.py"
      provides: "Thread-scoped document upload and listing endpoints"
      contains: "upload_thread_document"
  key_links:
    - from: "backend/app/routes/skills.py"
      to: ".claude/ directory"
      via: "Path iteration for SKILL.md files"
      pattern: "SKILL\\.md"
    - from: "backend/app/routes/documents.py"
      to: "backend/app/models.py"
      via: "Document model with thread_id association"
      pattern: "thread_id"
---

<objective>
Create backend API endpoints for skills discovery and thread-scoped document upload.

Purpose: The Assistant chat screen needs two backend capabilities: (1) discovering available Claude Code skills from the .claude/ directory for the skill selector UI, and (2) uploading documents directly to an Assistant thread (not to a project) so the AI can reference them as context.

Output: Two new API capabilities — GET /api/skills and POST /api/threads/{thread_id}/documents + GET /api/threads/{thread_id}/documents
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/64-conversation-documents/64-RESEARCH.md
@.planning/phases/62-backend-foundation/62-01-SUMMARY.md
@backend/app/routes/documents.py
@backend/app/routes/threads.py
@backend/app/models.py
@backend/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Skills Discovery API Endpoint</name>
  <files>
    backend/app/routes/skills.py
    backend/app/routes/__init__.py
    backend/main.py
  </files>
  <action>
Create a new `backend/app/routes/skills.py` file with a GET /api/skills endpoint:

1. **Router setup**: Create `router = APIRouter()` with `tags=["skills"]`

2. **GET /api/skills endpoint**:
   - Protected with `Depends(get_current_user)` (any authenticated user)
   - Scans the `.claude/` directory (relative to project root) for subdirectories containing `SKILL.md`
   - For each skill found, extracts:
     - `name`: directory name (e.g., "business-analyst")
     - `description`: first non-empty line from SKILL.md after any frontmatter (skip lines starting with `---` and `#`)
     - `skill_path`: relative path to SKILL.md (e.g., ".claude/business-analyst/SKILL.md")
   - Returns `List[dict]` with `name`, `description`, `skill_path` fields
   - If `.claude/` directory doesn't exist, return empty list (not error)
   - Handle I/O errors gracefully (log warning, skip problematic skills)

3. **Project root detection**: Use `Path(__file__).resolve().parents[2]` to find project root (from backend/app/routes/ up 3 levels), then look for `.claude/` there. If that fails, try `Path.cwd()`. Log which path is used.

4. **Register route**: Add `from app.routes.skills import router as skills_router` in `backend/main.py` and mount with `app.include_router(skills_router, prefix="/api")`.

5. **Export**: Add skills to `backend/app/routes/__init__.py` if it exports routes.

IMPORTANT: This endpoint is read-only, no database access needed. Keep it simple — just file system scanning.
  </action>
  <verify>
Run: `cd /Users/a1testingmac/projects/XtraSkill/backend && python -c "from app.routes.skills import router; print('Skills router imported successfully')"` — should not error.

Check endpoint exists: `grep -r 'list_skills\|/skills' backend/app/routes/skills.py` — should show the endpoint definition.
  </verify>
  <done>GET /api/skills endpoint exists, imports cleanly, scans .claude/ directory for SKILL.md files, returns skill name + description + path.</done>
</task>

<task type="auto">
  <name>Task 2: Thread-Scoped Document Upload and Listing</name>
  <files>
    backend/app/routes/documents.py
  </files>
  <action>
Add two new endpoints to the existing `backend/app/routes/documents.py` for thread-scoped document management:

1. **POST /api/threads/{thread_id}/documents** (upload):
   - Protected with `Depends(get_current_user)`
   - Validate thread exists AND belongs to current user (use ownership check pattern from `backend/app/routes/threads.py`)
   - Accept `UploadFile` (same as existing upload endpoint)
   - Reuse the SAME upload logic as the project upload: validate file type via `ALLOWED_CONTENT_TYPES`, validate security via `validate_file_security`, parse via `ParserFactory`, encrypt, create Document record
   - Key difference: set `project_id=None` (Assistant threads have no project per API-03 from Phase 62)
   - Additionally, store `thread_id` on the Document. Check if Document model has a `thread_id` field. If NOT, the Document model already has nullable `project_id` — we need to add a `thread_id` column (nullable String, foreign key to threads.id). Add an inline migration in the database init if needed, using the same pattern as Phase 62's migration (ALTER TABLE ADD COLUMN with try/except for idempotency).
   - After creation, index for FTS5 search via `index_document(db, doc.id)`
   - Return `{"id": doc.id, "filename": doc.filename, "content_type": doc.content_type}`

2. **GET /api/threads/{thread_id}/documents** (list):
   - Protected with `Depends(get_current_user)`
   - Validate thread ownership
   - Query `Document` where `thread_id == thread_id` (NOT project_id)
   - Return list of `{"id", "filename", "content_type", "created_at", "metadata_json"}`
   - Order by `created_at DESC`

3. **Model update (if needed)**: If Document model doesn't have `thread_id`, add it:
   - In `backend/app/models.py`: Add `thread_id = Column(String(36), ForeignKey("threads.id", ondelete="CASCADE"), nullable=True)`
   - In `backend/app/database.py` (or wherever migrations run): Add idempotent ALTER TABLE to add thread_id column

4. **Reuse pattern**: Extract the upload logic from the existing `upload_document` function into a helper `_process_and_store_document(db, file, project_id, thread_id)` to avoid code duplication. Both the project upload and thread upload should call this helper.

IMPORTANT: Do NOT change the existing project document upload behavior. The thread upload is additive.
  </action>
  <verify>
Run: `cd /Users/a1testingmac/projects/XtraSkill/backend && python -c "from app.routes.documents import router; print([r.path for r in router.routes])"` — should show the new thread document routes alongside existing project routes.

Check: `grep -n 'thread_id' backend/app/routes/documents.py` — should show the new endpoints referencing thread_id.

Check model: `grep -n 'thread_id' backend/app/models.py` — should show thread_id field on Document (if it was added).
  </verify>
  <done>POST /api/threads/{thread_id}/documents uploads and stores documents associated with a thread. GET /api/threads/{thread_id}/documents lists thread documents. Existing project upload unchanged. Documents persist for the thread and are available for AI context.</done>
</task>

</tasks>

<verification>
1. Skills endpoint: `curl -H "Authorization: Bearer $TOKEN" http://localhost:8000/api/skills` returns JSON array with at least one skill (business-analyst)
2. Thread document upload: `curl -X POST -H "Authorization: Bearer $TOKEN" -F "file=@test.txt" http://localhost:8000/api/threads/{thread_id}/documents` returns 201 with document ID
3. Thread document list: `curl -H "Authorization: Bearer $TOKEN" http://localhost:8000/api/threads/{thread_id}/documents` returns array of uploaded documents
4. Existing project upload still works: `curl -X POST -H "Authorization: Bearer $TOKEN" -F "file=@test.txt" http://localhost:8000/api/projects/{project_id}/documents` returns 201
</verification>

<success_criteria>
- GET /api/skills returns skills discovered from .claude/ directory
- POST /api/threads/{thread_id}/documents creates thread-scoped documents
- GET /api/threads/{thread_id}/documents lists thread documents
- Existing project document upload is unaffected
- All endpoints are protected with authentication
</success_criteria>

<output>
After completion, create `.planning/phases/64-conversation-documents/64-01-SUMMARY.md`
</output>

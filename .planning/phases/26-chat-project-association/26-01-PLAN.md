---
phase: 26-chat-project-association
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/routes/threads.py
autonomous: true

must_haves:
  truths:
    - "PATCH /api/threads/{id} accepts project_id field"
    - "Thread ownership transitions from user_id to project_id"
    - "Cannot associate thread that already has a project"
    - "Cannot associate with non-existent or other user's project"
  artifacts:
    - path: "backend/app/routes/threads.py"
      provides: "Extended PATCH endpoint with project_id support"
      contains: "project_id"
  key_links:
    - from: "PATCH /api/threads/{id}"
      to: "Thread.project_id and Thread.user_id"
      via: "ownership model transition"
      pattern: "thread\\.project_id = .*project_id"
---

<objective>
Extend PATCH /api/threads/{id} endpoint to accept project_id field for associating project-less chats with projects.

Purpose: Enable backend support for permanent thread-project association with proper ownership model transition (clear user_id when setting project_id).

Output: Modified threads.py with extended ThreadUpdate model and updated rename_thread endpoint logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-chat-project-association/26-CONTEXT.md
@.planning/phases/26-chat-project-association/26-RESEARCH.md

@backend/app/routes/threads.py
@backend/app/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ThreadUpdate model and PATCH endpoint</name>
  <files>backend/app/routes/threads.py</files>
  <action>
Modify the ThreadUpdate Pydantic model to accept an optional project_id field:

```python
class ThreadUpdate(BaseModel):
    """Request model for updating a thread."""
    title: Optional[str] = Field(None, max_length=255)
    project_id: Optional[str] = None  # NEW: for project association
```

Extend the rename_thread endpoint (PATCH /threads/{thread_id}) to handle project_id:

1. After existing ownership validation, check if project_id is provided in update_data
2. If project_id provided:
   - Verify thread doesn't already have a project (thread.project_id is not None) - return 400 "Thread already associated with a project"
   - Validate project exists and belongs to current user (reuse pattern from create_global_thread)
   - Update thread.project_id to the new value
   - Clear thread.user_id to None (ownership transitions to project)
3. Keep existing title update logic (apply if title provided)
4. Commit and return updated thread

Key validation logic:
```python
# Handle project association
if update_data.project_id is not None:
    # Prevent re-association (permanent, one-way)
    if thread.project_id is not None:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Thread already associated with a project"
        )

    # Validate project ownership
    stmt = select(Project).where(
        Project.id == update_data.project_id,
        Project.user_id == user_id
    )
    result = await db.execute(stmt)
    project = result.scalar_one_or_none()

    if not project:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Project not found"
        )

    # Transition ownership model
    thread.project_id = update_data.project_id
    thread.user_id = None  # Clear direct ownership

# Handle title update (existing logic)
if update_data.title is not None:
    thread.title = update_data.title
```

Update docstring to reflect new capability:
"Update thread title and/or associate with project."
  </action>
  <verify>
Run backend and test with curl:

1. Create project-less thread:
```bash
curl -X POST http://localhost:8000/api/threads \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"title": "Test Chat"}'
```

2. Associate with project:
```bash
curl -X PATCH http://localhost:8000/api/threads/{thread_id} \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"project_id": "{project_id}"}'
```
Expected: 200 with thread showing project_id set, user_id cleared

3. Try to re-associate:
```bash
curl -X PATCH http://localhost:8000/api/threads/{thread_id} \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"project_id": "{other_project_id}"}'
```
Expected: 400 "Thread already associated with a project"

4. Try invalid project:
```bash
curl -X PATCH http://localhost:8000/api/threads/{thread_id} \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"project_id": "invalid-uuid"}'
```
Expected: 404 "Project not found"
  </verify>
  <done>
PATCH /api/threads/{id} accepts project_id, validates ownership, transitions ownership model (clears user_id), and prevents re-association with 400 error.
  </done>
</task>

</tasks>

<verification>
## API Verification

1. Project association succeeds for project-less threads
2. Association is rejected for threads already in a project (400)
3. Association is rejected for invalid/non-owned projects (404)
4. Title updates continue to work alongside or independent of association
5. Ownership model correctly transitions (user_id becomes null, project_id set)
</verification>

<success_criteria>
- PATCH /api/threads/{id} accepts `{"project_id": "..."}` payload
- Thread with project_id=null can be associated with user's project
- Thread with existing project_id returns 400 on association attempt
- Invalid project_id returns 404
- Thread ownership transitions: user_id cleared when project_id set
- Existing title rename functionality unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/26-chat-project-association/26-01-SUMMARY.md`
</output>

---
phase: 27-thread-search-filter
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/providers/thread_provider.dart
  - frontend/lib/screens/threads/thread_list_screen.dart
autonomous: true

must_haves:
  truths:
    - "User can search threads within a project"
    - "User can sort project threads by date or name"
    - "Search persists until cleared"
    - "No threads matching message shown when search has no results"
  artifacts:
    - path: "frontend/lib/providers/thread_provider.dart"
      provides: "Search/sort state and filteredThreads getter"
      contains: "filteredThreads"
    - path: "frontend/lib/screens/threads/thread_list_screen.dart"
      provides: "SearchBar and SegmentedButton UI"
      contains: "SearchBar"
  key_links:
    - from: "frontend/lib/screens/threads/thread_list_screen.dart"
      to: "ThreadProvider.setSearchQuery"
      via: "SearchBar onChanged callback"
      pattern: "setSearchQuery"
    - from: "frontend/lib/screens/threads/thread_list_screen.dart"
      to: "ThreadProvider.filteredThreads"
      via: "Consumer using filteredThreads instead of threads"
      pattern: "provider.filteredThreads"
---

<objective>
Add search and sort functionality to the ThreadListScreen (project threads view).

Purpose: Mirror ChatsScreen search/sort pattern for consistency within project view.
Output: Working search bar and sort selector on ThreadListScreen.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-thread-search-filter/27-RESEARCH.md

@frontend/lib/providers/thread_provider.dart
@frontend/lib/screens/threads/thread_list_screen.dart
@frontend/lib/models/thread_sort.dart (created in 27-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add filter state to ThreadProvider</name>
  <files>
    frontend/lib/providers/thread_provider.dart
  </files>
  <action>
    Update `frontend/lib/providers/thread_provider.dart`:

    1. Import `../models/thread_sort.dart`

    2. Add private fields:
       - `String _searchQuery = ''`
       - `ThreadSortOption _sortOption = ThreadSortOption.newest`

    3. Add getters:
       - `String get searchQuery => _searchQuery`
       - `ThreadSortOption get sortOption => _sortOption`

    4. Add computed getter `filteredThreads`:
       ```dart
       List<Thread> get filteredThreads {
         var result = _threads.where((thread) {
           if (_searchQuery.isEmpty) return true;
           final title = thread.title?.toLowerCase() ?? '';
           return title.contains(_searchQuery.toLowerCase());
         }).toList();

         switch (_sortOption) {
           case ThreadSortOption.newest:
             result.sort((a, b) => (b.lastActivityAt ?? b.updatedAt)
                 .compareTo(a.lastActivityAt ?? a.updatedAt));
           case ThreadSortOption.oldest:
             result.sort((a, b) => (a.lastActivityAt ?? a.updatedAt)
                 .compareTo(b.lastActivityAt ?? b.updatedAt));
           case ThreadSortOption.alphabetical:
             result.sort((a, b) =>
                 (a.title ?? '').toLowerCase().compareTo((b.title ?? '').toLowerCase()));
         }
         return result;
       }
       ```

    5. Add methods:
       ```dart
       void setSearchQuery(String query) {
         _searchQuery = query;
         notifyListeners();
       }

       void setSortOption(ThreadSortOption option) {
         _sortOption = option;
         notifyListeners();
       }

       void clearSearch() {
         _searchQuery = '';
         notifyListeners();
       }
       ```

    6. Update `clearThreads()` to also reset search/sort state:
       ```dart
       void clearThreads() {
         _threads = [];
         _selectedThread = null;
         _error = null;
         _loading = false;
         _searchQuery = '';
         _sortOption = ThreadSortOption.newest;
         notifyListeners();
       }
       ```
  </action>
  <verify>
    Run `flutter analyze` - no new errors.
    Verify ThreadProvider compiles with new methods.
  </verify>
  <done>
    - ThreadProvider has searchQuery, sortOption state
    - ThreadProvider.filteredThreads returns filtered/sorted list
    - setSearchQuery, setSortOption, clearSearch methods work
    - clearThreads resets search/sort state
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SearchBar and SegmentedButton UI to ThreadListScreen</name>
  <files>
    frontend/lib/screens/threads/thread_list_screen.dart
  </files>
  <action>
    1. Import `thread_sort.dart`

    2. Add TextEditingController `_searchController` as class field

    3. In initState, add restoration of search query from provider (after loadThreads callback):
       ```dart
       WidgetsBinding.instance.addPostFrameCallback((_) {
         final provider = context.read<ThreadProvider>();
         provider.loadThreads(widget.projectId);
         // Restore search query if any
         if (provider.searchQuery.isNotEmpty) {
           _searchController.text = provider.searchQuery;
         }
       });
       ```

    4. In dispose, add `_searchController.dispose()`

    5. Add helper method `_clearSearch()`:
       ```dart
       void _clearSearch() {
         _searchController.clear();
         context.read<ThreadProvider>().clearSearch();
       }
       ```

    6. Modify build method to wrap content in Column with search controls:
       - Add header section with SearchBar and SegmentedButton (Padding 16)
       - SearchBar: hintText 'Search conversations...', leading search icon, trailing clear button (conditional)
       - SegmentedButton: ThreadSortOption values, showSelectedIcon: false for compact display
       - Keep RefreshIndicator and Skeletonizer wrapping the ListView

    7. Update empty state logic:
       - Extract to method `_buildContent(ThreadProvider provider)`
       - If provider.searchQuery.isNotEmpty AND provider.filteredThreads.isEmpty:
         Show "No conversations matching 'X'" with clear search button
       - Else if !provider.isLoading AND provider.threads.isEmpty:
         Show existing EmptyState
       - Else: Show thread list

    8. Update ListView.builder:
       - Use provider.filteredThreads instead of provider.threads
       - itemCount: provider.isLoading ? 4 : provider.filteredThreads.length

    Important: Don't break existing Skeletonizer behavior - skeleton shows during loading regardless of filter state.
  </action>
  <verify>
    Run app, navigate to a project:
    - SearchBar appears at top of thread list
    - SegmentedButton shows Newest/Oldest/A-Z
    - Typing in search filters list instantly
    - Clear button appears when search has text
    - Changing sort reorders list
    - With no matches: "No conversations matching 'X'" message appears
    - With no threads at all: "No conversations yet" message appears
    - Skeleton loader still works during loading
  </verify>
  <done>
    - ThreadListScreen has SearchBar with clear button
    - ThreadListScreen has SegmentedButton for sort options
    - Filtering works instantly on typing
    - Empty state differentiates "no threads" vs "no matches"
    - Search persists until cleared or navigating to different project
    - Skeleton loader unchanged
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Flutter tests for ThreadListScreen search/sort</name>
  <files>
    frontend/test/widget/thread_list_screen_test.dart
  </files>
  <action>
    Update existing test file or create if needed:

    1. Test: "search bar filters project threads by title"
       - Setup mock ThreadProvider with threads
       - Pump ThreadListScreen with projectId
       - Enter search text
       - Verify filtered results displayed

    2. Test: "sort options change project thread order"
       - Setup threads with different dates
       - Verify default newest first
       - Select oldest
       - Verify order changes

    3. Test: "empty search results show appropriate message"
       - Search for non-existent term
       - Verify "No conversations matching" text

    4. Test: "clear button clears search and shows all threads"
       - Enter search
       - Tap clear
       - Verify all threads shown

    Follow existing test patterns in codebase for mocking.
  </action>
  <verify>
    Run: `cd frontend && flutter test test/widget/thread_list_screen_test.dart`
    All tests pass.
  </verify>
  <done>
    - 4 test cases covering search, sort, empty results, clear
    - All tests pass
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && flutter analyze` - no errors
2. `cd frontend && flutter test` - all tests pass
3. Manual: Open app, go to a project, verify search and sort work
4. Verify consistency with ChatsScreen behavior
</verification>

<success_criteria>
- SearchBar visible on ThreadListScreen
- Typing filters threads instantly (case-insensitive title match)
- SegmentedButton switches between Newest, Oldest, A-Z sort
- Clear button clears search
- "No conversations matching 'X'" shown when no results
- "No conversations yet" shown when truly empty
- Search state resets when switching projects (via clearThreads)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/27-thread-search-filter/27-02-SUMMARY.md`
</output>

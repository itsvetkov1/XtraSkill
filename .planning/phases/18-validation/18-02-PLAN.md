---
phase: 18-validation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/18-validation/PRODUCTION-DEPLOYMENT.md
  - .planning/ROADMAP.md
  - .planning/STATE.md
autonomous: true

must_haves:
  truths:
    - "Developer can configure nginx for SPA deep linking"
    - "Developer can configure Apache for SPA deep linking"
    - "Developer can configure Vercel for SPA deep linking"
    - "Developer can configure Firebase Hosting for SPA deep linking"
    - "Developer can troubleshoot common production issues"
  artifacts:
    - path: ".planning/phases/18-validation/PRODUCTION-DEPLOYMENT.md"
      provides: "Server configuration documentation for all major platforms"
      contains: "try_files"
  key_links:
    - from: "PRODUCTION-DEPLOYMENT.md"
      to: "Production server"
      via: "Copy-paste configuration"
      pattern: "location|RewriteRule|rewrites"
---

<objective>
Create production deployment documentation for SPA deep linking server configuration.

Purpose: Document server-side requirements so deep links work in production (not just flutter run). Addresses concern from STATE.md about "Production server SPA rewrite rules."
Output: PRODUCTION-DEPLOYMENT.md with nginx, Apache, Vercel, and Firebase Hosting configurations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-validation/18-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create production deployment guide</name>
  <files>.planning/phases/18-validation/PRODUCTION-DEPLOYMENT.md</files>
  <action>
Create PRODUCTION-DEPLOYMENT.md with comprehensive server configuration documentation.

**Structure:**

# Production Deployment Guide: SPA Deep Linking

## Overview
- Explain why SPA routing requires server configuration
- Explain what happens without rewrite rules (browser 404 on refresh)

## Flutter Build
- `flutter build web --release`
- Output in `build/web/`
- Base href configuration for subdirectory deployment

## Server Configurations

### Nginx
```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /var/www/flutter_app/build/web;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### Apache (.htaccess)
```apache
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^ index.html [L]
</IfModule>
```

### Vercel (vercel.json)
```json
{
  "rewrites": [
    { "source": "/(.*)", "destination": "/" }
  ]
}
```

### Firebase Hosting (firebase.json)
```json
{
  "hosting": {
    "public": "build/web",
    "rewrites": [
      { "source": "**", "destination": "/index.html" }
    ]
  }
}
```

## Base Href Configuration
- Root domain: `<base href="/">`
- Subdirectory: `<base href="/app/">`
- Build with: `flutter build web --base-href /app/`

## Troubleshooting

| Problem | Cause | Solution |
|---------|-------|----------|
| 404 on page refresh | Missing rewrite rules | Add server configuration above |
| Assets not loading | Wrong base href | Match base href to deployment path |
| Deep links go to 404 | Server 404 not Flutter 404 | Check server is serving index.html for all routes |
| OAuth callback fails | Redirect URI mismatch | Update OAuth app settings with production URL |

## Security Considerations
- Always use HTTPS in production
- Session storage is per-origin (HTTPS and HTTP are different origins)
- returnUrl validation prevents open redirect (already implemented)
  </action>
  <verify>PRODUCTION-DEPLOYMENT.md exists with all 4 server configurations</verify>
  <done>Production deployment guide created with nginx, Apache, Vercel, Firebase configurations</done>
</task>

<task type="auto">
  <name>Task 2: Update roadmap and state for milestone completion</name>
  <files>.planning/ROADMAP.md, .planning/STATE.md</files>
  <action>
Update ROADMAP.md:
1. Mark Phase 18 as Complete in the Progress table
2. Update Phase 18 section with plan count: `**Plans:** 2 plans`
3. Add plan list:
   ```
   Plans:
   - [x] 18-01-PLAN.md - End-to-end validation test execution
   - [x] 18-02-PLAN.md - Production deployment documentation
   ```

Update STATE.md:
1. Update "Current Position" section:
   - Phase: 18 - validation (COMPLETE - VERIFIED)
   - Plan: 2/2 complete
   - Status: Phase verified, v1.7 milestone complete
   - Progress bar: [████████████████████] Phase 18 complete (2/2 plans)

2. Update Performance Metrics:
   - Increment URL v1.7 plans count to 8/?

3. Remove the production SPA concern from Blockers/Concerns (now documented)

4. Update Session Continuity:
   - Last session: current date
   - Stopped at: Phase 18 complete, v1.7 milestone complete
   - Next action: Archive v1.7 roadmap and create v1.8 or v2.0 roadmap
  </action>
  <verify>ROADMAP.md shows Phase 18 Complete; STATE.md reflects milestone completion</verify>
  <done>Project state updated to reflect v1.7 milestone completion</done>
</task>

</tasks>

<verification>
- [ ] PRODUCTION-DEPLOYMENT.md exists with all server configurations
- [ ] Nginx configuration includes try_files directive
- [ ] Apache configuration includes RewriteRule
- [ ] Vercel configuration includes rewrites
- [ ] Firebase configuration includes rewrites
- [ ] Troubleshooting section covers common issues
- [ ] ROADMAP.md updated with Phase 18 completion
- [ ] STATE.md updated for v1.7 milestone completion
</verification>

<success_criteria>
1. Production deployment documented for 4 common server platforms
2. Troubleshooting guide covers refresh 404 issue
3. v1.7 milestone marked complete in project state
4. Clear next steps documented (archive roadmap, plan next milestone)
</success_criteria>

<output>
After completion, create `.planning/phases/18-validation/18-02-SUMMARY.md`
</output>

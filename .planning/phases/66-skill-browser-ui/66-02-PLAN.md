---
phase: 66-skill-browser-ui
plan: 02
type: execute
wave: 2
depends_on: [66-01]
files_modified:
  - frontend/lib/screens/assistant/widgets/skill_browser_sheet.dart
  - frontend/lib/screens/assistant/widgets/skill_selector.dart
  - frontend/lib/screens/assistant/widgets/assistant_chat_input.dart
autonomous: true
requirements: [BROWSE-01, BROWSE-02, BROWSE-03, BROWSE-04, SEL-01, SEL-02, SEL-03]

must_haves:
  truths:
    - "User can open skill browser bottom sheet from chat input skill button"
    - "User sees all skills in a responsive grid with cards showing emoji, name, description, features"
    - "User can select a skill by tapping a card â€” card highlights briefly then sheet closes"
    - "Selected skill appears as a prominent filled chip above the text field"
    - "User can dismiss the chip via its X button to deselect the skill"
    - "Selecting a new skill replaces the current one (single-select)"
    - "Loading state shows skeleton cards in grid shape"
    - "Error state shows friendly message with retry button"
  artifacts:
    - path: "frontend/lib/screens/assistant/widgets/skill_browser_sheet.dart"
      provides: "Draggable bottom sheet with skill grid browser"
      contains: "class SkillBrowserSheet"
      min_lines: 80
    - path: "frontend/lib/screens/assistant/widgets/skill_selector.dart"
      provides: "Updated skill selector that opens browser sheet"
      contains: "SkillBrowserSheet.show"
    - path: "frontend/lib/screens/assistant/widgets/assistant_chat_input.dart"
      provides: "Updated chip style with solid accent color"
      contains: "colorScheme.primary"
  key_links:
    - from: "frontend/lib/screens/assistant/widgets/skill_selector.dart"
      to: "frontend/lib/screens/assistant/widgets/skill_browser_sheet.dart"
      via: "SkillBrowserSheet.show() static method"
      pattern: "SkillBrowserSheet\\.show"
    - from: "frontend/lib/screens/assistant/widgets/skill_browser_sheet.dart"
      to: "frontend/lib/screens/assistant/widgets/skill_card.dart"
      via: "SkillCard widget in grid"
      pattern: "SkillCard"
    - from: "frontend/lib/screens/assistant/widgets/skill_browser_sheet.dart"
      to: "frontend/lib/services/skill_service.dart"
      via: "SkillService.getSkills() for data loading"
      pattern: "SkillService.*getSkills"
    - from: "frontend/lib/screens/assistant/widgets/assistant_chat_input.dart"
      to: "frontend/lib/utils/skill_emoji.dart"
      via: "getSkillEmoji for chip avatar"
      pattern: "getSkillEmoji"
---

<objective>
Build the skill browser bottom sheet, integrate it into the chat input replacing the PopupMenuButton, and update the selection chip to the user-specified prominent filled style.

Purpose: This completes the skill browser UI. Users can browse skills in a rich grid, select one, and see it prominently displayed as a chip â€” replacing the simple popup menu with a discoverable, delightful experience.

Output: Working skill browser sheet, updated skill selector trigger, and prominent chip style.
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/66-skill-browser-ui/66-CONTEXT.md
@.planning/phases/66-skill-browser-ui/66-RESEARCH.md
@.planning/phases/66-skill-browser-ui/66-01-SUMMARY.md

@frontend/lib/screens/assistant/widgets/skill_card.dart
@frontend/lib/screens/assistant/widgets/skill_selector.dart
@frontend/lib/screens/assistant/widgets/assistant_chat_input.dart
@frontend/lib/screens/conversation/widgets/artifact_type_picker.dart
@frontend/lib/services/skill_service.dart
@frontend/lib/widgets/responsive_layout.dart
@frontend/lib/utils/skill_emoji.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SkillBrowserSheet with DraggableScrollableSheet and skill grid</name>
  <files>
    frontend/lib/screens/assistant/widgets/skill_browser_sheet.dart
  </files>
  <action>
Create `frontend/lib/screens/assistant/widgets/skill_browser_sheet.dart`:

**Widget:** `SkillBrowserSheet` â€” a StatefulWidget with a static `show()` method for launching the bottom sheet.

**Static show method** (follows ArtifactTypePicker pattern):
```dart
static Future<Skill?> show(BuildContext context) {
  return showModalBottomSheet<Skill>(
    context: context,
    isScrollControlled: true,
    shape: const RoundedRectangleBorder(
      borderRadius: BorderRadius.vertical(top: Radius.circular(16)),
    ),
    builder: (sheetContext) => const SkillBrowserSheet(),
  );
}
```

**State fields:**
- `final SkillService _skillService = SkillService();`
- `List<Skill>? _skills;` (null = not loaded)
- `bool _isLoading = true;`
- `String? _error;`
- `int? _selectedIndex;` (for selection highlight animation)

**initState:** Call `_loadSkills()`.

**_loadSkills() method:**
```dart
Future<void> _loadSkills() async {
  setState(() { _isLoading = true; _error = null; });
  try {
    final skills = await _skillService.getSkills();
    if (mounted) setState(() { _skills = skills; _isLoading = false; });
  } catch (e) {
    if (mounted) setState(() { _error = 'Couldn\'t load skills'; _isLoading = false; });
  }
}
```

**_handleSelection(Skill skill, int index) method:**
- Guard against double-tap: `if (_selectedIndex != null) return;`
- `setState(() => _selectedIndex = index);`
- `await Future.delayed(const Duration(milliseconds: 300));`
- `if (mounted) Navigator.pop(context, skill);`

**Build method:**
Use `DraggableScrollableSheet` wrapped in the modal bottom sheet (per user decision: draggable, starts at ~50%, up to ~90%, drag down to dismiss).

```dart
@override
Widget build(BuildContext context) {
  return DraggableScrollableSheet(
    initialChildSize: 0.5,
    minChildSize: 0.3,
    maxChildSize: 0.9,
    expand: false,
    builder: (context, scrollController) {
      return Column(
        children: [
          _buildHeader(context),
          Expanded(child: _buildBody(context, scrollController)),
        ],
      );
    },
  );
}
```

**_buildHeader(context):**
- Container with padding
- Row with:
  - Center-aligned drag handle: `Container(width: 40, height: 4, decoration: BoxDecoration(color: theme.colorScheme.onSurfaceVariant.withValues(alpha: 0.4), borderRadius: BorderRadius.circular(2)))`
- Below drag handle: `SizedBox(height: 12)`
- Row: `Text('Choose a Skill', style: theme.textTheme.titleLarge)`
- `Divider()` at the bottom

**_buildBody(context, scrollController):**
- **If loading:** Use `Skeletonizer` package (already in pubspec) wrapping a grid of 6 dummy SkillCard widgets
  - Create `_dummySkill` with placeholder text: `Skill(name: 'Loading Skill', description: 'Loading description text for the skill card', features: ['Feature one', 'Feature two', 'Feature three'], skillPath: '')`
  - `Skeletonizer(enabled: true, child: _buildGrid(List.generate(6, (_) => _dummySkill), scrollController))`

- **If error:** Center column with:
  - `Icon(Icons.error_outline, size: 48, color: theme.colorScheme.error)`
  - `SizedBox(height: 16)`
  - `Text(_error!, style: theme.textTheme.bodyLarge)`
  - `SizedBox(height: 16)`
  - `FilledButton.tonal(onPressed: _loadSkills, child: Text('Retry'))`

- **If empty (skills loaded but empty):** Center column with:
  - `Icon(Icons.inbox_outlined, size: 48, color: theme.colorScheme.onSurfaceVariant)`
  - `SizedBox(height: 16)`
  - `Text('No skills available', style: theme.textTheme.bodyLarge)`

- **If loaded with skills:** `_buildGrid(_skills!, scrollController)`

**_buildGrid(List<Skill> skills, ScrollController scrollController):**
Responsive grid per user decision (3 columns desktop, 2 tablet, 1 mobile):

```dart
Widget _buildGrid(List<Skill> skills, ScrollController scrollController) {
  return GridView.builder(
    controller: scrollController,
    padding: const EdgeInsets.all(16),
    gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
      crossAxisCount: _getColumnCount(context),
      crossAxisSpacing: 12,
      mainAxisSpacing: 12,
      childAspectRatio: _getAspectRatio(context),
    ),
    itemCount: skills.length,
    itemBuilder: (context, index) {
      return SkillCard(
        skill: skills[index],
        isSelected: _selectedIndex == index,
        onTap: () => _handleSelection(skills[index], index),
      );
    },
  );
}

int _getColumnCount(BuildContext context) {
  if (context.isDesktop) return 3;
  if (context.isTablet) return 2;
  return 1;
}
```

**Aspect ratio:** Use Claude's discretion â€” on mobile (1 column), cards should be wider than tall (~2.5), on tablet (2 cols) ~1.4, on desktop (3 cols) ~1.3. Adjust so cards don't overflow with name+description+3 features.

**Imports needed:**
- `package:flutter/material.dart`
- `package:skeletonizer/skeletonizer.dart`
- `../../../models/skill.dart`
- `../../../services/skill_service.dart`
- `../../../widgets/responsive_layout.dart`
- `skill_card.dart`
  </action>
  <verify>
- `dart analyze frontend/lib/screens/assistant/widgets/skill_browser_sheet.dart` â€” no errors
- File contains: SkillBrowserSheet class, static show() method, DraggableScrollableSheet
- Loading state uses Skeletonizer with dummy cards
- Error state shows message and retry button
- Selection highlights card then pops with 300ms delay
- Grid uses responsive column counts (3/2/1)
  </verify>
  <done>SkillBrowserSheet opens as a draggable bottom sheet (50%-90% height) showing skills in a responsive grid with skeleton loading, error/empty states, and selection animation with 300ms close delay.</done>
</task>

<task type="auto">
  <name>Task 2: Replace PopupMenuButton in SkillSelector with browser sheet trigger</name>
  <files>
    frontend/lib/screens/assistant/widgets/skill_selector.dart
  </files>
  <action>
**Rewrite** `frontend/lib/screens/assistant/widgets/skill_selector.dart`:

Replace the entire `PopupMenuButton<Skill>` + `FutureBuilder` implementation with a simple `IconButton` that opens the `SkillBrowserSheet`.

**New implementation:**
```dart
class SkillSelector extends StatelessWidget {
  final void Function(Skill) onSkillSelected;

  const SkillSelector({
    super.key,
    required this.onSkillSelected,
  });

  @override
  Widget build(BuildContext context) {
    return IconButton(
      icon: const Icon(Icons.add_box_outlined),
      tooltip: 'Choose a skill',
      onPressed: () async {
        final skill = await SkillBrowserSheet.show(context);
        if (skill != null) {
          onSkillSelected(skill);
        }
      },
    );
  }
}
```

**Key changes:**
- Remove `FutureBuilder` â€” data loading moves to SkillBrowserSheet
- Remove `SkillService` instantiation â€” SkillBrowserSheet owns it
- Remove all loading/error/empty state handling â€” SkillBrowserSheet handles it
- Remove `PopupMenuButton` â€” replaced by `IconButton` + sheet
- Keep same constructor signature (`onSkillSelected` callback) so `AssistantChatInput` doesn't need callback changes
- Widget can now be `const` constructible (no mutable SkillService field)
- Import `skill_browser_sheet.dart`

**Requirement coverage:**
- BROWSE-01: User taps skill button (IconButton) -> SkillBrowserSheet.show() opens bottom sheet
- BROWSE-04: Sheet returns Skill? via Navigator.pop, which triggers onSkillSelected
  </action>
  <verify>
- `dart analyze frontend/lib/screens/assistant/widgets/skill_selector.dart` â€” no errors
- Widget is now a simple IconButton that calls SkillBrowserSheet.show()
- onSkillSelected callback is invoked when user selects a skill from the sheet
- Null result (sheet dismissed without selection) is handled gracefully (no-op)
  </verify>
  <done>SkillSelector is a simple IconButton that opens the SkillBrowserSheet. No more PopupMenuButton. Selection flows through the same onSkillSelected callback interface.</done>
</task>

<task type="auto">
  <name>Task 3: Update skill chip to prominent filled style with emoji</name>
  <files>
    frontend/lib/screens/assistant/widgets/assistant_chat_input.dart
  </files>
  <action>
**Update the skill chip** in `AssistantChatInput._buildChipsArea()` (currently lines 226-238):

**Current chip (subtle secondary style):**
```dart
Chip(
  avatar: const Icon(Icons.add_box_outlined, size: 18),
  label: Text(widget.provider.selectedSkill!.displayName, ...),
  backgroundColor: theme.colorScheme.secondaryContainer,
)
```

**New chip (per user decision: solid accent color, white text, prominent):**
```dart
Chip(
  avatar: Text(
    getSkillEmoji(widget.provider.selectedSkill!.name),
    style: const TextStyle(fontSize: 16),
  ),
  label: Text(
    widget.provider.selectedSkill!.name,
    style: TextStyle(
      fontSize: 13,
      color: theme.colorScheme.onPrimary,
    ),
  ),
  deleteIcon: Icon(
    Icons.close,
    size: 18,
    color: theme.colorScheme.onPrimary,
  ),
  onDeleted: widget.provider.clearSkill,
  backgroundColor: theme.colorScheme.primary,
  visualDensity: VisualDensity.compact,
  materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,
)
```

**Key changes:**
1. `avatar`: Replace `Icon(Icons.add_box_outlined)` with `Text(getSkillEmoji(...))` â€” shows emoji per user decision ("ðŸ“Š Business Analyst x")
2. `label`: Use `skill.name` instead of `skill.displayName` â€” Phase 65 API returns human-readable names already
3. `label` style: Add `color: theme.colorScheme.onPrimary` â€” white text on accent background
4. `deleteIcon`: Add `color: theme.colorScheme.onPrimary` â€” white X on accent background
5. `backgroundColor`: Change from `secondaryContainer` to `primary` â€” solid accent color per user decision
6. Keep `onDeleted`, `visualDensity`, `materialTapTargetSize` unchanged

**Add import** at top of file:
```dart
import '../../../utils/skill_emoji.dart';
```

**Requirement coverage:**
- SEL-01: Chip appears with emoji + full skill name (already positioned above text field)
- SEL-02: X button calls clearSkill (already wired, just updated style)
- SEL-03: Single-select already enforced by provider's `_selectedSkill` field
  </action>
  <verify>
- `dart analyze frontend/lib/screens/assistant/widgets/assistant_chat_input.dart` â€” no errors
- Chip uses primary color background (not secondaryContainer)
- Chip shows emoji avatar from getSkillEmoji
- Chip text and delete icon are onPrimary color (white on accent)
- Chip uses skill.name (human-readable from API) not skill.displayName
  </verify>
  <done>Skill chip displays with prominent filled style: solid accent color background, white text, emoji icon, and white X dismiss button. Matches user decision for visible, prominent selection indicator.</done>
</task>

</tasks>

<verification>
1. `dart analyze frontend/lib/screens/assistant/widgets/` â€” all files clean
2. SkillBrowserSheet.show() returns Future<Skill?> and can be called from SkillSelector
3. SkillSelector opens browser sheet (not popup menu) on tap
4. Selection flow: tap skill button -> sheet opens -> tap card -> highlight -> 300ms -> sheet closes -> chip appears
5. Chip shows emoji + name in prominent filled style
6. Chip X button dismisses skill selection
7. Loading state shows skeleton cards, error shows retry button
8. Grid is responsive: 3 columns desktop, 2 tablet, 1 mobile
</verification>

<success_criteria>
- User can tap skill button to open a draggable bottom sheet browser
- Skills displayed in responsive grid with emoji, name, description, features
- Tapping a card highlights it, waits 300ms, then closes the sheet
- Selected skill shown as prominent filled chip with emoji and name
- Chip can be dismissed via X button
- Loading shows skeleton cards, error shows retry with friendly message
- All 7 requirements (BROWSE-01..04, SEL-01..03) are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/66-skill-browser-ui/66-02-SUMMARY.md`
</output>

---
phase: 02-project-document-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/models.py
  - backend/alembic/versions/002_add_project_document_thread.py
  - backend/app/database.py
  - frontend/lib/models/project.dart
  - frontend/lib/models/document.dart
  - frontend/lib/models/thread.dart
  - frontend/lib/models/message.dart
autonomous: true

must_haves:
  truths:
    - "Projects belong to users via foreign key"
    - "Documents belong to projects and are cascade-deleted with project"
    - "Threads belong to projects and are cascade-deleted with project"
    - "Messages belong to threads and are cascade-deleted with thread"
    - "SQLite enforces foreign key constraints"
  artifacts:
    - path: "backend/app/models.py"
      provides: "Project, Document, Thread, Message models"
      min_lines: 150
      contains: "class Project(Base)"
    - path: "backend/alembic/versions/002_add_project_document_thread.py"
      provides: "Database migration for new tables"
      exports: ["upgrade", "downgrade"]
    - path: "frontend/lib/models/project.dart"
      provides: "Project model with fromJson/toJson"
      exports: ["class Project"]
    - path: "frontend/lib/models/document.dart"
      provides: "Document model"
      exports: ["class Document"]
    - path: "frontend/lib/models/thread.dart"
      provides: "Thread model"
      exports: ["class Thread"]
  key_links:
    - from: "backend/app/models.py:Project"
      to: "backend/app/models.py:User"
      via: "ForeignKey('users.id', ondelete='CASCADE')"
      pattern: "ForeignKey.*users\\.id.*CASCADE"
    - from: "backend/app/models.py:Document"
      to: "backend/app/models.py:Project"
      via: "ForeignKey('projects.id', ondelete='CASCADE')"
      pattern: "ForeignKey.*projects\\.id.*CASCADE"
    - from: "backend/app/database.py"
      to: "SQLite pragma"
      via: "event listener enabling foreign keys"
      pattern: "PRAGMA foreign_keys=ON"
---

<objective>
Create database schema and data models for projects, documents, threads, and messages.

Purpose: Establish the foundation for Phase 2's project organization system with proper relationships and cascade deletes. This enables all subsequent features (project CRUD, document upload, thread management) to work on a solid data model.

Output: Complete backend models with SQLAlchemy relationships, Alembic migration, and frontend Dart models ready for API integration.
</objective>

<execution_context>
@G:\.claude\get-shit-done\workflows\execute-plan.md
@G:\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@G:\git_repos\BA_assistant\.planning\PROJECT.md
@G:\git_repos\BA_assistant\.planning\ROADMAP.md
@G:\git_repos\BA_assistant\.planning\STATE.md
@G:\git_repos\BA_assistant\.planning\REQUIREMENTS.md
@G:\git_repos\BA_assistant\.planning\phases\02-project-document-management\02-RESEARCH.md

# Phase 1 foundation
@G:\git_repos\BA_assistant\backend\app\models.py
@G:\git_repos\BA_assistant\backend\app\database.py
@G:\git_repos\BA_assistant\.planning\phases\01-foundation-authentication\01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Backend Models with Relationships</name>
  <files>
backend/app/models.py
backend/app/database.py
  </files>
  <action>
Add four new models to models.py following the existing User and TokenUsage patterns:

**Project model:**
- UUID primary key (String(36))
- user_id: ForeignKey to users.id with ondelete="CASCADE"
- name: String(255), not null
- description: Text, nullable
- created_at, updated_at: DateTime(timezone=True)
- Relationships: documents and threads with cascade="all, delete-orphan", passive_deletes=True

**Document model:**
- UUID primary key
- project_id: ForeignKey to projects.id with ondelete="CASCADE"
- filename: String(255), not null
- content_encrypted: LargeBinary, not null (will store Fernet-encrypted content)
- created_at: DateTime(timezone=True)
- Relationship: back to project

**Thread model:**
- UUID primary key
- project_id: ForeignKey to projects.id with ondelete="CASCADE"
- title: String(255), nullable (AI will generate summaries in Phase 3)
- created_at, updated_at: DateTime(timezone=True), created_at indexed
- Relationships: back to project, forward to messages with cascade

**Message model:**
- UUID primary key
- thread_id: ForeignKey to threads.id with ondelete="CASCADE"
- role: String(20), not null (values: 'user' or 'assistant')
- content: Text, not null
- created_at: DateTime(timezone=True), indexed
- Relationship: back to thread with order_by="Message.created_at"

**Enable SQLite foreign keys (CRITICAL):**
Add event listener to database.py to execute "PRAGMA foreign_keys=ON" on every connection:

```python
from sqlalchemy import event, Engine

@event.listens_for(Engine, "connect")
def set_sqlite_pragma(dbapi_conn, connection_record):
    cursor = dbapi_conn.cursor()
    cursor.execute("PRAGMA foreign_keys=ON")
    cursor.close()
```

Follow research pattern from 02-RESEARCH.md sections "Pattern 1: One-to-Many Relationships" and "Pattern 2: SQLite Foreign Key Enforcement". Use back_populates on both sides (not backref - deprecated in SQLAlchemy 2.0).
  </action>
  <verify>
- Run `cd backend && python -c "from app.models import Project, Document, Thread, Message; print('Models imported successfully')"` - should succeed
- Check models.py contains ForeignKey with ondelete="CASCADE" for all relationships
- Check database.py contains PRAGMA event listener
- Verify relationships use back_populates (not backref)
  </verify>
  <done>
Models defined with proper types, foreign keys with CASCADE, relationships with cascade="all, delete-orphan", and SQLite PRAGMA listener added. All models follow Phase 1 patterns (UUID primary keys, timezone-aware timestamps, async compatibility).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Alembic Migration</name>
  <files>
backend/alembic/versions/002_add_project_document_thread.py
  </files>
  <action>
Generate Alembic migration for new tables:

```bash
cd backend
alembic revision --autogenerate -m "Add Project, Document, Thread, Message models"
```

Review the generated migration to ensure:
1. Creates tables in dependency order: projects, documents, threads, messages
2. Foreign key constraints include ON DELETE CASCADE
3. Indexes created on: user_id, project_id, thread_id, created_at fields
4. Downgrade function drops tables in reverse order

Run migration to create tables:
```bash
alembic upgrade head
```

Verify tables exist:
```bash
sqlite3 ba_assistant.db ".schema projects"
sqlite3 ba_assistant.db ".schema documents"
sqlite3 ba_assistant.db ".schema threads"
sqlite3 ba_assistant.db ".schema messages"
```
  </action>
  <verify>
- `alembic current` shows latest migration as head
- `sqlite3 ba_assistant.db ".tables"` includes projects, documents, threads, messages
- Check foreign keys with: `sqlite3 ba_assistant.db "PRAGMA foreign_key_list(projects);"` - shows user_id → users.id
- Check foreign keys with: `sqlite3 ba_assistant.db "PRAGMA foreign_key_list(documents);"` - shows project_id → projects.id
  </verify>
  <done>
Migration created, applied successfully, and all four tables exist in database with proper foreign key constraints. Database schema ready for API endpoints.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Frontend Dart Models</name>
  <files>
frontend/lib/models/project.dart
frontend/lib/models/document.dart
frontend/lib/models/thread.dart
frontend/lib/models/message.dart
  </files>
  <action>
Create models directory and four Dart model files:

**frontend/lib/models/project.dart:**
```dart
class Project {
  final String id;
  final String name;
  final String? description;
  final DateTime createdAt;
  final DateTime updatedAt;

  Project({
    required this.id,
    required this.name,
    this.description,
    required this.createdAt,
    required this.updatedAt,
  });

  factory Project.fromJson(Map<String, dynamic> json) {
    return Project(
      id: json['id'],
      name: json['name'],
      description: json['description'],
      createdAt: DateTime.parse(json['created_at']),
      updatedAt: DateTime.parse(json['updated_at']),
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'name': name,
      'description': description,
      'created_at': createdAt.toIso8601String(),
      'updated_at': updatedAt.toIso8601String(),
    };
  }
}
```

**frontend/lib/models/document.dart:**
- Fields: id, filename, createdAt
- fromJson/toJson methods (content not exposed to frontend - backend decrypts on demand)

**frontend/lib/models/thread.dart:**
- Fields: id, projectId, title (nullable), createdAt, updatedAt
- fromJson/toJson methods

**frontend/lib/models/message.dart:**
- Fields: id, role (enum: user/assistant), content, createdAt
- fromJson/toJson methods

Follow patterns from existing frontend code (check lib/providers/auth_provider.dart for reference).
  </action>
  <verify>
- Run `cd frontend && flutter analyze lib/models/` - no errors
- Check each model has fromJson factory constructor
- Check DateTime fields use DateTime.parse() and toIso8601String()
- Verify nullable fields use String? syntax
  </verify>
  <done>
Four Dart models created with proper JSON serialization, matching backend schema exactly. Models ready for use in API service classes and state providers.
  </done>
</task>

</tasks>

<verification>
1. Backend models import successfully without errors
2. Alembic migration applied, all tables exist in database
3. SQLite foreign keys enabled (verify with test: try inserting document with invalid project_id → should fail with foreign key error)
4. Frontend models pass `flutter analyze` with no errors
5. Models use consistent naming (snake_case in backend, camelCase in frontend)
</verification>

<success_criteria>
- [ ] Four backend models (Project, Document, Thread, Message) defined with proper SQLAlchemy 2.0 syntax
- [ ] All foreign keys use ondelete="CASCADE" at database level
- [ ] All relationships use cascade="all, delete-orphan" at ORM level
- [ ] SQLite PRAGMA foreign_keys=ON event listener added to database.py
- [ ] Alembic migration created and applied successfully
- [ ] Database contains all four new tables with proper indexes
- [ ] Four frontend Dart models created with fromJson/toJson
- [ ] All models follow Phase 1 patterns (UUID, timezone-aware timestamps)
- [ ] Foreign key constraints are enforced (test with invalid foreign key → error)
</success_criteria>

<output>
After completion, create `.planning/phases/02-project-document-management/02-01-SUMMARY.md`
</output>

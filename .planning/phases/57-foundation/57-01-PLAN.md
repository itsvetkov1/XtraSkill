---
phase: 57-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/requirements.txt
  - backend/app/services/mcp_tools.py
  - backend/app/services/agent_service.py
autonomous: true

must_haves:
  truths:
    - "claude-agent-sdk>=0.1.35 is specified in requirements.txt"
    - "search_documents and save_artifact tool definitions exist as importable functions in mcp_tools.py"
    - "AgentService still works after refactor by importing tools from mcp_tools.py"
    - "ContextVar declarations for db, project_id, thread_id, documents_used live in mcp_tools.py"
  artifacts:
    - path: "backend/requirements.txt"
      provides: "Upgraded SDK dependency"
      contains: "claude-agent-sdk>=0.1.35"
    - path: "backend/app/services/mcp_tools.py"
      provides: "Shared MCP tool definitions for search_documents and save_artifact"
      exports: ["search_documents_tool", "save_artifact_tool", "_db_context", "_project_id_context", "_thread_id_context", "_documents_used_context", "create_ba_mcp_server"]
    - path: "backend/app/services/agent_service.py"
      provides: "Refactored to import from mcp_tools.py instead of defining tools inline"
  key_links:
    - from: "backend/app/services/agent_service.py"
      to: "backend/app/services/mcp_tools.py"
      via: "import statement"
      pattern: "from app\\.services\\.mcp_tools import"
    - from: "backend/app/services/mcp_tools.py"
      to: "backend/app/services/document_search.py"
      via: "function call in tool handler"
      pattern: "from app\\.services\\.document_search import search_documents"
---

<objective>
Upgrade claude-agent-sdk to v0.1.35+ and extract MCP tool definitions to a shared module.

Purpose: Both the Agent SDK adapter (Phase 58) and CLI adapter (Phase 59) need reusable MCP tool wrappers for search_documents and save_artifact. Currently these are defined inline in agent_service.py (lines 40-196). Extract them to a shared mcp_tools.py module so both adapters can import and reuse them. Also upgrade the SDK from the existing >=0.1.0 pin to >=0.1.35 to get bundled CLI and ARG_MAX fixes.

Output: Updated requirements.txt, new mcp_tools.py, refactored agent_service.py
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/57-foundation/research/ARCHITECTURE.md
@.planning/phases/57-foundation/research/SUMMARY.md

@backend/requirements.txt
@backend/app/services/agent_service.py
@backend/app/services/mcp_tools.py
@backend/app/services/document_search.py
@backend/app/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade SDK dependency and create shared mcp_tools.py</name>
  <files>backend/requirements.txt, backend/app/services/mcp_tools.py</files>
  <action>
1. In `backend/requirements.txt`, change `claude-agent-sdk>=0.1.0` to `claude-agent-sdk>=0.1.35` (line 33). This gets the bundled CLI and ARG_MAX fix from v0.1.31+.

2. Create `backend/app/services/mcp_tools.py` containing:
   - All 4 ContextVar declarations currently in agent_service.py (lines 33-36): `_db_context`, `_project_id_context`, `_thread_id_context`, `_documents_used_context`
   - The `search_documents_tool` function with its @tool decorator (agent_service.py lines 40-120) -- copy exactly, preserving the tool name "search_documents", description, and args schema
   - The `save_artifact_tool` function with its @tool decorator (agent_service.py lines 123-196) -- copy exactly, preserving the tool name "save_artifact", description, and args schema
   - A new `create_ba_mcp_server()` factory function that creates and returns the MCP server:
     ```python
     def create_ba_mcp_server():
         """Create MCP server with BA Assistant tools for reuse across adapters."""
         return create_sdk_mcp_server(
             name="ba-tools",
             version="1.0.0",
             tools=[search_documents_tool, save_artifact_tool]
         )
     ```
   - Import statements needed: json, logging, ContextVar from contextvars, Dict/Any from typing, claude_agent_sdk imports (tool, create_sdk_mcp_server), app imports (search_documents, Artifact, ArtifactType)
   - Module docstring explaining this is shared MCP tool definitions for reuse by AgentService, ClaudeAgentAdapter, and ClaudeCLIAdapter

3. Include `__all__` in mcp_tools.py exporting: `search_documents_tool`, `save_artifact_tool`, `create_ba_mcp_server`, `_db_context`, `_project_id_context`, `_thread_id_context`, `_documents_used_context`
  </action>
  <verify>
Run: `cd /Users/a1testingmac/projects/XtraSkill/backend && python -c "from app.services.mcp_tools import search_documents_tool, save_artifact_tool, create_ba_mcp_server, _db_context, _project_id_context, _thread_id_context, _documents_used_context; print('All exports available')"` -- should print success message without ImportError.
  </verify>
  <done>mcp_tools.py exists with all tool definitions, ContextVars, and create_ba_mcp_server factory. requirements.txt pins claude-agent-sdk>=0.1.35.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor agent_service.py to import from mcp_tools.py</name>
  <files>backend/app/services/agent_service.py</files>
  <action>
1. Remove the inline tool definitions and ContextVar declarations from agent_service.py:
   - Remove lines 10 (ContextVar import -- will come from mcp_tools)
   - Remove lines 33-36 (the 4 ContextVar declarations)
   - Remove lines 40-196 (both @tool decorated functions: search_documents_tool and save_artifact_tool)

2. Add import from mcp_tools at the top:
   ```python
   from app.services.mcp_tools import (
       create_ba_mcp_server,
       _db_context,
       _project_id_context,
       _thread_id_context,
       _documents_used_context,
   )
   ```

3. In the `AgentService.__init__` method, replace the inline `create_sdk_mcp_server(...)` call (lines 211-215) with:
   ```python
   self.tools_server = create_ba_mcp_server()
   ```

4. Remove unused imports that were only needed for the inline tool definitions:
   - `from app.services.document_search import search_documents` (now in mcp_tools.py)
   - `from app.models import Artifact, ArtifactType` (now in mcp_tools.py)
   - The `tool` and `create_sdk_mcp_server` imports from claude_agent_sdk (now in mcp_tools.py)

5. Keep all other imports that agent_service.py still needs directly: `json`, `logging`, `AsyncGenerator`, `Dict`, `Any`, `Optional`, `query`, `ClaudeAgentOptions`, `AssistantMessage`, `TextBlock`, `ToolUseBlock`, `ToolResultBlock`, `ResultMessage`, `StreamEvent`, `settings`, `load_skill_prompt`.

6. The rest of AgentService class (stream_chat method, lines 239-431) stays UNCHANGED -- it still uses the ContextVars (imported from mcp_tools) and self.tools_server (now from create_ba_mcp_server).
  </action>
  <verify>
Run: `cd /Users/a1testingmac/projects/XtraSkill/backend && python -c "from app.services.agent_service import AgentService; print('AgentService imports successfully')"` -- should succeed without error.

Also verify no circular imports: `cd /Users/a1testingmac/projects/XtraSkill/backend && python -c "from app.services.mcp_tools import create_ba_mcp_server; from app.services.agent_service import AgentService; print('No circular imports')"` -- should print success.
  </verify>
  <done>agent_service.py imports all tool definitions and ContextVars from mcp_tools.py. No inline tool code remains. AgentService.__init__ uses create_ba_mcp_server(). No circular import issues.</done>
</task>

</tasks>

<verification>
1. `python -c "from app.services.mcp_tools import create_ba_mcp_server; server = create_ba_mcp_server(); print(f'MCP server created: {server}')"` -- MCP server creates without error
2. `python -c "from app.services.agent_service import AgentService; a = AgentService(); print(f'AgentService initialized, tools_server={a.tools_server}')"` -- AgentService still initializes correctly with refactored imports
3. `grep -n "claude-agent-sdk" requirements.txt` -- shows >=0.1.35
4. `grep -c "@tool" app/services/mcp_tools.py` -- returns 2 (two tool decorators)
5. `grep -c "@tool" app/services/agent_service.py` -- returns 0 (no inline tools)
6. Existing tests pass: `cd /Users/a1testingmac/projects/XtraSkill/backend && python -m pytest tests/ -x -q --timeout=30 2>&1 | tail -5`
</verification>

<success_criteria>
- requirements.txt specifies claude-agent-sdk>=0.1.35
- mcp_tools.py exists with search_documents_tool, save_artifact_tool, create_ba_mcp_server, and all 4 ContextVars
- agent_service.py has zero @tool decorators and imports everything from mcp_tools
- AgentService initializes successfully with shared MCP server
- No circular imports between mcp_tools.py and agent_service.py
- Existing test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/57-foundation/57-01-SUMMARY.md`
</output>

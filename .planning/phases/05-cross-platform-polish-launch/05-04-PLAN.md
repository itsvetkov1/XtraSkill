---
phase: 05-cross-platform-polish-launch
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - backend/requirements.txt
  - backend/Procfile
  - backend/railway.json
  - backend/render.yaml
  - .github/workflows/flutter-ci.yml
autonomous: true

must_haves:
  truths:
    - Backend can be deployed to Railway or Render with single git push
    - Production server uses Gunicorn with multiple Uvicorn workers
    - CI/CD pipeline runs tests automatically on every push
  artifacts:
    - path: "backend/requirements.txt"
      provides: "Production server dependencies"
      contains: "gunicorn"
    - path: "backend/Procfile"
      provides: "Railway deployment command"
      contains: "gunicorn main:app"
    - path: ".github/workflows/flutter-ci.yml"
      provides: "Automated testing pipeline"
      contains: "flutter test"
      min_lines: 40
  key_links:
    - from: "backend/Procfile"
      to: "Gunicorn + Uvicorn workers"
      via: "Production ASGI server command"
      pattern: "gunicorn.*uvicorn\\.workers"
---

<objective>
Prepare backend for production deployment on PaaS platforms (Railway/Render) with production-grade ASGI server and establish CI/CD pipeline for automated testing.

Purpose: Enable one-command deployment to production infrastructure with proper multi-worker server configuration and automated quality gates to catch regressions before merge.

Output: Deployment configuration files for Railway and Render, production server dependencies, and GitHub Actions workflow running tests on every push.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-cross-platform-polish-launch/05-RESEARCH.md

# Current backend setup
@backend/requirements.txt
@backend/main.py
</context>

<tasks>

<task type="auto">
  <name>Add production server dependencies and deployment configs</name>
  <files>
    backend/requirements.txt
    backend/Procfile
    backend/railway.json
    backend/render.yaml
  </files>
  <action>
    **Update requirements.txt:**
    Add production server dependencies (if not already present):
    ```
    gunicorn==21.2.0
    uvicorn[standard]==0.27.0
    ```

    These enable multi-worker ASGI server for production. Uvicorn[standard] includes performance optimizations (uvloop, httptools).

    **Create Procfile (Railway deployment):**
    ```
    web: gunicorn main:app --workers 4 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT --timeout 120
    ```

    Explanation:
    - `--workers 4`: Multi-core utilization (Railway provides 4 vCPUs on starter plan)
    - `--worker-class uvicorn.workers.UvicornWorker`: Use Uvicorn for async support
    - `--bind 0.0.0.0:$PORT`: Railway provides PORT env var dynamically
    - `--timeout 120`: Allow 2 minutes for AI streaming responses (default 30s too short)

    **Create railway.json (Railway config):**
    ```json
    {
      "$schema": "https://railway.app/railway.schema.json",
      "build": {
        "builder": "NIXPACKS",
        "buildCommand": "pip install -r requirements.txt"
      },
      "deploy": {
        "startCommand": "gunicorn main:app --workers 4 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT --timeout 120",
        "restartPolicyType": "ON_FAILURE",
        "restartPolicyMaxRetries": 3
      }
    }
    ```

    **Create render.yaml (Render deployment):**
    ```yaml
    services:
      - type: web
        name: ba-assistant-backend
        env: python
        buildCommand: pip install -r requirements.txt
        startCommand: gunicorn main:app --workers 4 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT --timeout 120
        envVars:
          - key: ENVIRONMENT
            value: production
          - key: DATABASE_URL
            fromDatabase:
              name: ba-assistant-db
              property: connectionString
          - key: SECRET_KEY
            generateValue: true
          - key: ANTHROPIC_API_KEY
            sync: false  # User must provide via dashboard
          - key: GOOGLE_CLIENT_ID
            sync: false
          - key: GOOGLE_CLIENT_SECRET
            sync: false
          - key: MICROSOFT_CLIENT_ID
            sync: false
          - key: MICROSOFT_CLIENT_SECRET
            sync: false
          - key: BACKEND_URL
            value: https://ba-assistant-backend.onrender.com
          - key: CORS_ORIGINS
            value: https://ba-assistant-frontend.onrender.com

    databases:
      - name: ba-assistant-db
        databaseName: ba_assistant
        user: ba_assistant_user
    ```

    Render.yaml enables infrastructure-as-code deployment. All files should be in backend/ directory.

    Do NOT add .env to git (already in .gitignore). These files configure PaaS deployment, not local dev.
  </action>
  <verify>
    1. Check requirements: `grep "gunicorn" backend/requirements.txt`
    2. Check Procfile: `cat backend/Procfile` (contains gunicorn command)
    3. Check Railway config: `cat backend/railway.json` (valid JSON)
    4. Check Render config: `cat backend/render.yaml` (valid YAML)
    5. Test Procfile locally: `cd backend && gunicorn main:app --workers 2 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000 --timeout 120` (should start)
  </verify>
  <done>
    - gunicorn and uvicorn[standard] added to requirements.txt
    - Procfile created with 4-worker Gunicorn + Uvicorn configuration
    - railway.json created with build/deploy config and restart policy
    - render.yaml created with service definitions and environment variables
    - All configs use --timeout 120 to support AI streaming responses
    - Gunicorn command tested locally and starts successfully
  </done>
</task>

<task type="auto">
  <name>Create GitHub Actions CI/CD workflow</name>
  <files>
    .github/workflows/flutter-ci.yml
  </files>
  <action>
    Create GitHub Actions workflow that runs tests automatically on every push and pull request.

    Create .github/workflows/ directory if it doesn't exist.

    **flutter-ci.yml:**
    ```yaml
    name: Flutter CI/CD

    on:
      push:
        branches: [main, master, develop]
      pull_request:
        branches: [main, master]

    jobs:
      # Backend tests
      backend-test:
        runs-on: ubuntu-latest
        defaults:
          run:
            working-directory: ./backend

        steps:
          - uses: actions/checkout@v4

          - name: Set up Python
            uses: actions/setup-python@v5
            with:
              python-version: '3.11'
              cache: 'pip'

          - name: Install dependencies
            run: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt

          - name: Run backend tests
            run: |
              pytest tests/test_backend_integration.py -v
            env:
              ANTHROPIC_API_KEY: test-key-for-ci

      # Flutter tests
      flutter-test:
        runs-on: ubuntu-latest
        defaults:
          run:
            working-directory: ./frontend

        steps:
          - uses: actions/checkout@v4

          - uses: subosito/flutter-action@v2
            with:
              flutter-version: '3.x'
              channel: 'stable'
              cache: true

          - name: Install dependencies
            run: flutter pub get

          - name: Run widget tests
            run: flutter test test/widget/

          - name: Run integration tests
            run: flutter test test/integration/

          - name: Analyze code
            run: flutter analyze

      # Flutter web build (smoke test)
      flutter-build-web:
        runs-on: ubuntu-latest
        needs: [flutter-test]
        defaults:
          run:
            working-directory: ./frontend

        steps:
          - uses: actions/checkout@v4

          - uses: subosito/flutter-action@v2
            with:
              flutter-version: '3.x'
              channel: 'stable'
              cache: true

          - name: Install dependencies
            run: flutter pub get

          - name: Build web
            run: flutter build web --release
    ```

    This workflow:
    - Runs on pushes to main/master/develop branches
    - Runs on pull requests to main/master
    - Executes backend tests with pytest
    - Executes Flutter widget and integration tests
    - Runs flutter analyze for linting
    - Builds web app as smoke test (ensures no build errors)
    - Uses caching for faster runs (pip cache, Flutter cache)
    - Provides ANTHROPIC_API_KEY env var for tests (mocked, not real)

    GitHub Actions is free for public repos, $0.008/minute for private repos (roughly $5-10/month for active development).

    Do NOT add deployment automation yet (defer to Phase 6 post-launch). This workflow is quality gates only.
  </action>
  <verify>
    1. Check file exists: `ls .github/workflows/flutter-ci.yml`
    2. Validate YAML syntax: `python -c "import yaml; yaml.safe_load(open('.github/workflows/flutter-ci.yml'))"`
    3. Check job names: `grep "jobs:" .github/workflows/flutter-ci.yml`
    4. After commit, go to GitHub Actions tab - workflow should appear
  </verify>
  <done>
    - .github/workflows/flutter-ci.yml created with 3 jobs (backend-test, flutter-test, flutter-build-web)
    - Workflow triggers on push to main/master/develop and PRs to main/master
    - Backend tests run with pytest in backend/ directory
    - Flutter tests run with flutter test in frontend/ directory
    - Flutter analyze checks code quality
    - Web build validates no build errors
    - Caching enabled for pip and Flutter for faster CI runs
    - All jobs use ubuntu-latest runner (free tier compatible)
  </done>
</task>

</tasks>

<verification>
**Deployment Configs:**
1. Check Procfile works locally:
   ```bash
   cd backend
   pip install gunicorn uvicorn[standard]
   gunicorn main:app --workers 2 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000 --timeout 120
   ```
   Expected: Server starts on http://0.0.0.0:8000, accepts requests

2. Validate JSON/YAML syntax:
   ```bash
   python -c "import json; json.load(open('backend/railway.json'))"
   python -c "import yaml; yaml.safe_load(open('backend/render.yaml'))"
   ```
   Expected: No syntax errors

**CI/CD Pipeline:**
1. Commit and push .github/workflows/flutter-ci.yml
2. Go to GitHub â†’ Actions tab
3. Workflow "Flutter CI/CD" appears in list
4. Click on latest run - should see 3 jobs (backend-test, flutter-test, flutter-build-web)
5. All jobs complete successfully (green checkmarks)
6. Total run time: ~3-5 minutes

**Production Readiness:**
1. All tests pass in CI
2. Deployment configs present for 2 PaaS options (Railway and Render)
3. Production server command uses multiple workers
4. Timeout configured for AI streaming (120 seconds)
</verification>

<success_criteria>
- Procfile contains 4-worker Gunicorn command with Uvicorn worker class and 120s timeout
- railway.json and render.yaml provide infrastructure-as-code deployment configs
- GitHub Actions workflow runs on every push and pull request
- CI pipeline executes backend tests, Flutter tests, and build validation
- All CI jobs pass successfully in <5 minutes
- Gunicorn command works locally (tested with 2 workers)
- Deployment configs reference ENVIRONMENT=production and validate_required() checks
</success_criteria>

<output>
After completion, create `.planning/phases/05-cross-platform-polish-launch/05-04-SUMMARY.md`
</output>

---
phase: 57-foundation
plan: 02
type: execute
wave: 2
depends_on: ["57-01"]
files_modified:
  - backend/app/services/llm/base.py
  - backend/app/services/llm/claude_agent_adapter.py
  - backend/app/services/llm/claude_cli_adapter.py
  - backend/app/services/llm/factory.py
  - backend/app/services/llm/__init__.py
  - backend/tests/unit/llm/test_claude_agent_adapter.py
  - backend/tests/unit/llm/test_claude_cli_adapter.py
autonomous: true

must_haves:
  truths:
    - "LLMFactory.create('claude-code-sdk') returns a ClaudeAgentAdapter instance"
    - "LLMFactory.create('claude-code-cli') returns a ClaudeCLIAdapter instance"
    - "LLMFactory.list_providers() includes 'claude-code-sdk' and 'claude-code-cli'"
    - "Both adapter stubs raise NotImplementedError when stream_chat is called"
    - "Both adapters return their correct LLMProvider enum value from the provider property"
  artifacts:
    - path: "backend/app/services/llm/base.py"
      provides: "Extended LLMProvider enum with CLAUDE_CODE_SDK and CLAUDE_CODE_CLI values"
      contains: "CLAUDE_CODE_SDK"
    - path: "backend/app/services/llm/claude_agent_adapter.py"
      provides: "ClaudeAgentAdapter stub implementing LLMAdapter ABC"
      exports: ["ClaudeAgentAdapter"]
    - path: "backend/app/services/llm/claude_cli_adapter.py"
      provides: "ClaudeCLIAdapter stub implementing LLMAdapter ABC"
      exports: ["ClaudeCLIAdapter"]
    - path: "backend/app/services/llm/factory.py"
      provides: "Factory routing for both new providers"
      contains: "CLAUDE_CODE_SDK"
    - path: "backend/tests/unit/llm/test_claude_agent_adapter.py"
      provides: "Unit tests for adapter stub"
    - path: "backend/tests/unit/llm/test_claude_cli_adapter.py"
      provides: "Unit tests for CLI adapter stub"
  key_links:
    - from: "backend/app/services/llm/factory.py"
      to: "backend/app/services/llm/claude_agent_adapter.py"
      via: "import and registry entry"
      pattern: "LLMProvider\\.CLAUDE_CODE_SDK.*ClaudeAgentAdapter"
    - from: "backend/app/services/llm/factory.py"
      to: "backend/app/services/llm/claude_cli_adapter.py"
      via: "import and registry entry"
      pattern: "LLMProvider\\.CLAUDE_CODE_CLI.*ClaudeCLIAdapter"
    - from: "backend/app/services/llm/__init__.py"
      to: "backend/app/services/llm/claude_agent_adapter.py"
      via: "package export"
      pattern: "from \\.claude_agent_adapter import ClaudeAgentAdapter"
---

<objective>
Register "claude-code-sdk" and "claude-code-cli" providers in LLMFactory with adapter stubs.

Purpose: Phase 58 (Agent SDK Adapter) and Phase 59 (CLI Adapter) need factory routing in place before implementing the actual stream_chat logic. This plan creates the adapter stub classes, adds enum values, registers them in the factory, and adds unit tests. The stubs raise NotImplementedError from stream_chat -- actual implementations come in later phases.

Output: Two new adapter files, updated base.py/factory.py/__init__.py, unit tests for both stubs
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/57-foundation/57-01-SUMMARY.md

@backend/app/services/llm/base.py
@backend/app/services/llm/factory.py
@backend/app/services/llm/__init__.py
@backend/app/services/llm/anthropic_adapter.py
@backend/tests/unit/llm/conftest.py
@backend/tests/unit/llm/test_anthropic_adapter.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add provider enum values, create adapter stubs, register in factory</name>
  <files>backend/app/services/llm/base.py, backend/app/services/llm/claude_agent_adapter.py, backend/app/services/llm/claude_cli_adapter.py, backend/app/services/llm/factory.py, backend/app/services/llm/__init__.py</files>
  <action>
1. **base.py** -- Add two new enum values to `LLMProvider`:
   ```python
   class LLMProvider(str, Enum):
       ANTHROPIC = "anthropic"
       GOOGLE = "google"
       DEEPSEEK = "deepseek"
       CLAUDE_CODE_SDK = "claude-code-sdk"
       CLAUDE_CODE_CLI = "claude-code-cli"
   ```

2. **claude_agent_adapter.py** -- Create new file with stub adapter. Follow the same pattern as anthropic_adapter.py:
   ```python
   """
   Claude Agent SDK Adapter (Stub).

   Implements LLMAdapter interface for Claude Agent SDK integration.
   This is a stub — actual stream_chat implementation comes in Phase 58.

   Architecture note (from research PITFALL-04):
   The Agent SDK handles tool execution internally via MCP servers.
   Unlike other adapters where AIService runs an external tool loop,
   this adapter will bypass the manual tool loop. The SDK's agent loop
   calls tools automatically via the MCP server from mcp_tools.py.
   """
   from typing import AsyncGenerator, Dict, Any, List, Optional
   from .base import LLMAdapter, LLMProvider, StreamChunk

   DEFAULT_MODEL = "claude-sonnet-4-5-20250514"

   class ClaudeAgentAdapter(LLMAdapter):
       """
       Claude Agent SDK adapter stub.

       Will translate Agent SDK streaming events (AssistantMessage, StreamEvent,
       ResultMessage) to StreamChunk format. Uses shared MCP tools from
       mcp_tools.py for search_documents and save_artifact.

       Phase 58 will implement the actual stream_chat method.
       """

       def __init__(self, api_key: str, model: Optional[str] = None):
           self._api_key = api_key
           self.model = model or DEFAULT_MODEL

       @property
       def provider(self) -> LLMProvider:
           return LLMProvider.CLAUDE_CODE_SDK

       async def stream_chat(
           self,
           messages: List[Dict[str, Any]],
           system_prompt: str,
           tools: Optional[List[Dict[str, Any]]] = None,
           max_tokens: int = 4096,
       ) -> AsyncGenerator[StreamChunk, None]:
           raise NotImplementedError(
               "ClaudeAgentAdapter.stream_chat not yet implemented. "
               "Implementation planned for Phase 58."
           )
           # Required yield to satisfy async generator type
           yield  # pragma: no cover
   ```

3. **claude_cli_adapter.py** -- Create new file with stub adapter:
   ```python
   """
   Claude Code CLI Subprocess Adapter (Stub).

   Implements LLMAdapter interface for Claude Code CLI subprocess integration.
   This is a stub — actual stream_chat implementation comes in Phase 59.

   Architecture note:
   This adapter will spawn Claude Code CLI as a subprocess with
   --output-format stream-json, parse line-delimited JSON from stdout,
   and translate events to StreamChunk format. Process lifecycle
   management (timeout, cleanup, zombie prevention) is critical.
   """
   from typing import AsyncGenerator, Dict, Any, List, Optional
   from .base import LLMAdapter, LLMProvider, StreamChunk

   DEFAULT_MODEL = "claude-sonnet-4-5-20250929"

   class ClaudeCLIAdapter(LLMAdapter):
       """
       Claude Code CLI subprocess adapter stub.

       Will spawn CLI process, parse JSON stream output, and translate
       to StreamChunk format. Uses shared MCP tools from mcp_tools.py
       via MCP config passed to CLI.

       Phase 59 will implement the actual stream_chat method.
       """

       def __init__(self, api_key: str, model: Optional[str] = None):
           self._api_key = api_key
           self.model = model or DEFAULT_MODEL

       @property
       def provider(self) -> LLMProvider:
           return LLMProvider.CLAUDE_CODE_CLI

       async def stream_chat(
           self,
           messages: List[Dict[str, Any]],
           system_prompt: str,
           tools: Optional[List[Dict[str, Any]]] = None,
           max_tokens: int = 4096,
       ) -> AsyncGenerator[StreamChunk, None]:
           raise NotImplementedError(
               "ClaudeCLIAdapter.stream_chat not yet implemented. "
               "Implementation planned for Phase 59."
           )
           # Required yield to satisfy async generator type
           yield  # pragma: no cover
   ```

4. **factory.py** -- Register both adapters:
   - Add imports: `from .claude_agent_adapter import ClaudeAgentAdapter` and `from .claude_cli_adapter import ClaudeCLIAdapter`
   - Add to `_adapters` dict:
     ```python
     _adapters = {
         LLMProvider.ANTHROPIC: AnthropicAdapter,
         LLMProvider.GOOGLE: GeminiAdapter,
         LLMProvider.DEEPSEEK: DeepSeekAdapter,
         LLMProvider.CLAUDE_CODE_SDK: ClaudeAgentAdapter,
         LLMProvider.CLAUDE_CODE_CLI: ClaudeCLIAdapter,
     }
     ```
   - In `_get_api_key`, add handling for both new providers -- they both use the existing ANTHROPIC_API_KEY since Claude Code uses the same Anthropic API key:
     ```python
     if provider in (LLMProvider.CLAUDE_CODE_SDK, LLMProvider.CLAUDE_CODE_CLI):
         key = settings.anthropic_api_key
         if not key:
             raise ValueError(
                 "ANTHROPIC_API_KEY not configured. "
                 "Claude Code providers require an Anthropic API key."
             )
         return key
     ```
     Add this block BEFORE the final raise at the end of _get_api_key.

5. **__init__.py** -- Add exports for new adapters:
   - Add imports: `from .claude_agent_adapter import ClaudeAgentAdapter` and `from .claude_cli_adapter import ClaudeCLIAdapter`
   - Add to `__all__`: `"ClaudeAgentAdapter"`, `"ClaudeCLIAdapter"`
   - Update module docstring to mention the new adapters
  </action>
  <verify>
Run these commands from `backend/` directory:
1. `python -c "from app.services.llm import LLMProvider; print(LLMProvider.CLAUDE_CODE_SDK.value, LLMProvider.CLAUDE_CODE_CLI.value)"` -- prints "claude-code-sdk claude-code-cli"
2. `python -c "from app.services.llm import LLMFactory; print(LLMFactory.list_providers())"` -- list includes "claude-code-sdk" and "claude-code-cli"
3. `python -c "from app.services.llm import ClaudeAgentAdapter, ClaudeCLIAdapter; a = ClaudeAgentAdapter('key'); c = ClaudeCLIAdapter('key'); print(a.provider.value, c.provider.value)"` -- prints correct provider values
  </verify>
  <done>LLMProvider enum has CLAUDE_CODE_SDK and CLAUDE_CODE_CLI values. Both adapter stub files exist. Factory routes to correct adapter class. Package __init__.py exports both adapters.</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for both adapter stubs</name>
  <files>backend/tests/unit/llm/test_claude_agent_adapter.py, backend/tests/unit/llm/test_claude_cli_adapter.py</files>
  <action>
1. **test_claude_agent_adapter.py** -- Follow the pattern from test_anthropic_adapter.py. Tests:
   - `TestClaudeAgentAdapterInit`:
     - `test_initializes_with_api_key` -- verifies _api_key is stored
     - `test_uses_default_model` -- verifies DEFAULT_MODEL used when none specified
     - `test_uses_custom_model` -- verifies custom model parameter
     - `test_provider_returns_claude_code_sdk` -- verifies provider property returns LLMProvider.CLAUDE_CODE_SDK
   - `TestClaudeAgentAdapterStreamChat`:
     - `test_stream_chat_raises_not_implemented` -- calls stream_chat and asserts NotImplementedError is raised with message containing "Phase 58"
   - `TestClaudeAgentAdapterFactory`:
     - `test_factory_creates_adapter` -- uses LLMFactory.create("claude-code-sdk") with mock settings (anthropic_api_key="test-key") and asserts returned instance is ClaudeAgentAdapter
     - `test_factory_raises_without_api_key` -- with empty anthropic_api_key, asserts ValueError raised

2. **test_claude_cli_adapter.py** -- Same pattern:
   - `TestClaudeCLIAdapterInit`:
     - `test_initializes_with_api_key`
     - `test_uses_default_model`
     - `test_uses_custom_model`
     - `test_provider_returns_claude_code_cli` -- verifies LLMProvider.CLAUDE_CODE_CLI
   - `TestClaudeCLIAdapterStreamChat`:
     - `test_stream_chat_raises_not_implemented` -- message contains "Phase 59"
   - `TestClaudeCLIAdapterFactory`:
     - `test_factory_creates_adapter` -- LLMFactory.create("claude-code-cli") returns ClaudeCLIAdapter
     - `test_factory_raises_without_api_key`

For factory tests, mock `app.config.settings` to control anthropic_api_key. Use `@pytest.mark.asyncio` for async tests. Use the `with pytest.raises(NotImplementedError):` pattern for the stub tests.

Note on testing the NotImplementedError in an async generator: You need to actually iterate the generator to trigger the error:
```python
@pytest.mark.asyncio
async def test_stream_chat_raises_not_implemented(self):
    adapter = ClaudeAgentAdapter(api_key="test-key")
    with pytest.raises(NotImplementedError, match="Phase 58"):
        async for _ in adapter.stream_chat([], "system"):
            pass
```
  </action>
  <verify>
Run: `cd /Users/a1testingmac/projects/XtraSkill/backend && python -m pytest tests/unit/llm/test_claude_agent_adapter.py tests/unit/llm/test_claude_cli_adapter.py -v --timeout=30` -- all tests pass.

Also run full test suite to check no regressions: `python -m pytest tests/ -x -q --timeout=30 2>&1 | tail -10`
  </verify>
  <done>Unit tests exist for both adapter stubs covering init, provider property, stream_chat NotImplementedError, and factory creation. All tests pass. No regressions in existing tests.</done>
</task>

</tasks>

<verification>
1. `python -c "from app.services.llm import LLMFactory; a = LLMFactory.create('claude-code-sdk'); print(type(a).__name__, a.provider.value)"` -- prints "ClaudeAgentAdapter claude-code-sdk"
2. `python -c "from app.services.llm import LLMFactory; a = LLMFactory.create('claude-code-cli'); print(type(a).__name__, a.provider.value)"` -- prints "ClaudeCLIAdapter claude-code-cli"
3. `python -c "from app.services.llm import LLMFactory; providers = LLMFactory.list_providers(); assert 'claude-code-sdk' in providers and 'claude-code-cli' in providers; print(f'Providers: {providers}')"` -- lists all 5 providers
4. `python -m pytest tests/unit/llm/ -v --timeout=30` -- all adapter tests pass (anthropic, gemini, deepseek, claude_agent, claude_cli)
5. `python -m pytest tests/ -x -q --timeout=30` -- full test suite passes (no regressions)
</verification>

<success_criteria>
- LLMProvider enum has CLAUDE_CODE_SDK="claude-code-sdk" and CLAUDE_CODE_CLI="claude-code-cli"
- ClaudeAgentAdapter exists, returns correct provider, raises NotImplementedError from stream_chat
- ClaudeCLIAdapter exists, returns correct provider, raises NotImplementedError from stream_chat
- LLMFactory.create("claude-code-sdk") returns ClaudeAgentAdapter
- LLMFactory.create("claude-code-cli") returns ClaudeCLIAdapter
- Both use ANTHROPIC_API_KEY (Claude Code uses same key)
- Unit tests cover all adapter stubs and factory routing
- Full test suite passes with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/57-foundation/57-02-SUMMARY.md`
</output>

---
phase: 35-transparency-indicators
plan: 03
type: execute
wave: 2
depends_on: [35-02]
files_modified:
  - frontend/lib/models/thread.dart
  - frontend/lib/screens/conversation/widgets/mode_badge.dart
  - frontend/lib/screens/conversation/conversation_screen.dart
  - frontend/lib/providers/conversation_provider.dart
  - frontend/lib/widgets/mode_change_dialog.dart
autonomous: true

must_haves:
  truths:
    - "User sees conversation mode as chip/badge in ConversationScreen AppBar"
    - "User can tap mode badge to open mode change menu"
    - "Mode change shows warning about potential context shift"
    - "Mode persists after app restart (survives refresh)"
  artifacts:
    - path: "frontend/lib/screens/conversation/widgets/mode_badge.dart"
      provides: "Tappable mode chip for AppBar"
      min_lines: 30
    - path: "frontend/lib/widgets/mode_change_dialog.dart"
      provides: "Mode selection dialog with warning"
      min_lines: 50
    - path: "frontend/lib/models/thread.dart"
      provides: "conversationMode field in Thread model"
      contains: "conversationMode"
  key_links:
    - from: "frontend/lib/screens/conversation/conversation_screen.dart"
      to: "frontend/lib/screens/conversation/widgets/mode_badge.dart"
      via: "AppBar actions"
      pattern: "ModeBadge"
    - from: "frontend/lib/providers/conversation_provider.dart"
      to: "PATCH /threads/{id}"
      via: "updateMode method"
      pattern: "_threadService\\.(update|patch)"
---

<objective>
Implement mode indicator badge in AppBar with tap-to-change functionality and persistence.

Purpose: Users need to see which mode their conversation is in and be able to change it. Per PITFALL-07, mode is a thread property that persists.

Output: ModeBadge widget in AppBar, ModeChangeDialog with warning, mode update via API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-transparency-indicators/35-02-SUMMARY.md
@frontend/lib/models/thread.dart
@frontend/lib/screens/conversation/conversation_screen.dart
@frontend/lib/providers/conversation_provider.dart
@frontend/lib/widgets/mode_selector.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Thread model to include conversationMode</name>
  <files>frontend/lib/models/thread.dart</files>
  <action>
Add conversationMode field to Thread model:

```dart
class Thread {
  // ... existing fields ...
  final String? conversationMode; // "meeting" or "document_refinement"

  Thread({
    // ... existing params ...
    this.conversationMode,
  });

  // Add to factory fromJson:
  // conversationMode: json['conversation_mode'] as String?,

  // Add to toJson:
  // if (conversationMode != null) 'conversation_mode': conversationMode,
}
```

Add helper getters for display:
```dart
/// Display name for the mode
String get modeDisplayName {
  switch (conversationMode) {
    case 'meeting':
      return 'Meeting Mode';
    case 'document_refinement':
      return 'Document Refinement';
    default:
      return 'No Mode';
  }
}

/// Icon for the mode
IconData get modeIcon {
  switch (conversationMode) {
    case 'meeting':
      return Icons.groups;
    case 'document_refinement':
      return Icons.edit_document;
    default:
      return Icons.chat_bubble_outline;
  }
}
```
  </action>
  <verify>
flutter analyze frontend/lib/models/thread.dart
grep -n "conversationMode\|conversation_mode" frontend/lib/models/thread.dart
  </verify>
  <done>
Thread model has conversationMode field with JSON serialization and display helpers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ModeBadge widget and ModeChangeDialog</name>
  <files>
    frontend/lib/screens/conversation/widgets/mode_badge.dart
    frontend/lib/widgets/mode_change_dialog.dart
  </files>
  <action>
1. Create ModeBadge widget (mode_badge.dart):

Displays current mode as a tappable chip in the AppBar. Shows icon + short label.

```dart
class ModeBadge extends StatelessWidget {
  final String? mode;
  final VoidCallback onTap;

  // Returns ActionChip with mode icon and label
  // If mode is null, show "Select Mode" with outline style
  // If mode set, show filled chip with mode icon/name
}
```

Style:
- Chip fits in AppBar (compact)
- Icon left of text
- Distinct from rename icon (use ActionChip, not IconButton)

2. Create ModeChangeDialog widget (mode_change_dialog.dart):

Dialog with mode options and context shift warning.

```dart
class ModeChangeDialog extends StatelessWidget {
  final String? currentMode;

  // Returns selected mode string or null if cancelled

  // Structure:
  // - Title: "Change Conversation Mode"
  // - Warning text: "Changing mode may affect how the AI interprets previous messages in this conversation."
  // - RadioListTile for "Meeting Mode" (value: "meeting")
  // - RadioListTile for "Document Refinement" (value: "document_refinement")
  // - Cancel / Confirm buttons
}
```

Per MODE-03: Warning about potential context shift is shown in the dialog.
  </action>
  <verify>
flutter analyze frontend/lib/screens/conversation/widgets/mode_badge.dart
flutter analyze frontend/lib/widgets/mode_change_dialog.dart
grep -n "context shift\|affect" frontend/lib/widgets/mode_change_dialog.dart
  </verify>
  <done>
ModeBadge shows current mode as tappable chip. ModeChangeDialog shows warning and mode options.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add mode update to ConversationProvider and integrate in ConversationScreen</name>
  <files>
    frontend/lib/providers/conversation_provider.dart
    frontend/lib/services/thread_service.dart
    frontend/lib/screens/conversation/conversation_screen.dart
  </files>
  <action>
1. Update ThreadService if needed to support mode update:

The existing PATCH /threads/{id} endpoint should accept conversation_mode. Check if ThreadService.updateThread exists and supports arbitrary fields. If not, add:

```dart
Future<void> updateThreadMode(String threadId, String mode) async {
  await _dio.patch(
    '/threads/$threadId',
    data: {'conversation_mode': mode},
  );
}
```

2. Add updateMode method to ConversationProvider:

```dart
Future<bool> updateMode(String mode) async {
  if (_thread == null) return false;

  try {
    await _threadService.updateThreadMode(_thread!.id, mode);
    // Reload thread to get updated mode
    await loadThread(_thread!.id);
    return true;
  } catch (e) {
    _error = e.toString();
    notifyListeners();
    return false;
  }
}
```

3. Update ConversationScreen:

- Import ModeBadge and ModeChangeDialog
- Add ModeBadge to AppBar actions (before rename icon)
- Implement _showModeChangeDialog method:
  - Show ModeChangeDialog
  - If result is not null and different from current, call provider.updateMode(result)
  - Show error snackbar on failure

- Handle initial mode selection:
  - When user selects mode via ModeSelector on empty conversation, also update thread mode
  - Modify onModeSelected callback in ModeSelector to first update mode, then send message
  </action>
  <verify>
flutter analyze frontend/lib/providers/conversation_provider.dart
flutter analyze frontend/lib/screens/conversation/conversation_screen.dart
grep -n "ModeBadge\|updateMode\|ModeChangeDialog" frontend/lib/screens/conversation/conversation_screen.dart
  </verify>
  <done>
ConversationProvider can update mode. ConversationScreen shows ModeBadge in AppBar with tap-to-change functionality.
  </done>
</task>

</tasks>

<verification>
1. flutter analyze - no errors on all modified files
2. Thread.fromJson parses conversation_mode from API
3. ModeBadge displays in AppBar when thread has mode
4. ModeBadge shows "Select Mode" when thread has no mode
5. Tapping ModeBadge opens ModeChangeDialog with warning text
6. Selecting mode updates via API and refreshes UI
7. Mode persists after navigating away and back (API stores it)
</verification>

<success_criteria>
- MODE-01: Current conversation mode shown as chip/badge in ConversationScreen AppBar
- MODE-02: Mode badge is tappable to open mode change menu
- MODE-03: Mode change shows warning about potential context shift
- MODE-04 (frontend): Mode persists in database for that thread (survives app restart via API)
</success_criteria>

<output>
After completion, create `.planning/phases/35-transparency-indicators/35-03-SUMMARY.md`
</output>

---
phase: 64-conversation-documents
plan: 04
type: execute
wave: 3
depends_on: [64-01, 64-03]
files_modified:
  - frontend/lib/screens/assistant/widgets/assistant_chat_input.dart
  - frontend/lib/screens/assistant/widgets/skill_selector.dart
  - frontend/lib/screens/assistant/widgets/document_attachment_chip.dart
  - frontend/lib/screens/assistant/assistant_chat_screen.dart
  - frontend/lib/services/skill_service.dart
autonomous: true
requirements: [UI-03, UI-04]

must_haves:
  truths:
    - "Attachment button on the left of input opens file picker for document upload"
    - "Skills button (plus-in-square icon) on the right opens a list of available skills"
    - "Selected skill appears as a small colored chip above the text field with X to remove"
    - "Attached files appear as removable chips above the text field"
    - "Enter sends message, Shift+Enter for newline"
    - "Send button grouped with skills button on the right"
    - "Input is multi-line (3-4 lines tall by default)"
  artifacts:
    - path: "frontend/lib/screens/assistant/widgets/assistant_chat_input.dart"
      provides: "Full-featured input bar with attachment, skills, and send"
      contains: "AssistantChatInput"
    - path: "frontend/lib/screens/assistant/widgets/skill_selector.dart"
      provides: "Skill picker popup/sheet"
      contains: "SkillSelector"
    - path: "frontend/lib/screens/assistant/widgets/document_attachment_chip.dart"
      provides: "Removable file chip"
      contains: "DocumentAttachmentChip"
    - path: "frontend/lib/services/skill_service.dart"
      provides: "Backend skill discovery client"
      contains: "SkillService"
  key_links:
    - from: "frontend/lib/screens/assistant/widgets/assistant_chat_input.dart"
      to: "frontend/lib/providers/assistant_conversation_provider.dart"
      via: "Provider for skill/file state"
      pattern: "AssistantConversationProvider"
    - from: "frontend/lib/services/skill_service.dart"
      to: "backend/app/routes/skills.py"
      via: "GET /api/skills HTTP call"
      pattern: "/api/skills"
---

<objective>
Build the full-featured AssistantChatInput widget with file attachment, skill selection, and send controls, replacing the temporary input from Plan 64-03.

Purpose: The Assistant chat input needs to support file attachments (for document upload), skill selection (for prepending Claude Code skills), and the Enter/Shift+Enter keyboard pattern ‚Äî with a specific layout: attachment button on the left, skills button + send button on the right.

Output: AssistantChatInput + SkillSelector + DocumentAttachmentChip + SkillService + integration into AssistantChatScreen
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/64-conversation-documents/64-RESEARCH.md
@.planning/phases/64-conversation-documents/64-03-SUMMARY.md
@frontend/lib/screens/conversation/widgets/chat_input.dart
@frontend/lib/providers/assistant_conversation_provider.dart
@frontend/lib/screens/assistant/assistant_chat_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SkillService and SkillSelector Widget</name>
  <files>
    frontend/lib/services/skill_service.dart
    frontend/lib/screens/assistant/widgets/skill_selector.dart
  </files>
  <action>
**1. Create SkillService** (`frontend/lib/services/skill_service.dart`):

A service that fetches available skills from the backend API:

```dart
class SkillService {
  final Dio _dio;
  List<Skill>? _cachedSkills; // Cache to avoid repeated API calls

  SkillService() : _dio = ApiClient().dio; // Reuse authenticated Dio instance

  Future<List<Skill>> getSkills() async {
    if (_cachedSkills != null) return _cachedSkills!;
    try {
      final response = await _dio.get('/api/skills');
      final List<dynamic> data = response.data;
      _cachedSkills = data.map((json) => Skill.fromJson(json)).toList();
      return _cachedSkills!;
    } catch (e) {
      debugPrint('Failed to load skills: $e');
      return []; // Graceful degradation
    }
  }

  void clearCache() => _cachedSkills = null;
}
```

Use `Skill` model from `assistant_conversation_provider.dart` (or move it to a shared models file if cleaner).

**2. Create SkillSelector widget** (`frontend/lib/screens/assistant/widgets/skill_selector.dart`):

A popup menu (or bottom sheet on mobile) that shows available skills:

- Takes `Function(Skill) onSkillSelected` callback
- Uses `SkillService().getSkills()` to load skills
- Shows loading indicator while fetching (first load only, then cached)
- Each skill shows: name (bold) and description (subtitle) in a ListTile
- If no skills found: show "No skills available" message
- Implementation choice (Claude's discretion): Use `PopupMenuButton` for desktop-like feel, or `showModalBottomSheet` for mobile-friendly. Recommendation: `PopupMenuButton` since this is primarily a web app and matches the icon button pattern.

**PopupMenuButton approach:**
```dart
class SkillSelector extends StatelessWidget {
  final Function(Skill) onSkillSelected;
  final SkillService _skillService = SkillService();

  Widget build(context) {
    return FutureBuilder<List<Skill>>(
      future: _skillService.getSkills(),
      builder: (context, snapshot) {
        return IconButton(
          icon: Icon(Icons.add_box_outlined), // "rugged plus-in-square" per user decision
          tooltip: 'Select skill',
          onPressed: () => _showSkillMenu(context, snapshot.data ?? []),
        );
      },
    );
  }
}
```

Actually, since PopupMenuButton handles its own state, use that directly:
- The icon is `Icons.add_box_outlined` per user decision ("rugged-looking plus-in-a-square icon")
- Each PopupMenuItem shows skill name + description
- On tap: call `onSkillSelected(skill)`, menu closes automatically
- If skills list is empty or loading, show disabled icon with "Loading skills..." tooltip

IMPORTANT: Skills come from `.claude/` directory on the backend. The user sees skill names like "business-analyst" rendered as display names. If the name has hyphens, convert to title case with spaces for display (e.g., "business-analyst" ‚Üí "Business Analyst").
  </action>
  <verify>
Run: `cd /Users/a1testingmac/projects/XtraSkill/frontend && flutter analyze lib/services/skill_service.dart lib/screens/assistant/widgets/skill_selector.dart` ‚Äî should pass with no errors.

Check: `grep 'getSkills\|add_box_outlined\|onSkillSelected' frontend/lib/screens/assistant/widgets/skill_selector.dart` ‚Äî should show skill loading and selection.
  </verify>
  <done>SkillService fetches and caches skills from GET /api/skills. SkillSelector shows popup menu with skill names and descriptions. Plus-in-square icon per user decision. Skills display with human-readable names.</done>
</task>

<task type="auto">
  <name>Task 2: Create AssistantChatInput and Wire into Screen</name>
  <files>
    frontend/lib/screens/assistant/widgets/assistant_chat_input.dart
    frontend/lib/screens/assistant/widgets/document_attachment_chip.dart
    frontend/lib/screens/assistant/assistant_chat_screen.dart
  </files>
  <action>
**1. Create DocumentAttachmentChip** (`frontend/lib/screens/assistant/widgets/document_attachment_chip.dart`):

A small removable chip showing an attached file:
- Parameters: `String filename`, `int fileSize`, `VoidCallback onRemove`
- Renders as a `Chip` or `InputChip` with:
  - Leading icon: file type icon (detect from extension: document, image, code, spreadsheet)
  - Label: filename (truncated to ~20 chars with ellipsis)
  - Delete icon: X button calling `onRemove`
- Compact size (small font, tight padding)

**2. Create AssistantChatInput** (`frontend/lib/screens/assistant/widgets/assistant_chat_input.dart`):

The complete input widget for Assistant chat. Layout per user decision:
```
[Skill chip]  [File chip 1] [File chip 2]  ‚Üê above text field (only if present)
[üìé] [_____text input_____] [üß©] [‚Üí]
 ^              ^              ^    ^
 attach      3-4 lines       skills send
 (left)      multi-line       (right, grouped)
```

**Parameters:**
- `Function(String message) onSend`
- `bool enabled` ‚Äî disable during streaming
- `AssistantConversationProvider provider` ‚Äî for skill/file state

**Implementation:**

a) **Text input:**
   - `TextField` with `maxLines: null`, `minLines: 3` (3-4 lines tall by default)
   - `textInputAction: TextInputAction.none` (prevent system Enter handling)
   - `FocusNode` with `onKeyEvent` for Enter/Shift+Enter (same pattern as existing ChatInput)
   - Enter: send if text is not empty and enabled
   - Shift+Enter: insert newline
   - Placeholder: "Type a message..." (or "Thinking..." when streaming)

b) **Attachment button (left):**
   - `IconButton(icon: Icon(Icons.attach_file))`
   - On tap: open `FilePicker.platform.pickFiles(allowMultiple: true, type: FileType.any)`
   - On files picked: for each file, call `provider.addAttachedFile(AttachedFile(name: file.name, size: file.size, bytes: file.bytes, contentType: file.extension))`
   - Disabled while streaming

c) **Skills button (right, before send):**
   - Use `SkillSelector(onSkillSelected: provider.selectSkill)`
   - Disabled while streaming

d) **Send button (right, after skills):**
   - `IconButton(icon: Icon(Icons.send))`
   - Enabled only when text is not empty AND not streaming
   - On tap: call `onSend(_controller.text)`, clear text, request focus back
   - Color: primary when enabled, disabled when not

e) **Chip display area (above text field):**
   - If `provider.selectedSkill != null`: show a small colored `Chip` with skill name and X to remove
     - Color: `Theme.of(context).colorScheme.secondaryContainer`
     - Label: skill display name (humanized from "business-analyst" ‚Üí "Business Analyst")
     - Delete icon: calls `provider.clearSkill()`
   - If `provider.attachedFiles.isNotEmpty`: show `Wrap` of `DocumentAttachmentChip` widgets
     - Each chip shows filename and remove button
   - Both chip rows in a `Column` above the input row, with subtle divider or spacing

f) **Layout:**
   ```dart
   Column(
     children: [
       // Chips area (conditionally shown)
       if (provider.selectedSkill != null || provider.attachedFiles.isNotEmpty)
         _buildChipsArea(),
       // Input row
       Row(
         crossAxisAlignment: CrossAxisAlignment.end,
         children: [
           _buildAttachButton(),
           Expanded(child: _buildTextField()),
           _buildSkillsButton(),
           _buildSendButton(),
         ],
       ),
     ],
   )
   ```

g) **Decoration:** Wrap in Container with top border (subtle divider from message list), padding 8px horizontal + 8px vertical.

**3. Replace temporary input in AssistantChatScreen:**

In `assistant_chat_screen.dart`, replace the temporary TextField+Send button with `AssistantChatInput`:
- Pass `onSend` callback that calls `provider.sendMessage(text)` and triggers scroll-to-bottom
- Pass `enabled: !provider.isStreaming`
- Pass `provider` for skill and file state access

Also wire the file upload into the send flow:
- When `onSend` is called, if there are attached files, upload each file via the backend API (POST /api/threads/{thread_id}/documents) BEFORE sending the message
- After upload, include the document IDs/names in the message context (or simply send the message ‚Äî the AI will pick up thread documents automatically via the backend)
- Clear attached files after successful send
- Show upload progress if needed (simple ‚Äî just disable send until uploads complete)

IMPORTANT: The actual document upload to backend happens in the provider's sendMessage method or in a pre-send step in the screen. Keep it simple for v1: upload files, then send message. The backend already makes thread documents available to the AI via the document search tool.
  </action>
  <verify>
Run: `cd /Users/a1testingmac/projects/XtraSkill/frontend && flutter analyze lib/screens/assistant/widgets/assistant_chat_input.dart lib/screens/assistant/widgets/document_attachment_chip.dart lib/screens/assistant/assistant_chat_screen.dart` ‚Äî should pass with no errors.

Check: `grep 'attach_file\|add_box_outlined\|Icons.send\|SkillSelector\|DocumentAttachmentChip' frontend/lib/screens/assistant/widgets/assistant_chat_input.dart` ‚Äî should show all control buttons and widget references.

Check layout: `grep 'selectedSkill\|attachedFiles\|onSend\|FocusNode' frontend/lib/screens/assistant/widgets/assistant_chat_input.dart` ‚Äî should show skill/file integration and keyboard handling.
  </verify>
  <done>AssistantChatInput has attachment button (left), multi-line text input, skills button + send button (right). Skill chip and file chips appear above text field. Enter sends, Shift+Enter for newline. Fully integrated into AssistantChatScreen replacing the temporary input.</done>
</task>

</tasks>

<verification>
1. Attachment button opens file picker and selected files appear as chips above input
2. Skills button shows popup with discovered skills from backend
3. Selecting a skill shows chip above input with X to remove
4. File chips can be removed individually
5. Enter sends message, Shift+Enter adds newline
6. Input has 3-4 lines visible by default
7. All controls disabled during streaming
8. Layout matches: attachment left, text center, skills+send right
</verification>

<success_criteria>
- AssistantChatInput has the correct layout per user decision
- Skills discovered from backend API and displayed in popup
- Selected skill shown as chip, cleared after send (one-time use)
- File attachment via file picker with removable chips
- Enter/Shift+Enter keyboard handling works
- Input integrated into AssistantChatScreen
</success_criteria>

<output>
After completion, create `.planning/phases/64-conversation-documents/64-04-SUMMARY.md`
</output>

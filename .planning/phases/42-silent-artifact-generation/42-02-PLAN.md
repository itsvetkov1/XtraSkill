---
phase: 42-silent-artifact-generation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/services/ai_service.dart
  - frontend/lib/providers/conversation_provider.dart
autonomous: true

must_haves:
  truths:
    - "AIService.streamChat accepts optional artifactGeneration parameter"
    - "artifactGeneration flag is sent in the request body to backend"
    - "generateArtifact() is a separate method from sendMessage() on ConversationProvider"
    - "generateArtifact() does NOT add user or assistant messages to _messages list"
    - "generateArtifact() does NOT set _isStreaming or accumulate _streamingText"
    - "generateArtifact() adds artifact to _artifacts list on ArtifactCreatedEvent"
    - "generateArtifact() clears state on artifact_created (not message_complete)"
    - "isGeneratingArtifact and generatingArtifactType getters are available"
    - "retryLastGeneration() replays the last failed silent generation"
    - "cancelGeneration() clears generating state"
    - "clearError() also clears generation-specific error state"
  artifacts:
    - path: "frontend/lib/services/ai_service.dart"
      provides: "streamChat with artifactGeneration parameter"
      contains: "artifactGeneration"
    - path: "frontend/lib/providers/conversation_provider.dart"
      provides: "generateArtifact method, generation state variables, retry/cancel"
      contains: "generateArtifact"
  key_links:
    - from: "ConversationProvider.generateArtifact"
      to: "AIService.streamChat"
      via: "artifactGeneration: true parameter"
      pattern: "artifactGeneration: true"
    - from: "generateArtifact"
      to: "_artifacts.add"
      via: "ArtifactCreatedEvent handler"
      pattern: "ArtifactCreatedEvent"
---

<objective>
Add `artifactGeneration` flag to the frontend AI service and create the separate `generateArtifact()` code path on ConversationProvider.

Purpose: The frontend needs a completely separate code path from `sendMessage()` for button-triggered artifact generation. This avoids state machine conflicts (blank message bubbles, incorrect streaming state) by using dedicated state variables (`_isGeneratingArtifact`, `_generatingArtifactType`) that don't interfere with the normal chat flow. This is the critical architectural change per PITFALL-06.

Output: Modified `ai_service.dart` with optional parameter, modified `conversation_provider.dart` with `generateArtifact()` method, generation state, retry, and cancel.
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@frontend/lib/services/ai_service.dart
@frontend/lib/providers/conversation_provider.dart
@frontend/lib/models/artifact.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add artifactGeneration parameter to AIService.streamChat</name>
  <files>frontend/lib/services/ai_service.dart</files>
  <action>
  Modify `frontend/lib/services/ai_service.dart`:

  1. **streamChat method signature** (line ~111): Add optional named parameter:
     ```dart
     Stream<ChatEvent> streamChat(
       String threadId,
       String message,
       {bool artifactGeneration = false}
     ) async* {
     ```

  2. **Request body** (line ~131): Add the flag to the body map:
     ```dart
     body: {
       'content': message,
       if (artifactGeneration) 'artifact_generation': true,
     },
     ```
     Use collection-if so the field is only included when true, keeping backward compatibility.

  No other changes needed to ai_service.dart. Event parsing remains identical - the backend suppresses text_delta events but the client-side event parsing doesn't need to change (it simply won't receive text_delta events in silent mode).
  </action>
  <verify>
  Run: `cd /Users/a1testingmac/projects/XtraSkill/frontend && grep -n "artifactGeneration" lib/services/ai_service.dart` - should show the parameter and body usage
  </verify>
  <done>
  - streamChat accepts `{bool artifactGeneration = false}` named parameter
  - When true, `artifact_generation: true` is included in the request body
  - When false (default), no extra field is sent (backward compatible)
  - Event parsing is unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Add generateArtifact() method and generation state to ConversationProvider</name>
  <files>frontend/lib/providers/conversation_provider.dart</files>
  <action>
  Modify `frontend/lib/providers/conversation_provider.dart`:

  1. **New state variables** (after `_hasPartialContent` declaration, around line ~61):
     ```dart
     /// Whether artifact is currently being generated silently
     bool _isGeneratingArtifact = false;

     /// Type label for current generation (e.g., "User Stories")
     String? _generatingArtifactType;

     /// Prompt of last generation attempt (for retry)
     String? _lastGenerationPrompt;

     /// Type of last generation attempt (for retry)
     String? _lastGenerationArtifactType;

     /// Whether the last error was from a generation operation
     bool _lastOperationWasGeneration = false;
     ```

  2. **New getters** (after `artifacts` getter, around line ~103):
     ```dart
     /// Whether artifact generation is in progress
     bool get isGeneratingArtifact => _isGeneratingArtifact;

     /// Type of artifact being generated (for label display)
     String? get generatingArtifactType => _generatingArtifactType;

     /// Whether retry is available for a failed generation
     bool get canRetryGeneration => _lastGenerationPrompt != null && _error != null && _lastOperationWasGeneration;

     /// Whether the last error was from generation (for error state display)
     bool get lastOperationWasGeneration => _lastOperationWasGeneration;
     ```

  3. **generateArtifact() method** (after `sendMessage()`, around line ~211):
     ```dart
     /// Generate artifact silently without adding chat messages.
     ///
     /// This is a SEPARATE code path from sendMessage() (PITFALL-06).
     /// It does NOT:
     /// - Add user message to _messages
     /// - Set _isStreaming
     /// - Accumulate _streamingText
     /// - Add assistant message to _messages
     ///
     /// It ONLY:
     /// - Sets _isGeneratingArtifact state
     /// - Listens for ArtifactCreatedEvent to add to _artifacts
     /// - Clears state on completion or error
     Future<void> generateArtifact(String prompt, String artifactType) async {
       if (_thread == null || _isGeneratingArtifact || _isStreaming) return;

       _error = null;
       _lastOperationWasGeneration = true;
       _lastGenerationPrompt = prompt;
       _lastGenerationArtifactType = artifactType;
       _isGeneratingArtifact = true;
       _generatingArtifactType = artifactType;
       notifyListeners();

       try {
         await for (final event in _aiService.streamChat(
           _thread!.id,
           prompt,
           artifactGeneration: true,
         )) {
           if (event is ArtifactCreatedEvent) {
             // Add artifact to list
             _artifacts.add(Artifact.fromEvent(
               id: event.id,
               artifactType: event.artifactType,
               title: event.title,
               threadId: _thread!.id,
             ));
             // Clear generating state immediately when artifact appears (PITFALL-05)
             _isGeneratingArtifact = false;
             _generatingArtifactType = null;
             _lastGenerationPrompt = null; // Success - clear retry data
             _lastGenerationArtifactType = null;
             notifyListeners();
           } else if (event is ErrorEvent) {
             _error = event.message;
             break;
           } else if (event is MessageCompleteEvent) {
             // Stream ended (after artifact_created typically)
             break;
           }
           // Note: TextDeltaEvent and ToolExecutingEvent are suppressed by backend
           // but handle gracefully if they somehow arrive
         }
       } catch (e) {
         _error = e.toString();
       } finally {
         // Ensure state cleared even if error before artifact_created (PITFALL-04)
         _isGeneratingArtifact = false;
         _generatingArtifactType = null;
         notifyListeners();
       }
     }
     ```

  4. **retryLastGeneration() method** (after generateArtifact):
     ```dart
     /// Retry the last failed artifact generation
     void retryLastGeneration() {
       if (_lastGenerationPrompt == null || !_lastOperationWasGeneration) return;

       final prompt = _lastGenerationPrompt!;
       final type = _lastGenerationArtifactType ?? 'Artifact';
       _error = null;
       generateArtifact(prompt, type);
     }
     ```

  5. **cancelGeneration() method** (after retryLastGeneration):
     ```dart
     /// Cancel in-progress artifact generation
     void cancelGeneration() {
       _isGeneratingArtifact = false;
       _generatingArtifactType = null;
       _lastOperationWasGeneration = false;
       _lastGenerationPrompt = null;
       _lastGenerationArtifactType = null;
       _error = null;
       notifyListeners();
     }
     ```

  6. **Update clearConversation()** (around line ~213): Add new state vars to reset:
     ```dart
     void clearConversation() {
       _thread = null;
       _messages = [];
       _artifacts = [];
       _streamingText = '';
       _statusMessage = null;
       _isStreaming = false;
       _error = null;
       _isNotFound = false;
       _loading = false;
       _hasPartialContent = false;
       _isGeneratingArtifact = false;      // NEW
       _generatingArtifactType = null;      // NEW
       _lastGenerationPrompt = null;        // NEW
       _lastGenerationArtifactType = null;  // NEW
       _lastOperationWasGeneration = false; // NEW
       notifyListeners();
     }
     ```

  7. **Update clearError()** (around line ~228): Also clear generation error state:
     ```dart
     void clearError() {
       _error = null;
       _isNotFound = false;
       _lastFailedMessage = null;
       _hasPartialContent = false;
       _streamingText = '';
       _lastOperationWasGeneration = false;  // NEW
       _lastGenerationPrompt = null;         // NEW
       _lastGenerationArtifactType = null;   // NEW
       notifyListeners();
     }
     ```

  8. **Update sendMessage()**: At the start of sendMessage, set `_lastOperationWasGeneration = false` so that error state from normal chat doesn't show generation retry UI:
     ```dart
     Future<void> sendMessage(String content) async {
       if (_thread == null || _isStreaming) return;

       _error = null;
       _lastFailedMessage = content;
       _lastOperationWasGeneration = false;  // NEW - distinguish from generation errors
       // ... rest unchanged
     ```

  **CRITICAL architecture notes:**
  - generateArtifact() MUST NOT set `_isStreaming = true` (would trigger streaming UI)
  - generateArtifact() MUST NOT add to `_messages` (would create blank bubbles)
  - generateArtifact() MUST NOT accumulate `_streamingText` (not used in silent mode)
  - State clears on `ArtifactCreatedEvent` (not `MessageCompleteEvent`) per PITFALL-05
  - Guard at top: `if (_isGeneratingArtifact || _isStreaming) return` prevents concurrent operations
  </action>
  <verify>
  1. Run frontend tests: `cd /Users/a1testingmac/projects/XtraSkill/frontend && flutter test test/unit/providers/conversation_provider_test.dart --reporter compact 2>&1 | tail -20`
  2. Verify compile: `cd /Users/a1testingmac/projects/XtraSkill/frontend && flutter analyze lib/providers/conversation_provider.dart 2>&1 | tail -10`
  3. Verify new method exists: `grep -n "generateArtifact\|isGeneratingArtifact\|retryLastGeneration\|cancelGeneration" /Users/a1testingmac/projects/XtraSkill/frontend/lib/providers/conversation_provider.dart`
  </verify>
  <done>
  - AIService.streamChat accepts `{bool artifactGeneration = false}` parameter
  - ConversationProvider has `generateArtifact(prompt, artifactType)` method
  - generateArtifact is completely separate from sendMessage (no shared streaming state)
  - `_isGeneratingArtifact`, `_generatingArtifactType` state variables exposed via getters
  - State clears on ArtifactCreatedEvent (not MessageCompleteEvent)
  - `retryLastGeneration()` replays last failed prompt
  - `cancelGeneration()` clears all generating state
  - `clearConversation()` and `clearError()` reset new state variables
  - sendMessage sets `_lastOperationWasGeneration = false` to distinguish error sources
  - Existing tests still pass
  </done>
</task>

</tasks>

<verification>
1. AIService.streamChat has artifactGeneration parameter that adds field to request body
2. ConversationProvider.generateArtifact() is separate from sendMessage()
3. generateArtifact() does NOT set _isStreaming, add messages, or accumulate text
4. isGeneratingArtifact getter returns true during generation
5. generatingArtifactType getter returns the typed label
6. canRetryGeneration works for failed generation attempts
7. cancelGeneration clears all state cleanly
8. Existing conversation_provider_test.dart tests pass
9. Flutter analyze shows no errors
</verification>

<success_criteria>
Frontend AI service passes `artifact_generation: true` to backend, and ConversationProvider has a separate `generateArtifact()` code path that manages generation-specific state (`_isGeneratingArtifact`, `_generatingArtifactType`) without interfering with the normal `sendMessage()` chat flow. Retry and cancel mechanisms are available. All existing tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/42-silent-artifact-generation/42-02-SUMMARY.md`
</output>

---
phase: 31-frontend-provider-service-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/test/unit/providers/document_provider_test.dart
  - frontend/test/unit/providers/document_provider_test.mocks.dart
  - frontend/test/unit/providers/thread_provider_test.dart
  - frontend/test/unit/providers/thread_provider_test.mocks.dart
autonomous: true

must_haves:
  truths:
    - "DocumentProvider tests verify document CRUD and upload progress tracking"
    - "ThreadProvider tests verify thread CRUD and search/sort filtering"
    - "Tests verify state changes for loading, error, and success paths"
  artifacts:
    - path: "frontend/test/unit/providers/document_provider_test.dart"
      provides: "DocumentProvider unit tests"
      min_lines: 180
    - path: "frontend/test/unit/providers/thread_provider_test.dart"
      provides: "ThreadProvider unit tests"
      min_lines: 200
  key_links:
    - from: "document_provider_test.dart"
      to: "DocumentProvider"
      via: "MockDocumentService injection"
      pattern: "MockDocumentService"
    - from: "thread_provider_test.dart"
      to: "ThreadProvider"
      via: "MockThreadService injection"
      pattern: "MockThreadService"
---

<objective>
Create unit tests for DocumentProvider and ThreadProvider.

Purpose: Cover FPROV-03 (DocumentsProvider) and FPROV-04 (ThreadsProvider) requirements with isolated unit tests that verify state management, filtering, and sorting logic.

Output: Two test files with mocks that verify CRUD operations, upload progress, search/sort filtering, and error handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-frontend-provider-service-tests/31-RESEARCH.md

# Template for testing pattern
@frontend/test/unit/chats_provider_test.dart

# Source files under test
@frontend/lib/providers/document_provider.dart
@frontend/lib/providers/thread_provider.dart
@frontend/lib/services/document_service.dart
@frontend/lib/services/thread_service.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: DocumentProvider unit tests</name>
  <files>
    frontend/test/unit/providers/document_provider_test.dart
  </files>
  <action>
Create comprehensive unit tests for DocumentProvider following the established pattern.

Use @GenerateNiceMocks([MockSpec<DocumentService>()]) annotation.

Test groups to implement:
1. **Initial State** - empty documents list, no selected document, loading/uploading false, no error, uploadProgress 0
2. **loadDocuments** - sets loading during call, updates documents on success, sets error on failure
3. **uploadDocument** - sets uploading true, tracks upload progress via onSendProgress callback, adds document to beginning of list on success, rethrows error on failure (verify error is set AND rethrown)
4. **selectDocument** - loads document content, sets selectedDocument on success, sets error on failure
5. **clearSelectedDocument** - sets selectedDocument to null
6. **clearError** - clears error
7. **searchDocuments** - returns search results on success, sets error and rethrows on failure (does NOT modify documents list)

For optimistic delete (deleteDocument):
- Test immediate state changes only (document removed from list, selectedDocument cleared if same)
- Skip timer-based undo/commit logic (requires BuildContext)

Test upload progress specifically:
```dart
test('tracks upload progress', () async {
  ProgressCallback? capturedCallback;
  when(mockService.uploadDocument(
    any, any, any,
    onSendProgress: anyNamed('onSendProgress'),
  )).thenAnswer((invocation) async {
    capturedCallback = invocation.namedArguments[#onSendProgress];
    // Simulate progress updates
    capturedCallback?.call(50, 100);
    expect(provider.uploadProgress, equals(0.5));
    capturedCallback?.call(100, 100);
    expect(provider.uploadProgress, equals(1.0));
    return Document(...);
  });
  await provider.uploadDocument('project-1', [1,2,3], 'test.txt');
});
```

Create mock Document objects with required fields (id, filename, projectId, createdAt).
  </action>
  <verify>
Run: `cd frontend && flutter test test/unit/providers/document_provider_test.dart -v`
All tests pass without errors.
  </verify>
  <done>
DocumentProvider has unit test coverage including upload progress tracking.
  </done>
</task>

<task type="auto">
  <name>Task 2: ThreadProvider unit tests</name>
  <files>
    frontend/test/unit/providers/thread_provider_test.dart
  </files>
  <action>
Create comprehensive unit tests for ThreadProvider following the established pattern.

Use @GenerateNiceMocks([MockSpec<ThreadService>()]) annotation.

Test groups to implement:
1. **Initial State** - empty threads list, no selected thread, loading false, no error, empty searchQuery, sortOption = newest
2. **loadThreads** - sets loading during call, updates threads on success, rethrows error on failure
3. **createThread** - adds thread to beginning of list, returns thread on success, rethrows error on failure, passes optional provider parameter
4. **selectThread** - loads thread with messages, sets selectedThread on success, rethrows error on failure
5. **renameThread** - updates thread in list, updates selectedThread if same, returns thread on success, sets error on failure (does NOT rethrow)
6. **clearThreads** - resets all state including search/sort
7. **clearError** - clears error

Search and sort filtering (filteredThreads getter):
8. **setSearchQuery/clearSearch** - updates searchQuery, notifies listeners
9. **setSortOption** - updates sortOption, notifies listeners
10. **filteredThreads** - filters by title containing query (case-insensitive), sorts by newest/oldest/alphabetical

Test filteredThreads specifically:
```dart
group('filteredThreads', () {
  final threads = [
    Thread(id: '1', title: 'Alpha', updatedAt: DateTime(2024, 1, 1)),
    Thread(id: '2', title: 'Beta', updatedAt: DateTime(2024, 1, 3)),
    Thread(id: '3', title: 'Charlie', updatedAt: DateTime(2024, 1, 2)),
  ];

  test('filters by search query case-insensitively', () async {
    // Load threads, set search query 'alpha', verify only Alpha in result
  });

  test('sorts by newest (default)', () async {
    // Verify order: Beta, Charlie, Alpha (by updatedAt desc)
  });

  test('sorts by oldest', () async {
    // Set sortOption to oldest, verify order: Alpha, Charlie, Beta
  });

  test('sorts alphabetically', () async {
    // Set sortOption to alphabetical, verify order: Alpha, Beta, Charlie
  });
});
```

For optimistic delete (deleteThread):
- Test immediate state changes only
- Skip timer-based logic
  </action>
  <verify>
Run: `cd frontend && flutter test test/unit/providers/thread_provider_test.dart -v`
All tests pass without errors.
  </verify>
  <done>
ThreadProvider has unit test coverage including search and sort filtering.
  </done>
</task>

<task type="auto">
  <name>Task 3: Generate mocks and verify</name>
  <files>
    frontend/test/unit/providers/document_provider_test.mocks.dart
    frontend/test/unit/providers/thread_provider_test.mocks.dart
  </files>
  <action>
Run build_runner to generate mock files:

```bash
cd frontend
flutter pub run build_runner build --delete-conflicting-outputs
```

Verify:
1. document_provider_test.mocks.dart exists and contains MockDocumentService class
2. thread_provider_test.mocks.dart exists and contains MockThreadService class
3. Run all tests to confirm mocks work correctly
  </action>
  <verify>
Run: `cd frontend && flutter test test/unit/providers/document_provider_test.dart test/unit/providers/thread_provider_test.dart -v`
All tests pass.
  </verify>
  <done>
Mock files are generated and DocumentProvider/ThreadProvider tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && flutter test test/unit/providers/document_provider_test.dart` - DocumentProvider tests pass
2. `cd frontend && flutter test test/unit/providers/thread_provider_test.dart` - ThreadProvider tests pass
3. Upload progress tracking is tested with simulated callbacks
4. Search and sort filtering is tested with multiple scenarios
5. Tests cover FPROV-03 and FPROV-04 requirements
</verification>

<success_criteria>
- DocumentProvider has unit test coverage with 12+ test cases
- ThreadProvider has unit test coverage with 15+ test cases
- Upload progress callback testing demonstrates proper progress tracking
- filteredThreads getter tested for all three sort options and search filtering
- All tests pass with `flutter test test/unit/providers/`
</success_criteria>

<output>
After completion, create `.planning/phases/31-frontend-provider-service-tests/31-02-SUMMARY.md`
</output>

---
phase: 07-responsive-navigation-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - frontend/lib/main.dart
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Authenticated routes (/home, /projects, /projects/:id, /settings) wrapped in StatefulShellRoute"
    - "Unauthenticated routes (/splash, /login, /auth/callback) remain outside shell"
    - "Sidebar visible on all authenticated screens without page reload"
    - "Navigating between Home, Projects, Settings highlights correct sidebar item"
    - "Deep navigation (e.g., /projects/:id) keeps Projects highlighted"
    - "NavigationProvider loads before MaterialApp (no sidebar flash)"
    - "Browser resize smoothly transitions between mobile/tablet/desktop layouts"
  artifacts:
    - path: "frontend/lib/main.dart"
      provides: "GoRouter with StatefulShellRoute wrapping authenticated routes"
      contains: "StatefulShellRoute.indexedStack"
      min_lines: 150
  key_links:
    - from: "frontend/lib/main.dart"
      to: "frontend/lib/widgets/responsive_scaffold.dart"
      via: "StatefulShellRoute builder"
      pattern: "ResponsiveScaffold"
    - from: "frontend/lib/main.dart"
      to: "frontend/lib/providers/navigation_provider.dart"
      via: "ChangeNotifierProvider in MultiProvider"
      pattern: "NavigationProvider"
    - from: "StatefulShellRoute"
      to: "navigationShell.goBranch"
      via: "onDestinationSelected callback"
      pattern: "goBranch"
---

<objective>
Integrate NavigationProvider and ResponsiveScaffold into main.dart using StatefulShellRoute to wrap all authenticated routes.

Purpose: Enable persistent navigation shell across all authenticated screens, with current location highlighting and seamless responsive transitions.

Output:
- main.dart with NavigationProvider loaded alongside ThemeProvider
- GoRouter refactored with StatefulShellRoute.indexedStack wrapping authenticated routes
- Navigation highlighting working based on current route path
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-responsive-navigation-infrastructure/07-RESEARCH.md
@.planning/phases/07-responsive-navigation-infrastructure/07-01-SUMMARY.md

# Files to modify
@frontend/lib/main.dart

# Files created in Plan 01
@frontend/lib/providers/navigation_provider.dart
@frontend/lib/widgets/responsive_scaffold.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NavigationProvider to main.dart initialization</name>
  <files>frontend/lib/main.dart</files>
  <action>
Update main.dart to load NavigationProvider alongside ThemeProvider:

1. Add import:
   ```dart
   import 'providers/navigation_provider.dart';
   ```

2. In main() function, load NavigationProvider after ThemeProvider:
   ```dart
   final prefs = await SharedPreferences.getInstance();
   final themeProvider = await ThemeProvider.load(prefs);
   final navigationProvider = await NavigationProvider.load(prefs);
   ```

3. Update MyApp constructor to accept navigationProvider:
   ```dart
   class MyApp extends StatefulWidget {
     final ThemeProvider themeProvider;
     final NavigationProvider navigationProvider;

     const MyApp({
       super.key,
       required this.themeProvider,
       required this.navigationProvider,
     });
   ```

4. Update runApp call:
   ```dart
   runApp(MyApp(
     themeProvider: themeProvider,
     navigationProvider: navigationProvider,
   ));
   ```

5. Add NavigationProvider to MultiProvider using ChangeNotifierProvider.value:
   ```dart
   providers: [
     ChangeNotifierProvider.value(value: widget.themeProvider),
     ChangeNotifierProvider.value(value: widget.navigationProvider),
     // ... other providers
   ],
   ```

IMPORTANT: Use ChangeNotifierProvider.value() for NavigationProvider (same as ThemeProvider) to avoid recreation on rebuild.
  </action>
  <verify>
Run `flutter analyze frontend/lib/main.dart` - verify no errors related to NavigationProvider.
Check that both ThemeProvider and NavigationProvider are loaded in main() before runApp.
  </verify>
  <done>
NavigationProvider loads at startup and is available via Provider throughout the app.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor GoRouter to use StatefulShellRoute.indexedStack</name>
  <files>frontend/lib/main.dart</files>
  <action>
Refactor _createRouter to wrap authenticated routes in StatefulShellRoute.indexedStack:

1. Add import for ResponsiveScaffold:
   ```dart
   import 'widgets/responsive_scaffold.dart';
   ```

2. Create helper function to derive selected index from path:
   ```dart
   int _getSelectedIndex(String path) {
     if (path.startsWith('/home')) return 0;
     if (path.startsWith('/projects')) return 1;
     if (path.startsWith('/settings')) return 2;
     return 0; // Default to home
   }
   ```

3. Replace flat authenticated routes with StatefulShellRoute.indexedStack:
   ```dart
   GoRouter(
     initialLocation: '/splash',
     redirect: (context, state) {
       // Keep existing redirect logic unchanged
     },
     routes: [
       // Unauthenticated routes OUTSIDE shell
       GoRoute(
         path: '/splash',
         builder: (context, state) => const SplashScreen(),
       ),
       GoRoute(
         path: '/login',
         builder: (context, state) => const LoginScreen(),
       ),
       GoRoute(
         path: '/auth/callback',
         builder: (context, state) => const CallbackScreen(),
       ),

       // Authenticated routes INSIDE shell
       StatefulShellRoute.indexedStack(
         builder: (context, state, navigationShell) {
           // Derive index from path for proper highlighting on nested routes
           final selectedIndex = _getSelectedIndex(state.uri.path);
           return ResponsiveScaffold(
             currentIndex: selectedIndex,
             onDestinationSelected: (index) {
               navigationShell.goBranch(
                 index,
                 // If tapping current branch, go to initial location
                 initialLocation: index == navigationShell.currentIndex,
               );
             },
             child: navigationShell,
           );
         },
         branches: [
           // Branch 0: Home
           StatefulShellBranch(
             routes: [
               GoRoute(
                 path: '/home',
                 builder: (context, state) => const HomeContent(),
               ),
             ],
           ),
           // Branch 1: Projects
           StatefulShellBranch(
             routes: [
               GoRoute(
                 path: '/projects',
                 builder: (context, state) => const ProjectListScreen(),
                 routes: [
                   GoRoute(
                     path: ':id',
                     builder: (context, state) {
                       final id = state.pathParameters['id']!;
                       return ProjectDetailScreen(projectId: id);
                     },
                   ),
                 ],
               ),
             ],
           ),
           // Branch 2: Settings
           StatefulShellBranch(
             routes: [
               GoRoute(
                 path: '/settings',
                 builder: (context, state) => const SettingsScreen(),
               ),
             ],
           ),
         ],
       ),
     ],
     refreshListenable: authProvider,
   );
   ```

4. Create HomeContent widget (extract content from HomeScreen without its navigation):
   Add this private widget in main.dart OR update HomeScreen to export a content-only version.

   For simplicity, create a minimal HomeContent inline that reuses _HomeContent from home_screen.dart:
   ```dart
   // HomeContent is just the content without the ResponsiveLayout/Scaffold wrapper
   // We'll update home_screen.dart in Plan 03 to export this properly
   ```

   ALTERNATIVELY (simpler approach): Keep HomeScreen as-is for now - the StatefulShellRoute will wrap it. The redundant scaffold nesting will be cleaned up in Plan 03.

CRITICAL: The `state.uri.path` in the builder gives us the current location for proper highlighting. Using `navigationShell.currentIndex` alone would NOT highlight Projects when on /projects/:id.

PITFALL AVOIDANCE: Do NOT use `router.location` - it was removed in go_router 9.0. Use `state.uri.path` from the GoRouterState passed to the builder.
  </action>
  <verify>
Run `flutter analyze frontend/lib/main.dart` - no errors.
Run `flutter run -d chrome` and verify:
1. Navigate to /home - Home is highlighted in sidebar
2. Navigate to /projects - Projects is highlighted
3. Navigate to /projects/some-id - Projects remains highlighted
4. Navigate to /settings - Settings is highlighted
5. Resize browser window - navigation smoothly transitions between rail and drawer
  </verify>
  <done>
GoRouter uses StatefulShellRoute.indexedStack, authenticated routes share ResponsiveScaffold shell, navigation highlighting works for both root and nested routes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix any nested Scaffold conflicts</name>
  <files>frontend/lib/main.dart</files>
  <action>
After Task 2, test for nested Scaffold issues. The StatefulShellRoute wraps content in ResponsiveScaffold (which has its own Scaffold for mobile). If individual screens also have Scaffold, this can cause:
- Double AppBars on mobile
- Drawer not opening properly

DIAGNOSTIC: Run the app and check:
1. Mobile view: Is there double AppBar?
2. Does hamburger menu work?

IF ISSUES FOUND:
- The proper fix is in Plan 03 (screen refactoring)
- For now, update ResponsiveScaffold's mobile layout to NOT include Scaffold/AppBar if the child already provides one
- OR add a flag to ResponsiveScaffold: `showMobileAppBar: false`

IF NO ISSUES:
- Document that screens will be refactored in Plan 03 to remove their Scaffolds
- The current state works because child screens' Scaffolds render inside the shell

LIKELY SCENARIO: The nested Scaffolds will work but look wrong (double AppBar). This is acceptable for Plan 02 - Plan 03 handles cleanup.

Document findings in the SUMMARY.md for Plan 03 to address.
  </action>
  <verify>
Run app on mobile viewport (Chrome DevTools, 375px width).
Verify app does not crash due to Scaffold conflicts.
Note any visual issues (double AppBar, drawer issues) for Plan 03.
  </verify>
  <done>
App runs without crashes on mobile viewport. Any visual issues documented for Plan 03 cleanup.
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze frontend/lib/main.dart` - no errors
2. App runs: `flutter run -d chrome`
3. Sidebar visible on /home, /projects, /projects/:id, /settings
4. Sidebar NOT visible on /splash, /login, /auth/callback
5. Navigation highlighting correct for all routes including nested /projects/:id
6. Browser resize transitions navigation mode smoothly
7. Mobile hamburger menu opens drawer
</verification>

<success_criteria>
1. NavigationProvider integrated into main.dart MultiProvider
2. GoRouter uses StatefulShellRoute.indexedStack for authenticated routes
3. ResponsiveScaffold renders as shell for all authenticated screens
4. Navigation highlighting works for root and nested routes
5. No crashes on any viewport size
6. Auth redirect logic unchanged (splash/login/callback still work)
</success_criteria>

<output>
After completion, create `.planning/phases/07-responsive-navigation-infrastructure/07-02-SUMMARY.md`
</output>

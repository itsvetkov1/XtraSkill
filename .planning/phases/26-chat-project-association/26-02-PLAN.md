---
phase: 26-chat-project-association
plan: 02
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - frontend/lib/services/thread_service.dart
  - frontend/lib/providers/conversation_provider.dart
  - frontend/lib/screens/conversation/conversation_screen.dart
  - frontend/lib/screens/conversation/widgets/add_to_project_button.dart
  - frontend/lib/widgets/project_picker_dialog.dart
autonomous: false

must_haves:
  truths:
    - "Project-less chat shows Add to Project button in toolbar area"
    - "Project-less chat has Add to Project option in menu"
    - "Clicking Add to Project opens project picker modal"
    - "Selecting project shows confirmation dialog"
    - "Confirming association updates header in-place"
    - "Associated chats hide Add to Project UI elements"
  artifacts:
    - path: "frontend/lib/services/thread_service.dart"
      provides: "associateWithProject method"
      contains: "associateWithProject"
    - path: "frontend/lib/providers/conversation_provider.dart"
      provides: "associateWithProject method"
      contains: "associateWithProject"
    - path: "frontend/lib/screens/conversation/conversation_screen.dart"
      provides: "Options menu and toolbar integration"
      contains: "PopupMenuButton"
    - path: "frontend/lib/screens/conversation/widgets/add_to_project_button.dart"
      provides: "Toolbar button widget"
      min_lines: 20
    - path: "frontend/lib/widgets/project_picker_dialog.dart"
      provides: "Project selection modal with confirmation"
      min_lines: 50
  key_links:
    - from: "ConversationScreen"
      to: "ProjectPickerDialog"
      via: "showDialog on button/menu tap"
      pattern: "showDialog.*ProjectPickerDialog"
    - from: "ConversationProvider.associateWithProject"
      to: "ThreadService.associateWithProject"
      via: "service method call"
      pattern: "_threadService\\.associateWithProject"
    - from: "ThreadService.associateWithProject"
      to: "PATCH /api/threads/{id}"
      via: "HTTP PATCH request"
      pattern: "_dio\\.patch.*threads"
---

<objective>
Build frontend UI for associating project-less chats with projects: toolbar button, options menu item, project picker modal, and confirmation dialog.

Purpose: Enable users to add project-less chats to projects via dual entry points (toolbar button and options menu) with confirmation flow.

Output: New widgets (AddToProjectButton, ProjectPickerDialog), updated ConversationScreen with menu and toolbar, service/provider methods.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-chat-project-association/26-CONTEXT.md
@.planning/phases/26-chat-project-association/26-RESEARCH.md
@.planning/phases/26-chat-project-association/26-01-SUMMARY.md

@frontend/lib/services/thread_service.dart
@frontend/lib/providers/conversation_provider.dart
@frontend/lib/providers/project_provider.dart
@frontend/lib/screens/conversation/conversation_screen.dart
@frontend/lib/widgets/delete_confirmation_dialog.dart
@frontend/lib/models/project.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add service and provider methods</name>
  <files>frontend/lib/services/thread_service.dart, frontend/lib/providers/conversation_provider.dart</files>
  <action>
**ThreadService** - Add associateWithProject method:

```dart
/// Associate a project-less thread with a project
///
/// [threadId] - ID of the thread to associate
/// [projectId] - ID of the project to associate with
///
/// Returns updated Thread object
/// Throws exception if thread already has project (400) or project not found (404)
Future<Thread> associateWithProject(String threadId, String projectId) async {
  try {
    final headers = await _getAuthHeaders();
    final response = await _dio.patch(
      '$_baseUrl/api/threads/$threadId',
      options: Options(headers: headers),
      data: {'project_id': projectId},
    );

    return Thread.fromJson(response.data as Map<String, dynamic>);
  } on DioException catch (e) {
    if (e.response?.statusCode == 401 || e.response?.statusCode == 403) {
      throw Exception('Authentication required');
    } else if (e.response?.statusCode == 400) {
      throw Exception('Thread already associated with a project');
    } else if (e.response?.statusCode == 404) {
      throw Exception('Thread or project not found');
    }
    throw Exception('Failed to associate thread: ${e.message}');
  }
}
```

**ConversationProvider** - Add associateWithProject method:

```dart
/// Associate current thread with a project
///
/// Returns true on success, false on failure.
/// On success, reloads thread to update UI state.
/// On failure, sets error message.
Future<bool> associateWithProject(String projectId) async {
  if (_thread == null) return false;

  try {
    await _threadService.associateWithProject(_thread!.id, projectId);
    // Reload thread to get updated project info
    await loadThread(_thread!.id);
    return true;
  } catch (e) {
    _error = e.toString();
    notifyListeners();
    return false;
  }
}
```
  </action>
  <verify>
Run `flutter analyze` - no errors in thread_service.dart or conversation_provider.dart
  </verify>
  <done>
ThreadService has associateWithProject(threadId, projectId) method calling PATCH /api/threads/{id}.
ConversationProvider has associateWithProject(projectId) method that calls service and reloads thread.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AddToProjectButton and ProjectPickerDialog widgets</name>
  <files>frontend/lib/screens/conversation/widgets/add_to_project_button.dart, frontend/lib/widgets/project_picker_dialog.dart</files>
  <action>
**AddToProjectButton** - Create new widget at `frontend/lib/screens/conversation/widgets/add_to_project_button.dart`:

```dart
/// Button to add current chat to a project.
library;

import 'package:flutter/material.dart';

/// Toolbar button for adding chat to project
///
/// Displays icon + "Add to Project" label.
/// Only shown for project-less chats.
class AddToProjectButton extends StatelessWidget {
  /// Callback when button is pressed
  final VoidCallback onPressed;

  const AddToProjectButton({
    super.key,
    required this.onPressed,
  });

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 8),
      child: TextButton.icon(
        icon: const Icon(Icons.folder_open_outlined, size: 18),
        label: const Text('Add to Project'),
        style: TextButton.styleFrom(
          foregroundColor: Theme.of(context).colorScheme.primary,
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
        ),
        onPressed: onPressed,
      ),
    );
  }
}
```

**ProjectPickerDialog** - Create new widget at `frontend/lib/widgets/project_picker_dialog.dart`:

```dart
/// Project picker dialog for associating chats with projects.
library;

import 'package:flutter/material.dart';
import 'package:provider/provider.dart';

import '../models/project.dart';
import '../providers/project_provider.dart';

/// Dialog for selecting a project to associate chat with
///
/// Shows loading indicator while fetching projects.
/// After selection, shows confirmation dialog.
/// Returns selected Project or null if cancelled.
class ProjectPickerDialog extends StatefulWidget {
  const ProjectPickerDialog({super.key});

  @override
  State<ProjectPickerDialog> createState() => _ProjectPickerDialogState();
}

class _ProjectPickerDialogState extends State<ProjectPickerDialog> {
  @override
  void initState() {
    super.initState();
    // Load projects when dialog opens
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.read<ProjectProvider>().loadProjects();
    });
  }

  Future<void> _selectProject(Project project) async {
    // Show confirmation dialog
    final confirmed = await showDialog<bool>(
      context: context,
      builder: (dialogContext) => AlertDialog(
        title: Text('Add to "${project.name}"?'),
        content: const Text('This chat will be permanently added to this project.'),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(dialogContext).pop(false),
            child: const Text('Cancel'),
          ),
          TextButton(
            onPressed: () => Navigator.of(dialogContext).pop(true),
            child: const Text('Confirm'),
          ),
        ],
      ),
    );

    if (confirmed == true && mounted) {
      Navigator.of(context).pop(project);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      child: ConstrainedBox(
        constraints: const BoxConstraints(maxWidth: 400, maxHeight: 500),
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Header
              Row(
                children: [
                  const Icon(Icons.folder_outlined),
                  const SizedBox(width: 8),
                  Text(
                    'Select Project',
                    style: Theme.of(context).textTheme.titleLarge,
                  ),
                  const Spacer(),
                  IconButton(
                    icon: const Icon(Icons.close),
                    onPressed: () => Navigator.of(context).pop(),
                  ),
                ],
              ),
              const Divider(),

              // Project list
              Flexible(
                child: Consumer<ProjectProvider>(
                  builder: (context, provider, child) {
                    if (provider.isLoading) {
                      return const Center(
                        child: Padding(
                          padding: EdgeInsets.all(32),
                          child: CircularProgressIndicator(),
                        ),
                      );
                    }

                    if (provider.error != null) {
                      return Center(
                        child: Column(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Icon(
                              Icons.error_outline,
                              size: 48,
                              color: Theme.of(context).colorScheme.error,
                            ),
                            const SizedBox(height: 8),
                            Text(provider.error!),
                            TextButton(
                              onPressed: () => provider.loadProjects(),
                              child: const Text('Retry'),
                            ),
                          ],
                        ),
                      );
                    }

                    final projects = provider.projects;

                    if (projects.isEmpty) {
                      return const Center(
                        child: Padding(
                          padding: EdgeInsets.all(32),
                          child: Column(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              Icon(Icons.folder_off_outlined, size: 48),
                              SizedBox(height: 8),
                              Text('No projects yet'),
                              SizedBox(height: 4),
                              Text(
                                'Create a project first to organize your chats.',
                                textAlign: TextAlign.center,
                              ),
                            ],
                          ),
                        ),
                      );
                    }

                    return ListView.builder(
                      shrinkWrap: true,
                      itemCount: projects.length,
                      itemBuilder: (context, index) {
                        final project = projects[index];
                        return ListTile(
                          leading: const Icon(Icons.folder_outlined),
                          title: Text(project.name),
                          subtitle: project.description != null
                              ? Text(
                                  project.description!,
                                  maxLines: 1,
                                  overflow: TextOverflow.ellipsis,
                                )
                              : null,
                          onTap: () => _selectProject(project),
                        );
                      },
                    );
                  },
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
```
  </action>
  <verify>
Run `flutter analyze` - no errors in new widget files
  </verify>
  <done>
AddToProjectButton widget created with icon + label, styled consistently.
ProjectPickerDialog created with project list, loading state, error handling, empty state, and confirmation flow.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate into ConversationScreen</name>
  <files>frontend/lib/screens/conversation/conversation_screen.dart</files>
  <action>
Update ConversationScreen to add:
1. Options menu (PopupMenuButton) in AppBar actions
2. Toolbar button row between ProviderIndicator and ChatInput
3. Handler method for association flow

**Add imports:**
```dart
import 'package:provider/provider.dart';
import '../../providers/project_provider.dart';
import '../../widgets/project_picker_dialog.dart';
import 'widgets/add_to_project_button.dart';
```

**Add method to show project picker and handle association:**
```dart
/// Show project picker and handle association
Future<void> _showAddToProjectDialog() async {
  final selectedProject = await showDialog<Project>(
    context: context,
    builder: (dialogContext) => const ProjectPickerDialog(),
  );

  if (selectedProject != null && mounted) {
    final provider = context.read<ConversationProvider>();
    final success = await provider.associateWithProject(selectedProject.id);

    if (!success && mounted) {
      // Show error snackbar with retry
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(provider.error ?? 'Failed to add to project'),
          action: SnackBarAction(
            label: 'Retry',
            onPressed: _showAddToProjectDialog,
          ),
        ),
      );
    }
    // Success: header updates in-place via loadThread() (no snackbar per CONTEXT.md)
  }
}
```

**Update AppBar actions to include PopupMenuButton:**
Replace the current actions list:
```dart
actions: [
  IconButton(
    icon: const Icon(Icons.edit_outlined),
    tooltip: 'Rename conversation',
    onPressed: provider.thread != null ? _showRenameDialog : null,
  ),
  // Add PopupMenuButton with "Add to Project" option
  PopupMenuButton<String>(
    icon: const Icon(Icons.more_vert),
    tooltip: 'More options',
    onSelected: (value) {
      if (value == 'add_to_project') {
        _showAddToProjectDialog();
      }
    },
    itemBuilder: (context) => [
      // Only show for project-less threads
      if (provider.thread != null && !provider.thread!.hasProject)
        const PopupMenuItem<String>(
          value: 'add_to_project',
          child: Row(
            children: [
              Icon(Icons.folder_open_outlined, size: 20),
              SizedBox(width: 12),
              Text('Add to Project'),
            ],
          ),
        ),
    ],
  ),
],
```

**Add toolbar row in body Column between ProviderIndicator and ChatInput:**

Find the Column children in the body and modify to add a Row containing both ProviderIndicator and AddToProjectButton:

```dart
body: Column(
  children: [
    // Error banner (existing)
    if (provider.error != null)
      MaterialBanner(...),

    // Message list (existing)
    Expanded(
      child: _buildMessageList(provider),
    ),

    // Toolbar row: Provider indicator + Add to Project button
    Row(
      children: [
        // Provider indicator (existing, wrapped)
        ProviderIndicator(
          provider: provider.thread?.modelProvider,
        ),
        const Spacer(),
        // Add to Project button (only for project-less threads)
        if (provider.thread != null && !provider.thread!.hasProject)
          AddToProjectButton(
            onPressed: _showAddToProjectDialog,
          ),
      ],
    ),

    // Chat input (existing)
    ChatInput(
      onSend: provider.sendMessage,
      enabled: !provider.isStreaming,
    ),
  ],
),
```

Note: Import Project model for the dialog result type:
```dart
import '../../models/project.dart';
```
  </action>
  <verify>
1. Run `flutter analyze` - no errors
2. Run the app and navigate to a project-less chat
3. Verify toolbar shows "Add to Project" button next to provider indicator
4. Verify options menu (three dots) shows "Add to Project" option
5. Verify associated chats hide both button and menu option
  </verify>
  <done>
ConversationScreen has PopupMenuButton with "Add to Project" option for project-less threads.
Toolbar row shows AddToProjectButton next to ProviderIndicator for project-less threads.
Both entry points call _showAddToProjectDialog which shows ProjectPickerDialog.
Association updates header in-place, errors show snackbar with retry.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete chat-to-project association flow:
- Toolbar button "Add to Project" appears for project-less chats
- Options menu has "Add to Project" item for project-less chats
- Project picker modal shows user's projects
- Confirmation dialog asks "Add to [Project]?"
- After confirmation, header updates to show project name
- Button and menu item disappear after association
  </what-built>
  <how-to-verify>
1. Start backend: `cd backend && python run.py`
2. Start frontend: `cd frontend && flutter run -d chrome`
3. Login and create a new project-less chat from Home or Chats section
4. Verify "Add to Project" button appears in toolbar (next to LLM indicator)
5. Verify three-dot menu shows "Add to Project" option
6. Click either entry point -> project picker modal appears
7. Select a project -> confirmation dialog appears
8. Click Confirm -> header updates, button/menu option disappear
9. Refresh page -> chat still shows project association (persistent)
10. Navigate to Projects -> associated chat appears in project's thread list
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
## Full Flow Verification

1. Project-less chat shows "Add to Project" button in toolbar
2. Project-less chat shows "Add to Project" in options menu
3. Chats with projects hide both UI elements
4. Project picker loads projects on open
5. Empty state shown if no projects
6. Selecting project shows confirmation with project name
7. Confirming triggers API call and refreshes thread
8. Error shows snackbar with retry option
9. Associated chat visible in both Chats menu and project thread list
</verification>

<success_criteria>
- CHATS-08: Chat detail shows project or "No Project" with add button - SATISFIED
- CHATS-09: Add to Project button in header - SATISFIED (toolbar area)
- CHATS-10: Add to Project in options menu - SATISFIED
- CHATS-11: Project selection modal - SATISFIED
- CHATS-12: After association, chat in project's list - SATISFIED (via backend)
- CHATS-13: Association is permanent - SATISFIED (one-way, backend enforced)
</success_criteria>

<output>
After completion, create `.planning/phases/26-chat-project-association/26-02-SUMMARY.md`
</output>

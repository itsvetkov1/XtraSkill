# Phase 4.1 Research: Agent SDK & Business-Analyst Skill Integration

**Project:** BA Assistant
**Researched:** 2026-01-25
**Overall confidence:** HIGH

## Executive Summary

The Claude Agent SDK (`claude-agent-sdk`) provides a production-ready framework for building AI agents with built-in tool execution, context management, and streaming support. It offers significant advantages over direct Anthropic API usage for this use case, including automatic tool handling, session management, and native skill/CLAUDE.md integration.

**Key finding:** The SDK is well-suited for integrating the business-analyst skill, but requires careful consideration of the SSE streaming architecture and skill loading configuration. The migration from direct `anthropic.AsyncAnthropic` to the Agent SDK is feasible but requires architectural changes to the `AIService` class.

## Research Questions Answered

### 1. Installation & Package Details

**Confidence:** HIGH (verified via official docs)

```bash
pip install claude-agent-sdk
```

**Requirements:**
- Python 3.10+
- Node.js (Claude Code CLI is bundled with the package)
- API key via `ANTHROPIC_API_KEY` environment variable

**Current version:** As of January 2026, package is actively maintained with recent releases.

**Source:** [PyPI - claude-agent-sdk](https://pypi.org/project/claude-agent-sdk/), [Official Docs](https://platform.claude.com/docs/en/agent-sdk/overview)

### 2. query() Function API

**Confidence:** HIGH (verified via official docs)

```python
async def query(
    *,
    prompt: str | AsyncIterable[dict[str, Any]],
    options: ClaudeAgentOptions | None = None
) -> AsyncIterator[Message]
```

**Key parameters in `ClaudeAgentOptions`:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `system_prompt` | `str \| SystemPromptPreset` | Custom or preset system prompt |
| `allowed_tools` | `list[str]` | List of allowed tool names |
| `mcp_servers` | `dict[str, McpServerConfig]` | MCP server configurations |
| `permission_mode` | `PermissionMode` | Tool permission handling |
| `cwd` | `str \| Path` | Working directory |
| `setting_sources` | `list[SettingSource]` | Which settings to load (`"user"`, `"project"`, `"local"`) |
| `hooks` | `dict[HookEvent, list[HookMatcher]]` | Lifecycle hooks |
| `include_partial_messages` | `bool` | Enable streaming deltas |
| `model` | `str` | Claude model to use |

**Source:** [Python SDK Reference](https://platform.claude.com/docs/en/agent-sdk/python)

### 3. Custom Tool Definition

**Confidence:** HIGH (verified via official docs)

The SDK provides the `@tool` decorator for defining custom tools:

```python
from claude_agent_sdk import tool, create_sdk_mcp_server
from typing import Any

@tool("search_documents", "Search project documents for relevant information", {
    "query": str
})
async def search_documents(args: dict[str, Any]) -> dict[str, Any]:
    query = args["query"]
    results = await document_search_service.search(query)
    return {
        "content": [{
            "type": "text",
            "text": f"Found {len(results)} documents: {results}"
        }]
    }

@tool("save_artifact", "Save a business analysis artifact", {
    "artifact_type": str,
    "title": str,
    "content_markdown": str
})
async def save_artifact(args: dict[str, Any]) -> dict[str, Any]:
    # Save artifact logic
    return {
        "content": [{
            "type": "text",
            "text": f"Artifact saved: {args['title']}"
        }]
    }

# Create MCP server with tools
my_tools_server = create_sdk_mcp_server(
    name="ba-tools",
    version="1.0.0",
    tools=[search_documents, save_artifact]
)

# Use in query
options = ClaudeAgentOptions(
    mcp_servers={"ba": my_tools_server},
    allowed_tools=["mcp__ba__search_documents", "mcp__ba__save_artifact"]
)
```

**Benefits of SDK tool approach:**
- No subprocess overhead (in-process execution)
- Type-safe Python integration
- Simpler than manual tool loop

**Source:** [Python SDK Reference - tool()](https://platform.claude.com/docs/en/agent-sdk/python)

### 4. Streaming Response Handling

**Confidence:** HIGH (verified via official docs)

The SDK streams messages via async iteration:

```python
from claude_agent_sdk import (
    query,
    ClaudeAgentOptions,
    AssistantMessage,
    TextBlock,
    ToolUseBlock,
    ToolResultBlock,
    ResultMessage
)

async for message in query(prompt="...", options=options):
    if isinstance(message, AssistantMessage):
        for block in message.content:
            if isinstance(block, TextBlock):
                # Stream text to client
                yield {"event": "text_delta", "data": block.text}
            elif isinstance(block, ToolUseBlock):
                # Tool being called
                yield {"event": "tool_executing", "data": block.name}
            elif isinstance(block, ToolResultBlock):
                # Tool completed
                pass
    elif isinstance(message, ResultMessage):
        # Final result
        yield {"event": "message_complete", "data": message.result}
```

**For finer-grained streaming:**
```python
options = ClaudeAgentOptions(
    include_partial_messages=True  # Enables StreamEvent messages
)
```

**Key consideration:** TextBlock content may only be delivered once fully available, which can cause "chunky" delivery patterns.

**Source:** [Streaming documentation](https://platform.claude.com/docs/en/build-with-claude/streaming)

### 5. FastAPI/Async Web Backend Compatibility

**Confidence:** HIGH

The SDK is fully async and compatible with FastAPI:

```python
from fastapi import FastAPI
from fastapi.responses import StreamingResponse
from claude_agent_sdk import query, ClaudeAgentOptions
import json

app = FastAPI()

async def stream_agent_response(prompt: str, project_id: str):
    options = ClaudeAgentOptions(
        allowed_tools=["mcp__ba__search_documents", "mcp__ba__save_artifact"],
        permission_mode="acceptEdits"
    )

    async for message in query(prompt=prompt, options=options):
        # Format as SSE
        yield f"data: {json.dumps(format_message(message))}\n\n"

@app.post("/api/chat")
async def chat(request: ChatRequest):
    return StreamingResponse(
        stream_agent_response(request.prompt, request.project_id),
        media_type="text/event-stream"
    )
```

**SSE Considerations:**
- SSE is unidirectional (server-to-client only)
- May experience reconnection overhead
- For long-running sessions, consider WebSocket upgrade
- Current implementation with `sse-starlette` is compatible

**Source:** [SDK Overview](https://platform.claude.com/docs/en/agent-sdk/overview), project analysis

### 6. MCP Server Creation

**Confidence:** HIGH (verified via official docs)

In-process MCP servers are created with `create_sdk_mcp_server()`:

```python
from claude_agent_sdk import tool, create_sdk_mcp_server, ClaudeAgentOptions

@tool("my_tool", "Description", {"param": str})
async def my_tool(args):
    return {"content": [{"type": "text", "text": "result"}]}

server = create_sdk_mcp_server(
    name="my-server",
    version="1.0.0",
    tools=[my_tool]
)

options = ClaudeAgentOptions(
    mcp_servers={"my": server},
    allowed_tools=["mcp__my__my_tool"]
)
```

**MCP server types supported:**
- **SDK (in-process):** `McpSdkServerConfig` - direct Python execution
- **stdio (subprocess):** `McpStdioServerConfig` - external command
- **SSE (remote):** `McpSSEServerConfig` - HTTP SSE endpoint
- **HTTP (remote):** `McpHttpServerConfig` - HTTP endpoint

**Source:** [Python SDK Reference](https://platform.claude.com/docs/en/agent-sdk/python)

### 7. Skill Integration (SKILL.md)

**Confidence:** HIGH (verified via official docs)

The business-analyst skill can be integrated in two ways:

**Option A: Load skill from filesystem (Recommended)**

```python
options = ClaudeAgentOptions(
    cwd="/path/to/project",  # Must contain .claude/skills/
    setting_sources=["project"],  # Required to load skills
    allowed_tools=["Skill", "mcp__ba__search_documents", "mcp__ba__save_artifact"]
)
```

With this approach, the skill at `.claude/business-analyst/SKILL.md` is auto-discovered.

**CRITICAL:** `setting_sources=["project"]` is REQUIRED to load skills from filesystem.

**Option B: Embed skill in system_prompt**

```python
skill_content = Path(".claude/business-analyst/SKILL.md").read_text()

options = ClaudeAgentOptions(
    system_prompt={
        "type": "preset",
        "preset": "claude_code",
        "append": skill_content
    }
)
```

This embeds the skill instructions directly in the system prompt.

**Source:** [Agent Skills in SDK](https://platform.claude.com/docs/en/agent-sdk/skills), [Modifying System Prompts](https://platform.claude.com/docs/en/agent-sdk/modifying-system-prompts)

### 8. Session Management

**Confidence:** HIGH (verified via official docs)

For multi-turn conversations (required for BA discovery), use `ClaudeSDKClient`:

```python
from claude_agent_sdk import ClaudeSDKClient, ClaudeAgentOptions

async with ClaudeSDKClient(options=options) as client:
    # First turn
    await client.query("Start a requirements discovery session")
    async for msg in client.receive_response():
        process_message(msg)

    # Second turn (maintains context)
    await client.query("The primary objective is...")
    async for msg in client.receive_response():
        process_message(msg)
```

**Session features:**
- `resume` option: Resume previous sessions by ID
- `fork_session`: Branch conversations
- Session ID returned in `SystemMessage` with `subtype='init'`

**Source:** [Python SDK Reference - ClaudeSDKClient](https://platform.claude.com/docs/en/agent-sdk/python)

### 9. Migration from Direct API

**Confidence:** HIGH

**Current approach (direct API):**
```python
# Current implementation
class AIService:
    def __init__(self):
        self.client = anthropic.AsyncAnthropic(api_key=settings.anthropic_api_key)
        self.tools = [DOCUMENT_SEARCH_TOOL, SAVE_ARTIFACT_TOOL]

    async def stream_chat(self, messages, project_id, thread_id, db):
        while True:
            async with self.client.messages.stream(...) as stream:
                # Manual tool loop
                if final.stop_reason == "tool_use":
                    # Execute tools manually
                    tool_results = []
                    for block in final.content:
                        result = await self.execute_tool(block.name, block.input)
                        tool_results.append(result)
                    messages.append(...)  # Continue conversation
```

**New approach (Agent SDK):**
```python
class AIService:
    def __init__(self):
        self.tools_server = create_sdk_mcp_server(
            name="ba",
            tools=[search_documents_tool, save_artifact_tool]
        )

    async def stream_chat(self, messages, project_id, thread_id, db):
        # Inject context into tools
        tool_context = {"project_id": project_id, "thread_id": thread_id, "db": db}

        options = ClaudeAgentOptions(
            mcp_servers={"ba": self.tools_server},
            allowed_tools=["mcp__ba__search_documents", "mcp__ba__save_artifact"],
            system_prompt={"type": "preset", "preset": "claude_code", "append": skill_content},
            permission_mode="acceptEdits"
        )

        async for message in query(prompt=user_message, options=options):
            yield format_for_sse(message)
```

**Key differences:**
| Aspect | Direct API | Agent SDK |
|--------|-----------|-----------|
| Tool execution | Manual loop | Automatic |
| Context management | Manual | Automatic compaction |
| Streaming | Manual handling | Built-in iterator |
| Tool definition | JSON schema dicts | Python decorators |
| Error handling | Manual | SDK-handled |
| Session management | Manual messages list | Built-in sessions |

### 10. Blockers & Concerns

**Confidence:** MEDIUM (based on analysis)

**Potential issues:**

1. **Tool context injection:** The SDK tools run in-process but need access to `db` session, `project_id`, `thread_id`. Options:
   - Use closure to capture context
   - Pass context via global/thread-local
   - Use hooks to inject context

2. **Skill loading:** The skill references validation scripts (`scripts/validate_preflight.py`) that may not work in SDK context. These may need to be converted to tool definitions or removed.

3. **TextBlock chunking:** TextBlock content may arrive all at once rather than streaming character-by-character. This differs from current implementation's `text_stream`.

4. **SSE compatibility:** Current SSE format uses custom event types (`text_delta`, `tool_executing`, `artifact_created`). Need to map SDK message types to these events.

5. **Session persistence:** Current implementation uses database-stored message history. SDK sessions are ephemeral unless explicitly resumed. May need hybrid approach.

6. **Node.js dependency:** The SDK bundles Claude Code CLI which requires Node.js. This adds a system dependency.

## Recommendations for Phase 4.1

### Architecture Approach

**Recommended:** Hybrid approach using SDK with custom system prompt

1. **Load skill content into system_prompt.append** rather than using the Skill tool
   - Provides more control over skill behavior
   - Avoids filesystem-based discovery complexity
   - Works with existing SSE streaming architecture

2. **Define tools using @tool decorator**
   - `search_documents` - wrap existing document search service
   - `save_artifact` - wrap existing artifact persistence

3. **Use query() for single-turn, ClaudeSDKClient for multi-turn**
   - Keep conversation state in database
   - Resume sessions using SDK's `resume` parameter

4. **Map SDK messages to existing SSE events**
   - `AssistantMessage` with `TextBlock` -> `text_delta`
   - `AssistantMessage` with `ToolUseBlock` -> `tool_executing`
   - `ResultMessage` -> `message_complete`

### Skill Integration Strategy

The business-analyst skill should be loaded as a system prompt append:

```python
# Load skill and references
skill_path = Path(".claude/business-analyst/SKILL.md")
references_path = Path(".claude/business-analyst/references")

skill_content = skill_path.read_text()
for ref_file in references_path.glob("*.md"):
    skill_content += f"\n\n---\n# {ref_file.stem}\n{ref_file.read_text()}"

# Apply to options
options = ClaudeAgentOptions(
    system_prompt={
        "type": "preset",
        "preset": "claude_code",
        "append": skill_content
    }
)
```

This preserves all skill behaviors:
- One-question-at-a-time protocol
- Mode detection
- Zero-assumption protocol
- Technical boundary enforcement
- BRD generation with validation

### Migration Steps

1. **Install SDK:** Add `claude-agent-sdk` to requirements.txt
2. **Refactor tools:** Convert tool definitions to `@tool` decorators
3. **Create service:** New `AgentService` class using SDK
4. **Map streaming:** Create adapter from SDK messages to SSE events
5. **Integrate skill:** Load skill content into system prompt
6. **Update endpoints:** Modify chat endpoints to use new service
7. **Test compatibility:** Verify SSE streaming works correctly

## Sources

**Official Documentation:**
- [Agent SDK Overview](https://platform.claude.com/docs/en/agent-sdk/overview)
- [Python SDK Reference](https://platform.claude.com/docs/en/agent-sdk/python)
- [Quickstart Guide](https://platform.claude.com/docs/en/agent-sdk/quickstart)
- [Agent Skills in SDK](https://platform.claude.com/docs/en/agent-sdk/skills)
- [Modifying System Prompts](https://platform.claude.com/docs/en/agent-sdk/modifying-system-prompts)
- [Migration Guide](https://platform.claude.com/docs/en/agent-sdk/migration-guide)

**GitHub:**
- [claude-agent-sdk-python](https://github.com/anthropics/claude-agent-sdk-python)

**Package:**
- [PyPI - claude-agent-sdk](https://pypi.org/project/claude-agent-sdk/)

## Confidence Assessment

| Area | Confidence | Notes |
|------|------------|-------|
| Installation & Setup | HIGH | Verified via official docs and PyPI |
| Tool Definition | HIGH | Verified via official docs with examples |
| Streaming | HIGH | Verified via official docs, but TextBlock chunking noted |
| Skill Integration | HIGH | Verified via official docs, two approaches documented |
| FastAPI Compatibility | HIGH | SDK is fully async, compatible with current stack |
| Migration Path | MEDIUM | Clear conceptually, but implementation details untested |
| SSE Event Mapping | MEDIUM | Needs implementation to verify exact mappings |

## Open Questions for Planning

1. Should we use `ClaudeSDKClient` for session management or continue with database-stored messages?
2. How to pass database session and request context to tool handlers?
3. Should validation scripts be converted to tools or removed?
4. What is the impact on token usage/costs compared to direct API?
5. How to handle the Node.js dependency in deployment?

---

**Research Status:** COMPLETE
**Ready for Planning:** YES

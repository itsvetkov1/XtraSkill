---
phase: 55-frontend-display-ai-context
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/models/document.dart
  - frontend/lib/services/document_service.dart
  - frontend/lib/providers/document_provider.dart
  - frontend/lib/screens/documents/document_upload_screen.dart
  - frontend/lib/widgets/document_preview_dialog.dart
  - frontend/pubspec.yaml
autonomous: true

must_haves:
  truths:
    - "User can upload Excel, CSV, PDF, and Word files (not just .txt and .md)"
    - "User sees a table preview with first 10 rows when uploading Excel/CSV files"
    - "User can select which sheets to parse from multi-sheet Excel workbooks"
    - "Document model includes contentType and metadata from backend API"
    - "Upload dialog shows text preview for PDF/Word, table preview for Excel/CSV"
  artifacts:
    - path: "frontend/lib/models/document.dart"
      provides: "Document model with contentType and metadata fields"
      contains: "contentType"
    - path: "frontend/lib/widgets/document_preview_dialog.dart"
      provides: "Format-aware upload preview with sheet selector and table preview"
      contains: "DataTable"
    - path: "frontend/lib/screens/documents/document_upload_screen.dart"
      provides: "Upload screen accepting all 6 file types"
      contains: "xlsx"
    - path: "frontend/lib/services/document_service.dart"
      provides: "Document service with download endpoint support"
      contains: "download"
  key_links:
    - from: "frontend/lib/models/document.dart"
      to: "backend GET /projects/{id}/documents"
      via: "fromJson parsing content_type and metadata"
      pattern: "content_type|contentType"
    - from: "frontend/lib/widgets/document_preview_dialog.dart"
      to: "frontend/lib/screens/documents/document_upload_screen.dart"
      via: "show() method called before upload"
      pattern: "DocumentPreviewDialog"
    - from: "frontend/lib/services/document_service.dart"
      to: "backend GET /documents/{id}/download"
      via: "downloadDocument method for binary files"
      pattern: "download"
---

<objective>
Update Document model with rich format fields, extend upload flow to accept all 6 file types, and enhance preview dialog with table preview and sheet selector for Excel/CSV files.

Purpose: Users currently can only upload .txt and .md files. Phase 54 added backend support for Excel, CSV, PDF, and Word. This plan connects the frontend to that backend capability and provides visual feedback during upload.

Output: Document model with contentType/metadata, upload screen accepting rich formats, preview dialog with table preview for Excel/CSV and sheet selector for multi-sheet workbooks.
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-frontend-display-ai-context/55-RESEARCH.md
@.planning/phases/54-backend-foundation-document-parsing-security/54-03-SUMMARY.md
@frontend/lib/models/document.dart
@frontend/lib/services/document_service.dart
@frontend/lib/providers/document_provider.dart
@frontend/lib/screens/documents/document_upload_screen.dart
@frontend/lib/widgets/document_preview_dialog.dart
@frontend/pubspec.yaml
@backend/app/routes/documents.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Document model and service for rich format support</name>
  <files>
    frontend/lib/models/document.dart
    frontend/lib/services/document_service.dart
    frontend/lib/providers/document_provider.dart
    frontend/pubspec.yaml
  </files>
  <action>
    **Document model** (`frontend/lib/models/document.dart`):
    Add two fields to the Document class:
    - `final String? contentType;` — maps to `content_type` from backend API
    - `final Map<String, dynamic>? metadata;` — maps to `metadata` from backend API

    Update constructor to accept these as optional named parameters.

    Update `fromJson()`:
    - Parse `contentType: json['content_type'] as String?`
    - Parse `metadata: json['metadata'] as Map<String, dynamic>?`

    Update `toJson()`:
    - Include `'content_type': contentType` and `'metadata': metadata` if not null

    Add a helper getter for format detection:
    ```dart
    bool get isTableFormat {
      final ct = contentType ?? '';
      return ct.contains('spreadsheet') || ct == 'text/csv';
    }

    bool get isRichFormat {
      final ct = contentType ?? '';
      return ct.contains('spreadsheet') || ct == 'text/csv' ||
             ct == 'application/pdf' || ct.contains('wordprocessing');
    }
    ```

    **Document service** (`frontend/lib/services/document_service.dart`):
    Add a `downloadDocument()` method that calls `GET /documents/{id}/download` and returns raw bytes:
    ```dart
    Future<List<int>> downloadDocument(String documentId) async {
      final response = await _dio.get(
        '/api/documents/$documentId/download',
        options: Options(
          responseType: ResponseType.bytes,
          headers: (await _getAuthHeaders()).headers,
        ),
      );
      return response.data as List<int>;
    }
    ```

    **pubspec.yaml**: Add `excel: ^4.0.6` dependency (for client-side Excel preview parsing in upload dialog). Run `flutter pub get` after adding.

    **Document provider** (`frontend/lib/providers/document_provider.dart`): No changes needed — it already calls service methods that return Document objects, and the updated fromJson will handle new fields automatically.
  </action>
  <verify>
    1. `grep -n 'contentType\|content_type' frontend/lib/models/document.dart` — confirms fields exist
    2. `grep -n 'downloadDocument' frontend/lib/services/document_service.dart` — confirms download method
    3. `grep -n 'excel' frontend/pubspec.yaml` — confirms dependency added
    4. `cd frontend && flutter pub get` passes without errors
  </verify>
  <done>
    Document model parses contentType and metadata from backend JSON. Service has downloadDocument() method. Excel package available for preview parsing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance upload screen and preview dialog for rich document formats</name>
  <files>
    frontend/lib/screens/documents/document_upload_screen.dart
    frontend/lib/widgets/document_preview_dialog.dart
  </files>
  <action>
    **Upload screen** (`frontend/lib/screens/documents/document_upload_screen.dart`):

    1. Update `_maxFileSizeBytes` from 1MB to 10MB (10 * 1024 * 1024) — Phase 54 backend supports 10MB
    2. Update `FilePicker.platform.pickFiles()` to accept rich formats:
       ```dart
       allowedExtensions: ['txt', 'md', 'xlsx', 'csv', 'pdf', 'docx'],
       ```
    3. Update display text from "Only .txt and .md files are supported" to "Supported: .txt, .md, .xlsx, .csv, .pdf, .docx"
    4. Update "Upload a text document" title to "Upload a document"
    5. Update max file size label from "1MB" to "10MB"
    6. The preview dialog call (`DocumentPreviewDialog.show(context, file)`) remains the same — the dialog itself will handle format detection

    **Preview dialog** (`frontend/lib/widgets/document_preview_dialog.dart`):

    Complete rewrite to handle both text and rich document formats. Convert to StatefulWidget for sheet selector state.

    1. Detect file format from extension:
       ```dart
       String _getFileExtension(String filename) {
         final dotIndex = filename.lastIndexOf('.');
         return dotIndex >= 0 ? filename.substring(dotIndex + 1).toLowerCase() : '';
       }
       bool _isExcelFile(String ext) => ext == 'xlsx';
       bool _isCsvFile(String ext) => ext == 'csv';
       bool _isTableFile(String ext) => ext == 'xlsx' || ext == 'csv';
       ```

    2. For Excel files (.xlsx): Use the `excel` Dart package to parse bytes client-side for preview ONLY:
       ```dart
       import 'package:excel/excel.dart';

       Map<String, dynamic>? _parseExcelPreview(List<int> bytes) {
         try {
           final excel = Excel.decodeBytes(bytes);
           final sheetNames = excel.tables.keys.toList();
           if (sheetNames.isEmpty) return null;
           // Get first sheet (or selected sheet)
           final sheet = excel.tables[_selectedSheet ?? sheetNames.first]!;
           final allRows = sheet.rows.map((row) =>
             row.map((cell) => cell?.value?.toString() ?? '').toList()
           ).toList();
           return {
             'sheet_names': sheetNames,
             'headers': allRows.isNotEmpty ? allRows[0] : [],
             'preview_rows': allRows.skip(1).take(10).toList(),
             'total_rows': allRows.length,
           };
         } catch (e) {
           return null;
         }
       }
       ```

    3. For CSV files: Split by newlines and commas to extract first 10 rows:
       ```dart
       Map<String, dynamic>? _parseCsvPreview(List<int> bytes) {
         try {
           final content = utf8.decode(bytes, allowMalformed: true);
           final lines = content.split('\n').where((l) => l.trim().isNotEmpty).toList();
           if (lines.isEmpty) return null;
           final headers = lines[0].split(',');
           final previewRows = lines.skip(1).take(10).map((l) => l.split(',')).toList();
           return {
             'headers': headers,
             'preview_rows': previewRows,
             'total_rows': lines.length,
           };
         } catch (e) {
           return null;
         }
       }
       ```

    4. For PDF/Word files: Show file icon + filename + size (binary preview not possible client-side without heavy libs). Show message: "Preview not available for this file type. Content will be extracted after upload."

    5. Build the dialog content:
       - **Excel/CSV**: Show sheet selector dropdown (if multiple sheets, Excel only) + DataTable with first 10 rows + "Showing first 10 of N rows" footer. DataTable is fine for 10 rows.
       - **Text/Markdown**: Keep existing text preview (first 20 lines)
       - **PDF/Word**: Show file icon, filename, size, and info message

    6. Sheet selector state: `String? _selectedSheet` — default to first sheet. When changed, re-parse preview for selected sheet (Excel only). Only show dropdown when `sheetNames.length > 1`.

    7. Return value remains `bool` (true to upload, false to cancel). The sheet selection is purely for preview — backend parses all sheets on upload.

    **Important:** The `excel` package import is ONLY used in this preview dialog for client-side parsing. Backend does the real parsing with openpyxl. This is intentional — instant preview without network roundtrip.
  </action>
  <verify>
    1. `grep -n 'xlsx\|csv\|pdf\|docx' frontend/lib/screens/documents/document_upload_screen.dart` — confirms all extensions accepted
    2. `grep -n 'DataTable\|sheet_names\|_selectedSheet' frontend/lib/widgets/document_preview_dialog.dart` — confirms table preview and sheet selector
    3. `grep -n '10.*1024\|10MB' frontend/lib/screens/documents/document_upload_screen.dart` — confirms 10MB limit
    4. `cd frontend && flutter analyze --no-fatal-infos` passes
  </verify>
  <done>
    Upload screen accepts all 6 file types with 10MB limit. Preview dialog shows table preview (DataTable) with first 10 rows for Excel/CSV, sheet selector for multi-sheet Excel, text preview for txt/md, and info message for PDF/Word. User confirms before upload.
  </done>
</task>

</tasks>

<verification>
1. Document model has contentType and metadata fields that parse from backend API JSON
2. Upload screen file picker accepts .txt, .md, .xlsx, .csv, .pdf, .docx extensions
3. Upload screen shows 10MB file size limit
4. Preview dialog shows table preview with DataTable for Excel/CSV files
5. Preview dialog shows sheet selector dropdown for multi-sheet Excel files
6. Preview dialog shows text preview for .txt/.md files
7. Preview dialog shows info message for PDF/Word files
8. Document service has downloadDocument() method for binary file download
9. `flutter analyze` passes without errors
</verification>

<success_criteria>
- User can select and preview Excel/CSV files before upload (table with first 10 rows visible)
- User can switch between sheets in multi-sheet Excel preview
- User can select and upload PDF/Word files with info message instead of binary preview
- All 6 file types can be uploaded successfully via the enhanced upload flow
- Document model correctly parses contentType and metadata from backend responses
</success_criteria>

<output>
After completion, create `.planning/phases/55-frontend-display-ai-context/55-01-SUMMARY.md`
</output>

---
phase: 72-backend-file-generation
plan: "01"
subsystem: backend
tags: [mcp, fastmcp, alembic, artifact, file-generation]
dependency_graph:
  requires: []
  provides:
    - ArtifactType.GENERATED_FILE enum value
    - FastMCP HTTP server at /mcp with save_artifact tool
    - Session registry for per-request db context propagation
  affects:
    - backend/app/models.py
    - backend/main.py
    - backend/app/mcp_server.py
tech_stack:
  added:
    - mcp==1.12.4 (FastMCP, already installed — streamable_http_app() used)
  patterns:
    - FastMCP HTTP sub-app mounted in FastAPI at module level
    - Session token registry for cross-process db context propagation
    - Alembic checkpoint migration (no SQL DDL for SQLite native_enum=False)
key_files:
  created:
    - backend/app/mcp_server.py
    - backend/alembic/versions/55e1dfa98f3a_add_generated_file_artifact_type.py
  modified:
    - backend/app/models.py
    - backend/main.py
decisions:
  - "Use mcp_app variable name (not mcp) to avoid shadowing the mcp package import"
  - "Mount MCP server at module level in main.py (not in lifespan) to prevent ECONNREFUSED on process pool warm-up"
  - "Alembic migration is a checkpoint only — no SQL DDL needed for SQLite native_enum=False"
  - "Session registry maps token -> {db, thread_id}; token travels via system prompt text since CLI runs in separate process"
metrics:
  duration: 107s
  completed: "2026-02-24"
  tasks_completed: 2
  files_modified: 4
---

# Phase 72 Plan 01: Backend Infrastructure (MCP Server + ArtifactType) Summary

**One-liner:** FastMCP HTTP server mounted at /mcp with save_artifact tool using session token registry, plus generated_file ArtifactType enum value with Alembic checkpoint migration for SQLite.

## What Was Built

This plan creates the infrastructure layer for Phase 72 file generation. The key insight from the research is that Claude CLI subprocesses run in separate OS processes — Python ContextVars cannot cross that boundary. The solution is a real HTTP MCP server (using the already-installed `mcp==1.12.4` library) that the CLI subprocess connects to via `--mcp-config`. Per-request context (db session + thread_id) is propagated via a session token embedded in the system prompt and resolved from an in-memory registry when the MCP tool is called.

### Task 1: ArtifactType enum + Alembic migration

- Added `GENERATED_FILE = "generated_file"` to `ArtifactType` in `backend/app/models.py`
- Generated Alembic migration `55e1dfa98f3a` with `down_revision = 'e330b6621b90'`
- Replaced autogenerated body (which incorrectly included FTS virtual table drops) with checkpoint pass stubs and explanatory docstrings
- Applied migration — database at head `55e1dfa98f3a`

### Task 2: FastMCP server + main.py mount

- Created `backend/app/mcp_server.py`:
  - `mcp_app = FastMCP("assistant-tools")` — the server instance exported for mounting
  - `_session_registry: dict[str, dict]` — maps session_token to `{db, thread_id}`
  - `register_mcp_session(token, db, thread_id)` — called before CLI subprocess gets its system prompt
  - `unregister_mcp_session(token)` — called after CLI subprocess completes
  - `save_artifact` MCP tool — looks up session registry, creates `Artifact` with `ArtifactType.GENERATED_FILE`, returns `ARTIFACT_CREATED:{json}|...` marker following existing protocol from `mcp_tools.py`
- Updated `backend/main.py`:
  - Import: `from app.mcp_server import mcp_app`
  - Mount: `app.mount("/mcp", mcp_app.streamable_http_app())` placed after all `include_router` calls, before root endpoint, at module level (not in lifespan)

## Verification Results

All 4 plan verification checks passed:

1. `ArtifactType.GENERATED_FILE.value == 'generated_file'` — PASS
2. `from app.mcp_server import mcp_app, save_artifact, register_mcp_session` — PASS
3. `alembic current` shows `55e1dfa98f3a (head)` — PASS
4. FastAPI routes show `Mount(path='/mcp', name='', app=<starlette.applications.Starlette ...>)` — PASS

## Commits

| Task | Commit | Description |
|------|--------|-------------|
| Task 1 | b2a1ccd | feat(72-01): add GENERATED_FILE ArtifactType enum value and Alembic checkpoint migration |
| Task 2 | 9e3cb2c | feat(72-01): create FastMCP server with save_artifact tool and mount in FastAPI |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Alembic autogenerate included spurious FTS virtual table drop statements**

- **Found during:** Task 1 — Alembic revision generation
- **Issue:** `alembic revision --autogenerate` detected SQLite FTS5 virtual tables (`document_fts`, `document_fts_content`, etc.) present in the database but absent from the SQLAlchemy model definitions. It generated `op.drop_table(...)` calls for all 6 FTS tables in `upgrade()` and corresponding recreate calls in `downgrade()`.
- **Fix:** Replaced the entire `upgrade()` and `downgrade()` bodies with `pass` stubs and explanatory docstrings per the plan's explicit instruction. The FTS tables are unrelated to this migration's purpose (adding a new enum value).
- **Files modified:** `backend/alembic/versions/55e1dfa98f3a_add_generated_file_artifact_type.py`
- **Commit:** b2a1ccd

## Decisions Made

1. **mcp_app variable name (not mcp):** Avoids shadowing the `mcp` package namespace import — same rationale as plan spec.

2. **Module-level mount in main.py:** Per research Pitfall 4, mounting inside the lifespan event would race with process pool warm-up. Module-level registration ensures routes exist before any lifespan events run.

3. **Checkpoint migration body:** SQLite with `native_enum=False` stores enum values as plain VARCHAR strings. Adding a new value to the Python enum class is sufficient — no DDL is needed. The migration exists purely as a version checkpoint (so `alembic current` reflects the change) and to document the PostgreSQL equivalent (`ALTER TYPE artifacttype ADD VALUE`).

4. **Session registry dict pattern:** CLI subprocess calls the MCP server over HTTP — it cannot see Python ContextVars. The session token is the bridge: registered before CLI gets stdin, looked up by MCP tool on HTTP call, removed after CLI exits. Pattern confirmed in existing `mcp_tools.py`.

## Next: Plan 02

Plan 02 will wire this infrastructure into the request flow:
- Thread `artifact_generation` through `AIService.stream_chat()` and `_stream_agent_chat()`
- Add `--mcp-config` and `--tools ""` flags to CLI subprocess spawn
- Add session lifecycle (register/unregister) around CLI subprocess call
- Extend `_translate_event()` in `claude_cli_adapter.py` to scan `result` events for `ARTIFACT_CREATED:` marker

## Self-Check: PASSED

Files exist:
- `backend/app/mcp_server.py` — FOUND
- `backend/alembic/versions/55e1dfa98f3a_add_generated_file_artifact_type.py` — FOUND
- `backend/app/models.py` modified — FOUND

Commits exist:
- b2a1ccd — FOUND (feat(72-01): add GENERATED_FILE ArtifactType enum value)
- 9e3cb2c — FOUND (feat(72-01): create FastMCP server with save_artifact tool)

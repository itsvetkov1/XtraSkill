---
phase: 35-transparency-indicators
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/alembic/versions/xxx_add_conversation_mode_to_threads.py
  - backend/app/models.py
  - backend/app/routes/threads.py
autonomous: true

must_haves:
  truths:
    - "Thread has conversation_mode field persisted in database"
    - "API returns conversation_mode in thread responses"
    - "API accepts conversation_mode in thread creation/update"
    - "Mode defaults to null (no mode selected yet)"
  artifacts:
    - path: "backend/app/models.py"
      provides: "Thread.conversation_mode column"
      contains: "conversation_mode"
    - path: "backend/app/routes/threads.py"
      provides: "Mode in request/response models"
      contains: "conversation_mode"
  key_links:
    - from: "backend/app/routes/threads.py"
      to: "backend/app/models.py"
      via: "Thread model with conversation_mode"
      pattern: "thread\\.conversation_mode"
---

<objective>
Add conversation_mode field to Thread model with database migration and API support.

Purpose: Per PITFALL-07, mode is a thread property (not global preference). Each thread remembers its mode so users see the same mode after app restart.

Output: Alembic migration adding conversation_mode column, updated Thread model, updated API endpoints.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/app/models.py
@backend/app/routes/threads.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Alembic migration for conversation_mode</name>
  <files>backend/alembic/versions/xxx_add_conversation_mode_to_threads.py</files>
  <action>
Generate new Alembic migration to add conversation_mode column to threads table:

```bash
cd backend
alembic revision --autogenerate -m "add conversation_mode to threads"
```

The migration should add:
- conversation_mode: String(50), nullable=True, default=None

Valid modes will be: "meeting", "document_refinement" (enforced at API level, not DB constraint)

Verify the generated migration looks correct, then run:
```bash
alembic upgrade head
```
  </action>
  <verify>
alembic current  # Shows latest revision
sqlite3 backend/ba_assistant.db ".schema threads" | grep conversation_mode
  </verify>
  <done>
Migration created and applied. threads table has conversation_mode column.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Thread model and API schemas</name>
  <files>
    backend/app/models.py
    backend/app/routes/threads.py
  </files>
  <action>
1. Update Thread model in models.py:

Add after model_provider field:
```python
# Conversation mode (meeting, document_refinement)
conversation_mode: Mapped[Optional[str]] = mapped_column(
    String(50),
    nullable=True,
    default=None
)
```

2. Update routes/threads.py:

Add VALID_MODES constant:
```python
VALID_MODES = ["meeting", "document_refinement"]
```

Update request models:
- ThreadCreate: Add conversation_mode: Optional[str] = Field(None, max_length=50)
- GlobalThreadCreate: Add conversation_mode: Optional[str] = Field(None, max_length=50)
- ThreadUpdate: Add conversation_mode: Optional[str] = Field(None, max_length=50)

Update response models:
- ThreadResponse: Add conversation_mode: Optional[str] = None
- GlobalThreadListResponse: Add conversation_mode: Optional[str] = None

Update endpoint handlers:
- create_thread: Validate mode if provided, set on thread
- create_global_thread: Validate mode if provided, set on thread
- update_thread: Allow updating mode (validate if provided)
- get_thread, list_threads, list_all_threads: Include conversation_mode in response

Mode validation: If provided and not in VALID_MODES, return 400 "Invalid mode. Valid options: meeting, document_refinement"
  </action>
  <verify>
grep -n "conversation_mode" backend/app/models.py
grep -n "conversation_mode" backend/app/routes/threads.py
cd backend && python -c "from app.models import Thread; print('Model OK')"
  </verify>
  <done>
Thread model has conversation_mode field. All API endpoints accept and return conversation_mode.
  </done>
</task>

</tasks>

<verification>
1. alembic current shows latest migration applied
2. Thread model imports cleanly: python -c "from app.models import Thread"
3. API schema includes conversation_mode in request/response models
4. Mode validation returns 400 for invalid modes
5. Existing threads work (conversation_mode defaults to None)
</verification>

<success_criteria>
- MODE-04 (backend): Mode persists in database for that thread
- Thread table has conversation_mode column (nullable, defaults to None)
- API accepts mode on create/update, returns mode on get/list
- Invalid mode returns 400 error with valid options
</success_criteria>

<output>
After completion, create `.planning/phases/35-transparency-indicators/35-02-SUMMARY.md`
</output>

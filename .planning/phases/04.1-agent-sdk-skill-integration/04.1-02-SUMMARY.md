---
phase: 04.1-agent-sdk-skill-integration
plan: 02
subsystem: api
tags: [claude-agent-sdk, agent-service, skill-integration, sse-streaming]

# Dependency graph
requires:
  - phase: 04.1-01
    provides: claude-agent-sdk, skill_loader service
provides:
  - AgentService class using Claude Agent SDK
  - @tool decorated search_documents and save_artifact tools
  - Skill-enhanced chat endpoint with SSE streaming
affects: [frontend chat integration, artifact generation, future agent features]

# Tech tracking
tech-stack:
  added: []
  patterns: [context variables for tool injection, MCP server tools, SDK query streaming]

key-files:
  created:
    - backend/app/services/agent_service.py
  modified:
    - backend/app/routes/conversations.py
    - backend/app/services/ai_service.py

key-decisions:
  - "Context variables (_db_context, _project_id_context, _thread_id_context) for tool data"
  - "system_prompt.append for skill integration rather than filesystem discovery"
  - "ARTIFACT_CREATED marker in tool result for SSE event extraction"
  - "AIService kept as deprecated fallback"

patterns-established:
  - "AgentService.stream_chat() yields SSE-formatted events"
  - "@tool decorator with MCP server for Claude tool integration"
  - "Conversation history formatted as [ROLE]: content string"

# Metrics
duration: 4min
completed: 2026-01-25
---

# Phase 04.1 Plan 02: Agent SDK Chat Integration Summary

**AgentService using Claude Agent SDK with @tool decorators, skill prompt integration, and unchanged SSE streaming API contract**

## Performance

- **Duration:** 4 min
- **Started:** 2026-01-25T07:15:19Z
- **Completed:** 2026-01-25T07:19:00Z
- **Tasks:** 3
- **Files modified:** 3

## Accomplishments
- Created AgentService class using Claude Agent SDK query() function
- Defined search_documents_tool and save_artifact_tool with @tool decorator
- Integrated 90k+ char skill prompt via system_prompt.append
- Updated conversations endpoint to use AgentService
- Deprecated AIService with clear warning

## Task Commits

Each task was committed atomically:

1. **Task 1: Create AgentService with SDK tools** - `9c2701d` (feat)
2. **Task 2: Update conversations endpoint** - `60c8a6e` (feat)
3. **Task 3: Deprecate AIService** - `1fbf595` (chore)

## Files Created/Modified
- `backend/app/services/agent_service.py` - New AgentService with SDK integration
- `backend/app/routes/conversations.py` - Updated to use AgentService
- `backend/app/services/ai_service.py` - Added deprecation warning

## Key Implementation Details

### AgentService Architecture
```python
# Tool definitions use @tool decorator
@tool("search_documents", "description", {"query": str})
async def search_documents_tool(args): ...

@tool("save_artifact", "description", {"artifact_type": str, ...})
async def save_artifact_tool(args): ...

# MCP server created with tools
tools_server = create_sdk_mcp_server(
    name="ba-tools", version="1.0.0",
    tools=[search_documents_tool, save_artifact_tool]
)

# SDK options with skill prompt
options = ClaudeAgentOptions(
    system_prompt={"type": "preset", "preset": "claude_code", "append": skill_prompt},
    mcp_servers={"ba": tools_server},
    allowed_tools=["mcp__ba__search_documents", "mcp__ba__save_artifact"],
    permission_mode="acceptEdits",
    include_partial_messages=True
)
```

### Context Variable Pattern
Tools need database session, project_id, and thread_id. Used Python contextvars:
- `_db_context: ContextVar[Any]` - Database session
- `_project_id_context: ContextVar[str]` - Project ID for document search
- `_thread_id_context: ContextVar[str]` - Thread ID for artifact association

Set before query(), accessed in tool handlers via `.get()`.

### SSE Event Mapping
| SDK Message Type | SSE Event |
|-----------------|-----------|
| AssistantMessage + TextBlock | text_delta |
| AssistantMessage + ToolUseBlock | tool_executing |
| ToolResultBlock with ARTIFACT_CREATED | artifact_created |
| ResultMessage | message_complete |
| Exception | error |

## Decisions Made
1. **Context variables over closure:** Cleaner separation, tools defined at module level
2. **Skill as system_prompt.append:** More control than filesystem discovery, works with existing SSE architecture
3. **ARTIFACT_CREATED marker:** Tool results don't have custom fields, so marker in text parsed for event
4. **Keep AIService:** Gradual migration, existing tests may rely on it

## Deviations from Plan
None - plan executed exactly as written.

## Issues Encountered
None - SDK integration worked as documented in research phase.

## User Setup Required
None - uses existing ANTHROPIC_API_KEY environment variable.

## Testing Notes
- AgentService imports successfully and loads 90k+ char skill prompt
- Conversations router imports AgentService without error
- AIService shows DeprecationWarning when instantiated

## Next Phase Readiness
- Chat endpoint now uses skill-enhanced AgentService
- SSE streaming maintains existing frontend contract
- Ready for end-to-end testing with frontend
- Phase 04.1 complete - Agent SDK and Skill Integration done

---
*Phase: 04.1-agent-sdk-skill-integration*
*Completed: 2026-01-25*

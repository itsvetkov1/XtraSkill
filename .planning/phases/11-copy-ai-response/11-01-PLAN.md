---
phase: 11-copy-ai-response
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/screens/conversation/widgets/message_bubble.dart
autonomous: true

must_haves:
  truths:
    - "User sees copy icon on every assistant message bubble"
    - "Tapping copy icon places full message text on system clipboard"
    - "Copied to clipboard snackbar appears after successful copy"
    - "Copy failure shows error snackbar"
  artifacts:
    - path: "frontend/lib/screens/conversation/widgets/message_bubble.dart"
      provides: "Copy button and clipboard handling for assistant messages"
      contains: "Clipboard.setData"
  key_links:
    - from: "MessageBubble._buildCopyButton"
      to: "Clipboard.setData"
      via: "IconButton.onPressed (synchronous - no await)"
      pattern: "Clipboard\\.setData\\(ClipboardData"
    - from: "MessageBubble._copyToClipboard"
      to: "ScaffoldMessenger"
      via: "showSnackBar call"
      pattern: "ScaffoldMessenger\\.of\\(context\\)\\.showSnackBar"
---

<objective>
Add one-tap copy functionality to assistant message bubbles.

Purpose: Users frequently need to copy AI-generated content (requirements, user stories, acceptance criteria) to paste into other tools. A single-tap copy button eliminates the need to manually select text.

Output: Modified MessageBubble widget with copy button and clipboard integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-copy-ai-response/11-RESEARCH.md

@frontend/lib/screens/conversation/widgets/message_bubble.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add copy button to assistant messages</name>
  <files>frontend/lib/screens/conversation/widgets/message_bubble.dart</files>
  <action>
Modify MessageBubble to add copy functionality for assistant messages:

1. Add import: `import 'package:flutter/services.dart';`

2. Modify the build method to wrap content in a Column (for assistant messages only):
   - Keep existing SelectableText as first child
   - Add copy button row as second child (only when `!isUser`)

3. Add `_buildCopyButton(BuildContext context)` method:
   - Returns an Align widget with alignment: Alignment.centerRight
   - Contains IconButton with:
     - icon: `Icon(Icons.copy, size: 18, color: theme.colorScheme.onSurfaceVariant)`
     - tooltip: 'Copy to clipboard'
     - padding: EdgeInsets.zero
     - constraints: const BoxConstraints()
     - onPressed: calls `_copyToClipboard(context)`

4. Add `_copyToClipboard(BuildContext context)` method:
   - CRITICAL: Do NOT use async/await - Safari requires synchronous clipboard call
   - Wrap in try-catch
   - Call `Clipboard.setData(ClipboardData(text: message.content))` directly (no await)
   - On success: Show snackbar "Copied to clipboard"
   - On catch: Show snackbar "Failed to copy"
   - Follow existing snackbar pattern from codebase (SnackBar with Text content)

5. For user messages (`isUser == true`): Keep existing simple structure (no copy button)

Layout for assistant messages:
```dart
Container(
  // existing constraints, decoration...
  child: Column(
    crossAxisAlignment: CrossAxisAlignment.start,
    mainAxisSize: MainAxisSize.min,
    children: [
      SelectableText(message.content, ...),
      _buildCopyButton(context),
    ],
  ),
)
```

Layout for user messages (unchanged):
```dart
Container(
  child: SelectableText(message.content, ...),
)
```
  </action>
  <verify>
Run Flutter analyze:
```bash
cd frontend && flutter analyze lib/screens/conversation/widgets/message_bubble.dart
```
No errors or warnings should appear.

Run the app and visually confirm:
```bash
cd frontend && flutter run -d chrome
```
- Navigate to a conversation with assistant messages
- Copy icon should appear on assistant bubbles
- Copy icon should NOT appear on user bubbles
  </verify>
  <done>
- MessageBubble shows copy icon on assistant messages only
- Tapping copy icon copies message.content to clipboard
- Success snackbar "Copied to clipboard" appears
- Error snackbar "Failed to copy" appears on failure
- No async/await used for Clipboard.setData (Safari compatibility)
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify cross-platform clipboard behavior</name>
  <files>frontend/lib/screens/conversation/widgets/message_bubble.dart</files>
  <action>
Test the copy functionality on web platform (Chrome) which exercises the critical code path:

1. Start the Flutter web app:
   ```bash
   cd frontend && flutter run -d chrome
   ```

2. Navigate to a conversation with at least one assistant message

3. Click the copy icon on an assistant message

4. Verify:
   - Snackbar appears with "Copied to clipboard"
   - Paste in another app to confirm clipboard content matches

5. The synchronous clipboard call pattern (no await) ensures Safari compatibility.
   Since the code uses `Clipboard.setData()` without await, this works on:
   - Android (native)
   - iOS (native)
   - Chrome (web)
   - Safari (web) - the critical case
   - Firefox (web)
   - Windows (desktop)
   - macOS (desktop)

If any issues found, check:
- Clipboard.setData is called directly in try block (no await)
- ScaffoldMessenger.of(context) is called after clipboard operation
  </action>
  <verify>
Manual test on Chrome:
1. Run `cd frontend && flutter run -d chrome`
2. Login and go to any conversation with assistant messages
3. Click copy icon
4. "Copied to clipboard" snackbar appears
5. Paste in notepad/text editor - content matches message
  </verify>
  <done>
- Copy works on Chrome web platform
- Clipboard content matches full message text
- Error handling works (can simulate by temporarily breaking clipboard call)
  </done>
</task>

</tasks>

<verification>
Phase 11 requirements verification:

| Requirement | Verification |
|-------------|--------------|
| COPY-01: Copy icon visible on assistant messages | Visual inspection - icon appears on assistant bubbles only |
| COPY-02: Copy action copies full message content | Paste test - clipboard matches message.content |
| COPY-03: Snackbar confirms copy | Visual - "Copied to clipboard" appears |
| COPY-04: Cross-platform with error handling | Code review - synchronous call pattern, try-catch present |
</verification>

<success_criteria>
1. Copy icon (Icons.copy) visible on every assistant message bubble
2. Copy icon NOT visible on user message bubbles
3. Tapping copy places exact message.content text on clipboard
4. "Copied to clipboard" snackbar appears after successful copy
5. "Failed to copy" snackbar appears on clipboard error
6. No async/await before Clipboard.setData (Safari compatibility)
7. flutter analyze passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-copy-ai-response/11-01-SUMMARY.md`
</output>

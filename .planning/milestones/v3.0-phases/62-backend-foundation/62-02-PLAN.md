---
phase: 62-backend-foundation
plan: 02
type: execute
wave: 2
depends_on: [62-01]
files_modified:
  - backend/app/routes/threads.py
  - frontend/lib/services/thread_service.dart
  - frontend/lib/models/thread.dart
autonomous: true
requirements: [API-01, API-02, API-03]

must_haves:
  truths:
    - "Creating a thread via POST /api/threads with thread_type='assistant' stores the type and returns it in the response"
    - "Creating a thread via POST /api/threads without thread_type returns 422 validation error (field required)"
    - "Listing threads with GET /api/threads?thread_type=assistant returns only Assistant threads"
    - "Listing threads without thread_type filter returns all threads regardless of type (backward compatible)"
    - "Creating an Assistant thread with project_id silently ignores project_id (creates without project)"
    - "Invalid thread_type value returns HTTP 400 with clear error message listing valid options"
    - "thread_type field is present in all thread API responses (list, get, create)"
    - "Frontend BA thread creation sends thread_type=ba_assistant (prevents breakage)"
  artifacts:
    - path: "backend/app/routes/threads.py"
      provides: "Thread API with thread_type support on create, list filter, response models"
      contains: "thread_type"
    - path: "frontend/lib/services/thread_service.dart"
      provides: "Frontend service sending thread_type=ba_assistant on thread creation"
      contains: "thread_type"
    - path: "frontend/lib/models/thread.dart"
      provides: "Thread model with threadType field"
      contains: "threadType"
  key_links:
    - from: "frontend/lib/services/thread_service.dart"
      to: "backend/app/routes/threads.py"
      via: "HTTP POST /api/threads with thread_type field"
      pattern: "thread_type.*ba_assistant"
    - from: "backend/app/routes/threads.py"
      to: "backend/app/models.py"
      via: "Thread model with thread_type field"
      pattern: "thread\\.thread_type"
---

<objective>
Add thread_type support to all thread API endpoints (create, list, get) and update frontend to send thread_type on BA thread creation.

Purpose: Enable API consumers to create threads with explicit type, filter thread listings by type, and always see thread_type in responses. Fix frontend to prevent breakage from new required field.
Output: Updated thread routes with thread_type validation, filtering, and response inclusion. Updated frontend service and model.
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-backend-foundation/62-RESEARCH.md
@.planning/phases/62-backend-foundation/62-01-SUMMARY.md
@backend/app/routes/threads.py
@backend/app/models.py
@frontend/lib/services/thread_service.dart
@frontend/lib/models/thread.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add thread_type to thread API endpoints (create, list, get, response models)</name>
  <files>backend/app/routes/threads.py</files>
  <action>
1. Add VALID_THREAD_TYPES constant at module level (alongside existing VALID_PROVIDERS):
   ```python
   VALID_THREAD_TYPES = ["ba_assistant", "assistant"]
   ```

2. Update GlobalThreadCreate model -- add required thread_type field:
   ```python
   class GlobalThreadCreate(BaseModel):
       title: Optional[str] = Field(None, max_length=255)
       project_id: Optional[str] = None
       model_provider: Optional[str] = Field(None, max_length=20)
       conversation_mode: Optional[str] = Field(None, max_length=50)
       thread_type: str = Field(..., description="Required: ba_assistant or assistant")
   ```
   The `...` makes it required (no default). Per locked decision: "thread_type is required on thread creation -- no default, all callers must be explicit."

3. Update ThreadCreate model (project-scoped endpoint) -- add thread_type with default for backward compatibility:
   ```python
   class ThreadCreate(BaseModel):
       title: Optional[str] = Field(None, max_length=255)
       model_provider: Optional[str] = Field(None, max_length=20)
       conversation_mode: Optional[str] = Field(None, max_length=50)
       thread_type: str = Field(default="ba_assistant", description="Thread type, defaults to ba_assistant for project-scoped threads")
   ```
   Project-scoped endpoint is always BA, so default is safe here.

4. Update ALL response models to include thread_type:
   - ThreadResponse: add `thread_type: str = "ba_assistant"`
   - GlobalThreadListResponse: add `thread_type: str = "ba_assistant"`
   Per locked decision: "thread_type field always included in all thread API responses (list, get, create)"

5. Update create_global_thread endpoint:
   - Add thread_type validation BEFORE project validation:
     ```python
     if thread_data.thread_type not in VALID_THREAD_TYPES:
         raise HTTPException(
             status_code=400,
             detail=f"Invalid thread_type. Must be one of: {', '.join(VALID_THREAD_TYPES)}"
         )
     ```
   - API-03: Silent project_id ignore for Assistant threads (per locked decision):
     ```python
     if thread_data.thread_type == "assistant" and thread_data.project_id:
         thread_data.project_id = None  # Silently ignore per user decision
     ```
   - Pass thread_type to Thread constructor:
     ```python
     thread = Thread(
         ...existing fields...,
         thread_type=thread_data.thread_type,
     )
     ```
   - Include thread_type in ThreadResponse construction:
     ```python
     thread_type=thread.thread_type,
     ```
   - For Assistant threads, set user_id for direct ownership (project_id will be None):
     Keep existing logic: `user_id=user_id if thread_data.project_id is None else None` -- this already works correctly since we cleared project_id for Assistant threads above.

6. Update create_thread (project-scoped) endpoint:
   - Pass thread_type to Thread constructor (will default to ba_assistant from model)
   - Include thread_type in response

7. Update list_all_threads endpoint:
   - Add optional thread_type query parameter:
     ```python
     async def list_all_threads(
         page: int = Query(1, ge=1),
         page_size: int = Query(25, ge=1, le=50),
         thread_type: Optional[str] = Query(None, description="Filter by thread_type"),
         ...
     ```
   - Validate thread_type filter if provided:
     ```python
     if thread_type and thread_type not in VALID_THREAD_TYPES:
         raise HTTPException(status_code=400, detail=f"Invalid thread_type filter. Must be one of: {', '.join(VALID_THREAD_TYPES)}")
     ```
   - Apply filter to query:
     ```python
     if thread_type:
         base_query = base_query.where(Thread.thread_type == thread_type)
     ```
   - Also apply filter to count query for correct pagination totals
   - Include thread_type in GlobalThreadListResponse construction:
     ```python
     thread_type=t.thread_type or "ba_assistant",
     ```

8. Update get_thread endpoint:
   - Include thread_type in ThreadDetailResponse construction

9. Update update_thread endpoint:
   - Include thread_type in response

10. Update list_threads (project-scoped) endpoint:
   - Include thread_type in response
  </action>
  <verify>
Run the backend and test with curl:
```bash
cd /Users/a1testingmac/projects/XtraSkill/backend && source venv/bin/activate && python -c "
from app.routes.threads import GlobalThreadCreate, ThreadResponse, GlobalThreadListResponse, VALID_THREAD_TYPES
# Verify required field
try:
    GlobalThreadCreate(title='test')
    assert False, 'Should require thread_type'
except Exception:
    pass
# Verify valid creation
t = GlobalThreadCreate(title='test', thread_type='assistant')
assert t.thread_type == 'assistant'
# Verify response model has thread_type
r = ThreadResponse(id='x', project_id=None, title='t', created_at='2026-01-01', updated_at='2026-01-01', thread_type='assistant')
assert r.thread_type == 'assistant'
print('API model validation passed')
"
```
  </verify>
  <done>
- thread_type is required on GlobalThreadCreate (no default)
- thread_type defaults to ba_assistant on ThreadCreate (project-scoped)
- All response models include thread_type
- list_all_threads supports optional thread_type filter query parameter
- Invalid thread_type returns 400 with valid options
- Assistant + project_id silently ignores project_id
- Count query also filters by thread_type for correct pagination
  </done>
</task>

<task type="auto">
  <name>Task 2: Update frontend Thread model and service to send thread_type</name>
  <files>frontend/lib/services/thread_service.dart, frontend/lib/models/thread.dart</files>
  <action>
1. Update Thread model (frontend/lib/models/thread.dart):
   - Add threadType field:
     ```dart
     final String? threadType; // "ba_assistant" or "assistant"
     ```
   - Add to constructor
   - Add to fromJson: `threadType: json['thread_type'] as String?,`
   - Add to toJson: `if (threadType != null) 'thread_type': threadType,`

2. Update ThreadService (frontend/lib/services/thread_service.dart):
   - In createThread() method (project-scoped), add thread_type to data:
     ```dart
     data: {
       if (title != null && title.isNotEmpty) 'title': title,
       if (provider != null) 'model_provider': provider,
       'thread_type': 'ba_assistant',  // Required field - project threads are always BA
     },
     ```
   - In createGlobalThread() method, add thread_type to data:
     ```dart
     data['thread_type'] = 'ba_assistant';  // Required field - default to BA for existing callers
     ```
     NOTE: This is a minimal fix to prevent breakage. Phase 63 will add Assistant thread creation with thread_type='assistant'.

Per locked decision: "Fix existing frontend BA thread creation to send thread_type=ba_assistant in this phase (prevents breakage)"
  </action>
  <verify>
Run: `cd /Users/a1testingmac/projects/XtraSkill/frontend && grep -n 'thread_type' lib/services/thread_service.dart lib/models/thread.dart` -- should show thread_type in both files.
  </verify>
  <done>
- Thread model has threadType field parsed from JSON
- createThread sends thread_type='ba_assistant'
- createGlobalThread sends thread_type='ba_assistant'
- No existing functionality broken (all BA thread creation paths send the required field)
  </done>
</task>

</tasks>

<verification>
1. POST /api/threads with thread_type='assistant' returns 201 with thread_type in response
2. POST /api/threads without thread_type returns 422 (Pydantic validation error)
3. POST /api/threads with thread_type='invalid' returns 400 with clear message
4. POST /api/threads with thread_type='assistant' and project_id='xxx' silently creates without project
5. GET /api/threads?thread_type=assistant returns only assistant threads
6. GET /api/threads (no filter) returns all threads
7. GET /api/threads/{id} includes thread_type in response
8. Frontend thread creation includes thread_type='ba_assistant' in request body
</verification>

<success_criteria>
- All thread API endpoints accept and return thread_type
- thread_type is required on global thread creation (no default)
- thread_type filter works on list endpoint with correct pagination counts
- Invalid thread_type returns 400 with valid options message
- Assistant threads with project_id get project_id silently removed
- Frontend sends thread_type=ba_assistant on all existing thread creation paths
</success_criteria>

<output>
After completion, create `.planning/phases/62-backend-foundation/62-02-SUMMARY.md`
</output>

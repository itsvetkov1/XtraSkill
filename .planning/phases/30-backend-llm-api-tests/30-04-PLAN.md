---
phase: 30-backend-llm-api-tests
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/api/test_document_routes.py
  - backend/tests/api/test_thread_routes.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Documents routes return 201 on upload, 200 on list/get, 204 on delete"
    - "Documents routes return 400 for invalid file types"
    - "Documents routes return 413 for files over 1MB"
    - "Threads routes return 201 on create, 200 on list/get, 204 on delete"
    - "Threads routes handle both project-scoped and global threads"
  artifacts:
    - path: "backend/tests/api/test_document_routes.py"
      provides: "Documents router contract tests"
      min_lines: 100
    - path: "backend/tests/api/test_thread_routes.py"
      provides: "Threads router contract tests"
      min_lines: 120
  key_links:
    - from: "backend/tests/api/test_document_routes.py"
      to: "/api/projects/{id}/documents"
      via: "client.post/get/delete"
      pattern: "client\\.(post|get|delete).*\"/api/.*documents"
    - from: "backend/tests/api/test_thread_routes.py"
      to: "/api/threads"
      via: "client.post/get/patch/delete"
      pattern: "client\\.(post|get|patch|delete).*\"/api/.*threads"
---

<objective>
Create API contract tests for Documents and Threads routers

Purpose: Verify Documents and Threads endpoints return correct status codes and handle ownership/validation correctly (BAPI-03, BAPI-04)

Output: Test files in backend/tests/api/ with contract tests for documents and threads routes
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-backend-llm-api-tests/30-RESEARCH.md
@backend/app/routes/documents.py
@backend/app/routes/threads.py
@backend/tests/api/conftest.py
@backend/tests/fixtures/factories.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Documents router contract tests</name>
  <files>backend/tests/api/test_document_routes.py</files>
  <action>
Create `backend/tests/api/test_document_routes.py` with contract tests for all document endpoints.

**Class: TestUploadDocument**
- `test_201_upload_text_file`: POST /api/projects/{id}/documents with .txt returns 201
- `test_201_upload_markdown_file`: POST /api/projects/{id}/documents with .md returns 201
- `test_400_invalid_content_type`: POST with application/pdf returns 400 "Only .txt and .md files allowed"
- `test_413_file_too_large`: POST with file > 1MB returns 413 "File too large"
- `test_400_invalid_utf8`: POST with binary file returns 400 "File must be valid UTF-8 text"
- `test_403_without_auth`: POST without token returns 403
- `test_404_project_not_found`: POST to non-existent project returns 404
- `test_404_project_not_owned`: POST to other user's project returns 404
- `test_response_schema`: Response has id, filename, created_at

**Class: TestListDocuments**
- `test_200_returns_array`: GET /api/projects/{id}/documents returns 200 with array
- `test_403_without_auth`: GET without token returns 403
- `test_404_project_not_found`: GET for non-existent project returns 404
- `test_empty_list_for_new_project`: GET returns [] for project with no documents

**Class: TestGetDocument**
- `test_200_with_content`: GET /documents/{id} returns 200 with decrypted content
- `test_403_without_auth`: GET without token returns 403
- `test_404_not_found`: GET for non-existent document returns 404
- `test_404_not_owned`: GET for other user's document returns 404
- `test_response_schema`: Response has id, filename, content, created_at

**Class: TestSearchDocuments**
- `test_200_with_results`: GET /api/projects/{id}/documents/search?q=term returns matches
- `test_200_empty_results`: GET with no matches returns empty array
- `test_403_without_auth`: GET without token returns 403
- `test_404_project_not_found`: GET for non-existent project returns 404

**Class: TestDeleteDocument**
- `test_204_deletes_document`: DELETE /documents/{id} returns 204
- `test_403_without_auth`: DELETE without token returns 403
- `test_404_not_found`: DELETE for non-existent document returns 404
- `test_404_not_owned`: DELETE for other user's document returns 404

Example tests:
```python
import pytest
from io import BytesIO
from uuid import uuid4
from app.models import Project, Document
from app.services.encryption import get_encryption_service

class TestUploadDocument:
    """Contract tests for POST /api/projects/{id}/documents."""

    @pytest.mark.asyncio
    async def test_201_upload_text_file(self, authenticated_client, db_session):
        """Returns 201 on successful text file upload."""
        # Create project
        project = Project(
            user_id=authenticated_client.test_user.id,
            name="Test Project"
        )
        db_session.add(project)
        await db_session.commit()

        # Upload file
        files = {"file": ("test.txt", BytesIO(b"Hello World"), "text/plain")}
        response = await authenticated_client.post(
            f"/api/projects/{project.id}/documents",
            files=files
        )

        assert response.status_code == 201
        data = response.json()
        assert data["filename"] == "test.txt"
        assert "id" in data
        assert "created_at" in data

    @pytest.mark.asyncio
    async def test_400_invalid_content_type(self, authenticated_client, db_session):
        """Returns 400 for non-text files."""
        project = Project(
            user_id=authenticated_client.test_user.id,
            name="Test Project"
        )
        db_session.add(project)
        await db_session.commit()

        files = {"file": ("test.pdf", BytesIO(b"PDF content"), "application/pdf")}
        response = await authenticated_client.post(
            f"/api/projects/{project.id}/documents",
            files=files
        )

        assert response.status_code == 400
        assert "Only .txt and .md files allowed" in response.json()["detail"]

    @pytest.mark.asyncio
    async def test_413_file_too_large(self, authenticated_client, db_session):
        """Returns 413 for files over 1MB."""
        project = Project(
            user_id=authenticated_client.test_user.id,
            name="Test Project"
        )
        db_session.add(project)
        await db_session.commit()

        # Create file > 1MB
        large_content = b"x" * (1024 * 1024 + 1)
        files = {"file": ("large.txt", BytesIO(large_content), "text/plain")}
        response = await authenticated_client.post(
            f"/api/projects/{project.id}/documents",
            files=files
        )

        assert response.status_code == 413


class TestGetDocument:
    """Contract tests for GET /documents/{id}."""

    @pytest.mark.asyncio
    async def test_200_with_content(self, authenticated_client, db_session):
        """Returns document with decrypted content."""
        # Create project and document
        project = Project(
            user_id=authenticated_client.test_user.id,
            name="Test Project"
        )
        db_session.add(project)
        await db_session.commit()

        encrypted = get_encryption_service().encrypt_document("Test content here")
        doc = Document(
            project_id=project.id,
            filename="test.txt",
            content_encrypted=encrypted
        )
        db_session.add(doc)
        await db_session.commit()

        response = await authenticated_client.get(f"/api/documents/{doc.id}")

        assert response.status_code == 200
        data = response.json()
        assert data["content"] == "Test content here"
        assert data["filename"] == "test.txt"
```
  </action>
  <verify>
```bash
cd G:\git_repos\BA_assistant\backend
pytest tests/api/test_document_routes.py -v
```
All tests pass.
  </verify>
  <done>Documents router has contract tests for upload, list, get, search, delete with validation and error cases</done>
</task>

<task type="auto">
  <name>Task 2: Create Threads router contract tests</name>
  <files>backend/tests/api/test_thread_routes.py</files>
  <action>
Create `backend/tests/api/test_thread_routes.py` with contract tests for all thread endpoints.

**Class: TestCreateGlobalThread**
- `test_201_creates_projectless_thread`: POST /api/threads without project_id creates global thread
- `test_201_creates_project_thread`: POST /api/threads with project_id creates project thread
- `test_400_invalid_provider`: POST with invalid model_provider returns 400
- `test_403_without_auth`: POST without token returns 403
- `test_404_project_not_found`: POST with non-existent project_id returns 404
- `test_response_schema`: Response has id, project_id (nullable), title, model_provider

**Class: TestListAllThreads**
- `test_200_returns_paginated`: GET /api/threads returns paginated response
- `test_403_without_auth`: GET without token returns 403
- `test_pagination_params`: page and page_size params work correctly
- `test_response_schema`: Response has threads, total, page, page_size, has_more

**Class: TestCreateProjectThread**
- `test_201_creates_thread`: POST /api/projects/{id}/threads creates thread
- `test_400_invalid_provider`: POST with invalid model_provider returns 400
- `test_403_without_auth`: POST without token returns 403
- `test_404_project_not_found`: POST for non-existent project returns 404

**Class: TestListProjectThreads**
- `test_200_returns_array`: GET /api/projects/{id}/threads returns array
- `test_403_without_auth`: GET without token returns 403
- `test_404_project_not_found`: GET for non-existent project returns 404
- `test_message_count_included`: Response items have message_count field

**Class: TestGetThread**
- `test_200_with_messages`: GET /api/threads/{id} returns thread with messages
- `test_403_without_auth`: GET without token returns 403
- `test_404_not_found`: GET for non-existent thread returns 404
- `test_404_not_owned`: GET for other user's thread returns 404
- `test_messages_ordered_chronologically`: Messages sorted by created_at ASC

**Class: TestUpdateThread**
- `test_200_updates_title`: PATCH /api/threads/{id} with title updates thread
- `test_200_associates_project`: PATCH with project_id associates thread
- `test_400_already_associated`: PATCH trying to re-associate returns 400
- `test_403_without_auth`: PATCH without token returns 403
- `test_404_not_found`: PATCH for non-existent thread returns 404

**Class: TestDeleteThread**
- `test_204_deletes_thread`: DELETE /api/threads/{id} returns 204
- `test_403_without_auth`: DELETE without token returns 403
- `test_404_not_found`: DELETE for non-existent thread returns 404
- `test_404_not_owned`: DELETE for other user's thread returns 404

Example tests:
```python
import pytest
from uuid import uuid4
from datetime import datetime
from app.models import Project, Thread, Message

class TestCreateGlobalThread:
    """Contract tests for POST /api/threads."""

    @pytest.mark.asyncio
    async def test_201_creates_projectless_thread(self, authenticated_client):
        """Creates thread without project (global thread)."""
        response = await authenticated_client.post(
            "/api/threads",
            json={"title": "New Chat"}
        )

        assert response.status_code == 201
        data = response.json()
        assert data["title"] == "New Chat"
        assert data["project_id"] is None
        assert data["model_provider"] == "anthropic"  # default

    @pytest.mark.asyncio
    async def test_400_invalid_provider(self, authenticated_client):
        """Returns 400 for invalid model_provider."""
        response = await authenticated_client.post(
            "/api/threads",
            json={"title": "Test", "model_provider": "invalid_provider"}
        )

        assert response.status_code == 400
        assert "Invalid provider" in response.json()["detail"]


class TestListAllThreads:
    """Contract tests for GET /api/threads."""

    @pytest.mark.asyncio
    async def test_200_returns_paginated(self, authenticated_client, db_session):
        """Returns paginated thread list."""
        # Create a thread
        thread = Thread(
            user_id=authenticated_client.test_user.id,
            title="Test Thread",
            model_provider="anthropic",
            last_activity_at=datetime.utcnow()
        )
        db_session.add(thread)
        await db_session.commit()

        response = await authenticated_client.get("/api/threads")

        assert response.status_code == 200
        data = response.json()
        assert "threads" in data
        assert "total" in data
        assert "page" in data
        assert "page_size" in data
        assert "has_more" in data
        assert len(data["threads"]) >= 1


class TestGetThread:
    """Contract tests for GET /api/threads/{id}."""

    @pytest.mark.asyncio
    async def test_200_with_messages(self, authenticated_client, db_session):
        """Returns thread with messages."""
        # Create thread and messages
        thread = Thread(
            user_id=authenticated_client.test_user.id,
            title="Test Thread",
            model_provider="anthropic",
            last_activity_at=datetime.utcnow()
        )
        db_session.add(thread)
        await db_session.commit()

        msg = Message(
            thread_id=thread.id,
            role="user",
            content="Hello"
        )
        db_session.add(msg)
        await db_session.commit()

        response = await authenticated_client.get(f"/api/threads/{thread.id}")

        assert response.status_code == 200
        data = response.json()
        assert data["id"] == thread.id
        assert len(data["messages"]) == 1
        assert data["messages"][0]["content"] == "Hello"
```
  </action>
  <verify>
```bash
cd G:\git_repos\BA_assistant\backend
pytest tests/api/test_thread_routes.py -v
```
All tests pass.
  </verify>
  <done>Threads router has contract tests for global threads, project threads, pagination, update, and delete</done>
</task>

</tasks>

<verification>
Run all document and thread API tests:
```bash
cd G:\git_repos\BA_assistant\backend
pytest tests/api/test_document_routes.py tests/api/test_thread_routes.py -v --tb=short
```

Expected: All tests pass (35+ tests across 2 files)
</verification>

<success_criteria>
- test_document_routes.py has tests for upload, list, get, search, delete
- test_document_routes.py verifies 400 for invalid files, 413 for large files
- test_thread_routes.py has tests for global and project-scoped threads
- test_thread_routes.py verifies pagination, message counts, chronological order
- All tests verify correct status codes and response schemas
- All tests pass with `pytest tests/api/test_document_routes.py tests/api/test_thread_routes.py -v`
</success_criteria>

<output>
After completion, create `.planning/phases/30-backend-llm-api-tests/30-04-SUMMARY.md`
</output>

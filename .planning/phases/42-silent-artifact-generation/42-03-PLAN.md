---
phase: 42-silent-artifact-generation
plan: 03
type: execute
wave: 2
depends_on: ["42-02"]
files_modified:
  - frontend/lib/screens/conversation/widgets/generating_indicator.dart
  - frontend/lib/screens/conversation/widgets/generation_error_state.dart
  - frontend/lib/screens/conversation/conversation_screen.dart
  - frontend/lib/screens/conversation/widgets/chat_input.dart
autonomous: true

must_haves:
  truths:
    - "Clicking a preset artifact button shows a progress bar with typed label instead of message bubbles"
    - "Clicking a custom artifact submit shows a progress bar with generic 'Artifact' label"
    - "No user message bubble appears for button-triggered generation"
    - "No assistant text bubble appears for button-triggered generation"
    - "Progress bar replaces preset button area during generation (same physical space)"
    - "Loading label shows specific artifact type: 'Generating User Stories...'"
    - "After ~15 seconds, reassurance text 'This may take a moment...' appears"
    - "Cancel button is shown alongside progress bar"
    - "Cancel returns to normal state (preset buttons + active chat input)"
    - "Chat input field is DISABLED during silent generation"
    - "On failure, error state shows 'Something went wrong. Please try again.' with Retry and Dismiss"
    - "Retry re-triggers same artifact generation"
    - "Dismiss returns to normal preset buttons"
    - "Artifact card appears at bottom of message list after generation"
    - "On success, preset buttons return immediately"
    - "Regular typed messages work exactly as before"
  artifacts:
    - path: "frontend/lib/screens/conversation/widgets/generating_indicator.dart"
      provides: "GeneratingIndicator widget with progress bar, typed label, reassurance timer, cancel button"
    - path: "frontend/lib/screens/conversation/widgets/generation_error_state.dart"
      provides: "GenerationErrorState widget with friendly error message, Retry and Dismiss buttons"
    - path: "frontend/lib/screens/conversation/conversation_screen.dart"
      provides: "Screen integration wiring generateArtifact to picker, indicator in message list, disabled input"
      contains: "GeneratingIndicator"
    - path: "frontend/lib/screens/conversation/widgets/chat_input.dart"
      provides: "Updated hint text for generating state"
      contains: "Generating artifact"
  key_links:
    - from: "conversation_screen.dart _showArtifactTypePicker"
      to: "provider.generateArtifact"
      via: "method call after selection"
      pattern: "provider\\.generateArtifact"
    - from: "conversation_screen.dart _buildMessageList"
      to: "GeneratingIndicator"
      via: "conditional rendering in ListView"
      pattern: "GeneratingIndicator"
    - from: "conversation_screen.dart inputEnabled"
      to: "provider.isGeneratingArtifact"
      via: "boolean AND condition"
      pattern: "isGeneratingArtifact"
---

<objective>
Create the UI widgets and screen integration for silent artifact generation.

Purpose: Wire up the frontend UI so that clicking an artifact preset button triggers `generateArtifact()` (not `sendMessage()`), shows a progress indicator in the button area, handles errors with friendly messages, and returns to normal state on completion. This delivers the visible UX of Layer 4 deduplication - no message bubbles for button-triggered generation.

Output: Two new widget files (GeneratingIndicator, GenerationErrorState), modified conversation_screen.dart with wiring, modified chat_input.dart with generating hint text.
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-silent-artifact-generation/42-02-SUMMARY.md
@frontend/lib/screens/conversation/conversation_screen.dart
@frontend/lib/screens/conversation/widgets/chat_input.dart
@frontend/lib/screens/conversation/widgets/artifact_type_picker.dart
@frontend/lib/screens/conversation/widgets/error_state_message.dart
@frontend/lib/providers/conversation_provider.dart
@frontend/lib/models/artifact.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GeneratingIndicator and GenerationErrorState widgets</name>
  <files>
    frontend/lib/screens/conversation/widgets/generating_indicator.dart
    frontend/lib/screens/conversation/widgets/generation_error_state.dart
  </files>
  <action>
  **Create `frontend/lib/screens/conversation/widgets/generating_indicator.dart`:**

  A StatefulWidget that shows an indeterminate horizontal progress bar with a typed label and optional cancel button. After a configurable delay (~15 seconds), shows reassurance text "This may take a moment...".

  Requirements from CONTEXT.md (locked decisions):
  - Indeterminate horizontal progress bar (`LinearProgressIndicator(value: null)`)
  - Label below showing "Generating [Type]..." where Type matches button clicked
  - After ~15 seconds, add reassurance text below
  - Cancel button alongside progress bar
  - Uses `surfaceContainerHighest` background with rounded corners to match existing card patterns

  Implementation:
  ```dart
  import 'dart:async';
  import 'package:flutter/material.dart';

  /// Progress indicator for silent artifact generation.
  ///
  /// Shows indeterminate progress bar with typed label,
  /// optional cancel button, and reassurance text after delay.
  class GeneratingIndicator extends StatefulWidget {
    /// Type of artifact being generated (for label: "Generating [type]...")
    final String artifactType;

    /// Callback when user cancels generation
    final VoidCallback? onCancel;

    /// Delay before showing reassurance text
    final Duration reassuranceDelay;

    const GeneratingIndicator({
      super.key,
      required this.artifactType,
      this.onCancel,
      this.reassuranceDelay = const Duration(seconds: 15),
    });

    @override
    State<GeneratingIndicator> createState() => _GeneratingIndicatorState();
  }

  class _GeneratingIndicatorState extends State<GeneratingIndicator> {
    bool _showReassurance = false;
    Timer? _reassuranceTimer;

    @override
    void initState() {
      super.initState();
      _reassuranceTimer = Timer(widget.reassuranceDelay, () {
        if (mounted) {
          setState(() => _showReassurance = true);
        }
      });
    }

    @override
    void dispose() {
      _reassuranceTimer?.cancel();
      super.dispose();
    }

    @override
    Widget build(BuildContext context) {
      final theme = Theme.of(context);

      return Container(
        margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: theme.colorScheme.surfaceContainerHighest,
          borderRadius: BorderRadius.circular(12),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          mainAxisSize: MainAxisSize.min,
          children: [
            // Indeterminate progress bar
            ClipRRect(
              borderRadius: BorderRadius.circular(4),
              child: LinearProgressIndicator(
                value: null, // Indeterminate
                backgroundColor: theme.colorScheme.surfaceContainerHighest,
              ),
            ),
            const SizedBox(height: 12),

            // Label row with cancel button
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Expanded(
                  child: Text(
                    'Generating ${widget.artifactType}...',
                    style: theme.textTheme.bodyMedium?.copyWith(
                      color: theme.colorScheme.onSurfaceVariant,
                    ),
                  ),
                ),
                if (widget.onCancel != null)
                  TextButton(
                    onPressed: widget.onCancel,
                    child: const Text('Cancel'),
                  ),
              ],
            ),

            // Reassurance text (after delay)
            if (_showReassurance) ...[
              const SizedBox(height: 4),
              Text(
                'This may take a moment...',
                style: theme.textTheme.bodySmall?.copyWith(
                  color: theme.colorScheme.onSurfaceVariant,
                  fontStyle: FontStyle.italic,
                ),
              ),
            ],
          ],
        ),
      );
    }
  }
  ```

  **Create `frontend/lib/screens/conversation/widgets/generation_error_state.dart`:**

  A StatelessWidget showing a friendly error message with Retry and Dismiss buttons. No technical details per CONTEXT.md.

  ```dart
  import 'package:flutter/material.dart';

  /// Error state shown when silent artifact generation fails.
  ///
  /// Shows generic user-friendly error message with Retry and Dismiss actions.
  /// No technical error details are shown (per CONTEXT.md decision).
  class GenerationErrorState extends StatelessWidget {
    /// Callback when user taps Retry
    final VoidCallback onRetry;

    /// Callback when user taps Dismiss
    final VoidCallback onDismiss;

    const GenerationErrorState({
      super.key,
      required this.onRetry,
      required this.onDismiss,
    });

    @override
    Widget build(BuildContext context) {
      final theme = Theme.of(context);

      return Container(
        margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: theme.colorScheme.errorContainer,
          borderRadius: BorderRadius.circular(12),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          mainAxisSize: MainAxisSize.min,
          children: [
            // Error icon + message
            Row(
              children: [
                Icon(
                  Icons.error_outline,
                  color: theme.colorScheme.onErrorContainer,
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: Text(
                    'Something went wrong. Please try again.',
                    style: theme.textTheme.bodyMedium?.copyWith(
                      color: theme.colorScheme.onErrorContainer,
                    ),
                  ),
                ),
              ],
            ),
            const SizedBox(height: 12),

            // Action buttons
            Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                TextButton(
                  onPressed: onDismiss,
                  child: const Text('Dismiss'),
                ),
                const SizedBox(width: 8),
                FilledButton.tonal(
                  onPressed: onRetry,
                  child: const Text('Retry'),
                ),
              ],
            ),
          ],
        ),
      );
    }
  }
  ```
  </action>
  <verify>
  1. Run: `flutter analyze frontend/lib/screens/conversation/widgets/generating_indicator.dart frontend/lib/screens/conversation/widgets/generation_error_state.dart 2>&1 | tail -10` - no errors
  2. Verify files exist: `ls -la frontend/lib/screens/conversation/widgets/generating_indicator.dart frontend/lib/screens/conversation/widgets/generation_error_state.dart`
  </verify>
  <done>
  - GeneratingIndicator widget created with indeterminate progress bar, typed label, cancel button, and 15s reassurance text
  - GenerationErrorState widget created with friendly error message, Retry and Dismiss buttons
  - Both widgets follow existing card patterns (margin, padding, rounded corners)
  - No technical error details shown to user
  - Both compile without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire up conversation screen and chat input for silent generation</name>
  <files>
    frontend/lib/screens/conversation/conversation_screen.dart
    frontend/lib/screens/conversation/widgets/chat_input.dart
  </files>
  <action>
  **Modify `frontend/lib/screens/conversation/conversation_screen.dart`:**

  1. **Add imports** (after existing widget imports):
     ```dart
     import 'widgets/generating_indicator.dart';
     import 'widgets/generation_error_state.dart';
     ```

  2. **Update `_showArtifactTypePicker()`** (line ~198-216): Change from `provider.sendMessage(prompt)` to `provider.generateArtifact(prompt, artifactType)`:
     ```dart
     Future<void> _showArtifactTypePicker() async {
       final selection = await ArtifactTypePicker.show(context);

       if (selection != null && mounted) {
         final provider = context.read<ConversationProvider>();

         // Build prompt and artifact type label
         String prompt;
         String artifactType;

         if (selection.isCustom) {
           prompt = selection.customPrompt!;
           artifactType = 'Artifact'; // Generic label for custom
         } else {
           prompt = 'Generate ${selection.presetType!.displayName} from this conversation.';
           artifactType = selection.presetType!.displayName;
         }

         // Call generateArtifact (NOT sendMessage) for silent generation
         provider.generateArtifact(prompt, artifactType);
       }
     }
     ```

  3. **Update `inputEnabled` condition** (line ~259-260): Add `isGeneratingArtifact` check:
     ```dart
     final inputEnabled = !provider.isStreaming &&
         !provider.isGeneratingArtifact &&  // NEW - disable during generation
         budgetProvider.status != BudgetStatus.exhausted;
     ```

  4. **Update error banner section** (line ~312-331): Hide the MaterialBanner error when it's a generation error (generation errors show in the GenerationErrorState widget instead):
     ```dart
     // Error banner with connection-specific message
     // Hide for generation errors - those show in GenerationErrorState widget
     if (provider.error != null && !provider.lastOperationWasGeneration)
       MaterialBanner(
         // ... existing MaterialBanner code unchanged
       ),
     ```

  5. **Update `_buildMessageList()`** (line ~371-468): Add GeneratingIndicator and GenerationErrorState to the list:

     First, update the empty state check to also account for generating state:
     ```dart
     if (messages.isEmpty && !provider.isStreaming && !provider.isGeneratingArtifact) {
     ```

     Then update the extra item count and rendering. Replace the current `hasExtraItem` logic:
     ```dart
     // Calculate extra items for streaming, error, and generation states
     final hasStreamingItem = provider.isStreaming;
     final hasPartialErrorItem = provider.hasPartialContent && !provider.isStreaming;
     final hasGeneratingItem = provider.isGeneratingArtifact;
     final hasGenerationError = provider.canRetryGeneration;

     final artifactCount = provider.artifacts.length;
     final extraItemCount = (hasStreamingItem ? 1 : 0) +
         (hasPartialErrorItem ? 1 : 0) +
         (hasGeneratingItem ? 1 : 0) +
         (hasGenerationError ? 1 : 0);

     return ListView.builder(
       controller: _scrollController,
       padding: const EdgeInsets.symmetric(vertical: 16),
       itemCount: messages.length + artifactCount + extraItemCount,
       itemBuilder: (context, index) {
         // Regular messages
         if (index < messages.length) {
           final message = messages[index];
           return GestureDetector(
             onLongPress: () => _showMessageOptions(context, message),
             child: MessageBubble(
               message: message,
               projectId: widget.projectId,
             ),
           );
         }

         // Artifacts (after messages)
         if (index < messages.length + artifactCount) {
           final artifactIndex = index - messages.length;
           final artifact = provider.artifacts[artifactIndex];
           return ArtifactCard(
             artifact: artifact,
             threadId: widget.threadId,
           );
         }

         // Special states (after artifacts)
         final specialIndex = index - messages.length - artifactCount;
         int currentSpecialItem = 0;

         // Generating indicator
         if (hasGeneratingItem) {
           if (specialIndex == currentSpecialItem) {
             return GeneratingIndicator(
               artifactType: provider.generatingArtifactType ?? 'Artifact',
               onCancel: () {
                 provider.cancelGeneration();
               },
             );
           }
           currentSpecialItem++;
         }

         // Generation error state
         if (hasGenerationError) {
           if (specialIndex == currentSpecialItem) {
             return GenerationErrorState(
               onRetry: provider.retryLastGeneration,
               onDismiss: provider.clearError,
             );
           }
           currentSpecialItem++;
         }

         // Streaming message (existing)
         if (hasStreamingItem) {
           if (specialIndex == currentSpecialItem) {
             return StreamingMessage(
               text: provider.streamingText,
               statusMessage: provider.statusMessage,
             );
           }
           currentSpecialItem++;
         }

         // Error state partial message (existing)
         if (hasPartialErrorItem) {
           if (specialIndex == currentSpecialItem) {
             return ErrorStateMessage(
               partialText: provider.streamingText,
             );
           }
           currentSpecialItem++;
         }

         return const SizedBox.shrink();
       },
     );
     ```

  **Modify `frontend/lib/screens/conversation/widgets/chat_input.dart`:**

  6. **Add `isGenerating` parameter** to ChatInput for context-aware placeholder:
     ```dart
     class ChatInput extends StatefulWidget {
       final void Function(String message) onSend;
       final VoidCallback? onGenerateArtifact;
       final bool enabled;
       final bool isGenerating;  // NEW

       const ChatInput({
         super.key,
         required this.onSend,
         this.onGenerateArtifact,
         this.enabled = true,
         this.isGenerating = false,  // NEW
       });
     ```

  7. **Update hint text** in the build method to show generating-specific text:
     ```dart
     hintText: widget.enabled
         ? 'Type a message...'
         : (widget.isGenerating
             ? 'Generating artifact...'
             : 'Waiting for response...'),
     ```

  8. **Pass isGenerating to ChatInput** in conversation_screen.dart:
     ```dart
     ChatInput(
       onSend: (message) {
         provider.sendMessage(message);
         budgetProvider.refresh();
       },
       onGenerateArtifact: _showArtifactTypePicker,
       enabled: inputEnabled,
       isGenerating: provider.isGeneratingArtifact,  // NEW
     ),
     ```

  **What NOT to change:**
  - Do NOT auto-scroll when artifact appears (user may have scrolled up per CONTEXT.md)
  - Do NOT add success animation (per CONTEXT.md: preset buttons return immediately)
  - Do NOT show technical error details (per CONTEXT.md: generic message only)
  </action>
  <verify>
  1. Run: `cd /Users/a1testingmac/projects/XtraSkill/frontend && flutter analyze lib/screens/conversation/ 2>&1 | tail -15` - no errors
  2. Verify imports: `grep -n "generating_indicator\|generation_error_state" lib/screens/conversation/conversation_screen.dart`
  3. Verify wiring: `grep -n "generateArtifact\|isGeneratingArtifact\|GeneratingIndicator\|GenerationErrorState" lib/screens/conversation/conversation_screen.dart`
  4. Run all frontend tests: `cd /Users/a1testingmac/projects/XtraSkill/frontend && flutter test --reporter compact 2>&1 | tail -20`
  </verify>
  <done>
  - _showArtifactTypePicker calls provider.generateArtifact() (not sendMessage)
  - GeneratingIndicator appears in message list during generation
  - GenerationErrorState appears on failed generation with Retry/Dismiss
  - Chat input is disabled during generation with "Generating artifact..." hint
  - inputEnabled includes isGeneratingArtifact check
  - MaterialBanner error hidden for generation errors (shown in dedicated widget)
  - Artifact card appears naturally in list after generation
  - No auto-scroll on artifact appearance
  - Regular chat completely unaffected
  - All existing tests pass
  </done>
</task>

</tasks>

<verification>
1. Clicking preset artifact button shows GeneratingIndicator (progress bar + typed label)
2. No user or assistant message bubbles appear for button-triggered generation
3. Chat input shows "Generating artifact..." and is disabled during generation
4. Cancel button clears generating state and returns to normal
5. After ~15s, reassurance text appears
6. On failure, GenerationErrorState shows with friendly error message
7. Retry re-triggers same generation
8. Dismiss returns to normal preset buttons
9. Artifact card appears at bottom of message list on success
10. Regular typed messages work exactly as before
11. All frontend tests pass
12. Flutter analyze shows no errors
</verification>

<success_criteria>
Complete UI integration for silent artifact generation: GeneratingIndicator widget replaces preset buttons during generation, GenerationErrorState shows on failure with Retry/Dismiss, chat input disabled with generating hint text, artifact picker calls generateArtifact() instead of sendMessage(), and artifact card appears naturally in the message list on success. No message bubbles for button-triggered generation.
</success_criteria>

<output>
After completion, create `.planning/phases/42-silent-artifact-generation/42-03-SUMMARY.md`
</output>

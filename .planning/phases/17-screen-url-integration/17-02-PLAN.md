---
phase: 17-screen-url-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/providers/conversation_provider.dart
  - frontend/lib/screens/conversation/conversation_screen.dart
  - frontend/lib/main.dart
autonomous: true

must_haves:
  truths:
    - "User navigating to deleted thread sees 'Thread not found' message"
    - "User can navigate back to project from thread not-found screen"
    - "Browser back/forward buttons work correctly on nested routes"
    - "Valid thread still loads normally"
  artifacts:
    - path: "frontend/lib/providers/conversation_provider.dart"
      provides: "isNotFound flag for 404 detection"
      contains: "isNotFound"
    - path: "frontend/lib/screens/conversation/conversation_screen.dart"
      provides: "Not-found state rendering"
      contains: "ResourceNotFoundState"
    - path: "frontend/lib/main.dart"
      provides: "GoRouter browser history option"
      contains: "optionURLReflectsImperativeAPIs"
  key_links:
    - from: "frontend/lib/providers/conversation_provider.dart"
      to: "Exception('Thread not found')"
      via: "error message parsing"
      pattern: "contains.*not found"
    - from: "frontend/lib/screens/conversation/conversation_screen.dart"
      to: "frontend/lib/widgets/resource_not_found_state.dart"
      via: "import and usage"
      pattern: "ResourceNotFoundState"
---

<objective>
Implement thread not-found state (ERR-03) and browser back/forward consistency (ROUTE-02).

Purpose: Users who navigate to deleted threads see "Thread not found" with navigation to parent project. Browser history behaves correctly with nested routes.

Output: ConversationProvider.isNotFound flag, ConversationScreen not-found UI, GoRouter browser history option.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-screen-url-integration/17-RESEARCH.md

@frontend/lib/providers/conversation_provider.dart
@frontend/lib/screens/conversation/conversation_screen.dart
@frontend/lib/services/thread_service.dart
@frontend/lib/main.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isNotFound flag to ConversationProvider</name>
  <files>frontend/lib/providers/conversation_provider.dart</files>
  <action>
Add `_isNotFound` flag to distinguish 404 from other errors:

1. Add private field and getter after `_error`:
```dart
/// Whether the thread was not found (404)
bool _isNotFound = false;

/// Not-found state - true when API returned 404
bool get isNotFound => _isNotFound;
```

2. Update `loadThread()` to detect 404:
```dart
Future<void> loadThread(String threadId) async {
  _loading = true;
  _error = null;
  _isNotFound = false;  // Reset on new load
  notifyListeners();

  try {
    _thread = await _threadService.getThread(threadId);
    _messages = _thread?.messages ?? [];
    _loading = false;
    notifyListeners();
  } catch (e) {
    final errorMessage = e.toString();
    // Check if it's a 404 "not found" error (from thread_service.dart)
    if (errorMessage.contains('not found') ||
        errorMessage.contains('404')) {
      _isNotFound = true;
      _error = null;  // Not a "real" error, just not found
    } else {
      _error = errorMessage;
      _isNotFound = false;
    }
    _loading = false;
    notifyListeners();
    // Remove rethrow - let screen handle the not-found state
  }
}
```

3. Update `clearConversation()` to reset isNotFound:
```dart
void clearConversation() {
  _thread = null;
  _messages = [];
  _streamingText = '';
  _statusMessage = null;
  _isStreaming = false;
  _error = null;
  _isNotFound = false;  // Add this
  _loading = false;
  notifyListeners();
}
```

4. Update `clearError()` to also clear isNotFound:
```dart
void clearError() {
  _error = null;
  _isNotFound = false;  // Add this
  _lastFailedMessage = null;
  notifyListeners();
}
```

Note: Remove the `rethrow` from loadThread() - it was causing uncaught exceptions. Let the screen handle not-found via the isNotFound flag instead.
  </action>
  <verify>flutter analyze frontend/lib/providers/conversation_provider.dart</verify>
  <done>ConversationProvider has isNotFound getter that returns true when API returned 404 for thread lookup</done>
</task>

<task type="auto">
  <name>Task 2: Update ConversationScreen for not-found state</name>
  <files>frontend/lib/screens/conversation/conversation_screen.dart</files>
  <action>
Add ResourceNotFoundState import and update build() to show not-found UI:

1. Add imports at top:
```dart
import 'package:go_router/go_router.dart';
import '../../widgets/resource_not_found_state.dart';
```

2. Update the Consumer builder to check isNotFound. Insert AFTER loading check, BEFORE the Scaffold:
```dart
builder: (context, provider, child) {
  // ... existing scroll to bottom callback

  // Show loading indicator (full screen, not in scaffold)
  if (provider.loading) {
    return const Scaffold(
      body: Center(child: CircularProgressIndicator()),
    );
  }

  // Show not-found state (ERR-03) - full screen, not in scaffold
  if (provider.isNotFound) {
    return Scaffold(
      appBar: AppBar(title: const Text('Thread')),
      body: ResourceNotFoundState(
        icon: Icons.chat_bubble_off_outlined,
        title: 'Thread not found',
        message: 'This conversation may have been deleted or you may not have access to it.',
        buttonLabel: 'Back to Project',
        onPressed: () => context.go('/projects/${widget.projectId}'),
      ),
    );
  }

  return Scaffold(
    appBar: AppBar(
      // ... existing appbar
    ),
    body: Column(
      // ... existing body
    ),
  );
}
```

Key points:
- Uses `widget.projectId` for "Back to Project" navigation (not generic /home)
- Returns full Scaffold with AppBar for not-found state (consistent layout)
- Check isNotFound after loading (so loading spinner shows during fetch)
  </action>
  <verify>flutter analyze frontend/lib/screens/conversation/conversation_screen.dart</verify>
  <done>ConversationScreen shows ResourceNotFoundState when provider.isNotFound is true, with "Back to Project" navigation using projectId</done>
</task>

<task type="auto">
  <name>Task 3: Add GoRouter browser history option</name>
  <files>frontend/lib/main.dart</files>
  <action>
Add `GoRouter.optionURLReflectsImperativeAPIs = true` for consistent browser history with imperative navigation.

In main() function, add this line BEFORE `usePathUrlStrategy()`:
```dart
// Enable URL reflection for browser history consistency (ROUTE-02)
// Ensures browser back/forward works correctly with context.go() calls
GoRouter.optionURLReflectsImperativeAPIs = true;

// Use path-based URLs instead of hash-based for web
usePathUrlStrategy();
```

This setting ensures that:
- Browser back button returns to previous URL correctly
- Browser forward button works after using back
- History order matches navigation order even with imperative APIs (context.go, context.push)

Note: This is a static setting on GoRouter class, set before app runs.
  </action>
  <verify>flutter analyze frontend/lib/main.dart && flutter build web --no-tree-shake-icons</verify>
  <done>GoRouter.optionURLReflectsImperativeAPIs = true is set in main() before usePathUrlStrategy()</done>
</task>

</tasks>

<verification>
1. `flutter analyze frontend/lib/providers/conversation_provider.dart` - No issues
2. `flutter analyze frontend/lib/screens/conversation/conversation_screen.dart` - No issues
3. `flutter analyze frontend/lib/main.dart` - No issues
4. `flutter build web --no-tree-shake-icons` - Build succeeds
</verification>

<success_criteria>
- ConversationProvider.isNotFound returns true on 404, false otherwise
- ConversationScreen shows "Thread not found" with "Back to Project" for 404
- "Back to Project" navigates to `/projects/{projectId}` (not /home)
- GoRouter.optionURLReflectsImperativeAPIs set to true
- All files pass flutter analyze
- Web build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/17-screen-url-integration/17-02-SUMMARY.md`
</output>

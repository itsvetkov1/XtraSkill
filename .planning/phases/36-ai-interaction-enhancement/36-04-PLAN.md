---
phase: 36-ai-interaction-enhancement
plan: 04
type: execute
wave: 2
depends_on: ["36-01", "36-02"]
files_modified:
  - frontend/lib/screens/conversation/widgets/source_chips.dart
  - frontend/lib/screens/conversation/widgets/message_bubble.dart
  - frontend/lib/providers/conversation_provider.dart
autonomous: false
user_setup: []

must_haves:
  truths:
    - "AI messages show source chips when documents were used"
    - "Source chips display document filenames"
    - "Clicking source chip opens Document Viewer"
    - "No sources section shown if no documents used (SRC-04)"
    - "Source chips use Wrap widget for overflow handling (PITFALL-13)"
  artifacts:
    - path: "frontend/lib/screens/conversation/widgets/source_chips.dart"
      provides: "Collapsible source chips widget"
      exports: ["SourceChips"]
    - path: "frontend/lib/screens/conversation/widgets/message_bubble.dart"
      provides: "MessageBubble with source attribution"
      contains: "SourceChips"
    - path: "frontend/lib/providers/conversation_provider.dart"
      provides: "Message-to-sources mapping"
      contains: "documentsUsed"
  key_links:
    - from: "SourceChips"
      to: "Document Viewer"
      via: "onSourceTap callback opening bottom sheet"
      pattern: "onSourceTap.*documentId"
    - from: "MessageBubble"
      to: "SourceChips"
      via: "conditional render when documentsUsed not empty"
      pattern: "if.*documentsUsed.*isNotEmpty"
---

<objective>
Create source attribution UI showing which documents informed AI responses

Purpose: Enable users to see and navigate to documents that AI referenced (SRC-01 through SRC-04)
Output: SourceChips widget, MessageBubble with source display, Document Viewer navigation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-ai-interaction-enhancement/36-RESEARCH.md
@.planning/phases/36-ai-interaction-enhancement/36-01-SUMMARY.md
@.planning/phases/36-ai-interaction-enhancement/36-02-SUMMARY.md

@frontend/lib/screens/conversation/widgets/message_bubble.dart
@frontend/lib/services/ai_service.dart
@frontend/lib/models/message.dart
@frontend/lib/providers/conversation_provider.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SourceChips widget</name>
  <files>frontend/lib/screens/conversation/widgets/source_chips.dart</files>
  <action>
Create `frontend/lib/screens/conversation/widgets/source_chips.dart`:

```dart
/// Source attribution chips showing documents used in AI response.
library;

import 'package:flutter/material.dart';

import '../../../services/ai_service.dart';

/// Collapsible section showing source documents used in a response
class SourceChips extends StatefulWidget {
  /// List of document sources
  final List<DocumentSource> sources;

  /// Callback when a source chip is tapped
  final void Function(String documentId, String filename)? onSourceTap;

  const SourceChips({
    super.key,
    required this.sources,
    this.onSourceTap,
  });

  @override
  State<SourceChips> createState() => _SourceChipsState();
}

class _SourceChipsState extends State<SourceChips> {
  bool _expanded = false;
  static const int _maxVisibleCollapsed = 3;

  @override
  Widget build(BuildContext context) {
    // SRC-04: Don't show anything if no documents used
    if (widget.sources.isEmpty) return const SizedBox.shrink();

    final theme = Theme.of(context);

    return Padding(
      padding: const EdgeInsets.only(top: 8),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Collapsible header per CONTEXT.md
          InkWell(
            onTap: () => setState(() => _expanded = !_expanded),
            borderRadius: BorderRadius.circular(4),
            child: Padding(
              padding: const EdgeInsets.symmetric(vertical: 4, horizontal: 4),
              child: Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Icon(
                    Icons.source_outlined,
                    size: 16,
                    color: theme.colorScheme.onSurfaceVariant,
                  ),
                  const SizedBox(width: 4),
                  Text(
                    _expanded
                        ? 'Hide sources'
                        : '${widget.sources.length} source${widget.sources.length == 1 ? '' : 's'} used',
                    style: theme.textTheme.bodySmall?.copyWith(
                      color: theme.colorScheme.onSurfaceVariant,
                    ),
                  ),
                  Icon(
                    _expanded ? Icons.expand_less : Icons.expand_more,
                    size: 16,
                    color: theme.colorScheme.onSurfaceVariant,
                  ),
                ],
              ),
            ),
          ),

          // Chips - only when expanded
          if (_expanded) _buildChips(theme),
        ],
      ),
    );
  }

  Widget _buildChips(ThemeData theme) {
    // Per PITFALL-13: Use Wrap widget for overflow handling
    final visibleSources = widget.sources;

    return Padding(
      padding: const EdgeInsets.only(top: 4),
      child: Wrap(
        spacing: 8,
        runSpacing: 4,
        children: [
          for (final source in visibleSources)
            ActionChip(
              avatar: Icon(
                Icons.description_outlined,
                size: 16,
                color: theme.colorScheme.onSecondaryContainer,
              ),
              label: Text(
                _truncateFilename(source.filename),
                style: TextStyle(
                  fontSize: 12,
                  color: theme.colorScheme.onSecondaryContainer,
                ),
              ),
              tooltip: source.filename, // Full name on hover
              backgroundColor: theme.colorScheme.secondaryContainer.withOpacity(0.5),
              side: BorderSide(
                color: theme.colorScheme.outline.withOpacity(0.5),
              ),
              onPressed: () => widget.onSourceTap?.call(source.id, source.filename),
            ),
        ],
      ),
    );
  }

  String _truncateFilename(String filename) {
    if (filename.length <= 25) return filename;
    // Keep extension visible
    final dotIndex = filename.lastIndexOf('.');
    if (dotIndex > 0 && filename.length - dotIndex <= 5) {
      final ext = filename.substring(dotIndex);
      final name = filename.substring(0, dotIndex);
      if (name.length > 20) {
        return '${name.substring(0, 17)}...$ext';
      }
    }
    return '${filename.substring(0, 22)}...';
  }
}
```

Per SRC-01, SRC-02: Show source chips with document names.
Per SRC-04: Empty widget when no sources.
Per PITFALL-13: Wrap widget for overflow, truncate long filenames with tooltip.
Per CONTEXT.md: Collapsible "X sources used" header.
  </action>
  <verify>
```bash
cd frontend && flutter analyze lib/screens/conversation/widgets/source_chips.dart
```
  </verify>
  <done>
SourceChips widget created with:
- Collapsible header showing source count
- Wrap layout for chip overflow (PITFALL-13)
- Truncated filenames with full name tooltip
- Empty when no sources (SRC-04)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Message model and ConversationProvider for source tracking</name>
  <files>frontend/lib/models/message.dart, frontend/lib/providers/conversation_provider.dart</files>
  <action>
1. Update `frontend/lib/models/message.dart` to include document sources:

```dart
/// Message model for conversation messages.
library;

import '../services/ai_service.dart';

/// Role of the message sender
enum MessageRole {
  user,
  assistant,
}

/// Message in a conversation thread
class Message {
  final String id;
  final MessageRole role;
  final String content;
  final DateTime createdAt;
  final List<DocumentSource> documentsUsed; // NEW: source attribution

  Message({
    required this.id,
    required this.role,
    required this.content,
    required this.createdAt,
    this.documentsUsed = const [], // Default empty per SRC-04
  });

  factory Message.fromJson(Map<String, dynamic> json) {
    return Message(
      id: json['id'],
      role: json['role'] == 'user' ? MessageRole.user : MessageRole.assistant,
      content: json['content'],
      createdAt: DateTime.parse(json['created_at']),
      // documentsUsed not in existing backend response, will be empty
      documentsUsed: const [],
    );
  }
}
```

2. Update `frontend/lib/providers/conversation_provider.dart`:

In sendMessage method, update MessageCompleteEvent handling to include sources:

```dart
} else if (event is MessageCompleteEvent) {
  // Add assistant message to list with source attribution
  final assistantMessage = Message(
    id: 'temp-assistant-${DateTime.now().millisecondsSinceEpoch}',
    role: MessageRole.assistant,
    content: _streamingText.isNotEmpty ? _streamingText : event.content,
    createdAt: DateTime.now(),
    documentsUsed: event.documentsUsed, // NEW: capture sources
  );
  _messages.add(assistantMessage);

  // ... rest of existing code
}
```

The import for DocumentSource should already be available since we import ai_service.dart.
  </action>
  <verify>
```bash
cd frontend && flutter analyze lib/models/message.dart lib/providers/conversation_provider.dart
```
  </verify>
  <done>
- Message model has documentsUsed field
- ConversationProvider captures documentsUsed from MessageCompleteEvent
  </done>
</task>

<task type="auto">
  <name>Task 3: Update MessageBubble to display source chips and wire Document Viewer</name>
  <files>frontend/lib/screens/conversation/widgets/message_bubble.dart</files>
  <action>
Update `frontend/lib/screens/conversation/widgets/message_bubble.dart` to show source chips for assistant messages:

```dart
/// Message bubble widget for displaying conversation messages.
library;

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:go_router/go_router.dart';

import '../../../models/message.dart';
import 'source_chips.dart';

/// Message bubble displaying user or assistant message
class MessageBubble extends StatelessWidget {
  /// The message to display
  final Message message;

  /// Project ID for document navigation (optional)
  final String? projectId;

  const MessageBubble({
    super.key,
    required this.message,
    this.projectId,
  });

  @override
  Widget build(BuildContext context) {
    final isUser = message.role == MessageRole.user;
    final theme = Theme.of(context);

    final textWidget = SelectableText(
      message.content,
      style: TextStyle(
        fontSize: 15,
        height: 1.4,
        color: isUser
            ? theme.colorScheme.onPrimary
            : theme.colorScheme.onSurface,
      ),
    );

    return Align(
      alignment: isUser ? Alignment.centerRight : Alignment.centerLeft,
      child: Container(
        constraints: BoxConstraints(
          maxWidth: MediaQuery.of(context).size.width * 0.8,
        ),
        margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 6),
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: isUser
              ? theme.colorScheme.primary
              : theme.colorScheme.surfaceContainerHighest,
          borderRadius: BorderRadius.only(
            topLeft: const Radius.circular(16),
            topRight: const Radius.circular(16),
            bottomLeft: Radius.circular(isUser ? 16 : 4),
            bottomRight: Radius.circular(isUser ? 4 : 16),
          ),
        ),
        child: isUser
            ? textWidget
            : Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisSize: MainAxisSize.min,
                children: [
                  textWidget,
                  // Source chips for assistant messages (SRC-01, SRC-02)
                  if (message.documentsUsed.isNotEmpty)
                    SourceChips(
                      sources: message.documentsUsed,
                      onSourceTap: (documentId, filename) =>
                          _openDocument(context, documentId, filename),
                    ),
                  _buildCopyButton(context, theme),
                ],
              ),
      ),
    );
  }

  /// Opens document in Document Viewer (SRC-03)
  void _openDocument(BuildContext context, String documentId, String filename) {
    if (projectId != null) {
      // Navigate to document viewer within project context
      context.push('/projects/$projectId/documents/$documentId');
    } else {
      // Show document in bottom sheet preview for project-less threads
      _showDocumentPreview(context, documentId, filename);
    }
  }

  /// Show document in bottom sheet for project-less threads
  void _showDocumentPreview(BuildContext context, String documentId, String filename) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(16)),
      ),
      builder: (sheetContext) => DraggableScrollableSheet(
        initialChildSize: 0.6,
        minChildSize: 0.3,
        maxChildSize: 0.9,
        expand: false,
        builder: (_, scrollController) => Column(
          children: [
            // Handle bar
            Container(
              margin: const EdgeInsets.only(top: 8),
              width: 40,
              height: 4,
              decoration: BoxDecoration(
                color: Theme.of(context).colorScheme.outline.withOpacity(0.5),
                borderRadius: BorderRadius.circular(2),
              ),
            ),
            // Header
            Padding(
              padding: const EdgeInsets.all(16),
              child: Row(
                children: [
                  const Icon(Icons.description_outlined),
                  const SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      filename,
                      style: Theme.of(context).textTheme.titleMedium,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ),
                  IconButton(
                    icon: const Icon(Icons.close),
                    onPressed: () => Navigator.pop(sheetContext),
                  ),
                ],
              ),
            ),
            const Divider(height: 1),
            // Content placeholder - would need document fetch
            Expanded(
              child: Center(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(
                      Icons.description_outlined,
                      size: 48,
                      color: Theme.of(context).colorScheme.outline,
                    ),
                    const SizedBox(height: 16),
                    Text(
                      'Document: $filename',
                      style: Theme.of(context).textTheme.bodyLarge,
                    ),
                    const SizedBox(height: 8),
                    Text(
                      'ID: $documentId',
                      style: Theme.of(context).textTheme.bodySmall,
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildCopyButton(BuildContext context, ThemeData theme) {
    return Align(
      alignment: Alignment.centerRight,
      child: IconButton(
        icon: Icon(
          Icons.copy,
          size: 18,
          color: theme.colorScheme.onSurfaceVariant,
        ),
        tooltip: 'Copy to clipboard',
        padding: EdgeInsets.zero,
        constraints: const BoxConstraints(),
        onPressed: () => _copyToClipboard(context),
      ),
    );
  }

  void _copyToClipboard(BuildContext context) {
    try {
      Clipboard.setData(ClipboardData(text: message.content));
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Copied to clipboard')),
      );
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Failed to copy')),
      );
    }
  }
}
```

Note: The MessageBubble now accepts an optional projectId for proper navigation. Update conversation_screen.dart to pass projectId when rendering MessageBubble.
  </action>
  <verify>
```bash
cd frontend && flutter analyze lib/screens/conversation/widgets/message_bubble.dart
```
  </verify>
  <done>
- MessageBubble shows SourceChips for assistant messages with documentsUsed
- Source chip tap navigates to Document Viewer (SRC-03)
- No sources shown if documentsUsed is empty (SRC-04)
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes for all modified files
2. Manual test: Send message that triggers document search
3. Manual test: Source chips appear below AI response
4. Manual test: Tap chip to open document viewer
</verification>

<success_criteria>
- AI responses show source chips when documents were referenced (SRC-01)
- Source chips display document names (SRC-02)
- Clicking source chip opens Document Viewer (SRC-03)
- No sources section shown if no documents used (SRC-04)
- Wrap widget handles overflow (PITFALL-13)
</success_criteria>

<checkpoint type="human-verify" gate="blocking">
  <what-built>Source attribution UI: source chips showing documents used in AI responses with navigation to Document Viewer</what-built>
  <how-to-verify>
1. Start both backend and frontend
2. Create or open a project with uploaded documents
3. Start a conversation and ask a question that would cause document search (e.g., "What does the requirements document say about X?")
4. Verify AI response shows "X sources used" link at bottom
5. Click to expand - verify document chips appear with filenames
6. Click a chip - verify it navigates to Document Viewer for that document
7. Test with a generic question that wouldn't use documents - verify no sources section appears
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/36-ai-interaction-enhancement/36-04-SUMMARY.md`
</output>

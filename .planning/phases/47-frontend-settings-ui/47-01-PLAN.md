---
phase: 47-frontend-settings-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/providers/logging_provider.dart
  - frontend/lib/services/logging_service.dart
  - frontend/lib/screens/settings_screen.dart
  - frontend/lib/main.dart
  - frontend/test/widget/settings_screen_test.dart
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User sees 'Detailed Logging' toggle in Settings screen Preferences section"
    - "Toggling logging OFF stops all new logs from being captured"
    - "Toggle state persists across app restarts (survives kill/reopen)"
    - "Disabling logging clears the log buffer (privacy)"
  artifacts:
    - path: "frontend/lib/providers/logging_provider.dart"
      provides: "LoggingProvider ChangeNotifier with persistence"
      exports: ["LoggingProvider"]
    - path: "frontend/lib/services/logging_service.dart"
      provides: "isEnabled setter with early return in _log()"
      contains: "set isEnabled"
    - path: "frontend/lib/screens/settings_screen.dart"
      provides: "SwitchListTile for logging toggle"
      contains: "Detailed Logging"
    - path: "frontend/lib/main.dart"
      provides: "LoggingProvider initialization"
      contains: "LoggingProvider.load"
  key_links:
    - from: "frontend/lib/screens/settings_screen.dart"
      to: "frontend/lib/providers/logging_provider.dart"
      via: "Consumer<LoggingProvider>"
      pattern: "Consumer<LoggingProvider>"
    - from: "frontend/lib/providers/logging_provider.dart"
      to: "frontend/lib/services/logging_service.dart"
      via: "isEnabled setter"
      pattern: "LoggingService\\(\\)\\.isEnabled"
    - from: "frontend/lib/main.dart"
      to: "frontend/lib/providers/logging_provider.dart"
      via: "load and MultiProvider"
      pattern: "LoggingProvider\\.load"
---

<objective>
Add logging toggle to Settings screen with persistent state management.

Purpose: Users can enable/disable detailed logging for troubleshooting, with privacy protection when disabled (LOG-05, SLOG-01).
Output: Working logging toggle in Settings that persists across app restarts and controls all log capture.
</objective>

<execution_context>
@C:\Users\ibcve\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ibcve\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-frontend-settings-ui/47-RESEARCH.md
@frontend/lib/providers/theme_provider.dart
@frontend/lib/services/logging_service.dart
@frontend/lib/screens/settings_screen.dart
@frontend/lib/main.dart
@frontend/test/widget/settings_screen_test.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LoggingProvider and add isEnabled to LoggingService</name>
  <files>
    frontend/lib/providers/logging_provider.dart
    frontend/lib/services/logging_service.dart
  </files>
  <action>
Create LoggingProvider following ThemeProvider pattern exactly:

**frontend/lib/providers/logging_provider.dart:**
- Import flutter/material.dart and shared_preferences
- Import logging_service.dart
- Create LoggingProvider extending ChangeNotifier
- Private fields: `_prefs` (SharedPreferences), `_isLoggingEnabled` (bool)
- Static const `_loggingKey = 'isLoggingEnabled'`
- Private constructor taking prefs and optional initialEnabled (default: true for pilot)
- Static async factory `load(SharedPreferences prefs)`:
  - Try to read `_loggingKey` from prefs, default true
  - Return LoggingProvider with loaded state
  - Catch errors, log with debugPrint, return default-enabled provider
- Getter `isLoggingEnabled` returning `_isLoggingEnabled`
- Async method `toggleLogging()`:
  - Flip `_isLoggingEnabled`
  - PERSIST BEFORE NOTIFY: `await _prefs.setBool(_loggingKey, _isLoggingEnabled)`
  - Update LoggingService: `LoggingService().isEnabled = _isLoggingEnabled`
  - Call notifyListeners()
  - Handle persistence errors with debugPrint (don't block UI)

**frontend/lib/services/logging_service.dart:**
- Add private field `bool _isEnabled = true;`
- Add setter `set isEnabled(bool enabled)`:
  - Set `_isEnabled = enabled`
  - If disabled, call `clearBuffer()` for privacy
- Modify `_log()` method:
  - Add `if (!_isEnabled) return;` as FIRST line (before any logging)
  </action>
  <verify>
Run `flutter analyze frontend` - no errors.
Verify LoggingProvider.load() compiles and follows ThemeProvider pattern.
Verify LoggingService._log() has early return when disabled.
  </verify>
  <done>
LoggingProvider exists with persist-before-notify pattern.
LoggingService has isEnabled setter with early return in _log().
Buffer clears when logging disabled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire LoggingProvider in main.dart and add toggle to Settings</name>
  <files>
    frontend/lib/main.dart
    frontend/lib/screens/settings_screen.dart
    frontend/test/widget/settings_screen_test.dart
  </files>
  <action>
**frontend/lib/main.dart:**
- Import logging_provider.dart
- In main() function, after providerProvider load:
  - Add: `final loggingProvider = await LoggingProvider.load(prefs);`
- After LoggingService().init(), sync provider state to service:
  - Add: `LoggingService().isEnabled = loggingProvider.isLoggingEnabled;`
- Add loggingProvider parameter to MyApp constructor call
- In MyApp class:
  - Add `final LoggingProvider loggingProvider;` field
  - Add to constructor: `required this.loggingProvider`
- In _MyAppState.build() MultiProvider providers list:
  - Add: `ChangeNotifierProvider.value(value: widget.loggingProvider),`
  - Place after providerProvider (before DocumentColumnProvider)

**frontend/lib/screens/settings_screen.dart:**
- Import logging_provider.dart
- In build() method, after the AI Provider dropdown ListTile and before `const Divider()`:
  - Add Consumer<LoggingProvider> with SwitchListTile:
    - title: 'Detailed Logging'
    - subtitle: 'Capture diagnostic logs for troubleshooting'
    - value: loggingProvider.isLoggingEnabled
    - onChanged: (_) => loggingProvider.toggleLogging()

**frontend/test/widget/settings_screen_test.dart:**
- Import logging_provider.dart
- Add MockSpec<LoggingProvider>() to @GenerateNiceMocks list
- In setUp(), create mockLoggingProvider and set default:
  - `when(mockLoggingProvider.isLoggingEnabled).thenReturn(true);`
- Add mockLoggingProvider to MultiProvider in buildTestWidget()
- Run `dart run build_runner build --delete-conflicting-outputs` to regenerate mocks
- Add test group 'Logging Section' with tests:
  - 'shows logging toggle': verify find.text('Detailed Logging') exists
  - 'toggle calls toggleLogging': tap Switch, verify mockLoggingProvider.toggleLogging() called
  </action>
  <verify>
Run `dart run build_runner build --delete-conflicting-outputs` in frontend/ - mocks generated.
Run `flutter test frontend/test/widget/settings_screen_test.dart` - all tests pass.
Run `flutter analyze frontend` - no errors.
  </verify>
  <done>
LoggingProvider loaded in main.dart and provided to widget tree.
Logging toggle visible in Settings screen Preferences section.
Widget tests updated with LoggingProvider mock.
All existing tests still pass.
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze frontend` - no errors
2. `flutter test frontend/test/widget/settings_screen_test.dart` - all tests pass
3. `flutter test frontend/` - all frontend tests pass
4. Manual smoke test (if environment allows):
   - Run app, go to Settings
   - Verify "Detailed Logging" toggle appears in Preferences section
   - Toggle off, verify no console logs appear for navigation
   - Toggle on, verify logs resume
   - Kill app and reopen - verify toggle state persisted
</verification>

<success_criteria>
- LoggingProvider created with persist-before-notify pattern
- LoggingService has isEnabled with early return in _log()
- Settings screen shows logging toggle in Preferences section
- Toggle state persists via SharedPreferences
- Disabling logging clears buffer and stops new logs
- All widget tests pass including new logging tests
</success_criteria>

<output>
After completion, create `.planning/phases/47-frontend-settings-ui/47-01-SUMMARY.md`
</output>

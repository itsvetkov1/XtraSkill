---
phase: 35-transparency-indicators
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/providers/budget_provider.dart
  - frontend/lib/screens/conversation/conversation_screen.dart
  - frontend/lib/screens/conversation/widgets/budget_warning_banner.dart
  - frontend/lib/main.dart
autonomous: true

must_haves:
  truths:
    - "User sees warning banner when budget reaches 80%"
    - "User sees urgent warning banner when budget reaches 95%"
    - "User cannot send messages when budget exhausted (100%)"
    - "User can still view message history when budget exhausted"
    - "Budget displays percentage only, no monetary amounts"
  artifacts:
    - path: "frontend/lib/providers/budget_provider.dart"
      provides: "Budget state management with threshold detection"
      exports: ["BudgetProvider", "BudgetStatus"]
    - path: "frontend/lib/screens/conversation/widgets/budget_warning_banner.dart"
      provides: "Warning banner widget for budget thresholds"
      min_lines: 40
  key_links:
    - from: "frontend/lib/screens/conversation/conversation_screen.dart"
      to: "BudgetProvider"
      via: "Consumer widget"
      pattern: "Consumer<BudgetProvider>"
    - from: "frontend/lib/providers/budget_provider.dart"
      to: "/auth/usage"
      via: "AuthService.getUsage()"
      pattern: "_authService\\.getUsage"
---

<objective>
Implement budget warning banners and exhausted state blocking in ConversationScreen.

Purpose: Users need visibility into their token budget status to avoid surprise exhaustion mid-conversation. Per PITFALL-04, use API-provided token counts (not estimates).

Output: BudgetProvider tracking usage with threshold detection, BudgetWarningBanner widget, ChatInput disabled at 100% budget.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@frontend/lib/models/token_usage.dart
@frontend/lib/services/auth_service.dart
@frontend/lib/screens/conversation/conversation_screen.dart
@frontend/lib/screens/settings_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BudgetProvider with threshold detection</name>
  <files>
    frontend/lib/providers/budget_provider.dart
    frontend/lib/main.dart
  </files>
  <action>
Create BudgetProvider that:

1. Uses AuthService to fetch /auth/usage (already exists)
2. Parses TokenUsage model (already exists)
3. Exposes BudgetStatus enum: normal, warning (>=80%), urgent (>=95%), exhausted (>=100%)
4. Exposes percentage as int (0-100) for display
5. Has refresh() method to re-fetch usage
6. Auto-refreshes on construction

Per PITFALL-04: Use API-provided token counts from totalCost/budget ratio. DO NOT estimate tokens locally.

Per BUD-05: Expose percentage only - no totalCost or budget amounts to UI.

```dart
enum BudgetStatus { normal, warning, urgent, exhausted }

class BudgetProvider extends ChangeNotifier {
  final AuthService _authService;

  BudgetStatus _status = BudgetStatus.normal;
  int _percentage = 0;  // 0-100
  bool _loading = true;
  String? _error;

  // Getters...

  Future<void> refresh() async {
    // Fetch from API
    // Calculate percentage from costPercentage
    // Set status based on thresholds: 0.80, 0.95, 1.0
  }
}
```

Add to main.dart MultiProvider list after AuthProvider.
  </action>
  <verify>
flutter analyze frontend/lib/providers/budget_provider.dart
grep -n "BudgetProvider" frontend/lib/main.dart
  </verify>
  <done>
BudgetProvider exists with BudgetStatus enum, percentage getter, and refresh method. Registered in main.dart.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BudgetWarningBanner widget</name>
  <files>frontend/lib/screens/conversation/widgets/budget_warning_banner.dart</files>
  <action>
Create BudgetWarningBanner widget that shows appropriate message based on BudgetStatus:

- warning: Yellow/orange MaterialBanner "You've used 80% of your token budget"
- urgent: Orange/red MaterialBanner "Almost at limit - limited messages remaining"
- exhausted: Red MaterialBanner "Budget exhausted - unable to send messages"
- normal: Returns SizedBox.shrink() (nothing)

Widget takes BudgetStatus and int percentage as parameters. Use percentage in message if desired (e.g., "You've used 80% of your token budget").

Per BUD-05: Show percentage, NOT dollar amounts.

Style:
- warning: colorScheme.tertiaryContainer background, tertiary text
- urgent: Colors.orange[100] background, orange[900] text
- exhausted: colorScheme.errorContainer background, onErrorContainer text

Include dismiss action on warning/urgent (not exhausted - that stays).
  </action>
  <verify>
flutter analyze frontend/lib/screens/conversation/widgets/budget_warning_banner.dart
grep -n "BudgetStatus" frontend/lib/screens/conversation/widgets/budget_warning_banner.dart
  </verify>
  <done>
BudgetWarningBanner widget shows threshold-appropriate messages with correct colors. Returns nothing for normal status.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate budget state into ConversationScreen</name>
  <files>frontend/lib/screens/conversation/conversation_screen.dart</files>
  <action>
Update ConversationScreen to:

1. Import BudgetProvider and BudgetWarningBanner
2. Consume BudgetProvider via Consumer or context.watch
3. Show BudgetWarningBanner above error banner (budget status is more important)
4. Refresh budget on screen mount (initState or didChangeDependencies)
5. Disable ChatInput when budget status is exhausted:
   - Pass enabled: !provider.isStreaming && budgetProvider.status != BudgetStatus.exhausted
   - This satisfies BUD-04: can view history but not send

Per BUD-03: The exhausted state is indicated by the red banner + disabled input. No separate "exhausted screen" needed.

Refresh budget after successful message send (in sendMessage callback or via provider).
  </action>
  <verify>
flutter analyze frontend/lib/screens/conversation/conversation_screen.dart
grep -n "BudgetProvider\|BudgetWarningBanner\|BudgetStatus" frontend/lib/screens/conversation/conversation_screen.dart
  </verify>
  <done>
ConversationScreen shows budget warning banners at appropriate thresholds and disables input at 100%.
  </done>
</task>

</tasks>

<verification>
1. flutter analyze - no errors on modified files
2. BudgetProvider fetches from /auth/usage API
3. BudgetStatus enum has all four states (normal, warning, urgent, exhausted)
4. BudgetWarningBanner shows distinct messages for each threshold
5. ChatInput disabled when status is exhausted
6. No monetary amounts displayed anywhere (percentage only)
</verification>

<success_criteria>
- BUD-01: Warning banner at 80% shows "You've used 80% of your token budget"
- BUD-02: Warning banner at 95% shows "Almost at limit - limited messages remaining"
- BUD-03: At 100%, clear "Budget exhausted" state visible
- BUD-04: Exhausted state allows viewing history (scroll works) but blocks sending (ChatInput disabled)
- BUD-05: Budget display shows percentage only (no dollar amounts in BudgetWarningBanner)
</success_criteria>

<output>
After completion, create `.planning/phases/35-transparency-indicators/35-01-SUMMARY.md`
</output>

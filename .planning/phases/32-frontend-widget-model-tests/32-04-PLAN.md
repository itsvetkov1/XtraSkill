---
phase: 32-frontend-widget-model-tests
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/test/widget/home_screen_test.dart
  - frontend/test/widget/home_screen_test.mocks.dart
  - frontend/test/widget/settings_screen_test.dart
  - frontend/test/widget/settings_screen_test.mocks.dart
autonomous: true

must_haves:
  truths:
    - "HomeScreen displays personalized greeting"
    - "HomeScreen shows action buttons (New Chat, Browse Projects)"
    - "SettingsScreen shows all settings sections"
  artifacts:
    - path: "frontend/test/widget/home_screen_test.dart"
      provides: "HomeScreen widget tests"
      min_lines: 100
    - path: "frontend/test/widget/settings_screen_test.dart"
      provides: "SettingsScreen widget tests"
      min_lines: 100
  key_links:
    - from: "frontend/test/widget/home_screen_test.dart"
      to: "frontend/lib/screens/home_screen.dart"
      via: "imports HomeScreen widget"
      pattern: "import.*home_screen"
    - from: "frontend/test/widget/settings_screen_test.dart"
      to: "frontend/lib/screens/settings_screen.dart"
      via: "imports SettingsScreen widget"
      pattern: "import.*settings_screen"
---

<objective>
Create widget tests for HomeScreen and SettingsScreen to complete FWID-05 requirement.

Purpose: Ensure all major screens have test coverage by adding tests for HomeScreen (greeting, action buttons, recent projects) and SettingsScreen (profile, theme, provider, usage, logout).

Output: Two test files covering HomeScreen and SettingsScreen with multiple test groups.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-frontend-widget-model-tests/32-RESEARCH.md

# Source files
@frontend/lib/screens/home_screen.dart
@frontend/lib/screens/settings_screen.dart

# Existing test pattern
@frontend/test/widget/chats_screen_test.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HomeScreen widget tests</name>
  <files>frontend/test/widget/home_screen_test.dart</files>
  <action>
Create test file at `frontend/test/widget/home_screen_test.dart`:

HomeScreen depends on:
- AuthProvider (for greeting/user name)
- ProjectProvider (for recent projects)
- ChatsProvider (for creating new chat)
- ProviderProvider (for LLM provider)

Test groups:

1. Greeting display:
   - Shows "Welcome back, {displayName}" when displayName exists
   - Uses email prefix when no displayName
   - Defaults to "there" when neither exists

2. Action buttons:
   - "New Chat" button is present
   - "Browse Projects" button is present

3. Recent projects section:
   - Shows empty state when no projects
   - Shows up to 3 recent projects
   - Shows "See all" link when projects exist
   - Project cards are tappable

4. Loading state:
   - Doesn't show empty state hint during loading

```dart
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:frontend/models/project.dart';
import 'package:frontend/providers/auth_provider.dart';
import 'package:frontend/providers/chats_provider.dart';
import 'package:frontend/providers/project_provider.dart';
import 'package:frontend/providers/provider_provider.dart';
import 'package:frontend/screens/home_screen.dart';
import 'package:mockito/annotations.dart';
import 'package:mockito/mockito.dart';
import 'package:provider/provider.dart';

import 'home_screen_test.mocks.dart';

@GenerateNiceMocks([
  MockSpec<AuthProvider>(),
  MockSpec<ProjectProvider>(),
  MockSpec<ChatsProvider>(),
  MockSpec<ProviderProvider>(),
])
void main() {
  group('HomeScreen Widget Tests', () {
    late MockAuthProvider mockAuthProvider;
    late MockProjectProvider mockProjectProvider;
    late MockChatsProvider mockChatsProvider;
    late MockProviderProvider mockProviderProvider;

    setUp(() {
      mockAuthProvider = MockAuthProvider();
      mockProjectProvider = MockProjectProvider();
      mockChatsProvider = MockChatsProvider();
      mockProviderProvider = MockProviderProvider();

      // Default mock behavior
      when(mockAuthProvider.displayName).thenReturn('John');
      when(mockAuthProvider.email).thenReturn('john@example.com');

      when(mockProjectProvider.isLoading).thenReturn(false);
      when(mockProjectProvider.projects).thenReturn([]);
      when(mockProjectProvider.loadProjects()).thenAnswer((_) async {});

      when(mockProviderProvider.selectedProvider).thenReturn('anthropic');
    });

    Widget buildTestWidget() {
      return MaterialApp(
        home: MultiProvider(
          providers: [
            ChangeNotifierProvider<AuthProvider>.value(value: mockAuthProvider),
            ChangeNotifierProvider<ProjectProvider>.value(value: mockProjectProvider),
            ChangeNotifierProvider<ChatsProvider>.value(value: mockChatsProvider),
            ChangeNotifierProvider<ProviderProvider>.value(value: mockProviderProvider),
          ],
          child: const HomeScreen(),
        ),
      );
    }

    group('Greeting', () {
      testWidgets('shows greeting with displayName', (tester) async {
        when(mockAuthProvider.displayName).thenReturn('John');

        await tester.pumpWidget(buildTestWidget());
        await tester.pumpAndSettle();

        expect(find.text('Welcome back, John'), findsOneWidget);
      });

      testWidgets('uses email prefix when no displayName', (tester) async {
        when(mockAuthProvider.displayName).thenReturn(null);
        when(mockAuthProvider.email).thenReturn('jane@example.com');

        await tester.pumpWidget(buildTestWidget());
        await tester.pumpAndSettle();

        expect(find.text('Welcome back, jane'), findsOneWidget);
      });

      testWidgets('defaults to "there" when no name or email', (tester) async {
        when(mockAuthProvider.displayName).thenReturn(null);
        when(mockAuthProvider.email).thenReturn(null);

        await tester.pumpWidget(buildTestWidget());
        await tester.pumpAndSettle();

        expect(find.text('Welcome back, there'), findsOneWidget);
      });
    });

    group('Action Buttons', () {
      testWidgets('shows New Chat button', (tester) async {
        await tester.pumpWidget(buildTestWidget());
        await tester.pumpAndSettle();

        expect(find.text('New Chat'), findsOneWidget);
        expect(find.byIcon(Icons.chat_bubble), findsOneWidget);
      });

      testWidgets('shows Browse Projects button', (tester) async {
        await tester.pumpWidget(buildTestWidget());
        await tester.pumpAndSettle();

        expect(find.text('Browse Projects'), findsOneWidget);
        expect(find.byIcon(Icons.folder_outlined), findsOneWidget);
      });
    });

    group('Recent Projects', () {
      testWidgets('shows empty hint when no projects', (tester) async {
        when(mockProjectProvider.projects).thenReturn([]);
        when(mockProjectProvider.isLoading).thenReturn(false);

        await tester.pumpWidget(buildTestWidget());
        await tester.pumpAndSettle();

        expect(find.text('No projects yet - create your first one!'), findsOneWidget);
      });

      testWidgets('shows recent projects section', (tester) async {
        final projects = [
          Project(
            id: '1',
            name: 'Project Alpha',
            description: 'First project',
            createdAt: DateTime.now(),
            updatedAt: DateTime.now(),
          ),
          Project(
            id: '2',
            name: 'Project Beta',
            createdAt: DateTime.now(),
            updatedAt: DateTime.now(),
          ),
        ];
        when(mockProjectProvider.projects).thenReturn(projects);

        await tester.pumpWidget(buildTestWidget());
        await tester.pumpAndSettle();

        expect(find.text('Recent Projects'), findsOneWidget);
        expect(find.text('See all'), findsOneWidget);
        expect(find.text('Project Alpha'), findsOneWidget);
        expect(find.text('Project Beta'), findsOneWidget);
      });

      testWidgets('shows max 3 projects', (tester) async {
        final projects = List.generate(5, (i) => Project(
          id: '$i',
          name: 'Project $i',
          createdAt: DateTime.now(),
          updatedAt: DateTime.now(),
        ));
        when(mockProjectProvider.projects).thenReturn(projects);

        await tester.pumpWidget(buildTestWidget());
        await tester.pumpAndSettle();

        expect(find.text('Project 0'), findsOneWidget);
        expect(find.text('Project 1'), findsOneWidget);
        expect(find.text('Project 2'), findsOneWidget);
        expect(find.text('Project 3'), findsNothing);
        expect(find.text('Project 4'), findsNothing);
      });

      testWidgets('hides empty hint during loading', (tester) async {
        when(mockProjectProvider.isLoading).thenReturn(true);
        when(mockProjectProvider.projects).thenReturn([]);

        await tester.pumpWidget(buildTestWidget());
        await tester.pump();

        expect(find.text('No projects yet - create your first one!'), findsNothing);
      });
    });
  });
}
```
  </action>
  <verify>Run `flutter pub run build_runner build --delete-conflicting-outputs` then `flutter test frontend/test/widget/home_screen_test.dart -v` - all tests pass</verify>
  <done>10-12 tests covering HomeScreen greeting, action buttons, and recent projects</done>
</task>

<task type="auto">
  <name>Task 2: Create SettingsScreen widget tests</name>
  <files>frontend/test/widget/settings_screen_test.dart</files>
  <action>
Create test file at `frontend/test/widget/settings_screen_test.dart`:

SettingsScreen depends on:
- AuthProvider (for profile info)
- ThemeProvider (for dark mode toggle)
- ProviderProvider (for AI provider selection)
- AuthService (for usage - instantiated internally, can't easily mock)

Test groups:

1. Account section:
   - Shows profile tile with initials avatar
   - Displays email
   - Displays display name when available
   - Shows auth provider when available

2. Theme section:
   - Dark mode switch is present
   - Toggle calls toggleTheme()

3. Preferences section:
   - AI Provider dropdown is present
   - Shows available providers

4. Usage section:
   - Shows loading state initially
   - NOTE: Skip actual usage data testing (AuthService created internally)

5. Actions section:
   - Logout button is present
   - Logout button shows confirmation dialog

```dart
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:frontend/providers/auth_provider.dart';
import 'package:frontend/providers/provider_provider.dart';
import 'package:frontend/providers/theme_provider.dart';
import 'package:frontend/screens/settings_screen.dart';
import 'package:mockito/annotations.dart';
import 'package:mockito/mockito.dart';
import 'package:provider/provider.dart';

import 'settings_screen_test.mocks.dart';

@GenerateNiceMocks([
  MockSpec<AuthProvider>(),
  MockSpec<ThemeProvider>(),
  MockSpec<ProviderProvider>(),
])
void main() {
  group('SettingsScreen Widget Tests', () {
    late MockAuthProvider mockAuthProvider;
    late MockThemeProvider mockThemeProvider;
    late MockProviderProvider mockProviderProvider;

    setUp(() {
      mockAuthProvider = MockAuthProvider();
      mockThemeProvider = MockThemeProvider();
      mockProviderProvider = MockProviderProvider();

      // Default mock behavior
      when(mockAuthProvider.email).thenReturn('user@example.com');
      when(mockAuthProvider.displayName).thenReturn('Test User');
      when(mockAuthProvider.authProvider).thenReturn('google');

      when(mockThemeProvider.isDarkMode).thenReturn(false);

      when(mockProviderProvider.selectedProvider).thenReturn('anthropic');
    });

    Widget buildTestWidget() {
      return MaterialApp(
        home: MultiProvider(
          providers: [
            ChangeNotifierProvider<AuthProvider>.value(value: mockAuthProvider),
            ChangeNotifierProvider<ThemeProvider>.value(value: mockThemeProvider),
            ChangeNotifierProvider<ProviderProvider>.value(value: mockProviderProvider),
          ],
          child: const Scaffold(
            body: SettingsScreen(),
          ),
        ),
      );
    }

    group('Section Headers', () {
      testWidgets('shows all section headers', (tester) async {
        await tester.pumpWidget(buildTestWidget());
        await tester.pump();

        expect(find.text('Account'), findsOneWidget);
        expect(find.text('Appearance'), findsOneWidget);
        expect(find.text('Preferences'), findsOneWidget);
        expect(find.text('Usage'), findsOneWidget);
        expect(find.text('Actions'), findsOneWidget);
      });
    });

    group('Account Section', () {
      testWidgets('shows profile with initials avatar', (tester) async {
        when(mockAuthProvider.displayName).thenReturn('Test User');

        await tester.pumpWidget(buildTestWidget());
        await tester.pump();

        // Check for initials in CircleAvatar
        expect(find.byType(CircleAvatar), findsOneWidget);
        expect(find.text('TU'), findsOneWidget);
      });

      testWidgets('displays display name', (tester) async {
        when(mockAuthProvider.displayName).thenReturn('John Doe');

        await tester.pumpWidget(buildTestWidget());
        await tester.pump();

        expect(find.text('John Doe'), findsOneWidget);
      });

      testWidgets('displays email', (tester) async {
        when(mockAuthProvider.email).thenReturn('john@test.com');
        when(mockAuthProvider.displayName).thenReturn('John');

        await tester.pumpWidget(buildTestWidget());
        await tester.pump();

        expect(find.text('john@test.com'), findsOneWidget);
      });

      testWidgets('shows auth provider', (tester) async {
        when(mockAuthProvider.authProvider).thenReturn('google');

        await tester.pumpWidget(buildTestWidget());
        await tester.pump();

        expect(find.text('Signed in with Google'), findsOneWidget);
      });
    });

    group('Appearance Section', () {
      testWidgets('shows dark mode switch', (tester) async {
        await tester.pumpWidget(buildTestWidget());
        await tester.pump();

        expect(find.text('Dark Mode'), findsOneWidget);
        expect(find.byType(SwitchListTile), findsOneWidget);
      });

      testWidgets('toggle calls toggleTheme', (tester) async {
        await tester.pumpWidget(buildTestWidget());
        await tester.pump();

        await tester.tap(find.byType(Switch));
        await tester.pump();

        verify(mockThemeProvider.toggleTheme()).called(1);
      });
    });

    group('Preferences Section', () {
      testWidgets('shows AI provider dropdown', (tester) async {
        await tester.pumpWidget(buildTestWidget());
        await tester.pump();

        expect(find.text('Default AI Provider'), findsOneWidget);
        expect(find.byType(DropdownButton<String>), findsOneWidget);
      });
    });

    group('Usage Section', () {
      testWidgets('shows monthly token budget label', (tester) async {
        await tester.pumpWidget(buildTestWidget());
        await tester.pump();

        expect(find.text('Monthly Token Budget'), findsOneWidget);
      });

      testWidgets('shows loading indicator initially', (tester) async {
        await tester.pumpWidget(buildTestWidget());
        // Don't pump and settle - catch initial loading state
        await tester.pump();

        expect(find.byType(LinearProgressIndicator), findsOneWidget);
      });
    });

    group('Actions Section', () {
      testWidgets('shows logout button', (tester) async {
        await tester.pumpWidget(buildTestWidget());
        await tester.pump();

        expect(find.text('Log Out'), findsOneWidget);
        expect(find.byIcon(Icons.logout), findsOneWidget);
      });

      testWidgets('logout button shows confirmation dialog', (tester) async {
        await tester.pumpWidget(buildTestWidget());
        await tester.pump();

        await tester.tap(find.text('Log Out'));
        await tester.pumpAndSettle();

        expect(find.text('Are you sure you want to log out?'), findsOneWidget);
        expect(find.text('Cancel'), findsOneWidget);
        // Dialog has another "Log Out" button
        expect(find.text('Log Out'), findsNWidgets(2));
      });

      testWidgets('cancel dismisses logout dialog', (tester) async {
        await tester.pumpWidget(buildTestWidget());
        await tester.pump();

        await tester.tap(find.text('Log Out'));
        await tester.pumpAndSettle();

        await tester.tap(find.text('Cancel'));
        await tester.pumpAndSettle();

        // Dialog should be dismissed
        expect(find.text('Are you sure you want to log out?'), findsNothing);
      });
    });
  });
}
```
  </action>
  <verify>Run `flutter pub run build_runner build --delete-conflicting-outputs` then `flutter test frontend/test/widget/settings_screen_test.dart -v` - all tests pass</verify>
  <done>12-15 tests covering SettingsScreen sections, profile, theme toggle, and logout flow</done>
</task>

</tasks>

<verification>
Run all widget tests to verify:
```bash
flutter pub run build_runner build --delete-conflicting-outputs
flutter test frontend/test/widget/home_screen_test.dart frontend/test/widget/settings_screen_test.dart -v
```

Expected: All tests pass (10+ HomeScreen tests, 12+ SettingsScreen tests)
</verification>

<success_criteria>
1. HomeScreen tests verify greeting personalization with displayName, email, or fallback
2. HomeScreen tests verify action buttons presence
3. HomeScreen tests verify recent projects display (empty, populated, max 3)
4. SettingsScreen tests verify all section headers present
5. SettingsScreen tests verify profile tile with initials and auth info
6. SettingsScreen tests verify theme toggle functionality
7. SettingsScreen tests verify logout confirmation dialog
8. All tests pass without errors
</success_criteria>

<output>
After completion, create `.planning/phases/32-frontend-widget-model-tests/32-04-SUMMARY.md`
</output>

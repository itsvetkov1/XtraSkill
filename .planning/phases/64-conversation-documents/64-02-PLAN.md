---
phase: 64-conversation-documents
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/pubspec.yaml
  - frontend/lib/providers/assistant_conversation_provider.dart
  - frontend/lib/screens/assistant/widgets/markdown_message.dart
autonomous: true
requirements: [UI-03]

must_haves:
  truths:
    - "AssistantConversationProvider manages chat state for Assistant threads with SSE streaming"
    - "Markdown content renders with formatted headers, code blocks with syntax highlighting, tables, and lists"
    - "Streaming text renders progressively as markdown (not raw text)"
    - "Copy and retry controls work on assistant messages"
    - "Thinking indicator shows elapsed time during AI processing"
  artifacts:
    - path: "frontend/lib/providers/assistant_conversation_provider.dart"
      provides: "Chat state management for Assistant threads"
      contains: "AssistantConversationProvider"
    - path: "frontend/lib/screens/assistant/widgets/markdown_message.dart"
      provides: "Markdown rendering with syntax highlighting"
      contains: "MarkdownMessage"
  key_links:
    - from: "frontend/lib/providers/assistant_conversation_provider.dart"
      to: "frontend/lib/services/ai_service.dart"
      via: "SSE streaming via AIService.streamChat()"
      pattern: "streamChat"
    - from: "frontend/lib/screens/assistant/widgets/markdown_message.dart"
      to: "flutter_markdown package"
      via: "MarkdownBody widget with custom builders"
      pattern: "MarkdownBody"
---

<objective>
Create AssistantConversationProvider for chat state management and MarkdownMessage widget for formatted AI response rendering.

Purpose: The Assistant chat screen needs its own provider (separate from BA ConversationProvider) to manage streaming state without BA-specific logic (no artifacts, no mode selection, no budget warnings). AI responses must render as formatted markdown with syntax-highlighted code blocks.

Output: AssistantConversationProvider class + MarkdownMessage widget + flutter_markdown/flutter_highlight dependencies installed
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/64-conversation-documents/64-RESEARCH.md
@frontend/lib/providers/conversation_provider.dart
@frontend/lib/services/ai_service.dart
@frontend/lib/screens/conversation/widgets/streaming_message.dart
@frontend/lib/screens/conversation/widgets/message_bubble.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Dependencies and Create AssistantConversationProvider</name>
  <files>
    frontend/pubspec.yaml
    frontend/lib/providers/assistant_conversation_provider.dart
  </files>
  <action>
**1. Add Flutter dependencies:**
Run `cd /Users/a1testingmac/projects/XtraSkill/frontend && flutter pub add flutter_markdown flutter_highlight` to add markdown rendering and syntax highlighting packages.

**2. Create AssistantConversationProvider** at `frontend/lib/providers/assistant_conversation_provider.dart`:

Model it after the existing `ConversationProvider` but STRIPPED of BA-specific logic. Include ONLY:

**State fields:**
- `Thread? _thread` — current thread
- `List<Message> _messages` — messages in conversation
- `String _streamingText` — text accumulated during streaming
- `String? _statusMessage` — e.g., "Thinking..." status
- `bool _isStreaming` — whether AI is streaming
- `bool _loading` — initial load state
- `String? _error` — error message
- `bool _isNotFound` — 404 state
- `String? _lastFailedMessage` — for retry functionality
- `bool _hasPartialContent` — partial content from interrupted stream
- `Skill? _selectedSkill` — currently selected skill (for skill prepending)
- `List<AttachedFile> _attachedFiles` — files attached for current message (not yet sent)
- `DateTime? _thinkingStartTime` — when thinking indicator started (for elapsed time display)

**Constructor:** Takes `AIService` and `ThreadService` (same pattern as ConversationProvider).

**Core methods (adapt from ConversationProvider):**
- `loadThread(String threadId)` — loads thread and messages via ThreadService
- `sendMessage(String content)` — sends message with SSE streaming. If `_selectedSkill` is set, prepend skill context to the message before sending (user doesn't see this). After send, clear `_selectedSkill` (one-time use per user decision). If `_attachedFiles` is not empty, include file references in the message context.
- `retryLastMessage()` — retry the last failed message (same as ConversationProvider)
- `clearConversation()` — reset all state
- `clearError()` — clear error state

**Skill management:**
- `selectSkill(Skill skill)` — set selected skill, notify listeners
- `clearSkill()` — remove selected skill
- `Skill? get selectedSkill` — getter

**File attachment management:**
- `addAttachedFile(AttachedFile file)` — add to pending list
- `removeAttachedFile(AttachedFile file)` — remove from pending list
- `clearAttachedFiles()` — clear all pending files
- `List<AttachedFile> get attachedFiles` — getter

**Model classes (in same file or separate):**
- `Skill` — `name`, `description`, `skillPath` fields with `fromJson` constructor
- `AttachedFile` — `name`, `size`, `bytes` (Uint8List?), `contentType` fields

**What to EXCLUDE (BA-specific):**
- No `_artifacts` list or artifact generation
- No `_isGeneratingArtifact` state
- No `_pendingDelete` / message deletion with undo
- No budget checking
- No conversation mode switching
- No source chips / document attribution

**Streaming implementation:**
- Reuse the SAME `AIService.streamChat()` method — it already works for Assistant threads (backend routes to claude-code-cli based on thread_type)
- Handle `TextDeltaEvent`, `ToolExecutingEvent`, `MessageCompleteEvent`, `ErrorEvent`
- On streaming start: set `_thinkingStartTime = DateTime.now()` for elapsed time display
- On first `TextDeltaEvent`: clear `_thinkingStartTime` (text has started)
- Error handling: preserve `_streamingText` on error (PITFALL-01 from Phase 34), set `_hasPartialContent = true`, auto-retry once after 2-second delay
- On `MessageCompleteEvent`: add assistant message to `_messages`, clear streaming state

**Auto-retry pattern (from locked decision "auto-retry once"):**
```dart
} catch (e) {
  _error = e.toString();
  _hasPartialContent = _streamingText.isNotEmpty;
  // Auto-retry once on error
  if (!_hasAutoRetried) {
    _hasAutoRetried = true;
    await Future.delayed(const Duration(seconds: 2));
    if (!_isStreaming) { // Only if still in error state
      _error = null;
      await sendMessage(content); // Retry
    }
  }
}
```
Add `bool _hasAutoRetried = false;` field, reset on successful send.
  </action>
  <verify>
Run: `cd /Users/a1testingmac/projects/XtraSkill/frontend && flutter analyze lib/providers/assistant_conversation_provider.dart` — should pass with no errors.

Check: `grep -c 'artifact\|Artifact\|budget\|Budget\|mode.*selector\|ModeChange' frontend/lib/providers/assistant_conversation_provider.dart` — should return 0 (no BA-specific references).

Check: `grep 'selectedSkill\|sendMessage\|streamChat\|loadThread' frontend/lib/providers/assistant_conversation_provider.dart` — should show all core methods.
  </verify>
  <done>AssistantConversationProvider created with SSE streaming, skill prepending, file attachment tracking, auto-retry, and thinking timer — clean of all BA-specific logic. flutter_markdown and flutter_highlight packages installed.</done>
</task>

<task type="auto">
  <name>Task 2: Create MarkdownMessage Widget with Syntax Highlighting</name>
  <files>
    frontend/lib/screens/assistant/widgets/markdown_message.dart
  </files>
  <action>
Create `frontend/lib/screens/assistant/widgets/markdown_message.dart` — a widget that renders AI response content as formatted markdown with syntax-highlighted code blocks.

**MarkdownMessage widget:**
```dart
class MarkdownMessage extends StatelessWidget {
  final String content;
  final bool isStreaming; // If true, render incrementally
  const MarkdownMessage({required this.content, this.isStreaming = false});
}
```

**Implementation:**
1. Use `MarkdownBody` from `flutter_markdown` package (not `Markdown` which includes scrolling)
2. Set `selectable: true` so users can copy text from rendered content
3. Create custom `CodeElementBuilder` extending `MarkdownElementBuilder` for syntax highlighting:
   - Extract language from element's `class` attribute (e.g., `language-python` → `python`)
   - Use `HighlightView` from `flutter_highlight` for rendering
   - Use theme-appropriate highlight theme: `githubTheme` for light mode, `githubDarkTheme` (or `vs2015Theme`) for dark mode — detect via `Theme.of(context).brightness`
   - Wrap code blocks in a container with rounded corners, proper padding (12px), and surface background color
   - Add a "Copy code" button in the top-right corner of code blocks (small IconButton with Icons.copy)
4. Configure `MarkdownStyleSheet` from theme:
   - `codeblockDecoration`: rounded container with `surfaceContainerHighest` background
   - `code`: inline code with monospace font and subtle background
   - `h1`, `h2`, `h3`: proper heading sizes
   - `tableHead`, `tableBody`: table styling with borders
   - `blockquote`: styled with left border
5. Handle `onTapLink` — open URLs via `url_launcher` (already in pubspec)
6. Handle edge case: empty content → show nothing (don't render empty markdown)
7. Handle edge case: streaming partial markdown → MarkdownBody handles this gracefully (incomplete syntax renders as text)

**Copy code button pattern:**
The CodeElementBuilder should wrap each code block in a Stack with:
- The HighlightView as the main child
- A positioned "Copy" IconButton in the top-right
- Use `Clipboard.setData(ClipboardData(text: code))` on tap
- Show brief SnackBar "Code copied" confirmation

**Theme awareness:**
```dart
final isDark = Theme.of(context).brightness == Brightness.dark;
final codeTheme = isDark ? vs2015Theme : githubTheme;
```

**Import the highlight themes:**
```dart
import 'package:flutter_highlight/themes/github.dart';
import 'package:flutter_highlight/themes/vs2015.dart'; // or github-dark
```

IMPORTANT: This widget replaces the `Text()` widget currently used in BA message bubbles. The Assistant chat will use MarkdownMessage for ALL assistant messages, rendering formatted markdown instead of raw text.
  </action>
  <verify>
Run: `cd /Users/a1testingmac/projects/XtraSkill/frontend && flutter analyze lib/screens/assistant/widgets/markdown_message.dart` — should pass with no errors.

Check: `grep 'MarkdownBody\|HighlightView\|CodeElementBuilder\|flutter_markdown\|flutter_highlight' frontend/lib/screens/assistant/widgets/markdown_message.dart` — should show all key imports and class references.
  </verify>
  <done>MarkdownMessage widget renders AI content as formatted markdown with syntax-highlighted code blocks, theme-aware styling, copy-code buttons, link handling, and proper edge case handling for streaming content.</done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes for all new files
2. AssistantConversationProvider has sendMessage, loadThread, retryLastMessage, selectSkill, addAttachedFile methods
3. MarkdownMessage renders markdown content using flutter_markdown with syntax highlighting
4. No BA-specific logic in AssistantConversationProvider (no artifacts, budget, mode)
5. flutter_markdown and flutter_highlight are in pubspec.yaml dependencies
</verification>

<success_criteria>
- AssistantConversationProvider manages streaming chat state cleanly (no BA logic)
- Skill selection prepends to prompt transparently and clears after send
- MarkdownMessage renders headers, code blocks, tables, lists with proper formatting
- Code blocks have syntax highlighting with theme-appropriate colors
- Auto-retry on first streaming error after 2-second delay
- Thinking indicator start time tracked for elapsed time display
</success_criteria>

<output>
After completion, create `.planning/phases/64-conversation-documents/64-02-SUMMARY.md`
</output>

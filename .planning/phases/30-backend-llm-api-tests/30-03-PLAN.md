---
phase: 30-backend-llm-api-tests
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/api/__init__.py
  - backend/tests/api/conftest.py
  - backend/tests/api/test_auth_routes.py
  - backend/tests/api/test_project_routes.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Auth routes return correct status codes for each endpoint"
    - "Auth routes return consistent error format on failures"
    - "Projects routes return 201 on create, 200 on list/get, 204 on delete"
    - "Projects routes return 404 for non-existent or non-owned resources"
    - "Projects routes return 403 without authentication"
  artifacts:
    - path: "backend/tests/api/test_auth_routes.py"
      provides: "Auth router contract tests"
      min_lines: 80
    - path: "backend/tests/api/test_project_routes.py"
      provides: "Projects router contract tests"
      min_lines: 100
  key_links:
    - from: "backend/tests/api/test_auth_routes.py"
      to: "/auth/*"
      via: "client.post/get"
      pattern: "client\\.(post|get).*\"/auth/"
    - from: "backend/tests/api/test_project_routes.py"
      to: "/api/projects"
      via: "client.post/get/put/delete"
      pattern: "client\\.(post|get|put|delete).*\"/api/projects"
---

<objective>
Create API contract tests for Auth and Projects routers

Purpose: Verify Auth and Projects endpoints return correct status codes and response schemas (BAPI-01, BAPI-02)

Output: Test files in backend/tests/api/ with contract tests for auth and projects routes
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-backend-llm-api-tests/30-RESEARCH.md
@backend/app/routes/auth.py
@backend/app/routes/projects.py
@backend/tests/fixtures/auth_fixtures.py
@backend/tests/fixtures/factories.py
@backend/tests/test_projects.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API test module structure</name>
  <files>
    backend/tests/api/__init__.py
    backend/tests/api/conftest.py
  </files>
  <action>
Create the API test module directory structure:

1. Create `backend/tests/api/__init__.py` (empty file)

2. Create `backend/tests/api/conftest.py` with API-specific fixtures:
   - Re-export common fixtures from parent conftest
   - Add `authenticated_client` fixture that creates user + valid JWT
   - Add `auth_headers_for_user` factory fixture

```python
"""API test fixtures."""
import pytest
import pytest_asyncio
from uuid import uuid4
from httpx import ASGITransport, AsyncClient

from app.database import get_db
from app.models import User, OAuthProvider
from app.utils.jwt import create_access_token
from main import app


@pytest_asyncio.fixture
async def authenticated_client(db_session):
    """Create test client with authenticated user."""
    # Create test user
    user = User(
        id=str(uuid4()),
        email="testuser@example.com",
        oauth_provider=OAuthProvider.GOOGLE,
        oauth_id=f"google_{uuid4().hex[:8]}",
    )
    db_session.add(user)
    await db_session.commit()

    # Create JWT token
    token = create_access_token(user.id, user.email)

    # Override db dependency
    async def override_get_db():
        yield db_session

    app.dependency_overrides[get_db] = override_get_db

    async with AsyncClient(
        transport=ASGITransport(app=app),
        base_url="http://test",
        headers={"Authorization": f"Bearer {token}"}
    ) as ac:
        # Attach user for test access
        ac.test_user = user
        yield ac

    app.dependency_overrides.clear()


@pytest.fixture
def create_auth_token():
    """Factory to create JWT tokens for specific users."""
    def _create(user: User) -> str:
        return create_access_token(user.id, user.email)
    return _create
```
  </action>
  <verify>
```bash
cd G:\git_repos\BA_assistant\backend
python -c "from tests.api.conftest import authenticated_client; print('API test module created')"
```
  </verify>
  <done>API test module exists with conftest.py containing authenticated_client fixture</done>
</task>

<task type="auto">
  <name>Task 2: Create Auth router contract tests</name>
  <files>backend/tests/api/test_auth_routes.py</files>
  <action>
Create `backend/tests/api/test_auth_routes.py` with contract tests for all auth endpoints.

**Class: TestGoogleOAuthInitiate**
- `test_200_returns_auth_url`: POST /auth/google/initiate returns {"auth_url": "...", "state": "..."}
- `test_auth_url_is_google_domain`: auth_url starts with Google OAuth domain

**Class: TestGoogleOAuthCallback**
- `test_400_invalid_state`: GET /auth/google/callback with unknown state returns 400
- `test_400_missing_code`: GET /auth/google/callback without code returns 422 (FastAPI validation)

**Class: TestMicrosoftOAuthInitiate**
- `test_200_returns_auth_url`: POST /auth/microsoft/initiate returns {"auth_url": "...", "state": "..."}
- `test_auth_url_is_microsoft_domain`: auth_url contains Microsoft login domain

**Class: TestMicrosoftOAuthCallback**
- `test_400_invalid_state`: GET /auth/microsoft/callback with unknown state returns 400
- `test_400_missing_code`: GET /auth/microsoft/callback without code returns 422

**Class: TestLogout**
- `test_200_returns_message`: POST /auth/logout returns {"message": "Logged out successfully"}

**Class: TestGetMe**
- `test_200_with_valid_token`: GET /auth/me with valid JWT returns user info
- `test_403_without_token`: GET /auth/me without Authorization header returns 403
- `test_user_info_fields`: Response contains id, email, oauth_provider, created_at

**Class: TestGetUsage**
- `test_200_with_valid_token`: GET /auth/usage with valid JWT returns usage object
- `test_403_without_token`: GET /auth/usage without Authorization header returns 403
- `test_usage_fields`: Response contains total_cost, total_requests, budget

Example tests:
```python
import pytest
from unittest.mock import patch, AsyncMock

class TestGoogleOAuthInitiate:
    """Contract tests for POST /auth/google/initiate."""

    @pytest.mark.asyncio
    async def test_200_returns_auth_url(self, client, db_session):
        """Returns auth_url and state on success."""
        # Mock OAuth service to avoid real OAuth calls
        with patch('app.routes.auth.OAuth2Service') as MockService:
            mock_instance = MockService.return_value
            mock_instance.get_google_auth_url = AsyncMock(
                return_value=("https://accounts.google.com/oauth?...", "test-state")
            )

            response = await client.post("/auth/google/initiate")

            assert response.status_code == 200
            data = response.json()
            assert "auth_url" in data
            assert "state" in data
            assert data["auth_url"].startswith("https://accounts.google.com")


class TestGetMe:
    """Contract tests for GET /auth/me."""

    @pytest.mark.asyncio
    async def test_200_with_valid_token(self, authenticated_client):
        """Returns user info with valid JWT."""
        response = await authenticated_client.get("/auth/me")

        assert response.status_code == 200
        data = response.json()
        assert data["email"] == "testuser@example.com"
        assert "id" in data
        assert "oauth_provider" in data
        assert "created_at" in data

    @pytest.mark.asyncio
    async def test_403_without_token(self, client):
        """Returns 403 without Authorization header."""
        response = await client.get("/auth/me")
        assert response.status_code == 403
```
  </action>
  <verify>
```bash
cd G:\git_repos\BA_assistant\backend
pytest tests/api/test_auth_routes.py -v
```
All tests pass.
  </verify>
  <done>Auth router has contract tests for OAuth initiate, callback, logout, /me, and /usage endpoints</done>
</task>

<task type="auto">
  <name>Task 3: Create Projects router contract tests</name>
  <files>backend/tests/api/test_project_routes.py</files>
  <action>
Create `backend/tests/api/test_project_routes.py` with contract tests for all project endpoints.

Note: Some tests exist in test_projects.py but those are integration tests. These are focused contract tests verifying HTTP contracts.

**Class: TestCreateProject**
- `test_201_with_valid_data`: POST /api/projects returns 201 with project object
- `test_403_without_auth`: POST /api/projects without token returns 403
- `test_422_missing_name`: POST /api/projects without name returns 422
- `test_422_empty_name`: POST /api/projects with empty name returns 422
- `test_response_schema`: Response has id, name, description, created_at, updated_at

**Class: TestListProjects**
- `test_200_returns_array`: GET /api/projects returns 200 with array
- `test_403_without_auth`: GET /api/projects without token returns 403
- `test_empty_list_for_new_user`: GET /api/projects returns [] for user with no projects
- `test_returns_only_owned_projects`: User only sees their own projects

**Class: TestGetProject**
- `test_200_with_details`: GET /api/projects/{id} returns project with documents, threads
- `test_403_without_auth`: GET /api/projects/{id} without token returns 403
- `test_404_not_found`: GET /api/projects/{uuid} for non-existent returns 404
- `test_404_not_owned`: GET /api/projects/{id} for other user's project returns 404

**Class: TestUpdateProject**
- `test_200_updates_name`: PUT /api/projects/{id} updates name
- `test_200_updates_description`: PUT /api/projects/{id} updates description
- `test_403_without_auth`: PUT /api/projects/{id} without token returns 403
- `test_404_not_found`: PUT /api/projects/{uuid} for non-existent returns 404
- `test_404_not_owned`: PUT /api/projects/{id} for other user's project returns 404

**Class: TestDeleteProject**
- `test_204_deletes_project`: DELETE /api/projects/{id} returns 204
- `test_403_without_auth`: DELETE /api/projects/{id} without token returns 403
- `test_404_not_found`: DELETE /api/projects/{uuid} for non-existent returns 404
- `test_404_not_owned`: DELETE /api/projects/{id} for other user's project returns 404

Example tests:
```python
import pytest
from uuid import uuid4
from app.models import Project

class TestCreateProject:
    """Contract tests for POST /api/projects."""

    @pytest.mark.asyncio
    async def test_201_with_valid_data(self, authenticated_client):
        """Returns 201 and project data on success."""
        response = await authenticated_client.post(
            "/api/projects",
            json={"name": "Test Project", "description": "Test description"}
        )

        assert response.status_code == 201
        data = response.json()
        assert data["name"] == "Test Project"
        assert data["description"] == "Test description"
        assert "id" in data
        assert "created_at" in data
        assert "updated_at" in data

    @pytest.mark.asyncio
    async def test_403_without_auth(self, client):
        """Returns 403 without authentication."""
        response = await client.post(
            "/api/projects",
            json={"name": "Test"}
        )
        assert response.status_code == 403

    @pytest.mark.asyncio
    async def test_422_missing_name(self, authenticated_client):
        """Returns 422 when name is missing."""
        response = await authenticated_client.post(
            "/api/projects",
            json={"description": "No name"}
        )
        assert response.status_code == 422


class TestDeleteProject:
    """Contract tests for DELETE /api/projects/{id}."""

    @pytest.mark.asyncio
    async def test_204_deletes_project(self, authenticated_client, db_session):
        """Returns 204 on successful delete."""
        # Create project for the test user
        project = Project(
            user_id=authenticated_client.test_user.id,
            name="To Delete"
        )
        db_session.add(project)
        await db_session.commit()

        response = await authenticated_client.delete(f"/api/projects/{project.id}")

        assert response.status_code == 204

    @pytest.mark.asyncio
    async def test_404_not_found(self, authenticated_client):
        """Returns 404 for non-existent project."""
        response = await authenticated_client.delete(f"/api/projects/{uuid4()}")
        assert response.status_code == 404
```
  </action>
  <verify>
```bash
cd G:\git_repos\BA_assistant\backend
pytest tests/api/test_project_routes.py -v
```
All tests pass.
  </verify>
  <done>Projects router has contract tests for create, list, get, update, delete with auth and error cases</done>
</task>

</tasks>

<verification>
Run all API tests:
```bash
cd G:\git_repos\BA_assistant\backend
pytest tests/api/test_auth_routes.py tests/api/test_project_routes.py -v --tb=short
```

Expected: All tests pass (25+ tests across 2 files)
</verification>

<success_criteria>
- backend/tests/api/ directory exists with __init__.py and conftest.py
- test_auth_routes.py has tests for OAuth, logout, /me, /usage endpoints
- test_project_routes.py has tests for CRUD operations
- All tests verify correct status codes (201, 200, 204, 403, 404, 422)
- All tests pass with `pytest tests/api/ -v`
- Error responses use consistent {"detail": "..."} format
</success_criteria>

<output>
After completion, create `.planning/phases/30-backend-llm-api-tests/30-03-SUMMARY.md`
</output>

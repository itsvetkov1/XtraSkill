# Milestone v1.9.4: Artifact Generation Deduplication

**Status:** SHIPPED 2026-02-05
**Phases:** 40-42
**Total Plans:** 5

## Overview

Fix the artifact multiplication bug (BUG-016) through a 4-layer defense-in-depth strategy: prompt engineering (Layers 1+2), structural history annotation (Layer 3), and ephemeral silent generation (Layer 4). Each phase delivers measurable deduplication improvement and is independently shippable. Zero new dependencies — all changes modify existing files.

## Phases

### Phase 40: Prompt Engineering Fixes (Layers 1+2)

**Goal:** The AI model treats each artifact generation request as a single-call operation and ignores fulfilled requests in conversation history.

**Bug Reference:** BUG-017 (prompt deduplication rule), BUG-018 (tool description single-call)

**Dependencies:** None (first phase, zero-risk string edits)

**Requirements:** PROMPT-01, PROMPT-02, PROMPT-03, PROMPT-04, PROMPT-05, PROMPT-06, PROMPT-07, PROMPT-08

**Files:** `backend/app/services/ai_service.py` only

**Plans:** 1 plan

Plans:
- [x] 40-01-PLAN.md — Add deduplication rule to SYSTEM_PROMPT and enforce single-call in SAVE_ARTIFACT_TOOL

**Success Criteria:**
1. When a user has generated 3+ artifacts in a thread, sending a new chat message produces exactly one artifact (not duplicates of previous artifacts)
2. When a user says "regenerate the BRD with more detail," the model honors the request as a new generation (escape hatch works)
3. The save_artifact tool description no longer contains "multiple times" language
4. Regular chat messages (non-artifact) are completely unaffected by the prompt changes

**Research Flags:** None (well-documented patterns, skip research-phase)

**Completed:** 2026-02-05

---

### Phase 41: Structural History Filtering (Layer 3)

**Goal:** Fulfilled artifact requests are structurally removed from conversation context before reaching the model, so the model never sees completed generation requests.

**Bug Reference:** BUG-019 (history filtering fulfilled requests)

**Dependencies:** None (code-independent from Phase 40, but should execute after for safety-net benefit)

**Requirements:** HIST-01, HIST-02, HIST-03, HIST-04, HIST-05, HIST-06

**Files:** `backend/app/services/conversation_service.py` (primary), `backend/tests/unit/services/test_conversation_service.py`, `backend/tests/unit/services/test_conversation_service_db.py`

**Plans:** 1 plan

Plans:
- [x] 41-01-PLAN.md — Add artifact-aware filtering to build_conversation_context with database timestamp correlation detection

**Success Criteria:**
1. In a thread with fulfilled artifact requests, the model's conversation context excludes those message pairs entirely
2. A failed artifact generation (no artifact created) leaves the request in context, allowing the user to retry
3. No marker text leaks into user-visible responses (removal, not annotation)
4. Existing conversation truncation behavior (token limits) is unchanged

**Research Flags:** Resolved — database correlation via timestamp matching confirmed as detection strategy (see 41-RESEARCH.md).

**Completed:** 2026-02-05

---

### Phase 42: Silent Artifact Generation (Layer 4)

**Goal:** Button-triggered artifact generation produces an artifact card with a loading indicator and no chat message bubbles, completely bypassing conversation history accumulation.

**Bug Reference:** THREAD-011 (silent artifact generation)

**Dependencies:** Phases 40-41 provide safety net for edge cases; Phase 42 is code-independent but should execute last due to complexity.

**Requirements:** SILENT-01, SILENT-02, SILENT-03, SILENT-04, SILENT-05, SILENT-06, SILENT-07, SILENT-08, SILENT-09, SILENT-10, SILENT-11, SILENT-12, SILENT-13, SILENT-14, SILENT-15, SILENT-16, SILENT-17, ERR-01, ERR-02, ERR-03, ERR-04

**Files:**
- Backend: `backend/app/routes/conversations.py` (ChatRequest model, stream_chat, event_generator), `backend/app/services/ai_service.py` (token tracking fix)
- Frontend: `frontend/lib/services/ai_service.dart`, `frontend/lib/providers/conversation_provider.dart`, `frontend/lib/screens/conversation/conversation_screen.dart`, new `frontend/lib/widgets/generating_indicator.dart`

**Plans:** 3 plans

Plans:
- [x] 42-01-PLAN.md — Backend: ChatRequest extension + conditional persistence + SSE event filtering
- [x] 42-02-PLAN.md — Frontend: AIService parameter + ConversationProvider generateArtifact() method
- [x] 42-03-PLAN.md — Frontend UI: GeneratingIndicator + GenerationErrorState widgets + screen integration

**Success Criteria:**
1. Clicking a preset artifact button (e.g., "User Stories") shows a typed loading animation ("Generating User Stories..."), then an artifact card appears — no user or assistant message bubbles in the chat
2. If generation fails (network error, API error), the loading animation clears, an error message is shown, and the user can try again
3. Sending a regular typed message in the same thread works exactly as before (no regressions from silent generation changes)
4. After silent generation, the thread summary is NOT updated (no wasted API call for a message that does not exist in history)
5. The generated artifact appears in the artifacts list and can be exported normally

**Research Flags:** Frontend state management for `generateArtifact()` needs careful design to avoid blank message bubbles (PITFALL-06). Must be a separate code path from `sendMessage()`.

**Completed:** 2026-02-05

---

## Milestone Summary

**Key Decisions:**

- Deduplication rule at priority 2 (after one-question-at-a-time, before mode detection)
- Tool results as completion evidence (not dead ARTIFACT_CREATED marker from BUG-019)
- Escape hatch covers regenerate/revise/update/create-new-version user requests
- Positive framing in rule: "ONLY act on MOST RECENT" (not negative framing)
- Single-call enforcement in tool description prevents permissive "multiple times" language
- Filter fulfilled pairs BEFORE truncation for accurate token estimation
- 5-second correlation window for artifact timestamp matching
- Use total_seconds() for timezone-safe timestamp comparison
- text_delta is only SSE event suppressed in silent mode
- Ephemeral instruction appended in-memory only (never persisted)
- Token tracking unconditional in silent mode (budget enforcement)
- generateArtifact() separate state machine from sendMessage() (PITFALL-06)
- State clears on ArtifactCreatedEvent not MessageCompleteEvent (PITFALL-05)
- Error source tagging via _lastOperationWasGeneration
- GeneratingIndicator in ListView after artifacts (consistent with streaming pattern)
- Generation errors in dedicated widget, not MaterialBanner

**Issues Resolved:**

- BUG-016: Artifact multiplication bug (4-layer defense-in-depth)
- BUG-017: Prompt deduplication rule
- BUG-018: Tool description single-call
- BUG-019: History filtering fulfilled requests
- THREAD-011: Silent artifact generation

**Issues Deferred:**

- SAVE_ARTIFACT_TOOL enum missing "brd" type (pre-existing, LOW severity)
- 12 pre-existing test failures (10 conversation_screen_test, 2 conversation_provider_test)

**Technical Debt Incurred:**

- None new — all changes are clean implementations

---

*For current project status, see .planning/ROADMAP.md (if exists) or .planning/PROJECT.md*

---

*Archived: 2026-02-05 as part of v1.9.4 milestone completion*

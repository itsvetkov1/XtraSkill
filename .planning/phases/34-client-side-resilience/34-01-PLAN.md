---
phase: 34-client-side-resilience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/providers/conversation_provider.dart
  - frontend/lib/screens/conversation/conversation_screen.dart
  - frontend/lib/screens/conversation/widgets/streaming_message.dart
  - frontend/lib/screens/conversation/widgets/message_bubble.dart
  - frontend/lib/screens/conversation/widgets/error_state_message.dart
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User sees partial AI response preserved when network drops mid-stream (not blank message)"
    - "User sees 'Connection lost - response incomplete' banner when stream interrupted"
    - "User can tap Retry to regenerate interrupted response"
    - "User can copy partial content from error-state message"
  artifacts:
    - path: "frontend/lib/providers/conversation_provider.dart"
      provides: "Error state with preserved partial content"
      contains: "_hasPartialContent"
    - path: "frontend/lib/screens/conversation/widgets/error_state_message.dart"
      provides: "Widget for displaying incomplete AI response with copy/retry"
      min_lines: 50
    - path: "frontend/lib/screens/conversation/conversation_screen.dart"
      provides: "Error banner with connection lost message and retry"
      contains: "Connection lost"
  key_links:
    - from: "conversation_provider.dart"
      to: "conversation_screen.dart"
      via: "Consumer reading error + streamingText"
      pattern: "provider\\.error.*provider\\.streamingText"
    - from: "conversation_screen.dart"
      to: "error_state_message.dart"
      via: "ErrorStateMessage widget"
      pattern: "ErrorStateMessage"
---

<objective>
Implement network resilience for SSE streaming that preserves partial AI content on error.

Purpose: When network drops during AI response streaming, users currently lose all partial content (PITFALL-01). This plan fixes that by preserving `_streamingText` on error and displaying it in an error state with copy and retry capabilities.

Output:
- ConversationProvider preserves partial content on stream interruption
- ErrorStateMessage widget displays incomplete response with copy button
- Error banner shows "Connection lost - response incomplete" with Retry button
- User can copy partial content and retry to regenerate response
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/PITFALLS-v1.9.2.md

# Key files to modify
@frontend/lib/providers/conversation_provider.dart
@frontend/lib/screens/conversation/conversation_screen.dart
@frontend/lib/screens/conversation/widgets/streaming_message.dart
@frontend/lib/screens/conversation/widgets/message_bubble.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Preserve partial content on stream error in ConversationProvider</name>
  <files>frontend/lib/providers/conversation_provider.dart</files>
  <action>
Modify `sendMessage()` error handling to preserve partial content:

1. Add new state field: `bool _hasPartialContent = false`
2. Add getter: `bool get hasPartialContent => _hasPartialContent`

3. In the ErrorEvent handler (line ~170-175), change from:
```dart
} else if (event is ErrorEvent) {
  _error = event.message;
  _isStreaming = false;
  _streamingText = '';  // REMOVE THIS LINE
  _statusMessage = null;
  notifyListeners();
}
```
to:
```dart
} else if (event is ErrorEvent) {
  _error = event.message;
  _isStreaming = false;
  _hasPartialContent = _streamingText.isNotEmpty;
  // DO NOT clear _streamingText - preserve partial content per PITFALL-01
  _statusMessage = null;
  notifyListeners();
}
```

4. In the catch block (line ~178-184), same change:
```dart
} catch (e) {
  _error = e.toString();
  _isStreaming = false;
  _hasPartialContent = _streamingText.isNotEmpty;
  // DO NOT clear _streamingText - preserve partial content per PITFALL-01
  _statusMessage = null;
  notifyListeners();
}
```

5. In `retryLastMessage()`, clear the partial content state:
```dart
void retryLastMessage() {
  if (_lastFailedMessage == null) return;

  final content = _lastFailedMessage!;
  _lastFailedMessage = null;
  _error = null;
  _hasPartialContent = false;  // ADD THIS
  _streamingText = '';         // ADD THIS - clear on retry

  // Remove the optimistic user message...
}
```

6. In `clearError()`, also clear partial content:
```dart
void clearError() {
  _error = null;
  _isNotFound = false;
  _lastFailedMessage = null;
  _hasPartialContent = false;  // ADD THIS
  _streamingText = '';         // ADD THIS
  notifyListeners();
}
```

7. In `clearConversation()`, reset the new state:
```dart
_hasPartialContent = false;  // ADD THIS
```

CRITICAL: The key insight from PITFALL-01 is to NOT clear `_streamingText` when an error occurs, only when the user explicitly retries or dismisses.
  </action>
  <verify>
Run: `cd G:\git_repos\BA_assistant\frontend && flutter analyze lib/providers/conversation_provider.dart`
Verify no analysis errors.
  </verify>
  <done>
ConversationProvider preserves `_streamingText` on error and exposes `hasPartialContent` getter.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ErrorStateMessage widget for incomplete responses</name>
  <files>frontend/lib/screens/conversation/widgets/error_state_message.dart</files>
  <action>
Create new widget to display partial AI response in error state:

```dart
/// Widget displaying partial AI response after stream interruption.
library;

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';

/// Displays partial AI response with copy capability after stream error
class ErrorStateMessage extends StatelessWidget {
  /// Partial text accumulated before error
  final String partialText;

  /// Callback to copy content
  final VoidCallback? onCopy;

  const ErrorStateMessage({
    super.key,
    required this.partialText,
    this.onCopy,
  });

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    return Align(
      alignment: Alignment.centerLeft,
      child: Container(
        constraints: BoxConstraints(
          maxWidth: MediaQuery.of(context).size.width * 0.8,
        ),
        margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 6),
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: theme.colorScheme.surfaceContainerHighest,
          borderRadius: const BorderRadius.only(
            topLeft: Radius.circular(16),
            topRight: Radius.circular(16),
            bottomLeft: Radius.circular(4),
            bottomRight: Radius.circular(16),
          ),
          border: Border.all(
            color: theme.colorScheme.error.withValues(alpha: 0.3),
            width: 1,
          ),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          mainAxisSize: MainAxisSize.min,
          children: [
            // Incomplete response indicator
            Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Icon(
                  Icons.warning_amber_rounded,
                  size: 16,
                  color: theme.colorScheme.error,
                ),
                const SizedBox(width: 8),
                Text(
                  'Response incomplete',
                  style: TextStyle(
                    fontSize: 12,
                    fontStyle: FontStyle.italic,
                    color: theme.colorScheme.error,
                  ),
                ),
              ],
            ),
            const SizedBox(height: 8),
            // Partial text content
            SelectableText(
              partialText,
              style: TextStyle(
                fontSize: 15,
                height: 1.4,
                color: theme.colorScheme.onSurface,
              ),
            ),
            const SizedBox(height: 8),
            // Copy button
            Align(
              alignment: Alignment.centerRight,
              child: IconButton(
                icon: Icon(
                  Icons.copy,
                  size: 18,
                  color: theme.colorScheme.onSurfaceVariant,
                ),
                tooltip: 'Copy partial response',
                padding: EdgeInsets.zero,
                constraints: const BoxConstraints(),
                onPressed: () => _copyToClipboard(context),
              ),
            ),
          ],
        ),
      ),
    );
  }

  /// Copies partial content to clipboard
  /// CRITICAL: No async/await - Safari requires synchronous clipboard call
  void _copyToClipboard(BuildContext context) {
    try {
      Clipboard.setData(ClipboardData(text: partialText));
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Partial response copied')),
      );
      onCopy?.call();
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Failed to copy')),
      );
    }
  }
}
```

Key features:
- Visual distinction with error-colored border
- "Response incomplete" indicator at top
- SelectableText for partial content
- Copy button that works synchronously (Safari compatibility)
- Styling consistent with MessageBubble
  </action>
  <verify>
Run: `cd G:\git_repos\BA_assistant\frontend && flutter analyze lib/screens/conversation/widgets/error_state_message.dart`
Verify no analysis errors.
  </verify>
  <done>
ErrorStateMessage widget created with copy functionality and error-state styling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update ConversationScreen for error state display</name>
  <files>frontend/lib/screens/conversation/conversation_screen.dart</files>
  <action>
Modify ConversationScreen to display partial content and connection error banner:

1. Add import at top:
```dart
import 'widgets/error_state_message.dart';
```

2. Update the error banner section (around line ~237-252) to show specific connection error message:
```dart
// Error banner with connection-specific message
if (provider.error != null)
  MaterialBanner(
    content: Text(
      provider.hasPartialContent
          ? 'Connection lost - response incomplete'
          : provider.error!,
    ),
    backgroundColor: Theme.of(context).colorScheme.errorContainer,
    actions: [
      TextButton(
        onPressed: provider.clearError,
        child: const Text('Dismiss'),
      ),
      if (provider.canRetry)
        TextButton(
          onPressed: provider.retryLastMessage,
          child: const Text('Retry'),
        ),
    ],
  ),
```

3. In `_buildMessageList`, after the streaming message section (around line ~336-343), add error state message display:

Update the itemCount calculation:
```dart
itemCount: messages.length +
           (provider.isStreaming ? 1 : 0) +
           (provider.hasPartialContent && !provider.isStreaming ? 1 : 0),
```

Update the itemBuilder:
```dart
itemBuilder: (context, index) {
  // Error state partial message at the end (when not streaming)
  if (provider.hasPartialContent &&
      !provider.isStreaming &&
      index == messages.length) {
    return ErrorStateMessage(
      partialText: provider.streamingText,
    );
  }

  // Streaming message at the end
  if (provider.isStreaming && index == messages.length) {
    return StreamingMessage(
      text: provider.streamingText,
      statusMessage: provider.statusMessage,
    );
  }

  final message = messages[index];
  return GestureDetector(
    onLongPress: () => _showMessageOptions(context, message),
    child: MessageBubble(message: message),
  );
},
```

This ensures:
- Error state message appears below the last user message when stream fails
- Streaming message appears when actively streaming
- Never show both at same time (mutually exclusive via isStreaming check)
  </action>
  <verify>
Run: `cd G:\git_repos\BA_assistant\frontend && flutter analyze lib/screens/conversation/conversation_screen.dart`
Verify no analysis errors.
  </verify>
  <done>
ConversationScreen displays "Connection lost - response incomplete" banner and partial content message with copy/retry capabilities.
  </done>
</task>

</tasks>

<verification>
1. Static analysis passes: `cd G:\git_repos\BA_assistant\frontend && flutter analyze`
2. Code review checklist:
   - [ ] ConversationProvider preserves _streamingText on error (never cleared in error handlers)
   - [ ] hasPartialContent getter exposes error state
   - [ ] ErrorStateMessage has copy button with Safari-safe synchronous clipboard
   - [ ] ConversationScreen shows "Connection lost - response incomplete" when hasPartialContent
   - [ ] Retry button clears partial content and restarts request
   - [ ] Dismiss button clears error and partial content
</verification>

<success_criteria>
- NET-01: On network loss during SSE streaming, partial AI content is preserved (not cleared)
- NET-02: Error banner displays "Connection lost - response incomplete" when stream interrupted
- NET-03: Retry button available to regenerate interrupted response (existing canRetry + retryLastMessage)
- NET-04: Copy button remains functional for partial content in error state (ErrorStateMessage)
</success_criteria>

<output>
After completion, create `.planning/phases/34-client-side-resilience/34-01-SUMMARY.md`
</output>

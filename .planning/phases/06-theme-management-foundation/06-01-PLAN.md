---
phase: 06-theme-management-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/pubspec.yaml
  - frontend/lib/providers/theme_provider.dart
  - frontend/lib/core/theme.dart
autonomous: true

must_haves:
  truths:
    - "ThemeProvider class exists and manages theme state with SharedPreferences"
    - "AppTheme uses user-specified colors (blue #1976D2, dark gray #121212)"
    - "Theme preference can be toggled and persisted immediately"
  artifacts:
    - path: "frontend/lib/providers/theme_provider.dart"
      provides: "Theme state management with persistence"
      min_lines: 50
      exports: ["ThemeProvider"]
    - path: "frontend/lib/core/theme.dart"
      provides: "Material 3 theme definitions with user colors"
      contains: "Color(0xFF1976D2)"
      exports: ["AppTheme"]
    - path: "frontend/pubspec.yaml"
      provides: "shared_preferences dependency"
      contains: "shared_preferences:"
  key_links:
    - from: "ThemeProvider.toggleTheme()"
      to: "SharedPreferences.setBool()"
      via: "immediate persistence before notifyListeners"
      pattern: "await _prefs\\.setBool.*notifyListeners"
    - from: "ThemeProvider.load()"
      to: "SharedPreferences.getBool()"
      via: "static factory loading saved preference"
      pattern: "prefs\\.getBool\\('isDarkMode'\\)"
---

<objective>
Establish theme management foundation with persistent storage infrastructure and user-specified visual design.

**Purpose:** Create the core theme state management system using Provider + SharedPreferences pattern. This enables theme switching with immediate persistence and prevents white flash on dark mode startup (SET-06 requirement).

**Output:** ThemeProvider class ready for main.dart integration, AppTheme with professional blue accent and dark gray dark mode matching user decisions from 06-CONTEXT.md.
</objective>

<execution_context>
@G:/git_repos/BA_assistant/.claude/get-shit-done/workflows/execute-plan.md
@G:/git_repos/BA_assistant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@G:/git_repos/BA_assistant/.planning/PROJECT.md
@G:/git_repos/BA_assistant/.planning/ROADMAP.md
@G:/git_repos/BA_assistant/.planning/STATE.md
@G:/git_repos/BA_assistant/.planning/phases/06-theme-management-foundation/06-CONTEXT.md
@G:/git_repos/BA_assistant/.planning/phases/06-theme-management-foundation/06-RESEARCH.md

## Current Architecture

Provider pattern already established in project:
@G:/git_repos/BA_assistant/frontend/lib/providers/auth_provider.dart (reference pattern)
@G:/git_repos/BA_assistant/frontend/lib/main.dart (MultiProvider setup)

Existing theme definitions:
@G:/git_repos/BA_assistant/frontend/lib/core/theme.dart

Dependencies:
@G:/git_repos/BA_assistant/frontend/pubspec.yaml
</context>

<tasks>

<task type="auto">
  <name>Add shared_preferences dependency</name>
  <files>frontend/pubspec.yaml</files>
  <action>
Add `shared_preferences: ^2.5.4` to dependencies section (after existing packages, before dev_dependencies).

Use version 2.5.4+ for proven stability. Research confirmed this is the standard Flutter plugin for cross-platform persistent key-value storage (NSUserDefaults on iOS, SharedPreferences on Android, localStorage on web).

Verify: Alphabetical ordering maintained, valid YAML indentation (2 spaces).
  </action>
  <verify>grep "shared_preferences:" G:/git_repos/BA_assistant/frontend/pubspec.yaml</verify>
  <done>pubspec.yaml contains shared_preferences dependency with version constraint</done>
</task>

<task type="auto">
  <name>Create ThemeProvider with immediate persistence</name>
  <files>frontend/lib/providers/theme_provider.dart</files>
  <action>
Create ThemeProvider class following the ChangeNotifier pattern established in auth_provider.dart.

**Implementation requirements (from 06-CONTEXT.md user decisions):**

1. **State Management:**
   - Private `bool _isDarkMode` field
   - Private `SharedPreferences _prefs` field
   - Getter `bool get isDarkMode`
   - Getter `ThemeMode get themeMode` returning `ThemeMode.dark` or `ThemeMode.light` based on `_isDarkMode`

2. **Persistence (critical - SET-04):**
   - Store preference key as `'isDarkMode'`
   - In `toggleTheme()`: Call `await _prefs.setBool('isDarkMode', _isDarkMode)` IMMEDIATELY after flipping boolean, BEFORE `notifyListeners()`
   - Wrap persistence in try-catch (handle disk full/permission denied gracefully)
   - Default to `false` (light theme) if load fails (user decision: "Always default to light theme for new users")

3. **Initialization (critical - prevents white flash):**
   - Constructor: `ThemeProvider(this._prefs, {bool? initialDarkMode})`
   - Static factory: `static Future<ThemeProvider> load(SharedPreferences prefs)` that reads saved preference and returns initialized provider
   - Factory loads `prefs.getBool('isDarkMode') ?? false` (default to light)

4. **Toggle Method:**
   ```dart
   Future<void> toggleTheme() async {
     _isDarkMode = !_isDarkMode;

     try {
       await _prefs.setBool('isDarkMode', _isDarkMode);
     } catch (e) {
       debugPrint('Failed to persist theme preference: $e');
       // Don't block UI - user sees toggle, background save failed
     }

     notifyListeners();
   }
   ```

5. **File Structure:**
   - Library directive at top: `library;`
   - Import flutter/material.dart and shared_preferences
   - Single class: ThemeProvider extends ChangeNotifier
   - Static const for key: `static const String _themeKey = 'isDarkMode';`

**Why immediate persistence (user decision from 06-CONTEXT.md):** App may crash or be force-closed after toggle but before app shutdown. Saving immediately guarantees preference survives.

**Error handling:** Research flagged SharedPreferences failures (disk full, corrupted storage). Handle gracefully with try-catch and fallback to default light theme.

Follow auth_provider.dart structure: clear comments, explicit state management, consistent naming.
  </action>
  <verify>
dart analyze frontend/lib/providers/theme_provider.dart
grep -E "(toggleTheme|ThemeMode get themeMode|static Future.*load)" frontend/lib/providers/theme_provider.dart
  </verify>
  <done>
ThemeProvider class exists with ChangeNotifier pattern, immediate persistence in toggleTheme(), static load() factory, and handles SharedPreferences failures gracefully. No analyzer warnings.
  </done>
</task>

<task type="auto">
  <name>Update AppTheme with user-specified colors</name>
  <files>frontend/lib/core/theme.dart</files>
  <action>
Update existing AppTheme class to match user decisions from 06-CONTEXT.md:

1. **Seed Color Change:**
   - Change `primaryColor` from `Color(0xFF2196F3)` to `Color(0xFF1976D2)`
   - Update comment: `// Classic professional blue (user decision: #1976D2 range)`
   - This is a darker, more corporate blue per user preference

2. **Dark Theme Surface Color (critical for SET-06):**
   - In `darkTheme` getter, after `ColorScheme.fromSeed()` call, add `.copyWith()` to explicitly set surface color
   - ```dart
     colorScheme: ColorScheme.fromSeed(
       seedColor: primaryColor,
       brightness: Brightness.dark,
     ).copyWith(
       surface: const Color(0xFF121212), // Dark gray, not pure black (user decision)
     ),
     ```
   - Add comment: User decision from 06-CONTEXT.md - reduces eye strain vs pure black #000000

3. **Verify Elevation:**
   - Current elevation: 2 for cards (subtle shadows)
   - This matches user decision: "Subtle shadows only (no borders)"
   - Keep existing elevation values unchanged

4. **Material 3:**
   - Ensure `useMaterial3: true` remains in both themes (already set)
   - Material 3's surface tint approach automatically handles dark mode elevation per user decision

**Why #1976D2:** User specified "Blue accent for interactive elements (classic professional: #1976D2 range)" - this is Material Design's classic primary blue, universally recognized as clickable.

**Why #121212:** User specified "Dark gray background (#121212 - #1E1E1E range)" and research confirmed Material Design 3 uses #121212 to reduce eye strain compared to pure black.

Do NOT add borders, do NOT change elevation values, do NOT add custom theming beyond color updates. Keep it minimal.
  </action>
  <verify>
grep "0xFF1976D2" frontend/lib/core/theme.dart
grep "0xFF121212" frontend/lib/core/theme.dart
dart analyze frontend/lib/core/theme.dart
  </verify>
  <done>
AppTheme.primaryColor is #1976D2, darkTheme uses #121212 surface color, both themes use Material 3. No analyzer warnings. Color updates match user decisions.
  </done>
</task>

</tasks>

<verification>
**Code Quality:**
- `dart analyze frontend/` reports no errors or warnings
- ThemeProvider follows same ChangeNotifier pattern as auth_provider.dart
- SharedPreferences persistence wrapped in try-catch with graceful fallback

**Functional Verification:**
- `grep "shared_preferences:" frontend/pubspec.yaml` returns match
- `grep "class ThemeProvider extends ChangeNotifier" frontend/lib/providers/theme_provider.dart` returns match
- `grep "0xFF1976D2" frontend/lib/core/theme.dart` returns match (seed color)
- `grep "0xFF121212" frontend/lib/core/theme.dart` returns match (dark surface)

**Architecture Alignment:**
- ThemeProvider.load() factory enables async initialization in main() (prevents white flash per SET-06)
- toggleTheme() persists immediately before notifyListeners (survives crashes per user decision)
- Defaults to light theme (false) matching user decision: "Always default to light theme for new users"
</verification>

<success_criteria>
**Measurable Outcomes:**
1. `flutter pub get` in frontend/ succeeds without errors
2. ThemeProvider class compiles with zero analyzer warnings
3. AppTheme.lightTheme and AppTheme.darkTheme both use #1976D2 seed color
4. Dark theme explicitly sets surface to #121212 (not relying on Material 3 default alone)
5. ThemeProvider.load() factory method exists and returns Future<ThemeProvider>
6. toggleTheme() method calls _prefs.setBool() before notifyListeners()

**Ready for Integration:**
ThemeProvider can be instantiated in main() with async initialization. AppTheme colors match user's professional corporate aesthetic. All foundation pieces ready for Wave 2 integration.
</success_criteria>

<output>
After completion, create `G:/git_repos/BA_assistant/.planning/phases/06-theme-management-foundation/06-01-SUMMARY.md` using the summary template.

Include:
- Files created: theme_provider.dart
- Files modified: pubspec.yaml, theme.dart
- Key exports: ThemeProvider class with load() factory
- Key decisions: Immediate persistence pattern, #1976D2 blue, #121212 dark gray
- Integration notes: Ready for main.dart async initialization in Plan 2
</output>
